<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube 채널 검색 시스템</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .search-form {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #555;
            font-size: 0.95em;
        }

        .form-group input,
        .form-group select {
            padding: 12px 16px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s ease;
            background: white;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .date-range-container {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .date-input-group {
            display: flex;
            flex-direction: column;
            flex: 0 0 auto;
            width: 146px;
            min-width: 120px;
        }

        .date-input-group input[type="date"] {
            padding: 12px 16px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s ease;
            width: 100%;
            background: white;
        }

        .date-input-group input[type="date"]:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .checkbox-group {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-top: 8px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .checkbox-item input[type="checkbox"] {
            width: auto;
            margin: 0;
        }



        /* 카테고리 선택기 스타일 */
        .category-selector {
            position: relative;
        }

        .category-display {
            padding: 12px 16px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1em;
            user-select: none;
            min-height: 1.2em;
        }

        .category-display:hover {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .category-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #667eea;
            border-radius: 8px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.15);
            z-index: 1000;
            display: none;
            max-height: 300px;
            overflow-y: auto;
        }

        .category-dropdown.show {
            display: block;
        }

        .category-header {
            padding: 12px 16px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
        }

        .category-header input[type="checkbox"] {
            transform: scale(1.1);
        }

        .category-header label {
            cursor: pointer;
            user-select: none;
            margin: 0;
        }

        .category-options {
            max-height: 250px;
            overflow-y: auto;
        }

        .category-item {
            padding: 10px 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background-color 0.2s ease;
            border-bottom: 1px solid #f8f9fa;
        }

        .category-item:hover {
            background: #e3f2fd;
        }

        .category-item:last-child {
            border-bottom: none;
        }

        .category-item input[type="checkbox"] {
            transform: scale(1.05);
            margin: 0;
        }

        .category-item label {
            cursor: pointer;
            user-select: none;
            margin: 0;
            font-size: 0.95em;
        }

        .category-item input[type="checkbox"]:checked + label {
            color: #667eea;
            font-weight: 500;
        }

        /* 동영상 길이 섹션 스타일 */
        .video-length-section {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            margin-bottom: 25px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .section-label {
            font-weight: 600;
            font-size: 1.1em;
            color: #333;
            margin: 0;
        }

        .select-controls {
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        .select-all-container,
        .select-group-container {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9em;
            color: #555;
        }

        .select-all-container input[type="checkbox"],
        .select-group-container input[type="checkbox"] {
            transform: scale(1.1);
            cursor: pointer;
        }

        .select-all-container label,
        .select-group-container label {
            cursor: pointer;
            font-weight: 500;
            user-select: none;
        }

        .select-group-container {
            font-size: 0.85em;
            color: #666;
        }

        .video-length-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            align-items: start;
        }

        .video-length-grid .checkbox-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 15px;
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }

        .video-length-grid .checkbox-item:hover {
            border-color: #667eea;
            background: #f0f2ff;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
        }

        .video-length-grid .checkbox-item input[type="checkbox"]:checked + label {
            color: #667eea;
            font-weight: 600;
        }

        .video-length-grid .checkbox-item input[type="checkbox"] {
            margin-top: 4px;
            transform: scale(1.2);
        }

        .video-length-grid .checkbox-item label {
            font-weight: 500;
            font-size: 1em;
            line-height: 1.4;
            cursor: pointer;
        }

        .duration-desc {
            font-size: 0.85em;
            color: #666;
            font-weight: 400;
        }

        .search-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 50px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: block;
            margin: 20px auto 0;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .search-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .search-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.2em;
            color: #666;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .results-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .results-header {
            background: #f8f9fa;
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .results-info {
            font-weight: 600;
            color: #495057;
        }

        .results-controls {
            display: flex;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .pagination-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .pagination-controls select {
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            background: white;
        }

        .excel-download-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 0.9em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .excel-download-btn:hover {
            background: linear-gradient(135deg, #218838 0%, #1ea085 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4);
        }

        .excel-download-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .table-container {
            overflow-x: auto;
        }

        .results-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            table-layout: fixed; /* 컬럼 width 고정 */
        }

        /* 각 컬럼의 고정 width 설정 */
        .results-table th:nth-child(1),
        .results-table td:nth-child(1) {
            width: 90px; /* 썸네일 */
        }
        
        .results-table th:nth-child(2),
        .results-table td:nth-child(2) {
            width: 150px; /* 채널명 */
        }
        
        .results-table th:nth-child(3),
        .results-table td:nth-child(3) {
            width: 250px; /* 영상제목 */
        }
        
        .results-table th:nth-child(4),
        .results-table td:nth-child(4) {
            width: 120px; /* 카테고리 */
        }
        
        .results-table th:nth-child(5),
        .results-table td:nth-child(5) {
            width: 100px; /* 업로드일 */
        }
        
        .results-table th:nth-child(6),
        .results-table td:nth-child(6) {
            width: 100px; /* 조회수 */
        }
        
        .results-table th:nth-child(7),
        .results-table td:nth-child(7) {
            width: 80px; /* 구독자 */
        }
        
        .results-table th:nth-child(8),
        .results-table td:nth-child(8) {
            width: 60px; /* 링크 */
        }
        
        .results-table th:nth-child(9),
        .results-table td:nth-child(9) {
            width: 80px; /* 재생시간 */
        }
        
        .results-table th:nth-child(10),
        .results-table td:nth-child(10) {
            width: 60px; /* 썸네일 다운로드 */
        }
        


        .results-table th {
            background: #667eea;
            color: white;
            padding: 15px 12px;
            text-align: center;
            font-weight: 600;
            cursor: pointer;
            user-select: none;
            transition: background-color 0.3s ease;
            position: relative;
        }

        .results-table th:hover {
            background: #5a6fd8;
        }

        .results-table th.sortable::after {
            content: " ↕";
            font-size: 0.8em;
            opacity: 0.6;
        }

        .results-table th.sort-asc::after {
            content: " ↑";
            opacity: 1;
        }

        .results-table th.sort-desc::after {
            content: " ↓";
            opacity: 1;
        }

        .results-table td {
            padding: 12px;
            border-bottom: 1px solid #e9ecef;
            vertical-align: middle;
        }

        .results-table tr:nth-child(even) {
            background-color: #f8f9fa;
        }

        .results-table tr:hover {
            background-color: #e3f2fd;
        }

        .thumbnail {
            width: 80px;
            height: 60px;
            object-fit: cover;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .video-title {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            line-clamp: 2; /* 표준 CSS 추가 */
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.4em;
            max-height: 2.8em; /* line-height × 2 */
            word-break: break-word;
            hyphens: auto;
        }

        .channel-name {
            font-weight: 600;
            color: #495057;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            width: 100%;
            transition: color 0.2s ease, font-weight 0.2s ease;
        }

        .channel-link {
            color: #667eea;
            text-decoration: none;
            display: block;
            width: 100%;
        }

        .channel-link:hover {
            text-decoration: none;
        }

        .channel-link:hover .channel-name {
            color: #ff1493;
            font-weight: bold;
            text-decoration: none;
            transition: color 0.2s ease, font-weight 0.2s ease;
        }

        .channel-link:active .channel-name {
            color: #ff1493;
            font-weight: bold;
        }

        .view-count {
            font-weight: 600;
            color: #28a745;
            text-align: right;
            display: block;
        }

        .subscriber-count {
            font-weight: 600;
            color: #dc3545;
            text-align: center;
            display: block;
        }

        .duration-time {
            font-family: 'Courier New', monospace;
            font-weight: 600;
            color: #6c757d;
            background: #f8f9fa;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 13px;
        }

        .video-link {
            color: #667eea;
            text-decoration: none;
            font-weight: 500;
            display: block;
            text-align: center;
        }

        .video-link:hover {
            text-decoration: none;
        }

        .download-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85em;
            transition: background-color 0.3s ease;
        }

        .download-btn:hover {
            background: #218838;
        }



        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            gap: 10px;
        }

        .pagination button {
            padding: 8px 16px;
            border: 1px solid #ced4da;
            background: white;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.3s ease;
        }

        .pagination button:hover:not(:disabled) {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination button.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .page-info {
            margin: 0 15px;
            font-weight: 500;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #f5c6cb;
        }

        .no-results {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }

        .no-results h3 {
            margin-bottom: 10px;
            color: #495057;
        }

        /* 업로드 날짜 컬럼 두 줄 표시 */
        .upload-date {
            display: flex;
            flex-direction: column;
            align-items: center;
            line-height: 1.2;
        }
        
        .upload-date .year {
            font-weight: 600;
            font-size: 0.9em;
            color: #333;
        }
        
        .upload-date .month-day {
            font-weight: 600;
            font-size: 0.9em;
            color: #333;
            margin-top: 2px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .results-header {
                flex-direction: column;
                align-items: stretch;
            }
            
            .results-controls {
                flex-direction: column;
                gap: 15px;
            }
            
            .pagination-controls {
                justify-content: center;
            }
            
            .excel-download-btn {
                align-self: center;
                width: fit-content;
            }
            
            .results-table {
                font-size: 0.9em;
            }
            
            .thumbnail {
                width: 60px;
                height: 45px;
            }
            
            .video-length-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .video-length-grid .checkbox-item {
                padding: 12px;
            }
            
            /* 모바일에서 컬럼 width 재조정 */
            .results-table th:nth-child(1),
            .results-table td:nth-child(1) {
                width: 70px; /* 썸네일 */
            }
            
            .results-table th:nth-child(2),
            .results-table td:nth-child(2) {
                width: 120px; /* 채널명 */
            }
            
            .results-table th:nth-child(3),
            .results-table td:nth-child(3) {
                width: 200px; /* 영상제목 */
            }
            
            .results-table th:nth-child(4),
            .results-table td:nth-child(4) {
                width: 100px; /* 카테고리 */
            }
            
            .results-table th:nth-child(5),
            .results-table td:nth-child(5) {
                width: 80px; /* 업로드일 */
            }
            
            .results-table th:nth-child(6),
            .results-table td:nth-child(6) {
                width: 90px; /* 조회수 */
            }
            
            .results-table th:nth-child(7),
            .results-table td:nth-child(7) {
                width: 70px; /* 구독자 */
            }
            
            .results-table th:nth-child(8),
            .results-table td:nth-child(8) {
                width: 50px; /* 링크 */
            }
            
            .results-table th:nth-child(9),
            .results-table td:nth-child(9) {
                width: 70px; /* 재생시간 */
            }
            
            .results-table th:nth-child(10),
            .results-table td:nth-child(10) {
                width: 50px; /* 썸네일 다운로드 */
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎥 YouTube Search</h1>
            <p>전세계 유튜브 채널에서 원하는 동영상을 찾아봅시다</p>
        </div>

        <form class="search-form" id="searchForm">
            <div class="form-grid">
                <div class="form-group">
                    <label for="country">국가</label>
                    <select id="country" name="country">
                        <option value="worldwide">전세계 (Worldwide)</option>
                        <option value="korea" selected>대한민국 (Korea)</option>
                        <option value="usa">미국 (USA)</option>
                        <option value="japan">일본 (Japan)</option>
                        <option value="china">중국 (China)</option>
                        <option value="uk">영국 (UK)</option>
                        <option value="germany">독일 (Germany)</option>
                        <option value="france">프랑스 (France)</option>
                        <option value="canada">캐나다 (Canada)</option>
                        <option value="australia">호주 (Australia)</option>
                        <option value="india">인도 (India)</option>
                        <option value="brazil">브라질 (Brazil)</option>
                        <option value="mexico">멕시코 (Mexico)</option>
                        <option value="russia">러시아 (Russia)</option>
                        <option value="italy">이탈리아 (Italy)</option>
                        <option value="spain">스페인 (Spain)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="keyword">검색 키워드</label>
                    <input type="text" id="keyword" name="keyword" placeholder="키워드 입력 (비워두면 인기 동영상 검색)">
                </div>

                <div class="form-group">
                    <label for="searchScope">검색 범위</label>
                    <div class="category-selector">
                        <div class="category-display" id="searchScopeDisplay">영상제목 선택됨</div>
                        <div class="category-dropdown" id="searchScopeDropdown">
                            <div class="category-header">
                                <input type="checkbox" id="selectAllSearchScope">
                                <label for="selectAllSearchScope">모든 범위</label>
                            </div>
                            <div class="category-options">
                                <div class="category-item">
                                    <input type="checkbox" id="searchTitle" name="searchScope" value="title" checked>
                                    <label for="searchTitle">영상제목</label>
                                </div>
                                <div class="category-item">
                                    <input type="checkbox" id="searchChannel" name="searchScope" value="channel">
                                    <label for="searchChannel">채널명</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="viewRange">조회수</label>
                    <div class="date-range-container">
                        <div class="date-input-group">
                            <input type="number" id="minViews" name="minViews" value="100000" placeholder="최소 조회수" />
                        </div>
                        <div class="date-input-group">
                            <input type="number" id="maxViews" name="maxViews" placeholder="최대 조회수" />
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="categories">카테고리</label>
                    <div class="category-selector">
                        <div class="category-display" id="categoryDisplay">모든 카테고리 선택됨</div>
                        <div class="category-dropdown" id="categoryDropdown">
                            <div class="category-header">
                                <input type="checkbox" id="selectAllCategories" checked>
                                <label for="selectAllCategories">모든 카테고리</label>
                            </div>
                            <div class="category-options">
                                <div class="category-item">
                                    <input type="checkbox" id="cat1" name="categories" value="1" checked>
                                    <label for="cat1">Film & Animation</label>
                                </div>
                                <div class="category-item">
                                    <input type="checkbox" id="cat2" name="categories" value="2" checked>
                                    <label for="cat2">Autos & Vehicles</label>
                                </div>
                                <div class="category-item">
                                    <input type="checkbox" id="cat10" name="categories" value="10" checked>
                                    <label for="cat10">Music</label>
                                </div>
                                <div class="category-item">
                                    <input type="checkbox" id="cat15" name="categories" value="15" checked>
                                    <label for="cat15">Pets & Animals</label>
                                </div>
                                <div class="category-item">
                                    <input type="checkbox" id="cat17" name="categories" value="17" checked>
                                    <label for="cat17">Sports</label>
                                </div>
                                <div class="category-item">
                                    <input type="checkbox" id="cat19" name="categories" value="19" checked>
                                    <label for="cat19">Travel & Events</label>
                                </div>
                                <div class="category-item">
                                    <input type="checkbox" id="cat20" name="categories" value="20" checked>
                                    <label for="cat20">Gaming</label>
                                </div>
                                <div class="category-item">
                                    <input type="checkbox" id="cat22" name="categories" value="22" checked>
                                    <label for="cat22">People & Blogs</label>
                                </div>
                                <div class="category-item">
                                    <input type="checkbox" id="cat23" name="categories" value="23" checked>
                                    <label for="cat23">Comedy</label>
                                </div>
                                <div class="category-item">
                                    <input type="checkbox" id="cat24" name="categories" value="24" checked>
                                    <label for="cat24">Entertainment</label>
                                </div>
                                <div class="category-item">
                                    <input type="checkbox" id="cat25" name="categories" value="25" checked>
                                    <label for="cat25">News & Politics</label>
                                </div>
                                <div class="category-item">
                                    <input type="checkbox" id="cat26" name="categories" value="26" checked>
                                    <label for="cat26">Howto & Style</label>
                                </div>
                                <div class="category-item">
                                    <input type="checkbox" id="cat27" name="categories" value="27" checked>
                                    <label for="cat27">Education</label>
                                </div>
                                <div class="category-item">
                                    <input type="checkbox" id="cat28" name="categories" value="28" checked>
                                    <label for="cat28">Science & Technology</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="maxResults">검색 결과 수</label>
                    <select id="maxResults" name="maxResults">
                        <option value="10">10건 (최소)</option>
                        <option value="20" selected>20건 (기본)</option>
                        <option value="30">30건 (적음)</option>
                        <option value="40">40건 (소량)</option>
                        <option value="50">50건 (적당)</option>
                        <option value="60">60건 (quota 절약)</option>
                        <option value="100">100건 (균형)</option>
                        <option value="150">150건 (많음)</option>
                        <option value="200">200건 (최대)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="uploadPeriod">업로드 기간</label>
                    <select id="uploadPeriod" name="uploadPeriod">
                        <option value="">전체 기간</option>
                        <option value="1day">1일</option>
                        <option value="1week">1주일</option>
                        <option value="1month">1개월</option>
                        <option value="3months">3개월</option>
                        <option value="6months">6개월</option>
                        <option value="1year">1년</option>
                        <option value="2years">2년</option>
                        <option value="3years">3년</option>
                        <option value="4years">4년</option>
                        <option value="5years">5년</option>
                        <option value="6years">6년</option>
                        <option value="7years">7년</option>
                        <option value="8years">8년</option>
                        <option value="9years">9년</option>
                        <option value="10years">10년</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="uploadDateRange">업로드 연도</label>
                    <div class="date-range-container">
                        <div class="date-input-group">
                            <input type="date" id="startDate" name="startDate" placeholder="시작일" />
                        </div>
                        <div class="date-input-group">
                            <input type="date" id="endDate" name="endDate" placeholder="종료일" />
                        </div>
                    </div>
                </div>

            </div>

            <!-- 동영상 길이 선택 (별도 섹션으로 분리하여 넓은 공간 확보) -->
            <div class="video-length-section">
                <div class="section-header">
                    <label class="section-label">동영상 길이</label>
                    <div class="select-controls">
                        <div class="select-all-container">
                            <input type="checkbox" id="selectAllVideoLength">
                            <label for="selectAllVideoLength">모두 선택</label>
                        </div>
                        <div class="select-group-container">
                            <input type="checkbox" id="selectFirst2VideoLength" checked>
                            <label for="selectFirst2VideoLength">맨 앞 두 개만</label>
                        </div>
                        <div class="select-group-container">
                            <input type="checkbox" id="selectNext3VideoLength">
                            <label for="selectNext3VideoLength">그 뒤 세 개만</label>
                        </div>
                        <div class="select-group-container">
                            <input type="checkbox" id="selectTop5VideoLength">
                            <label for="selectTop5VideoLength">위 5개 선택</label>
                        </div>
                        <div class="select-group-container">
                            <input type="checkbox" id="selectBottom5VideoLength">
                            <label for="selectBottom5VideoLength">밑 5개 선택</label>
                        </div>
                    </div>
                </div>
                <div class="video-length-grid">
                    <div class="checkbox-item">
                        <input type="checkbox" id="shortForm1" name="videoLength" value="short1" checked>
                        <label for="shortForm1">Short Form1<br><span class="duration-desc">(1분 미만)</span></label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="shortForm2" name="videoLength" value="short2" checked>
                        <label for="shortForm2">Short Form2<br><span class="duration-desc">(1분 이상 2분 미만)</span></label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="midForm1" name="videoLength" value="mid1">
                        <label for="midForm1">Mid Form1<br><span class="duration-desc">(2분 이상 10분 미만)</span></label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="midForm2" name="videoLength" value="mid2">
                        <label for="midForm2">Mid Form2<br><span class="duration-desc">(10분 이상 20분 미만)</span></label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="longForm1" name="videoLength" value="long1">
                        <label for="longForm1">Long Form1<br><span class="duration-desc">(20분 이상 30분 미만)</span></label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="longForm2" name="videoLength" value="long2">
                        <label for="longForm2">Long Form2<br><span class="duration-desc">(30분 이상 40분 미만)</span></label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="longForm3" name="videoLength" value="long3">
                        <label for="longForm3">Long Form3<br><span class="duration-desc">(40분 이상 50분 미만)</span></label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="longForm4" name="videoLength" value="long4">
                        <label for="longForm4">Long Form4<br><span class="duration-desc">(50분 이상 60분 미만)</span></label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="longForm5" name="videoLength" value="long5">
                        <label for="longForm5">Long Form5<br><span class="duration-desc">(60분 이상 90분 미만)</span></label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="longForm6" name="videoLength" value="long6">
                        <label for="longForm6">Long Form6<br><span class="duration-desc">(90분 이상)</span></label>
                    </div>
                </div>
            </div>

            <button type="submit" class="search-btn">
                🔍 검색하기
            </button>
        </form>

        <div id="loadingIndicator" class="loading" style="display: none;">
            <div class="spinner"></div>
            <p>검색 중입니다... 잠시만 기다려주세요.</p>
        </div>

        <div id="errorMessage" class="error-message" style="display: none;"></div>

        <div id="resultsContainer" class="results-container" style="display: none;">
            <div class="results-header">
                <div class="results-info">
                    <span id="resultsCount">0</span>개의 결과가 검색되었습니다.
                </div>
                <div class="results-controls">
                    <div class="pagination-controls">
                        <label>(구독자수: 만 단위) &nbsp;&nbsp;페이지당 표시:</label>
                        <select id="itemsPerPage">
                            <option value="10">10개</option>
                            <option value="20">20개</option>
                            <option value="30" selected>30개</option>
                            <option value="40">40개</option>
                            <option value="50">50개</option>
                            <option value="100">100개</option>
                            <option value="150">150개</option>
                            <option value="200">200개</option>
                        </select>
                    </div>
                    <button id="downloadExcelBtn" class="excel-download-btn" style="display: none;" title="클릭하면 저장 위치를 선택할 수 있습니다 (Chrome/Edge 86+ 지원)">
                        📊
                    </button>
                </div>
            </div>

            <div class="table-container">
                <table class="results-table">
                    <thead>
                        <tr>
                            <th data-sort="thumbnail_url">👍</th>
                            <th data-sort="youtube_channel_name" class="sortable">채널명</th>
                            <th data-sort="title" class="sortable">영상제목</th>
                            <th data-sort="primary_category" class="sortable">카테고리</th>
                            <th data-sort="status_date" class="sortable">🗓️</th>
                            <th data-sort="daily_view_count" class="sortable">👓</th>
                            <th data-sort="subscriber_count" class="sortable">👪</th>
                            <th data-sort="vod_url">▶️</th>
                            <th data-sort="duration" class="sortable">⏰</th>
                            <th>👍</th>
                        </tr>
                    </thead>
                    <tbody id="resultsTableBody">
                    </tbody>
                </table>
            </div>

            <div class="pagination" id="pagination">
            </div>
        </div>
    </div>

    <script>
        let searchResults = [];
        let currentPage = 1;
        let itemsPerPage = 30;
        let sortColumn = 'daily_view_count';
        let sortDirection = 'desc';

        // 검색 폼 제출 이벤트
        document.getElementById('searchForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            await performSearch();
        });



        // 검색 범위 드롭다운 기능
        document.getElementById('searchScopeDisplay').addEventListener('click', () => {
            const dropdown = document.getElementById('searchScopeDropdown');
            dropdown.classList.toggle('show');
        });

        // 모든 검색 범위 선택/해제
        document.getElementById('selectAllSearchScope').addEventListener('change', (e) => {
            const isChecked = e.target.checked;
            const searchScopeCheckboxes = document.querySelectorAll('input[name="searchScope"]');
            
            searchScopeCheckboxes.forEach(checkbox => {
                checkbox.checked = isChecked;
            });
            
            updateSearchScopeDisplay();
        });

        // 개별 검색 범위 체크박스 이벤트
        document.querySelectorAll('input[name="searchScope"]').forEach(checkbox => {
            checkbox.addEventListener('change', () => {
                updateSelectAllSearchScope();
                updateSearchScopeDisplay();
            });
        });

        // 검색 범위 디스플레이 업데이트 함수
        function updateSearchScopeDisplay() {
            const searchScopeCheckboxes = document.querySelectorAll('input[name="searchScope"]:checked');
            const display = document.getElementById('searchScopeDisplay');
            
            if (searchScopeCheckboxes.length === 0) {
                display.textContent = '검색 범위를 선택해주세요';
            } else if (searchScopeCheckboxes.length === document.querySelectorAll('input[name="searchScope"]').length) {
                display.textContent = '모든 범위 선택됨';
            } else {
                const selectedNames = Array.from(searchScopeCheckboxes).map(cb => {
                    const label = cb.parentElement.querySelector('label');
                    return label.textContent;
                });
                display.textContent = selectedNames.join(', ') + ' 선택됨';
            }
        }

        // 모든 검색 범위 체크박스 상태 업데이트
        function updateSelectAllSearchScope() {
            const searchScopeCheckboxes = document.querySelectorAll('input[name="searchScope"]');
            const checkedSearchScope = document.querySelectorAll('input[name="searchScope"]:checked');
            const selectAllCheckbox = document.getElementById('selectAllSearchScope');
            
            if (checkedSearchScope.length === 0) {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = false;
            } else if (checkedSearchScope.length === searchScopeCheckboxes.length) {
                selectAllCheckbox.checked = true;
                selectAllCheckbox.indeterminate = false;
            } else {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = true;
            }
        }

        // 카테고리 드롭다운 기능
        document.getElementById('categoryDisplay').addEventListener('click', () => {
            const dropdown = document.getElementById('categoryDropdown');
            dropdown.classList.toggle('show');
        });

        // 문서 클릭 시 드롭다운 닫기
        document.addEventListener('click', (e) => {
            // 검색 범위 드롭다운 처리
            const searchScopeSelector = document.querySelector('.category-selector');
            const searchScopeDropdown = document.getElementById('searchScopeDropdown');
            
            if (searchScopeSelector && !searchScopeSelector.contains(e.target)) {
                searchScopeDropdown.classList.remove('show');
            }
            
            // 카테고리 드롭다운 처리 (두 번째 category-selector)
            const allCategorySelectors = document.querySelectorAll('.category-selector');
            if (allCategorySelectors.length > 1) {
                const categorySelector = allCategorySelectors[1];
                const categoryDropdown = document.getElementById('categoryDropdown');
                
                if (!categorySelector.contains(e.target)) {
                    categoryDropdown.classList.remove('show');
                }
            }
        });

        // 모든 카테고리 선택/해제
        document.getElementById('selectAllCategories').addEventListener('change', (e) => {
            const isChecked = e.target.checked;
            const categoryCheckboxes = document.querySelectorAll('input[name="categories"]');
            
            categoryCheckboxes.forEach(checkbox => {
                checkbox.checked = isChecked;
            });
            
            updateCategoryDisplay();
        });

        // 개별 카테고리 체크박스 이벤트
        document.querySelectorAll('input[name="categories"]').forEach(checkbox => {
            checkbox.addEventListener('change', () => {
                updateSelectAllCategories();
                updateCategoryDisplay();
            });
        });

        // 카테고리 디스플레이 업데이트 함수
        function updateCategoryDisplay() {
            const categoryCheckboxes = document.querySelectorAll('input[name="categories"]:checked');
            const display = document.getElementById('categoryDisplay');
            
            if (categoryCheckboxes.length === 0) {
                display.textContent = '카테고리를 선택해주세요';
            } else if (categoryCheckboxes.length === document.querySelectorAll('input[name="categories"]').length) {
                display.textContent = '모든 카테고리 선택됨';
            } else if (categoryCheckboxes.length <= 3) {
                const selectedNames = Array.from(categoryCheckboxes).map(cb => {
                    const label = cb.parentElement.querySelector('label');
                    return label.textContent;
                });
                display.textContent = selectedNames.join(', ');
            } else {
                display.textContent = `${categoryCheckboxes.length}개 카테고리 선택됨`;
            }
        }

        // 모든 카테고리 체크박스 상태 업데이트
        function updateSelectAllCategories() {
            const categoryCheckboxes = document.querySelectorAll('input[name="categories"]');
            const checkedCategories = document.querySelectorAll('input[name="categories"]:checked');
            const selectAllCheckbox = document.getElementById('selectAllCategories');
            
            if (checkedCategories.length === 0) {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = false;
            } else if (checkedCategories.length === categoryCheckboxes.length) {
                selectAllCheckbox.checked = true;
                selectAllCheckbox.indeterminate = false;
            } else {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = true;
            }
        }

        // 썸네일 다운로드 함수 (파일명 안전화 처리)
        async function downloadThumbnail(url, channelName) {
            try {
                console.log('📥 썸네일 다운로드 시작:', { url, channelName });
                
                // 채널명을 안전한 파일명으로 변환 (서버 측과 동일한 로직)
                let safeChannelName = channelName || 'channel';
                
                // 특수문자 및 유니코드 문자 처리
                safeChannelName = safeChannelName
                    .normalize('NFD')                          // 유니코드 정규화
                    .replace(/[\u0300-\u036f]/g, '')          // 발음 기호 제거
                    .replace(/[^\x00-\x7F]/g, '')             // ASCII가 아닌 문자 제거 (한글, 이모지 등)
                    .replace(/[<>:"/\\|?*\x00-\x1f]/g, '_')   // 파일명에 사용 불가한 문자들 제거
                    .replace(/["'`]/g, '')                    // 따옴표 제거
                    .replace(/\s+/g, '_')                     // 공백을 언더스코어로 변경
                    .replace(/_{2,}/g, '_')                   // 연속된 언더스코어를 하나로 변경
                    .replace(/^_+|_+$/g, '')                  // 앞뒤 언더스코어 제거
                    .substring(0, 50);                       // 파일명 길이 제한 (클라이언트에서는 더 짧게)
                
                // 파일명이 비어있으면 기본값 설정
                if (!safeChannelName || safeChannelName.length === 0) {
                    safeChannelName = 'channel';
                }
                
                // 현재 날짜시간을 파일명에 추가 (중복 방지)
                const now = new Date();
                const year = now.getFullYear().toString().slice(-2); // 뒤 2자리만 (25)
                const month = (now.getMonth() + 1).toString().padStart(2, '0');
                const day = now.getDate().toString().padStart(2, '0');
                const hour = now.getHours().toString().padStart(2, '0');
                const minute = now.getMinutes().toString().padStart(2, '0');
                const second = now.getSeconds().toString().padStart(2, '0');
                const millisecond = now.getMilliseconds().toString().padStart(3, '0');
                
                const timestamp = `${year}${month}${day}${hour}${minute}${second}${millisecond}`;
                const filename = `${safeChannelName}_${timestamp}.jpg`;
                
                console.log('🔧 파일명 변환:', { 
                    original: channelName, 
                    safe: safeChannelName, 
                    final: filename 
                });
                
                // 최신 브라우저에서 File System Access API 지원 확인
                if ('showSaveFilePicker' in window) {
                    // File System Access API 사용 (Chrome 86+, Edge 86+)
                    await downloadWithFilePicker(url, filename);
                } else if ('showDirectoryPicker' in window) {
                    // Directory Picker API 사용 (대체 방법)
                    await downloadWithDirectoryPicker(url, filename, channelName);
                } else {
                    // 기존 방식 (자동 다운로드) - 브라우저 호환성을 위한 fallback
                    await downloadWithTraditionalMethod(url, filename);
                }
                
            } catch (error) {
                console.error('다운로드 오류:', error);
                
                // 구체적인 오류 메시지 제공
                if (error.message.includes('Content-Disposition') || 
                    error.message.includes('ERR_INVALID_CHAR') ||
                    error.message.includes('Invalid character in header')) {
                    alert(`❌ 파일명 오류: 채널명에 특수문자가 포함되어 다운로드에 실패했습니다.\n\n원인: "${channelName}"에 HTTP 헤더에서 허용되지 않는 문자가 포함되어 있습니다.\n해결: 파일명이 자동으로 안전한 형태로 변환되었지만 서버에서 처리하지 못했습니다.\n\n다시 시도해 주세요.`);
                } else if (error.name === 'AbortError') {
                    console.log('사용자가 다운로드를 취소했습니다.');
                } else {
                    alert(`❌ 썸네일 다운로드에 실패했습니다.\n\n오류: ${error.message}\n\n가능한 원인:\n- 네트워크 연결 문제\n- 썸네일 이미지 서버 접근 불가\n- 파일명 처리 오류\n\n잠시 후 다시 시도해 주세요.`);
                }
            }
        }

        // File System Access API를 사용한 파일 저장 (개선된 버전)
        async function downloadWithFilePicker(url, filename) {
            try {
                // 파일 저장 위치 선택 다이얼로그 표시
                const fileHandle = await window.showSaveFilePicker({
                    suggestedName: filename,
                    types: [{
                        description: '이미지 파일',
                        accept: {
                            'image/jpeg': ['.jpg', '.jpeg'],
                            'image/png': ['.png'],
                            'image/webp': ['.webp']
                        }
                    }]
                });

                // URL 인코딩을 안전하게 처리
                const encodedUrl = encodeURIComponent(url);
                const encodedFilename = encodeURIComponent(filename);
                
                console.log('🔄 서버 요청:', {
                    url: `/api/download-thumbnail?url=${encodedUrl}&filename=${encodedFilename}`,
                    originalUrl: url,
                    originalFilename: filename
                });
                
                const response = await fetch(`/api/download-thumbnail?url=${encodedUrl}&filename=${encodedFilename}`);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    let errorData;
                    try {
                        errorData = JSON.parse(errorText);
                    } catch {
                        errorData = { error: errorText };
                    }
                    throw new Error(`서버 오류 (${response.status}): ${errorData.error || 'Unknown error'}`);
                }
                
                const blob = await response.blob();
                
                // 선택한 위치에 파일 저장
                const writable = await fileHandle.createWritable();
                await writable.write(blob);
                await writable.close();
                
                console.log(`✅ 썸네일 저장 완료: ${filename}`);
                alert(`✅ 썸네일이 선택한 위치에 저장되었습니다!\n\n파일명: ${filename}\n크기: ${(blob.size / 1024).toFixed(1)} KB`);
                
            } catch (error) {
                if (error.name === 'AbortError') {
                    console.log('사용자가 저장을 취소했습니다.');
                } else {
                    console.error('File System Access API 다운로드 오류:', error);
                    throw error;
                }
            }
        }

        // Directory Picker API를 사용한 폴더 선택 저장
        async function downloadWithDirectoryPicker(url, filename, channelName) {
            try {
                // 폴더 선택 다이얼로그 표시
                const dirHandle = await window.showDirectoryPicker();
                
                // 썸네일 이미지 다운로드
                const response = await fetch(`/api/download-thumbnail?url=${encodeURIComponent(url)}&filename=${encodeURIComponent(filename)}`);
                
                // 서버에서 전송한 로그를 콘솔에 출력
                const downloadLog = response.headers.get('X-Download-Log');
                if (downloadLog) {
                    try {
                        const logData = JSON.parse(downloadLog);
                        console.log(`📥 썸네일 다운로드 로그: ${logData.message}`);
                        
                        // 오류가 있는 경우 상세 정보 출력
                        if (logData.step === 'error') {
                            console.error(`❌ 썸네일 다운로드 실패: ${logData.error}`);
                            console.error(`📋 상세 정보: ${logData.details}`);
                            console.error(`🔗 URL: ${logData.url}`);
                        }
                    } catch (parseError) {
                        console.log('📥 썸네일 다운로드 로그 파싱 실패:', parseError);
                    }
                }
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`HTTP error! status: ${response.status}, message: ${errorData.error || 'Unknown error'}`);
                }
                
                const blob = await response.blob();
                
                // 선택한 폴더에 파일 생성 및 저장
                const fileHandle = await dirHandle.getFileHandle(filename, { create: true });
                const writable = await fileHandle.createWritable();
                await writable.write(blob);
                await writable.close();
                
                alert(`✅ 썸네일이 선택한 폴더에 저장되었습니다!\n파일명: ${filename}`);
            } catch (error) {
                if (error.name === 'AbortError') {
                    console.log('사용자가 폴더 선택을 취소했습니다.');
                } else {
                    throw error;
                }
            }
        }

        // 기존 방식 다운로드 (개선된 버전)
        async function downloadWithTraditionalMethod(url, filename) {
            try {
                // URL 인코딩을 안전하게 처리
                const encodedUrl = encodeURIComponent(url);
                const encodedFilename = encodeURIComponent(filename);
                
                console.log('🔄 기존 방식 다운로드:', { filename, encodedFilename });
                
                // 먼저 서버에서 파일을 가져와서 오류가 있는지 확인
                const testResponse = await fetch(`/api/download-thumbnail?url=${encodedUrl}&filename=${encodedFilename}`);
                
                if (!testResponse.ok) {
                    const errorText = await testResponse.text();
                    let errorData;
                    try {
                        errorData = JSON.parse(errorText);
                    } catch {
                        errorData = { error: errorText };
                    }
                    throw new Error(`서버 오류 (${testResponse.status}): ${errorData.error || 'Unknown error'}`);
                }
                
                // 성공한 경우 다운로드 링크 생성
                const downloadUrl = `/api/download-thumbnail?url=${encodedUrl}&filename=${encodedFilename}`;
                
                const link = document.createElement('a');
                link.href = downloadUrl;
                link.download = filename;
                link.style.display = 'none';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                console.log(`✅ 기존 방식 다운로드 완료: ${filename}`);
                alert(`📁 기본 다운로드 폴더에 저장됩니다.\n\n파일명: ${filename}\n위치: 브라우저 기본 다운로드 폴더\n(브라우저가 폴더 선택 기능을 지원하지 않습니다)`);
                
            } catch (error) {
                console.error('기존 방식 다운로드 오류:', error);
                throw error;
            }
        }

        // 페이지당 아이템 수 변경 이벤트
        document.getElementById('itemsPerPage').addEventListener('change', (e) => {
            itemsPerPage = parseInt(e.target.value);
            currentPage = 1;
            renderResults();
        });

        // Excel 다운로드 버튼 이벤트
        document.getElementById('downloadExcelBtn').addEventListener('click', async () => {
            await downloadExcel();
        });

        // 동영상 길이 "모두 선택" 체크박스 이벤트
        document.getElementById('selectAllVideoLength').addEventListener('change', (e) => {
            const isChecked = e.target.checked;
            const videoLengthCheckboxes = [
                'shortForm1', 'shortForm2', 'midForm1', 'midForm2', 
                'longForm1', 'longForm2', 'longForm3', 'longForm4', 'longForm5', 'longForm6'
            ];
            
            videoLengthCheckboxes.forEach(id => {
                const checkbox = document.getElementById(id);
                if (checkbox) {
                    checkbox.checked = isChecked;
                }
            });
            
            // 그룹 선택 체크박스 상태도 업데이트
            updateGroupCheckboxes();
        });

        // 동영상 길이 "맨 앞 두 개만" 체크박스 이벤트
        document.getElementById('selectFirst2VideoLength').addEventListener('change', (e) => {
            const isChecked = e.target.checked;
            const first2Checkboxes = ['shortForm1', 'shortForm2'];
            
            first2Checkboxes.forEach(id => {
                const checkbox = document.getElementById(id);
                if (checkbox) {
                    checkbox.checked = isChecked;
                }
            });
            
            updateSelectAllVideoLength();
            updateGroupCheckboxes();
        });

        // 동영상 길이 "그 뒤 세 개만" 체크박스 이벤트
        document.getElementById('selectNext3VideoLength').addEventListener('change', (e) => {
            const isChecked = e.target.checked;
            const next3Checkboxes = ['midForm1', 'midForm2', 'longForm1'];
            
            next3Checkboxes.forEach(id => {
                const checkbox = document.getElementById(id);
                if (checkbox) {
                    checkbox.checked = isChecked;
                }
            });
            
            updateSelectAllVideoLength();
            updateGroupCheckboxes();
        });

        // 동영상 길이 "위 5개 선택" 체크박스 이벤트
        document.getElementById('selectTop5VideoLength').addEventListener('change', (e) => {
            const isChecked = e.target.checked;
            const top5Checkboxes = ['shortForm1', 'shortForm2', 'midForm1', 'midForm2', 'longForm1'];
            
            top5Checkboxes.forEach(id => {
                const checkbox = document.getElementById(id);
                if (checkbox) {
                    checkbox.checked = isChecked;
                }
            });
            
            updateSelectAllVideoLength();
            updateGroupCheckboxes();
        });

        // 동영상 길이 "밑 5개 선택" 체크박스 이벤트
        document.getElementById('selectBottom5VideoLength').addEventListener('change', (e) => {
            const isChecked = e.target.checked;
            const bottom5Checkboxes = ['longForm2', 'longForm3', 'longForm4', 'longForm5', 'longForm6'];
            
            bottom5Checkboxes.forEach(id => {
                const checkbox = document.getElementById(id);
                if (checkbox) {
                    checkbox.checked = isChecked;
                }
            });
            
            updateSelectAllVideoLength();
            updateGroupCheckboxes();
        });

        // 개별 동영상 길이 체크박스 변경 시 "모두 선택" 상태 업데이트
        function updateSelectAllVideoLength() {
            const videoLengthCheckboxes = [
                'shortForm1', 'shortForm2', 'midForm1', 'midForm2', 
                'longForm1', 'longForm2', 'longForm3', 'longForm4', 'longForm5', 'longForm6'
            ];
            
            const checkedCount = videoLengthCheckboxes.filter(id => {
                const checkbox = document.getElementById(id);
                return checkbox && checkbox.checked;
            }).length;
            
            const selectAllCheckbox = document.getElementById('selectAllVideoLength');
            if (checkedCount === 0) {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = false;
            } else if (checkedCount === videoLengthCheckboxes.length) {
                selectAllCheckbox.checked = true;
                selectAllCheckbox.indeterminate = false;
            } else {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = true;
            }
        }

        // 그룹 체크박스 상태 업데이트
        function updateGroupCheckboxes() {
            const first2Checkboxes = ['shortForm1', 'shortForm2'];
            const next3Checkboxes = ['midForm1', 'midForm2', 'longForm1'];
            const top5Checkboxes = ['shortForm1', 'shortForm2', 'midForm1', 'midForm2', 'longForm1'];
            const bottom5Checkboxes = ['longForm2', 'longForm3', 'longForm4', 'longForm5', 'longForm6'];
            
            // 맨 앞 두 개 체크박스 상태 확인
            const first2CheckedCount = first2Checkboxes.filter(id => {
                const checkbox = document.getElementById(id);
                return checkbox && checkbox.checked;
            }).length;
            
            const selectFirst2Checkbox = document.getElementById('selectFirst2VideoLength');
            if (first2CheckedCount === 0) {
                selectFirst2Checkbox.checked = false;
                selectFirst2Checkbox.indeterminate = false;
            } else if (first2CheckedCount === first2Checkboxes.length) {
                selectFirst2Checkbox.checked = true;
                selectFirst2Checkbox.indeterminate = false;
            } else {
                selectFirst2Checkbox.checked = false;
                selectFirst2Checkbox.indeterminate = true;
            }
            
            // 그 뒤 세 개 체크박스 상태 확인
            const next3CheckedCount = next3Checkboxes.filter(id => {
                const checkbox = document.getElementById(id);
                return checkbox && checkbox.checked;
            }).length;
            
            const selectNext3Checkbox = document.getElementById('selectNext3VideoLength');
            if (next3CheckedCount === 0) {
                selectNext3Checkbox.checked = false;
                selectNext3Checkbox.indeterminate = false;
            } else if (next3CheckedCount === next3Checkboxes.length) {
                selectNext3Checkbox.checked = true;
                selectNext3Checkbox.indeterminate = false;
            } else {
                selectNext3Checkbox.checked = false;
                selectNext3Checkbox.indeterminate = true;
            }
            
            // 위 5개 체크박스 상태 확인
            const top5CheckedCount = top5Checkboxes.filter(id => {
                const checkbox = document.getElementById(id);
                return checkbox && checkbox.checked;
            }).length;
            
            const selectTop5Checkbox = document.getElementById('selectTop5VideoLength');
            if (top5CheckedCount === 0) {
                selectTop5Checkbox.checked = false;
                selectTop5Checkbox.indeterminate = false;
            } else if (top5CheckedCount === top5Checkboxes.length) {
                selectTop5Checkbox.checked = true;
                selectTop5Checkbox.indeterminate = false;
            } else {
                selectTop5Checkbox.checked = false;
                selectTop5Checkbox.indeterminate = true;
            }
            
            // 밑 5개 체크박스 상태 확인
            const bottom5CheckedCount = bottom5Checkboxes.filter(id => {
                const checkbox = document.getElementById(id);
                return checkbox && checkbox.checked;
            }).length;
            
            const selectBottom5Checkbox = document.getElementById('selectBottom5VideoLength');
            if (bottom5CheckedCount === 0) {
                selectBottom5Checkbox.checked = false;
                selectBottom5Checkbox.indeterminate = false;
            } else if (bottom5CheckedCount === bottom5Checkboxes.length) {
                selectBottom5Checkbox.checked = true;
                selectBottom5Checkbox.indeterminate = false;
            } else {
                selectBottom5Checkbox.checked = false;
                selectBottom5Checkbox.indeterminate = true;
            }
        }



        // 검색 수행 함수
        async function performSearch() {
            const formData = new FormData(document.getElementById('searchForm'));
            const searchParams = new URLSearchParams();

            // 폼 데이터 처리
            for (let [key, value] of formData.entries()) {
                if (key === 'videoLength') {
                    // 체크박스 처리는 별도로
                    continue;
                }
                if (value) {
                    searchParams.append(key, value);
                }
            }

            // 날짜 범위 처리
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            // 날짜 유효성 검증
            let validStartDate = null;
            let validEndDate = null;
            
            if (startDate) {
                try {
                    const testDate = new Date(startDate);
                    if (!isNaN(testDate.getTime()) && startDate.match(/^\d{4}-\d{2}-\d{2}$/)) {
                        validStartDate = startDate;
                        searchParams.append('startDate', startDate);
                        console.log('✅ 클라이언트: 시작일 유효성 검증 통과:', startDate);
                    } else {
                        console.warn('⚠️ 클라이언트: 시작일 형식이 올바르지 않음:', startDate);
                    }
                } catch (error) {
                    console.error('❌ 클라이언트: 시작일 검증 오류:', error.message);
                }
            }
            
            if (endDate) {
                try {
                    const testDate = new Date(endDate);
                    if (!isNaN(testDate.getTime()) && endDate.match(/^\d{4}-\d{2}-\d{2}$/)) {
                        validEndDate = endDate;
                        searchParams.append('endDate', endDate);
                        console.log('✅ 클라이언트: 종료일 유효성 검증 통과:', endDate);
                    } else {
                        console.warn('⚠️ 클라이언트: 종료일 형식이 올바르지 않음:', endDate);
                    }
                } catch (error) {
                    console.error('❌ 클라이언트: 종료일 검증 오류:', error.message);
                }
            }
            
            // 날짜 순서 검증
            if (validStartDate && validEndDate) {
                const start = new Date(validStartDate);
                const end = new Date(validEndDate);
                if (start > end) {
                    console.warn('⚠️ 시작일이 종료일보다 늦습니다. 날짜를 확인해주세요.');
                    alert('시작일이 종료일보다 늦습니다. 날짜를 확인해주세요.');
                    return;
                }
            }
            
            console.log('📅 날짜 범위 디버그:', {
                원본_startDate: startDate || '없음',
                원본_endDate: endDate || '없음',
                유효한_startDate: validStartDate || '없음',
                유효한_endDate: validEndDate || '없음',
                hasDateRange: !!(validStartDate || validEndDate)
            });

            // 비디오 길이 체크박스 처리
            const shortForm1 = document.getElementById('shortForm1').checked;
            const shortForm2 = document.getElementById('shortForm2').checked;
            const midForm1 = document.getElementById('midForm1').checked;
            const midForm2 = document.getElementById('midForm2').checked;
            const longForm1 = document.getElementById('longForm1').checked;
            const longForm2 = document.getElementById('longForm2').checked;
            const longForm3 = document.getElementById('longForm3').checked;
            const longForm4 = document.getElementById('longForm4').checked;
            const longForm5 = document.getElementById('longForm5').checked;
            const longForm6 = document.getElementById('longForm6').checked;
            
            const selectedLengths = [];
            if (shortForm1) selectedLengths.push('short1');
            if (shortForm2) selectedLengths.push('short2');
            if (midForm1) selectedLengths.push('mid1');
            if (midForm2) selectedLengths.push('mid2');
            if (longForm1) selectedLengths.push('long1');
            if (longForm2) selectedLengths.push('long2');
            if (longForm3) selectedLengths.push('long3');
            if (longForm4) selectedLengths.push('long4');
            if (longForm5) selectedLengths.push('long5');
            if (longForm6) selectedLengths.push('long6');
            
            // 동영상 길이 파라미터 (빈 배열이어도 전송)
            console.log('🎬 동영상 길이 디버그:', {
                selectedLengths: selectedLengths,
                lengthCount: selectedLengths.length,
                joinedString: selectedLengths.join(','),
                willSend: selectedLengths.join(',') || '빈 문자열'
            });
            searchParams.append('videoLength', selectedLengths.join(','));

            // 카테고리 체크박스 처리
            const selectedCategories = [];
            document.querySelectorAll('input[name="categories"]:checked').forEach(checkbox => {
                selectedCategories.push(checkbox.value);
            });
            
            console.log('📚 카테고리 디버그:', {
                selectedCategories: selectedCategories,
                categoryCount: selectedCategories.length,
                joinedString: selectedCategories.join(','),
                willSend: selectedCategories.join(',') || '빈 문자열'
            });
            searchParams.append('categories', selectedCategories.join(','));

            // 키워드 확인 및 안내 메시지
            const keyword = document.getElementById('keyword').value;
            const country = document.getElementById('country').value;
            const isEmptyKeyword = !keyword || !keyword.trim();
            
            console.log('=== 클라이언트 검색 요청 디버그 ===');
            console.log('🏳️ 선택된 국가:', country);
            console.log('🔍 입력된 키워드:', keyword || '없음');
            console.log('📋 검색 파라미터:', searchParams.toString());
            console.log('🌍 검색 범위:', country === 'worldwide' ? '전세계' : `${country} 국가별`);
            console.log('===========================');
            
            if (isEmptyKeyword) {
                console.log('키워드 없음: 국가별 인기 동영상 검색 모드');
                if (country === 'worldwide') {
                    showInfo('🔥 키워드가 없어서 전세계 조회수가 높은 인기 동영상들을 검색합니다.');
                } else {
                    showInfo(`🔥 키워드가 없어서 ${country} 국가의 인기 동영상들을 검색합니다.`);
                }
            } else {
                console.log(`키워드 검색: "${keyword.trim()}"`);
            }

            // UI 상태 업데이트
            showLoading();
            hideError();
            hideResults();

            try {
                const response = await fetch(`/api/search?${searchParams.toString()}`);
                const data = await response.json();

                hideLoading();

                                 if (data.success) {
                     searchResults = data.data;
                     currentPage = 1;
                     
                     // 검색 시마다 정렬을 조회수 내림차순으로 초기화
                     sortColumn = 'daily_view_count';
                     sortDirection = 'desc';
                     
                     sortResults();
                     renderResults();
                     showResults();
                     
                     // 중복 제거 정보 표시 (콘솔에만)
                     console.log(`✅ 검색 완료: ${searchResults.length}개 고유 결과`);
                 } else {
                    // 오류 타입별 처리
                    if (data.errorType === 'quota_exceeded') {
                        showError(`
                            <div style="text-align: center;">
                                <h3>🚫 YouTube API 할당량 초과</h3>
                                <p><strong>${data.error}</strong></p>
                                <div style="margin: 15px 0; padding: 10px; background: #f8f9fa; border-radius: 8px; font-size: 0.9em;">
                                    ${data.details}
                                </div>
                                <div style="margin-top: 15px;">
                                    <p><strong>해결 방법:</strong></p>
                                    <ul style="text-align: left; display: inline-block;">
                                        <li>내일 다시 시도해주세요 (할당량 자동 재설정)</li>
                                        <li>관리자에게 API 키 추가 요청</li>
                                        <li>검색 범위를 줄여서 재시도</li>
                                    </ul>
                                </div>
                            </div>
                        `);
                    } else if (data.errorType === 'invalid_api_key') {
                        showError(`
                            <div style="text-align: center;">
                                <h3>🔑 API 키 오류</h3>
                                <p><strong>${data.error}</strong></p>
                                <div style="margin-top: 15px;">
                                    <p>관리자가 .env 파일의 YOUTUBE_API_KEY를 확인해야 합니다.</p>
                                </div>
                            </div>
                        `);
                    } else {
                        showError(data.error || '검색 중 오류가 발생했습니다.');
                    }
                }
            } catch (error) {
                hideLoading();
                showError('서버 연결에 실패했습니다. 잠시 후 다시 시도해주세요.');
                console.error('검색 오류:', error);
            }
        }

        // 정렬 함수
        function sortResults() {
            searchResults.sort((a, b) => {
                let aVal = a[sortColumn];
                let bVal = b[sortColumn];

                // 숫자 값 처리
                if (sortColumn === 'daily_view_count' || sortColumn === 'subscriber_count') {
                    aVal = parseInt(aVal) || 0;
                    bVal = parseInt(bVal) || 0;
                }

                // 동영상 시간 처리
                if (sortColumn === 'duration') {
                    aVal = parseInt(a.duration_seconds) || 0;
                    bVal = parseInt(b.duration_seconds) || 0;
                }

                // 날짜 값 처리
                if (sortColumn === 'status_date') {
                    aVal = new Date(aVal);
                    bVal = new Date(bVal);
                }

                // 문자열 값 처리
                if (typeof aVal === 'string') {
                    aVal = aVal.toLowerCase();
                    bVal = bVal.toLowerCase();
                }

                if (sortDirection === 'asc') {
                    return aVal > bVal ? 1 : aVal < bVal ? -1 : 0;
                } else {
                    return aVal < bVal ? 1 : aVal > bVal ? -1 : 0;
                }
            });
        }

        // 결과 렌더링 함수
        function renderResults() {
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageResults = searchResults.slice(startIndex, endIndex);

            const tbody = document.getElementById('resultsTableBody');
            tbody.innerHTML = '';

            if (pageResults.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="10" class="no-results">
                            <h3>검색 결과가 없습니다</h3>
                            <p>다른 검색 조건으로 시도해보세요.</p>
                        </td>
                    </tr>
                `;
                return;
            }

            pageResults.forEach(result => {
                const row = document.createElement('tr');
                
                const uploadDateObj = new Date(result.status_date);
                const year = uploadDateObj.getFullYear();
                const monthDay = uploadDateObj.toLocaleDateString('ko-KR', { month: '2-digit', day: '2-digit' });
                const viewCount = formatViewCount(result.daily_view_count);
                const subscriberCount = formatSubscriberCount(result.subscriber_count || 0);
                const formattedDuration = formatDuration(result.duration_seconds);
                
                row.innerHTML = `
                    <td>
                        <img src="${result.thumbnail_url}" alt="썸네일" class="thumbnail">
                    </td>
                    <td>
                        <a href="https://www.youtube.com/channel/${result.youtube_channel_id}" target="_blank" class="channel-link" title="${result.youtube_channel_name} 채널 홈으로 이동">
                            <div class="channel-name">
                                ${result.youtube_channel_name}
                            </div>
                        </a>
                    </td>
                    <td>
                        <div class="video-title" title="${result.title}">
                            ${result.title}
                        </div>
                    </td>
                    <td>${result.primary_category}</td>
                    <td>
                        <div class="upload-date">
                            <div class="year">${year}</div>
                            <div class="month-day">${monthDay}</div>
                        </div>
                    </td>
                    <td>
                        <span class="view-count">${viewCount}</span>
                    </td>
                    <td>
                        <span class="subscriber-count">${subscriberCount}</span>
                    </td>
                    <td>
                        <a href="javascript:void(0)" onclick="openVideoWithCopy('${result.vod_url}')" class="video-link" title="동영상 열기 + URL 복사">
                            ▶️
                        </a>
                    </td>
                    <td>
                        <span class="duration-time" title="${result.duration_seconds}초">${formattedDuration}</span>
                    </td>
                    <td>
                        <button class="download-btn" onclick="downloadThumbnail('${result.thumbnail_url}', '${result.youtube_channel_name}')" title="클릭하면 저장 위치를 선택할 수 있습니다">
                            ⬇️ 
                        </button>
                    </td>
                `;
                
                tbody.appendChild(row);
            });

            // 결과 수 업데이트
            document.getElementById('resultsCount').textContent = searchResults.length;

            // 페이지네이션 렌더링
            renderPagination();

            // 정렬 헤더 업데이트
            updateSortHeaders();
        }

        // 페이지네이션 렌더링 함수
        function renderPagination() {
            const totalPages = Math.ceil(searchResults.length / itemsPerPage);
            const pagination = document.getElementById('pagination');
            pagination.innerHTML = '';

            if (totalPages <= 1) return;

            // 이전 페이지 버튼
            const prevBtn = document.createElement('button');
            prevBtn.textContent = '이전';
            prevBtn.disabled = currentPage === 1;
            prevBtn.onclick = () => changePage(currentPage - 1);
            pagination.appendChild(prevBtn);

            // 페이지 번호 버튼들
            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, currentPage + 2);

            if (startPage > 1) {
                const btn = document.createElement('button');
                btn.textContent = '1';
                btn.onclick = () => changePage(1);
                pagination.appendChild(btn);

                if (startPage > 2) {
                    const dots = document.createElement('span');
                    dots.textContent = '...';
                    pagination.appendChild(dots);
                }
            }

            for (let i = startPage; i <= endPage; i++) {
                const btn = document.createElement('button');
                btn.textContent = i;
                btn.className = i === currentPage ? 'active' : '';
                btn.onclick = () => changePage(i);
                pagination.appendChild(btn);
            }

            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    const dots = document.createElement('span');
                    dots.textContent = '...';
                    pagination.appendChild(dots);
                }

                const btn = document.createElement('button');
                btn.textContent = totalPages;
                btn.onclick = () => changePage(totalPages);
                pagination.appendChild(btn);
            }

            // 다음 페이지 버튼
            const nextBtn = document.createElement('button');
            nextBtn.textContent = '다음';
            nextBtn.disabled = currentPage === totalPages;
            nextBtn.onclick = () => changePage(currentPage + 1);
            pagination.appendChild(nextBtn);

            // 페이지 정보
            const pageInfo = document.createElement('div');
            pageInfo.className = 'page-info';
            pageInfo.textContent = `${currentPage} / ${totalPages} 페이지`;
            pagination.appendChild(pageInfo);
        }

        // 페이지 변경 함수
        function changePage(newPage) {
            const totalPages = Math.ceil(searchResults.length / itemsPerPage);
            if (newPage >= 1 && newPage <= totalPages) {
                currentPage = newPage;
                renderResults();
            }
        }

        // 정렬 헤더 업데이트 함수
        function updateSortHeaders() {
            document.querySelectorAll('.results-table th').forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
                if (th.dataset.sort === sortColumn) {
                    th.classList.add(sortDirection === 'asc' ? 'sort-asc' : 'sort-desc');
                }
            });
        }

        // 테이블 헤더 클릭 이벤트 (정렬)
        document.querySelectorAll('.results-table th.sortable').forEach(th => {
            th.addEventListener('click', () => {
                const column = th.dataset.sort;
                if (sortColumn === column) {
                    sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
                } else {
                    sortColumn = column;
                    sortDirection = 'desc';
                }
                sortResults();
                renderResults();
            });
        });



        // UI 상태 관리 함수들
        function showLoading() {
            document.getElementById('loadingIndicator').style.display = 'block';
        }

        function hideLoading() {
            document.getElementById('loadingIndicator').style.display = 'none';
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.innerHTML = message; // innerHTML로 변경하여 HTML 태그 지원
            errorDiv.style.display = 'block';
        }

        function hideError() {
            document.getElementById('errorMessage').style.display = 'none';
        }

        function showInfo(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.innerHTML = `<div style="background: #e3f2fd; color: #0277bd; border: 1px solid #81d4fa; border-radius: 8px; padding: 15px; margin: 10px 0;">${message}</div>`;
            errorDiv.style.display = 'block';
            
            // 3초 후 자동으로 숨김
            setTimeout(() => {
                hideError();
            }, 3000);
        }

        function showResults() {
            document.getElementById('resultsContainer').style.display = 'block';
            // Excel 다운로드 버튼 표시
            document.getElementById('downloadExcelBtn').style.display = 'flex';
        }

        function hideResults() {
            document.getElementById('resultsContainer').style.display = 'none';
            // Excel 다운로드 버튼 숨김
            document.getElementById('downloadExcelBtn').style.display = 'none';
        }

        // Excel 다운로드 함수
        async function downloadExcel() {
            if (!searchResults || searchResults.length === 0) {
                alert('다운로드할 검색 결과가 없습니다.');
                return;
            }

            try {
                const downloadBtn = document.getElementById('downloadExcelBtn');
                const originalText = downloadBtn.textContent;
                
                // 버튼 상태 변경
                downloadBtn.disabled = true;
                downloadBtn.textContent = '📊 ~';

                // 현재 검색 조건 수집
                const rawStartDate = document.getElementById('startDate').value;
                const rawEndDate = document.getElementById('endDate').value;
                
                // 날짜 유효성 검증
                let validStartDate = null;
                let validEndDate = null;
                
                if (rawStartDate) {
                    try {
                        const testDate = new Date(rawStartDate);
                        if (!isNaN(testDate.getTime()) && rawStartDate.match(/^\d{4}-\d{2}-\d{2}$/)) {
                            validStartDate = rawStartDate;
                        }
                    } catch (error) {
                        console.error('Excel: 시작일 검증 오류:', error.message);
                    }
                }
                
                if (rawEndDate) {
                    try {
                        const testDate = new Date(rawEndDate);
                        if (!isNaN(testDate.getTime()) && rawEndDate.match(/^\d{4}-\d{2}-\d{2}$/)) {
                            validEndDate = rawEndDate;
                        }
                    } catch (error) {
                        console.error('Excel: 종료일 검증 오류:', error.message);
                    }
                }
                
                const searchParams = {
                    keyword: document.getElementById('keyword').value || '전체',
                    country: document.getElementById('country').value || 'worldwide',
                    minViews: document.getElementById('minViews').value,
                    maxViews: document.getElementById('maxViews').value,
                    uploadPeriod: document.getElementById('uploadPeriod').value,
                    startDate: validStartDate,
                    endDate: validEndDate,
                    maxResults: document.getElementById('maxResults').value
                };

                // Excel 생성에 필요한 데이터만 추출하여 페이로드 크기 최적화
                const optimizedResults = searchResults.map(result => ({
                    youtube_channel_name: result.youtube_channel_name,
                    thumbnail_url: result.thumbnail_url,
                    status: result.status,
                    youtube_channel_id: result.youtube_channel_id,
                    title: result.title,
                    daily_view_count: result.daily_view_count,
                    subscriber_count: result.subscriber_count,
                    vod_url: result.vod_url,
                    status_date: result.status_date,
                    duration_seconds: result.duration_seconds,
                    video_length_category: result.video_length_category,
                    primary_category: result.primary_category
                }));

                console.log('Excel 다운로드 요청:', {
                    resultsCount: optimizedResults.length,
                    originalSize: JSON.stringify(searchResults).length,
                    optimizedSize: JSON.stringify(optimizedResults).length,
                    searchParams: searchParams
                });

                // 서버에 Excel 생성 요청
                const response = await fetch('/api/download-excel', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        searchResults: optimizedResults,
                        searchParams: searchParams
                    })
                });

                if (!response.ok) {
                    throw new Error(`서버 오류: ${response.status}`);
                }

                // 파일명을 응답 헤더에서 추출하거나 기본값 사용
                const contentDisposition = response.headers.get('Content-Disposition');
                let filename = 'YouTube_검색결과.xlsx';
                if (contentDisposition) {
                    const filenameMatch = contentDisposition.match(/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/);
                    if (filenameMatch) {
                        filename = decodeURIComponent(filenameMatch[1].replace(/['"]/g, ''));
                    }
                }

                // 파일 다운로드 (폴더 선택 가능)
                const blob = await response.blob();
                await downloadExcelWithFolderChoice(blob, filename);

                console.log(`✅ Excel 파일 다운로드 완료: ${filename}`);
                
                // alert 창을 표시하고, 확인 버튼을 누른 후에 버튼 상태 복원
                alert(`✅ Excel 파일이 다운로드되었습니다!\n파일명: ${filename}\n데이터: ${searchResults.length}행`);
                
                // alert 창이 닫힌 후에 버튼 상태 복원
                downloadBtn.disabled = false;
                downloadBtn.textContent = originalText;

            } catch (error) {
                console.error('Excel 다운로드 오류:', error);
                alert('Excel 파일 다운로드에 실패했습니다. 잠시 후 다시 시도해주세요.');
                
                // 오류 발생 시에도 alert 창이 닫힌 후에 버튼 상태 복원
                downloadBtn.disabled = false;
                downloadBtn.textContent = originalText;
            }
        }

        // Excel 파일 다운로드 (폴더 선택 가능)
        async function downloadExcelWithFolderChoice(blob, filename) {
            try {
                // 최신 브라우저에서 File System Access API 지원 확인
                if ('showSaveFilePicker' in window) {
                    // File System Access API 사용 (Chrome 86+, Edge 86+)
                    await downloadExcelWithFilePicker(blob, filename);
                } else if ('showDirectoryPicker' in window) {
                    // Directory Picker API 사용 (대체 방법)
                    await downloadExcelWithDirectoryPicker(blob, filename);
                } else {
                    // 기존 방식 (자동 다운로드) - 브라우저 호환성을 위한 fallback
                    await downloadExcelWithTraditionalMethod(blob, filename);
                }
            } catch (error) {
                console.error('Excel 다운로드 오류:', error);
                // 오류 발생 시 기본 방식으로 fallback
                await downloadExcelWithTraditionalMethod(blob, filename);
            }
        }

        // File System Access API를 사용한 Excel 파일 저장 (위치 선택 가능)
        async function downloadExcelWithFilePicker(blob, filename) {
            try {
                // 파일 저장 위치 선택 다이얼로그 표시
                const fileHandle = await window.showSaveFilePicker({
                    suggestedName: filename,
                    types: [{
                        description: 'Excel 파일',
                        accept: {
                            'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet': ['.xlsx'],
                            'application/vnd.ms-excel': ['.xls']
                        }
                    }]
                });

                // 선택한 위치에 파일 저장
                const writable = await fileHandle.createWritable();
                await writable.write(blob);
                await writable.close();
                
                console.log(`✅ Excel 파일이 선택한 위치에 저장되었습니다: ${filename}`);
            } catch (error) {
                if (error.name === 'AbortError') {
                    console.log('사용자가 저장을 취소했습니다.');
                    throw new Error('저장이 취소되었습니다.');
                } else {
                    throw error;
                }
            }
        }

        // Directory Picker API를 사용한 Excel 파일 저장
        async function downloadExcelWithDirectoryPicker(blob, filename) {
            try {
                // 폴더 선택 다이얼로그 표시
                const dirHandle = await window.showDirectoryPicker();
                
                // 선택한 폴더에 파일 생성 및 저장
                const fileHandle = await dirHandle.getFileHandle(filename, { create: true });
                const writable = await fileHandle.createWritable();
                await writable.write(blob);
                await writable.close();
                
                console.log(`✅ Excel 파일이 선택한 폴더에 저장되었습니다: ${filename}`);
            } catch (error) {
                if (error.name === 'AbortError') {
                    console.log('사용자가 폴더 선택을 취소했습니다.');
                    throw new Error('폴더 선택이 취소되었습니다.');
                } else {
                    throw error;
                }
            }
        }

        // 기존 방식 Excel 다운로드 (브라우저 호환성 fallback)
        async function downloadExcelWithTraditionalMethod(blob, filename) {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            
            console.log(`📁 Excel 파일이 기본 다운로드 폴더에 저장됩니다: ${filename}`);
        }

        // 조회수를 원래 숫자 그대로 표시하는 함수
        function formatViewCount(count) {
            if (!count || count === 0) {
                return '0';
            }
            
            const number = parseInt(count);
            return number.toLocaleString();
        }

        // 구독자 수를 만 단위로 변환하는 함수
        function formatSubscriberCount(count) {
            if (!count || count === 0) {
                return '0';
            }
            
            const number = parseInt(count);
            const inTenThousands = number / 10000;
            
            if (number < 10000) {
                // 1만 미만인 경우 소수점 2자리 표시
                return inTenThousands.toFixed(2);
            } else {
                // 1만 이상인 경우 소수점 1자리 표시 (100만 이상도 포함)
                return inTenThousands.toFixed(1);
            }
        }

        // 동영상 재생시간을 HH:MM:SS 형식으로 변환하는 함수
        function formatDuration(durationSeconds) {
            if (!durationSeconds || durationSeconds === 0) {
                // 0초인 경우 라이브 또는 연속 스트림으로 판단
                return 'LIVE';
            }
            
            const hours = Math.floor(durationSeconds / 3600);
            const minutes = Math.floor((durationSeconds % 3600) / 60);
            const seconds = durationSeconds % 60;
            
            if (hours > 0) {
                // 1시간 이상인 경우: HH:MM:SS 형식
                return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            } else {
                // 1시간 미만인 경우: MM:SS 형식
                return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
        }

        // 동영상 다운로드 함수 (화질 선택 모달 열기)
        let currentVideoUrl = '';
        let currentVideoTitle = '';
        let selectedQuality = '';
        
        function downloadVideo(videoUrl, videoTitle) {
            try {
                currentVideoUrl = videoUrl;
                currentVideoTitle = videoTitle;
                
                // 화질 선택 모달 열기
                document.getElementById('qualityModal').style.display = 'block';
                
            } catch (error) {
                console.error('동영상 다운로드 오류:', error);
                alert('동영상 다운로드 처리 중 오류가 발생했습니다.');
            }
        }
        
        // 화질 선택 함수
        function selectQuality(quality) {
            selectedQuality = quality;
            
            // 화질에 따른 다운로드 안내 메시지 생성
            let qualityText = '';
            let downloadTips = '';
            
            switch(quality) {
                case '4K':
                    qualityText = '4K (2160p) 최고 화질';
                    downloadTips = '최고 화질로 크기가 매우 클 수 있습니다. Wi-Fi 환경에서 다운로드를 추천합니다.';
                    break;
                case '1080p':
                    qualityText = 'Full HD (1080p) 고화질';
                    downloadTips = '가장 인기 있는 화질로 화질과 파일 크기의 바란스가 좋습니다.';
                    break;
                case '720p':
                    qualityText = 'HD (720p) 중간 화질';
                    downloadTips = '빠른 다운로드가 가능하며 대부분의 기기에서 원활하게 재생됩니다.';
                    break;
                case '480p':
                    qualityText = 'SD (480p) 기본 화질';
                    downloadTips = '작은 파일 크기로 데이터 절약이 가능합니다.';
                    break;
                case '360p':
                    qualityText = 'Low (360p) 낮은 화질';
                    downloadTips = '배경 재생이나 음성 위주의 콘텐츠에 적합합니다.';
                    break;
                case 'audio':
                    qualityText = '오디오만 (MP3/M4A)';
                    downloadTips = '음악, 팟컬스트, 강의 등 음성만 필요한 경우에 적합합니다.';
                    break;
            }
            
            const message = `선택한 화질: ${qualityText}\n\n` +
                `동영상: ${currentVideoTitle}\n\n` +
                `팁: ${downloadTips}\n\n` +
                `추천 다운로더:\n` +
                `1. yt-dlp (GitHub) - 최고 성능\n` +
                `2. 4K Video Downloader - 간편한 UI\n` +
                `3. ClipGrab - 사용 쉬움\n\n` +
                `온라인 서비스:\n` +
                `- savefrom.net\n` +
                `- y2mate.com\n` +
                `- keepvid.com\n\n` +
                `주의: 저작권 법률을 준수하여 개인 용도로만 사용하세요.`;
            
            alert(message);
            
            // URL 자동 복사
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(currentVideoUrl).then(() => {
                    console.log('동영상 URL이 클립보드에 복사되었습니다.');
                }).catch(err => {
                    console.log('URL 복사 실패:', err);
                });
            }
            
            // 동영상 페이지를 새 탭에서 열기
            window.open(currentVideoUrl, '_blank');
            
            // 모달 닫기
            closeQualityModal();
        }
        
        // 모달 닫기 함수
        function closeQualityModal() {
            document.getElementById('qualityModal').style.display = 'none';
            currentVideoUrl = '';
            currentVideoTitle = '';
            selectedQuality = '';
        }
        
        // URL 복사 후 모달 닫기
        function copyVideoUrl() {
            if (currentVideoUrl) {
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(currentVideoUrl).then(() => {
                        alert('동영상 URL이 클립보드에 복사되었습니다!');
                        closeQualityModal();
                    }).catch(err => {
                        alert('URL 복사에 실패했습니다.');
                        console.log('URL 복사 실패:', err);
                    });
                } else {
                    // 클립보드 API를 지원하지 않는 경우
                    alert(`URL을 수동으로 복사하세요:\n\n${currentVideoUrl}`);
                    closeQualityModal();
                }
            }
        }
        



        // 동영상 링크 클릭 시 URL 복사 + 새 탭 열기 함수
        function openVideoWithCopy(videoUrl) {
            try {
                // 1. 클립보드에 URL 복사
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(videoUrl).then(() => {
                        console.log('✅ URL이 클립보드에 복사되었습니다:', videoUrl);
                        
                        // 복사 성공을 시각적으로 표시 (선택적)
                        showCopyNotification('URL이 클립보드에 복사되었습니다!');
                    }).catch(err => {
                        console.warn('URL 복사 실패:', err);
                        // 복사 실패 시에도 링크는 열기
                        showCopyNotification('링크를 열었습니다 (URL 복사는 실패)', 'warning');
                    });
                } else {
                    // 클립보드 API를 지원하지 않는 경우
                    console.warn('클립보드 API 미지원 - URL 복사 건너뛰기');
                    showCopyNotification('링크를 열었습니다 (브라우저가 자동복사 미지원)', 'info');
                }
                
                // 2. 새 탭에서 YouTube 페이지 열기
                window.open(videoUrl, '_blank');
                
            } catch (error) {
                console.error('링크 처리 오류:', error);
                // 오류 발생 시에도 최소한 링크는 열기
                window.open(videoUrl, '_blank');
            }
        }
        
        // URL 복사 알림 표시 함수
        function showCopyNotification(message, type = 'success') {
            // 기존 알림이 있으면 제거
            const existingNotification = document.getElementById('copyNotification');
            if (existingNotification) {
                existingNotification.remove();
            }
            
            // 새 알림 생성
            const notification = document.createElement('div');
            notification.id = 'copyNotification';
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 10000;
                padding: 12px 20px;
                border-radius: 8px;
                font-weight: 500;
                font-size: 14px;
                max-width: 300px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                transform: translateX(100%);
                transition: transform 0.3s ease-in-out;
                cursor: pointer;
            `;
            
            // 타입별 스타일 설정
            if (type === 'success') {
                notification.style.backgroundColor = '#d4edda';
                notification.style.color = '#155724';
                notification.style.border = '1px solid #c3e6cb';
                notification.innerHTML = `✅ ${message}`;
            } else if (type === 'warning') {
                notification.style.backgroundColor = '#fff3cd';
                notification.style.color = '#856404';
                notification.style.border = '1px solid #ffeaa7';
                notification.innerHTML = `⚠️ ${message}`;
            } else if (type === 'info') {
                notification.style.backgroundColor = '#e3f2fd';
                notification.style.color = '#0277bd';
                notification.style.border = '1px solid #81d4fa';
                notification.innerHTML = `ℹ️ ${message}`;
            }
            
            // 페이지에 추가
            document.body.appendChild(notification);
            
            // 애니메이션으로 표시
            setTimeout(() => {
                notification.style.transform = 'translateX(0)';
            }, 100);
            
            // 클릭 시 즉시 제거
            notification.addEventListener('click', () => {
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, 300);
            });
            
            // 3초 후 자동 제거
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.style.transform = 'translateX(100%)';
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.remove();
                        }
                    }, 300);
                }
            }, 3000);
        }

        // 페이지 로드 시 초기화
        document.addEventListener('DOMContentLoaded', () => {
            console.log('YouTube 채널 검색 시스템이 준비되었습니다.');
            
            // 카테고리 초기 디스플레이 업데이트
            updateCategoryDisplay();
            
            // 검색 범위 초기 디스플레이 업데이트
            updateSearchScopeDisplay();
            
            // 동영상 길이 체크박스 이벤트 리스너 추가
            const videoLengthCheckboxes = [
                'shortForm1', 'shortForm2', 'midForm1', 'midForm2', 
                'longForm1', 'longForm2', 'longForm3', 'longForm4', 'longForm5', 'longForm6'
            ];
            
            videoLengthCheckboxes.forEach(id => {
                const checkbox = document.getElementById(id);
                if (checkbox) {
                    checkbox.addEventListener('change', () => {
                        updateSelectAllVideoLength();
                        updateGroupCheckboxes();
                    });
                }
            });
        });
    </script>
    

</body>
</html>