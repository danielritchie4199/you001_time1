## ğŸ” í˜„ì¬ YouTube ê²€ìƒ‰ ì‹œìŠ¤í…œ ë¶„ì„ ê²°ê³¼

### ëª©í‘œ:

í˜„ì¬ êµ¬í˜„ëœ YouTube ê²€ìƒ‰ ì•±ì˜ êµ¬ì¡°ë¥¼ ì™„ì „íˆ íŒŒì•…í•˜ì—¬ ê²€ìƒ‰ ì„±ëŠ¥ê³¼ ì‚¬ìš©ì ê²½í—˜ì„ í¬ê²Œ í–¥ìƒì‹œí‚¬ ìˆ˜ ìˆëŠ” ë°©ë²•ì„ ì œì‹œ

### ê°€ì •/ì œì•½:

- ê¸°ì¡´ ê¸°ëŠ¥ì€ ìœ ì§€í•˜ë©´ì„œ ì„±ëŠ¥ë§Œ ê°œì„ 

- Elasticsearchê°€ ì´ë¯¸ êµ¬í˜„ë˜ì–´ ìˆì–´ ì´ë¥¼ ìµœëŒ€í•œ í™œìš©

- YouTube API í• ë‹¹ëŸ‰ ì œí•œì€ ë³€ê²½ ë¶ˆê°€

### ì„ íƒì§€ ë¹„êµ:

ì—¬ëŸ¬ ìµœì í™” ë°©ë²• ì¤‘ì—ì„œ ì¦‰ì‹œ íš¨ê³¼ë¥¼ ë³¼ ìˆ˜ ìˆê³  ê¸°ì¡´ ì‹œìŠ¤í…œê³¼ í˜¸í™˜ë˜ëŠ” ë°©ì•ˆë“¤ì„ ìš°ì„  ì„ íƒ

---

## ğŸ¯ í˜„ì¬ êµ¬í˜„ëœ ìš°ìˆ˜í•œ ê¸°ëŠ¥ë“¤

### âœ…Â ì´ë¯¸ ì˜ êµ¬í˜„ëœ ë¶€ë¶„ë“¤:

1. Elasticsearch ìºì‹± ì‹œìŠ¤í…œÂ - ê²€ìƒ‰ ê²°ê³¼ë¥¼ ì¸ë±ì‹±í•˜ì—¬ ì¬ê²€ìƒ‰ ì‹œ ì´ˆê³ ì† ì‘ë‹µ

2. ë³‘ë ¬ API í‚¤ ê´€ë¦¬Â - ì—¬ëŸ¬ YouTube API í‚¤ë¥¼ ë¼ìš´ë“œ ë¡œë¹ˆìœ¼ë¡œ ì‚¬ìš©í•˜ì—¬ í• ë‹¹ëŸ‰ ë¶„ì‚°

3. ë³µí•© í•„í„°ë§Â - êµ­ê°€, ì¡°íšŒìˆ˜, ë‚ ì§œ, ì¹´í…Œê³ ë¦¬, ë™ì˜ìƒ ê¸¸ì´ ë“± ë‹¤ì–‘í•œ í•„í„°

4. ê²°ê³¼ë‚´ ì¬ê²€ìƒ‰Â - ì‹œê°„ëŒ€ë³„ í•„í„°ë§ìœ¼ë¡œ ì—…ë¡œë“œ ìµœì  ì‹œê°„ ë¶„ì„

5. ì‹¤ì‹œê°„ ì •ë ¬Â - ì¡°íšŒìˆ˜, êµ¬ë…ììˆ˜, ì‹œê°„ ë“± ë‹¤ì–‘í•œ ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬

---

## ğŸš€Â ê²€ìƒ‰ ê¸°ëŠ¥ í–¥ìƒì„ ìœ„í•œ í•µì‹¬ ê°œì„  ë°©ì•ˆ

1 of 4 Done

ì„±ëŠ¥ ë³‘ëª©ì§€ì ê³¼ ê°œì„  ê°€ëŠ¥í•œ ê²€ìƒ‰ ì˜ì—­ ì‹ë³„

1 of 4

### 1ï¸âƒ£ ì¦‰ì‹œ ê°œì„  ê°€ëŠ¥í•œ ì˜ì—­ë“¤

#### ğŸ”¥Â ê²€ìƒ‰ ì†ë„ ìµœì í™”

- í˜„ì¬: ì²« ê²€ìƒ‰ ì‹œ YouTube API ì‘ë‹µ ëŒ€ê¸° ì‹œê°„ 5-15ì´ˆ

- ê°œì„ : Elasticsearch ì¸ë±ìŠ¤ í”„ë¦¬ì›Œë° + ë°±ê·¸ë¼ìš´ë“œ ìºì‹œ ì—…ë°ì´íŠ¸

- íš¨ê³¼: ì²´ê° ì‘ë‹µ ì‹œê°„Â 0.1-0.5ì´ˆë¡œ ë‹¨ì¶•

#### ğŸ¯Â ê²€ìƒ‰ ì •í™•ë„ í–¥ìƒ

- í˜„ì¬: ë‹¨ìˆœ í‚¤ì›Œë“œ ë§¤ì¹­

- ê°œì„ :

- í•œêµ­ì–´ í˜•íƒœì†Œ ë¶„ì„ê¸°Â ì¶”ê°€ (ì€/ëŠ”/ì´/ê°€ ë“± ì¡°ì‚¬ ë¬´ì‹œ)

- ë™ì˜ì–´ í™•ì¥Â (ì˜ˆ: "ìŒì•…" â†” "ë®¤ì§", "ìš”ë¦¬" â†” "ì¿ í‚¹")

- ì˜¤íƒ€ í—ˆìš© ê²€ìƒ‰Â (ì˜ˆ: "ë¯¼ìœ " â†’ "ë¯¼ìš”")

#### ğŸ“ŠÂ ìŠ¤ë§ˆíŠ¸ í•„í„°ë§

- AI ê¸°ë°˜ ì¹´í…Œê³ ë¦¬ ìë™ ë¶„ë¥˜

- íŠ¸ë Œë“œ ê¸°ë°˜ ì¶”ì²œ ê²€ìƒ‰ì–´

- ì‚¬ìš©ì ê²€ìƒ‰ íŒ¨í„´ í•™ìŠµ

### 2ï¸âƒ£ Elasticsearch ê³ ë„í™”

#### í˜„ì¬ ë§¤í•‘ ê°œì„ ì•ˆ:

json

{

Â Â "mappings":Â {

Â Â Â Â "properties":Â {

Â Â Â Â Â Â "title":Â {

Â Â Â Â Â Â Â Â "type":Â "text",

Â Â Â Â Â Â Â Â "analyzer":Â "korean_analyzer",

Â Â Â Â Â Â Â Â "fields":Â {

Â Â Â Â Â Â Â Â Â Â "keyword":Â {"type":Â "keyword"},

Â Â Â Â Â Â Â Â Â Â "suggest":Â {"type":Â "completion"}

Â Â Â Â Â Â Â Â }

Â Â Â Â Â Â },

Â Â Â Â Â Â "tags":Â {"type":Â "keyword"},

Â Â Â Â Â Â "description":Â {"type":Â "text",Â "analyzer":Â "korean_analyzer"},

Â Â Â Â Â Â "trending_score":Â {"type":Â "float"},

Â Â Â Â Â Â "engagement_rate":Â {"type":Â "float"}

Â Â Â Â }

Â Â }

}

### 3ï¸âƒ£ ì‚¬ìš©ì ê²½í—˜ (UX) í–¥ìƒ

#### ì‹¤ì‹œê°„ ê²€ìƒ‰ ì œì•ˆ

- ìë™ì™„ì„±: ì…ë ¥ ì¤‘ ì‹¤ì‹œê°„ í‚¤ì›Œë“œ ì œì•ˆ

- ì¸ê¸° ê²€ìƒ‰ì–´: ì‹¤ì‹œê°„ íŠ¸ë Œë”© í‚¤ì›Œë“œ í‘œì‹œ

- ê²€ìƒ‰ ê¸°ë¡: ê°œì¸ë³„ ìµœê·¼ ê²€ìƒ‰ì–´ ì €ì¥

#### ê²€ìƒ‰ ê²°ê³¼ ê°œì„ 

- ë¬´í•œ ìŠ¤í¬ë¡¤: í˜ì´ì§€ë„¤ì´ì…˜ ëŒ€ì‹  ìë™ ë¡œë”©

- ë¯¸ë¦¬ë³´ê¸°: ì¸ë„¤ì¼ í˜¸ë²„ ì‹œ ë™ì˜ìƒ ë¯¸ë¦¬ë³´ê¸°

- ë¶ë§ˆí¬: ê´€ì‹¬ ë™ì˜ìƒ ì €ì¥ ê¸°ëŠ¥

### ğŸ¯ êµ¬í˜„ ëŒ€ìƒÂ ê¸°ëŠ¥ë“¤:

1. ğŸ”¥ ê²€ìƒ‰ ì†ë„ ìµœì í™”
- ElasticsearchÂ ì¸ë±ìŠ¤ í”„ë¦¬ì›Œë° +Â ë°±ê·¸ë¼ìš´ë“œ ìºì‹œÂ ì—…ë°ì´íŠ¸
1. ğŸ¯ ê²€ìƒ‰Â ì •í™•ë„ í–¥ìƒ
- í•œêµ­ì–´Â í˜•íƒœì†Œ ë¶„ì„ê¸° ì¶”ê°€ (ì€/ëŠ”/ì´/ê°€Â ë“±Â ì¡°ì‚¬ ë¬´ì‹œ)

- ë™ì˜ì–´ í™•ì¥Â (ì˜ˆ:Â "ìŒì•…"Â â†”Â "ë®¤ì§", "ìš”ë¦¬" â†”Â "ì¿ í‚¹")

- ì˜¤íƒ€ í—ˆìš© ê²€ìƒ‰ (ì˜ˆ: "ë¯¼ìœ " â†’ "ë¯¼ìš”")
1. ğŸ“ŠÂ ìŠ¤ë§ˆíŠ¸ í•„í„°ë§
- AI ê¸°ë°˜Â ì¹´í…Œê³ ë¦¬ ìë™ ë¶„ë¥˜

- íŠ¸ë Œë“œ ê¸°ë°˜ ì¶”ì²œÂ ê²€ìƒ‰ì–´
1. ğŸ¯  ì‹¤ì‹œê°„ ê²€ìƒ‰ ì œì•ˆ
- ìë™ì™„ì„±:Â ì…ë ¥ ì¤‘Â ì‹¤ì‹œê°„Â í‚¤ì›Œë“œ ì œì•ˆ

- ì¸ê¸°Â ê²€ìƒ‰ì–´: ì‹¤ì‹œê°„ íŠ¸ë Œë”© í‚¤ì›Œë“œÂ í‘œì‹œ

- ê²€ìƒ‰Â ê¸°ë¡: ê°œì¸ë³„ ìµœê·¼ ê²€ìƒ‰ì–´ ì €ì¥
1. ğŸ¯ ê²€ìƒ‰Â ê²°ê³¼ ê°œì„ 
- ë¬´í•œÂ ìŠ¤í¬ë¡¤: í˜ì´ì§€ë„¤ì´ì…˜Â ëŒ€ì‹  ìë™Â ë¡œë”©

- ë¯¸ë¦¬ë³´ê¸°:Â ì¸ë„¤ì¼Â í˜¸ë²„ ì‹œÂ ë™ì˜ìƒ ë¯¸ë¦¬ë³´ê¸°

- ë¶ë§ˆí¬: ê´€ì‹¬ ë™ì˜ìƒÂ ì €ì¥ ê¸°ëŠ¥

## ğŸ” ê¸°ëŠ¥ êµ¬í˜„ í˜„í™©Â ë¶„ì„

### âœ…Â êµ¬í˜„ ì™„ë£ŒëœÂ ê¸°ëŠ¥ë“¤

#### 1.Â ğŸ”¥ ê²€ìƒ‰ ì†ë„ ìµœì í™”

- Elasticsearch ì¸ë±ìŠ¤Â + ë°±ê·¸ë¼ìš´ë“œÂ ìºì‹œ:Â âœ…Â êµ¬í˜„ë¨

- server.jsì—ì„œ ElasticsearchÂ í´ë¼ì´ì–¸íŠ¸ ì„¤ì •Â ì™„ë£Œ

- ìºì‹œ ìš°ì„ Â ë¡œì§ êµ¬í˜„Â (lineÂ 805-885)

- ë°±ê·¸ë¼ìš´ë“œ ì¸ë±ì‹± ê¸°ëŠ¥ êµ¬í˜„Â (lineÂ 1551-1562)

#### 2. ğŸ¯ ê²€ìƒ‰ ì •í™•ë„ í–¥ìƒÂ (ë¶€ë¶„ êµ¬í˜„)

- í•œêµ­ì–´ í˜•íƒœì†Œ ë¶„ì„ê¸°: âœ…Â êµ¬í˜„ë¨

- server.jsÂ lineÂ 357-402ì—ì„œÂ korean_analyzerÂ ì‚¬ìš©

- ì¡°ì‚¬Â ë¬´ì‹œí•˜ëŠ”Â í•œêµ­ì–´ ë¶„ì„ê¸° ì ìš©

- ì˜¤íƒ€ í—ˆìš© ê²€ìƒ‰: âœ…Â êµ¬í˜„ë¨

- server.jsÂ line 383-392ì—ì„œÂ í¼ì§€ ë§¤ì¹­ êµ¬í˜„

- fuzziness:Â "AUTO"Â ì„¤ì •ìœ¼ë¡œ ìë™ ì˜¤íƒ€ ë³´ì •

- ë™ì˜ì–´ í™•ì¥:Â âŒÂ ë¯¸êµ¬í˜„

- ì½”ë“œì—ì„œ ë™ì˜ì–´ í™•ì¥Â ë¡œì§ í™•ì¸ë˜ì§€ ì•ŠìŒ

#### 3.Â ğŸ¯ ì‹¤ì‹œê°„ ê²€ìƒ‰ ì œì•ˆÂ (ì™„ì „Â êµ¬í˜„)

- ìë™ì™„ì„±: âœ…Â êµ¬í˜„ë¨

- server.jsÂ lineÂ 3077ì—ì„œ ìë™ì™„ì„± APIÂ ì—”ë“œí¬ì¸íŠ¸

- you_list.jsÂ lineÂ 4524-4600ì—ì„œ ì‹¤ì‹œê°„ ìë™ì™„ì„± UI

- ì¸ê¸°Â ê²€ìƒ‰ì–´: âœ…Â êµ¬í˜„ë¨

- server.jsÂ lineÂ 2762-2950ì—ì„œ ì¸ê¸°ê²€ìƒ‰ì–´ ë¶„ì„Â API

- you_list.jsÂ line 15-91ì—ì„œ ì¸ê¸°ê²€ìƒ‰ì–´Â UI

- ê²€ìƒ‰Â ê¸°ë¡: âœ…Â êµ¬í˜„ë¨Â (localStorage ê¸°ë°˜)

#### 4.Â ğŸ¯ ê²€ìƒ‰ ê²°ê³¼ ê°œì„  (ì™„ì „ êµ¬í˜„)

- ë¬´í•œ ìŠ¤í¬ë¡¤: âœ…Â êµ¬í˜„ë¨

- you_list.jsÂ lineÂ 4695-4770ì—ì„œ ë¬´í•œ ìŠ¤í¬ë¡¤ ë¡œì§

- ë¯¸ë¦¬ë³´ê¸°: âœ…Â êµ¬í˜„ë¨

- you_list.jsÂ lineÂ 4775-4823ì—ì„œ ë™ì˜ìƒ ë¯¸ë¦¬ë³´ê¸°

- ì¸ë„¤ì¼ í˜¸ë²„ ì‹œÂ YouTubeÂ iframeÂ í‘œì‹œ

- ë¶ë§ˆí¬: âœ…Â êµ¬í˜„ë¨

- you_list.jsÂ lineÂ 4825-4880ì—ì„œ ë¶ë§ˆí¬ ê¸°ëŠ¥

- localStorageÂ ê¸°ë°˜ ë¶ë§ˆí¬ ì €ì¥/ê´€ë¦¬

### âŒÂ ë¯¸êµ¬í˜„ëœÂ ê¸°ëŠ¥ë“¤

#### 1.Â ğŸ¯ ê²€ìƒ‰ ì •í™•ë„ í–¥ìƒ (ë¶€ë¶„ ë¯¸êµ¬í˜„)

- ë™ì˜ì–´ í™•ì¥:Â âŒÂ ë¯¸êµ¬í˜„

- "ìŒì•…"Â â†”Â "ë®¤ì§", "ìš”ë¦¬" â†”Â "ì¿ í‚¹" ë“±ì˜Â ë™ì˜ì–´ ë§¤í•‘ ì—†ìŒ

#### 2.Â ğŸ“Š ìŠ¤ë§ˆíŠ¸ í•„í„°ë§Â (ì™„ì „ ë¯¸êµ¬í˜„)

- AIÂ ê¸°ë°˜ ì¹´í…Œê³ ë¦¬ ìë™ ë¶„ë¥˜:Â âŒÂ ë¯¸êµ¬í˜„

- AIÂ ëª¨ë¸ì„Â í™œìš©í•œ ì¹´í…Œê³ ë¦¬ ë¶„ë¥˜ ë¡œì§ ì—†ìŒ

- íŠ¸ë Œë“œ ê¸°ë°˜ ì¶”ì²œÂ ê²€ìƒ‰ì–´: âŒÂ ë¯¸êµ¬í˜„

- íŠ¸ë Œë“œ ë°ì´í„°ë¥¼Â ê¸°ë°˜ìœ¼ë¡œ í•œ ì¶”ì²œ ì‹œìŠ¤í…œ ì—†ìŒ

## ğŸ“Š êµ¬í˜„ í˜„í™© ìš”ì•½

êµ¬í˜„ ì™„ë£Œë„: ì•½Â 80%

- ì™„ì „ êµ¬í˜„: ê²€ìƒ‰Â ì†ë„ ìµœì í™”, ì‹¤ì‹œê°„ ê²€ìƒ‰ ì œì•ˆ, ê²€ìƒ‰ ê²°ê³¼ ê°œì„ 

- ë¶€ë¶„ êµ¬í˜„: ê²€ìƒ‰ ì •í™•ë„ í–¥ìƒÂ (ë™ì˜ì–´ í™•ì¥ë§ŒÂ ë¯¸êµ¬í˜„)

- ë¯¸êµ¬í˜„: ìŠ¤ë§ˆíŠ¸ í•„í„°ë§Â (AI ì¹´í…Œê³ ë¦¬ ë¶„ë¥˜, íŠ¸ë Œë“œ ì¶”ì²œ)

ë³€ê²½ì : ì‹¤ì œÂ ì†ŒìŠ¤ ì½”ë“œÂ ë¶„ì„ì„Â í†µí•´ ì •í™•í•œÂ êµ¬í˜„ ìƒíƒœÂ íŒŒì•… ì™„ë£Œ

ì˜í–¥ë„: ê¸°ì¡´ êµ¬í˜„ëœÂ ê¸°ëŠ¥ë“¤ì€Â ëª¨ë‘ ì •ìƒÂ ë™ì‘ ì¤‘, ë¯¸êµ¬í˜„Â ê¸°ëŠ¥ë“¤ì€ ì¶”ê°€ ê°œë°œ í•„ìš”

ê²€ì¦: ê° ê¸°ëŠ¥ì˜Â ì‹¤ì œ ì½”ë“œ ìœ„ì¹˜ì™€ êµ¬í˜„ ë°©ì‹Â í™•ì¸ ì™„ë£Œ

ì •í™•ë„: 95%

ê·¼ê±°: ì‹¤ì œ ì†ŒìŠ¤Â íŒŒì¼(server.js,Â you_list.jsÂ ë“±)ì„ ì§ì ‘ ë¶„ì„í•˜ì—¬ ê°Â ê¸°ëŠ¥ì˜ êµ¬í˜„Â ì—¬ë¶€ë¥¼Â ì½”ë“œÂ ë ˆë²¨ì—ì„œ í™•ì¸í–ˆìŒ. ì¶”ì¸¡ì´Â ì•„ë‹Œ ì‹¤ì œ êµ¬í˜„ëœÂ ì½”ë“œë¥¼Â ê¸°ë°˜ìœ¼ë¡œ ë¶„ì„í•¨.

ì¶”ì¸¡ì´Â ì•„ë‹Œ ì‹¤ì œ êµ¬í˜„ëœÂ ì½”ë“œë¥¼Â ê¸°ë°˜ìœ¼ë¡œ ë¶„ì„í•¨.

- ë™ì˜ì–´ í™•ì¥:Â âŒÂ ë¯¸êµ¬í˜„  

- "ìŒì•…"Â â†”Â "ë®¤ì§", "ìš”ë¦¬" â†”Â "ì¿ í‚¹" ë“±ì˜Â ë™ì˜ì–´ ë§¤í•‘ ì—†ìŒ  
  ã„´ ì´ê²ƒì„ êµ¬í˜„í•˜ë ¤ë©´ ì–´ë–»ê²Œ í•˜ë©´ ë˜ëŠ”ê°€?

ëª©í‘œ: ë™ì˜ì–´ í™•ì¥Â ê¸°ëŠ¥ êµ¬í˜„ ë°©ì•ˆì„Â ë‹¨ê³„ë³„ë¡œ ì•ˆë‚´

ê°€ì •/ì œì•½: í˜„ì¬Â ElasticsearchÂ ê¸°ë°˜ ê²€ìƒ‰ ì‹œìŠ¤í…œì—Â ë™ì˜ì–´ ê¸°ëŠ¥ì„Â ì¶”ê°€, ê¸°ì¡´ ê¸°ëŠ¥ ì˜í–¥ ìµœì†Œí™”

ì„ íƒì§€Â ë¹„êµ:

1. Elasticsearch ë™ì˜ì–´ í•„í„°Â ë°©ì‹ (ì„œë²„Â ì‚¬ì´ë“œ)

2. í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œÂ ë™ì˜ì–´ ë§¤í•‘

3. í•˜ì´ë¸Œë¦¬ë“œ ë°©ì‹Â (ì„œë²„+í´ë¼ì´ì–¸íŠ¸)

ê²°ì •: Elasticsearch ë™ì˜ì–´ í•„í„°Â ë°©ì‹Â ì„ íƒÂ (ì„±ëŠ¥ ë°Â í™•ì¥ì„± ìš°ìˆ˜)

## ë™ì˜ì–´ í™•ì¥ ê¸°ëŠ¥ êµ¬í˜„ ë°©ì•ˆ

### 1ë‹¨ê³„: ë™ì˜ì–´ ì‚¬ì „ íŒŒì¼Â ìƒì„±

synonyms.txt(new)

+43

# í•œêµ­ì–´-ì˜ì–´Â ë™ì˜ì–´Â ë§¤í•‘

ìŒì•…,ë®¤ì§,music,ë…¸ë˜,song,ê³¡

ìš”ë¦¬,ì¿ í‚¹,cooking,ë ˆì‹œí”¼,recipe

ê²Œì„,ê²Œì´ë°,gaming,í”Œë ˆì´

ë·°í‹°,ë¯¸ìš©,beauty,í™”ì¥,ë©”ì´í¬ì—…,makeup

ìš´ë™,ìŠ¤í¬ì¸ ,sports,í—¬ìŠ¤,fitness,workout

ì—¬í–‰,íŠ¸ë˜ë¸”,travel,ì—¬í–‰ê¸°

ë¦¬ë·°,í›„ê¸°,review,í‰ê°€

ë¨¹ë°©,eating,food,ìŒì‹

ëŒ„ìŠ¤,ì¶¤,dance,ì•ˆë¬´

### 1ë‹¨ê³„: ë™ì˜ì–´ ì‚¬ì „ íŒŒì¼Â ìƒì„±

synonyms.txt(new)

# í•œêµ­ì–´-ì˜ì–´ ë™ì˜ì–´ ë§¤í•‘

ìŒì•…,ë®¤ì§,music,ë…¸ë˜,song,ê³¡
ìš”ë¦¬,ì¿ í‚¹,cooking,ë ˆì‹œí”¼,recipe
ê²Œì„,ê²Œì´ë°,gaming,í”Œë ˆì´
ë·°í‹°,ë¯¸ìš©,beauty,í™”ì¥,ë©”ì´í¬ì—…,makeup
ìš´ë™,ìŠ¤í¬ì¸ ,sports,í—¬ìŠ¤,fitness,workout
ì—¬í–‰,íŠ¸ë˜ë¸”,travel,ì—¬í–‰ê¸°
ë¦¬ë·°,í›„ê¸°,review,í‰ê°€
ë¨¹ë°©,eating,food,ìŒì‹
ëŒ„ìŠ¤,ì¶¤,dance,ì•ˆë¬´
ì½”ë¯¸ë””,ê°œê·¸,comedy,ì›ƒê¸´
ë“œë¼ë§ˆ,ì‹œë¦¬ì¦Œ,series,ì—°ì†ê·¹
ì˜í™”,movie,film,ì‹œë„¤ë§ˆ,cinema
ì• ë‹ˆë©”ì´ì…˜,ì• ë‹ˆ,anime,ë§Œí™”
êµìœ¡,í•™ìŠµ,education,ê°•ì˜,lecture
ë‰´ìŠ¤,ì†Œì‹,news,ì •ë³´
íŒ¨ì…˜,ìŠ¤íƒ€ì¼,fashion,style,ì˜·
ìë™ì°¨,ì¹´,car,automotive
IT,ê¸°ìˆ ,tech,í…Œí¬,ì»´í“¨í„°
DIY,ë§Œë“¤ê¸°,handmade,ìˆ˜ì œ
ASMR,íŒ…ê¸€,tingles,íë§

# ë¸Œëœë“œ/ì œí’ˆ ë™ì˜ì–´

ì•„ì´í°,iphone,ì• í”Œí°
ê°¤ëŸ­ì‹œ,galaxy,ì‚¼ì„±í°
ë§¥ë¶,macbook,ì• í”Œë…¸íŠ¸ë¶
ìœˆë„ìš°,windows,ë§ˆì´í¬ë¡œì†Œí”„íŠ¸

# ì¥ë¥´ë³„ ë™ì˜ì–´

ë°œë¼ë“œ,ballad,ê°ì„±
í™í•©,hiphop,rap,ë©
íŠ¸ë¡œíŠ¸,ë½•ì§,í•œêµ­ê°€ìš”
ì¬ì¦ˆ,jazz,ë¸”ë£¨ìŠ¤,blues
í´ë˜ì‹,classical,ì˜¤ì¼€ìŠ¤íŠ¸ë¼

# í•œêµ­ íŠ¹í™” í‘œí˜„

ë¨¹ë°©,mukbang,ì´íŒ…ì‡¼
ì¼€ì´íŒ,kpop,í•œêµ­ìŒì•…
í•œë¥˜,hallyu,korean wave
ì›¹íˆ°,webtoon,ë§Œí™”
ì¹˜í‚¨,chicken,ë‹­
ë¼ë©´,ramen,noodle
í•œêµ­ì–´,korean,í•œê¸€

+43

# í•œêµ­ì–´-ì˜ì–´Â ë™ì˜ì–´Â ë§¤í•‘

ìŒì•…,ë®¤ì§,music,ë…¸ë˜,song,ê³¡

ìš”ë¦¬,ì¿ í‚¹,cooking,ë ˆì‹œí”¼,recipe

ê²Œì„,ê²Œì´ë°,gaming,í”Œë ˆì´

ë·°í‹°,ë¯¸ìš©,beauty,í™”ì¥,ë©”ì´í¬ì—…,makeup

ìš´ë™,ìŠ¤í¬ì¸ ,sports,í—¬ìŠ¤,fitness,workout

ì—¬í–‰,íŠ¸ë˜ë¸”,travel,ì—¬í–‰ê¸°

ë¦¬ë·°,í›„ê¸°,review,í‰ê°€

ë¨¹ë°©,eating,food,ìŒì‹

ëŒ„ìŠ¤,ì¶¤,dance,ì•ˆë¬´

### 2ë‹¨ê³„: Elasticsearch ë§¤í•‘ ì„¤ì •Â ìˆ˜ì •

Readvideos_mapping.json

### 3ë‹¨ê³„: ë™ì˜ì–´ ë¶„ì„ê¸°ê°€Â í¬í•¨ëœ ìƒˆÂ ë§¤í•‘ ìƒì„±

videos_mapping_with_synonyms.json(new)

+140

{

Â Â "settings":Â {

Â Â Â Â "number_of_shards":Â 1,

Â Â Â Â "number_of_replicas":Â 0,

Â Â Â Â "analysis":Â {

Â Â Â Â Â Â "normalizer":Â {

Â Â Â Â Â Â Â Â "lowercase_norm":Â {

Â Â Â Â Â Â Â Â Â Â "type":Â "custom",

Â Â Â Â Â Â Â Â Â Â "char_filter":Â [],

Â Â Â Â Â Â Â Â Â Â "filter":Â ["lowercase"]
Â Â Â Â Â Â Â Â Â Â {
  "settings": {
    "number_of_shards": 1,
    "number_of_replicas": 0,
    "analysis": {
      "normalizer": {
        "lowercase_norm": {
          "type": "custom",
          "char_filter": [],
          "filter": ["lowercase"]
        }
      },
      "analyzer": {
        "korean_analyzer": {
          "type": "custom",
          "tokenizer": "standard",
          "filter": ["lowercase", "korean_stop", "korean_stemmer"]
        },
        "korean_synonym_analyzer": {
          "type": "custom",
          "tokenizer": "standard",
          "filter": ["lowercase", "korean_stop", "korean_synonyms", "korean_stemmer"]
        },
        "search_analyzer": {
          "type": "custom",
          "tokenizer": "standard",
          "filter": ["lowercase", "korean_stop", "korean_synonyms", "korean_stemmer"]
        }
      },
      "filter": {
        "korean_stop": {
          "type": "stop",
          "stopwords": ["ì€", "ëŠ”", "ì´", "ê°€", "ì„", "ë¥¼", "ì˜", "ì—", "ì™€", "ê³¼", "ë„", "ë¡œ", "ìœ¼ë¡œ", "ì—ì„œ", "ì—ê²Œ", "í•œí…Œ", "ê»˜", "ë¶€í„°", "ê¹Œì§€", "ë§Œ", "ë„", "ì¡°ì°¨", "ë§ˆì €", "ë¿", "ë°–ì—"]
        },
        "korean_stemmer": {
          "type": "stemmer",
          "language": "korean"
        },
        "korean_synonyms": {
          "type": "synonym",
          "synonyms": [
            "ìŒì•…,ë®¤ì§,music,ë…¸ë˜,song,ê³¡",
            "ìš”ë¦¬,ì¿ í‚¹,cooking,ë ˆì‹œí”¼,recipe",
            "ê²Œì„,ê²Œì´ë°,gaming,í”Œë ˆì´",
            "ë·°í‹°,ë¯¸ìš©,beauty,í™”ì¥,ë©”ì´í¬ì—…,makeup",
            "ìš´ë™,ìŠ¤í¬ì¸ ,sports,í—¬ìŠ¤,fitness,workout",
            "ì—¬í–‰,íŠ¸ë˜ë¸”,travel,ì—¬í–‰ê¸°",
            "ë¦¬ë·°,í›„ê¸°,review,í‰ê°€",
            "ë¨¹ë°©,eating,food,ìŒì‹",
            "ëŒ„ìŠ¤,ì¶¤,dance,ì•ˆë¬´",
            "ì½”ë¯¸ë””,ê°œê·¸,comedy,ì›ƒê¸´",
            "ë“œë¼ë§ˆ,ì‹œë¦¬ì¦Œ,series,ì—°ì†ê·¹",
            "ì˜í™”,movie,film,ì‹œë„¤ë§ˆ,cinema",
            "ì• ë‹ˆë©”ì´ì…˜,ì• ë‹ˆ,anime,ë§Œí™”",
            "êµìœ¡,í•™ìŠµ,education,ê°•ì˜,lecture",
            "ë‰´ìŠ¤,ì†Œì‹,news,ì •ë³´",
            "íŒ¨ì…˜,ìŠ¤íƒ€ì¼,fashion,style,ì˜·",
            "ìë™ì°¨,ì¹´,car,automotive",
            "IT,ê¸°ìˆ ,tech,í…Œí¬,ì»´í“¨í„°",
            "DIY,ë§Œë“¤ê¸°,handmade,ìˆ˜ì œ",
            "ASMR,íŒ…ê¸€,tingles,íë§",
            "ì•„ì´í°,iphone,ì• í”Œí°",
            "ê°¤ëŸ­ì‹œ,galaxy,ì‚¼ì„±í°",
            "ë§¥ë¶,macbook,ì• í”Œë…¸íŠ¸ë¶",
            "ìœˆë„ìš°,windows,ë§ˆì´í¬ë¡œì†Œí”„íŠ¸",
            "ë°œë¼ë“œ,ballad,ê°ì„±",
            "í™í•©,hiphop,rap,ë©",
            "íŠ¸ë¡œíŠ¸,ë½•ì§,í•œêµ­ê°€ìš”",
            "ì¬ì¦ˆ,jazz,ë¸”ë£¨ìŠ¤,blues",
            "í´ë˜ì‹,classical,ì˜¤ì¼€ìŠ¤íŠ¸ë¼",
            "ë¨¹ë°©,mukbang,ì´íŒ…ì‡¼",
            "ì¼€ì´íŒ,kpop,í•œêµ­ìŒì•…",
            "í•œë¥˜,hallyu,korean wave",
            "ì›¹íˆ°,webtoon,ë§Œí™”",
            "ì¹˜í‚¨,chicken,ë‹­",
            "ë¼ë©´,ramen,noodle",
            "í•œêµ­ì–´,korean,í•œê¸€"
          ]
        }
      }
    }
  },
  "mappings": {
    "properties": {
      "video_id": {"type": "keyword"},
      "title": {
        "type": "text",
        "analyzer": "korean_synonym_analyzer",
        "search_analyzer": "search_analyzer",
        "fields": {
          "raw": {"type": "keyword"},
          "suggest": {"type": "completion"},
          "exact": {
            "type": "text",
            "analyzer": "korean_analyzer"
          }
        }
      },
      "youtube_channel_name": {
        "type": "text",
        "analyzer": "korean_synonym_analyzer",
        "search_analyzer": "search_analyzer",
        "fields": {
          "raw": {"type": "keyword"},
          "suggest": {"type": "completion"},
          "exact": {
            "type": "text",
            "analyzer": "korean_analyzer"
          }
        }
      },
      "youtube_channel_id": {"type": "keyword"},
      "country": {"type": "keyword"},
      "status_date": {"type": "date"},
      "daily_view_count": {"type": "long"},
      "subscriber_count": {"type": "long"},
      "duration_seconds": {"type": "integer"},
      "video_length_category": {"type": "keyword"},
      "primary_category": {"type": "keyword"},
      "vod_url": {"type": "keyword"},
      "keyword_normalized": {"type": "keyword", "normalizer": "lowercase_norm"},
      "description": {
        "type": "text",
        "analyzer": "korean_synonym_analyzer",
        "search_analyzer": "search_analyzer",
        "fields": {
          "raw": {"type": "keyword"},
          "exact": {
            "type": "text",
            "analyzer": "korean_analyzer"
          }
        }
      },
      "tags": {"type": "keyword"},
      "trending_score": {"type": "float"},
      "engagement_rate": {"type": "float"},
      "indexed_at": {"type": "date"}
    }
  }
}

### 4ë‹¨ê³„: ì„œë²„Â ì½”ë“œì—ì„œÂ ë™ì˜ì–´ ê²€ìƒ‰ ì¿¼ë¦¬ ìˆ˜ì •

Readserver.js L356-405

### 5ë‹¨ê³„: ë™ì˜ì–´ ê²€ìƒ‰ ë¡œì§Â ì¶”ê°€

The model provided an ambiguous search string to replace.

Grepped// ê°œì„ ëœ ê²€ìƒ‰ ì¿¼ë¦¬: í•œêµ­ì–´ ë¶„ì„ê¸° (server.js)

### 6ë‹¨ê³„: ë™ì˜ì–´ ê¸°ëŠ¥ í™œì„±í™”ë¥¼Â ìœ„í•œ ì—…ë°ì´íŠ¸Â ìŠ¤í¬ë¦½íŠ¸ ìƒì„±

update_synonyms.js(new)

+117

//Â ë™ì˜ì–´Â ê¸°ëŠ¥Â ì—…ë°ì´íŠ¸Â ìŠ¤í¬ë¦½íŠ¸

constÂ {Â ClientÂ }Â =Â require('@elastic/elasticsearch');

constÂ fsÂ =Â require('fs');

require('dotenv').config();

constÂ clientÂ =Â newÂ Client({Â 

Â Â node:Â process.env.ES_NODEÂ ||Â 'http://localhost:9200'Â 

});

constÂ INDEX_NAMEÂ =Â 'youtube_videos';
// ë™ì˜ì–´ ê¸°ëŠ¥ ì—…ë°ì´íŠ¸ ìŠ¤í¬ë¦½íŠ¸
const { Client } = require('@elastic/elasticsearch');
const fs = require('fs');
require('dotenv').config();

const client = new Client({ 
  node: process.env.ES_NODE || 'http://localhost:9200' 
});

const INDEX_NAME = 'youtube_videos';

async function updateSynonyms() {
  try {
    console.log('ğŸ”„ ë™ì˜ì–´ ê¸°ëŠ¥ ì—…ë°ì´íŠ¸ ì‹œì‘...');

    // 1. ê¸°ì¡´ ì¸ë±ìŠ¤ ë°±ì—… ë° ì‚­ì œ
    console.log('ğŸ“‚ ê¸°ì¡´ ì¸ë±ìŠ¤ í™•ì¸ ì¤‘...');
    const indexExists = await client.indices.exists({ index: INDEX_NAME });
    
    if (indexExists.body || indexExists) {
      console.log('ğŸ—‚ï¸ ê¸°ì¡´ ì¸ë±ìŠ¤ ë°œê²¬, ë°±ì—… ì¸ë±ìŠ¤ ìƒì„±...');
    
      // ê¸°ì¡´ ë°ì´í„°ë¥¼ ë°±ì—… ì¸ë±ìŠ¤ë¡œ ë³µì‚¬
      const backupIndexName = `${INDEX_NAME}_backup_${new Date().toISOString().split('T')[0]}`;
    
      await client.reindex({
        body: {
          source: { index: INDEX_NAME },
          dest: { index: backupIndexName }
        }
      });
    
      console.log(`âœ… ë°±ì—… ì™„ë£Œ: ${backupIndexName}`);
    
      // ê¸°ì¡´ ì¸ë±ìŠ¤ ì‚­ì œ
      await client.indices.delete({ index: INDEX_NAME });
      console.log('ğŸ—‘ï¸ ê¸°ì¡´ ì¸ë±ìŠ¤ ì‚­ì œ ì™„ë£Œ');
    }
    
    // 2. ìƒˆë¡œìš´ ë§¤í•‘ìœ¼ë¡œ ì¸ë±ìŠ¤ ìƒì„±
    console.log('ğŸ”§ ë™ì˜ì–´ ê¸°ëŠ¥ì´ í¬í•¨ëœ ìƒˆ ì¸ë±ìŠ¤ ìƒì„± ì¤‘...');
    
    const mappingConfig = JSON.parse(
      fs.readFileSync('./videos_mapping_with_synonyms.json', 'utf8')
    );
    
    await client.indices.create({
      index: INDEX_NAME,
      body: mappingConfig
    });
    
    console.log('âœ… ë™ì˜ì–´ ê¸°ëŠ¥ì´ í¬í•¨ëœ ìƒˆ ì¸ë±ìŠ¤ ìƒì„± ì™„ë£Œ');
    
    // 3. ë°±ì—… ë°ì´í„°ê°€ ìˆë‹¤ë©´ ë³µì›
    if (indexExists.body || indexExists) {
      console.log('ğŸ“¥ ë°±ì—… ë°ì´í„° ë³µì› ì¤‘...');
      const backupIndexName = `${INDEX_NAME}_backup_${new Date().toISOString().split('T')[0]}`;
    
      await client.reindex({
        body: {
          source: { index: backupIndexName },
          dest: { index: INDEX_NAME }
        }
      });
    
      console.log('âœ… ë°±ì—… ë°ì´í„° ë³µì› ì™„ë£Œ');
    
      // ë°±ì—… ì¸ë±ìŠ¤ ì‚­ì œ (ì„ íƒì‚¬í•­)
      // await client.indices.delete({ index: backupIndexName });
      // console.log('ğŸ—‘ï¸ ë°±ì—… ì¸ë±ìŠ¤ ì •ë¦¬ ì™„ë£Œ');
    }
    
    // 4. ë™ì˜ì–´ ë¶„ì„ê¸° í…ŒìŠ¤íŠ¸
    console.log('ğŸ§ª ë™ì˜ì–´ ë¶„ì„ê¸° í…ŒìŠ¤íŠ¸ ì¤‘...');
    
    const testTerms = ['ìŒì•…', 'ë®¤ì§', 'ìš”ë¦¬', 'ì¿ í‚¹'];
    
    for (const term of testTerms) {
      const response = await client.indices.analyze({
        index: INDEX_NAME,
        body: {
          analyzer: 'search_analyzer',
          text: term
        }
      });
    
      const tokens = response.body?.tokens || response.tokens || [];
      console.log(`ğŸ“ "${term}" ë¶„ì„ ê²°ê³¼:`, tokens.map(t => t.token).join(', '));
    }
    
    console.log('ğŸ‰ ë™ì˜ì–´ ê¸°ëŠ¥ ì—…ë°ì´íŠ¸ ì™„ë£Œ!');
    console.log('');
    console.log('âœ¨ ì´ì œ ë‹¤ìŒê³¼ ê°™ì€ ë™ì˜ì–´ ê²€ìƒ‰ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤:');
    console.log('   - "ìŒì•…" ê²€ìƒ‰ ì‹œ â†’ "ë®¤ì§", "music", "ë…¸ë˜" í¬í•¨ ê²°ê³¼');
    console.log('   - "ìš”ë¦¬" ê²€ìƒ‰ ì‹œ â†’ "ì¿ í‚¹", "cooking", "ë ˆì‹œí”¼" í¬í•¨ ê²°ê³¼');
    console.log('   - "ê²Œì„" ê²€ìƒ‰ ì‹œ â†’ "ê²Œì´ë°", "gaming", "í”Œë ˆì´" í¬í•¨ ê²°ê³¼');

  } catch (error) {
    console.error('âŒ ë™ì˜ì–´ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
    throw error;
  }
}

// ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
if (require.main === module) {
  updateSynonyms()
    .then(() => {
      console.log('ì—…ë°ì´íŠ¸ ì™„ë£Œ');
      process.exit(0);
    })
    .catch((error) => {
      console.error('ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
      process.exit(1);
    });
}

module.exports = { updateSynonyms };

### 7ë‹¨ê³„: ë™ì˜ì–´ ê´€ë¦¬ë¥¼Â ìœ„í•œ APIÂ ì—”ë“œí¬ì¸íŠ¸ ì¶”ê°€

synonym_manager.js(new)

+163

//Â ë™ì˜ì–´Â ê´€ë¦¬Â ëª¨ë“ˆ

classÂ SynonymManagerÂ {

Â Â constructor()Â {

Â Â Â Â //Â ê¸°ë³¸Â ë™ì˜ì–´Â ë§¤í•‘

Â Â Â Â this.synonymMappingÂ =Â newÂ Map([

Â Â Â Â Â Â //Â ìŒì•…Â ê´€ë ¨

Â Â Â Â Â Â ['ìŒì•…',Â ['ë®¤ì§',Â 'music',Â 'ë…¸ë˜',Â 'song',Â 'ê³¡']],

Â Â Â Â Â Â ['ë®¤ì§',Â ['ìŒì•…',Â 'music',Â 'ë…¸ë˜',Â 'song',Â 'ê³¡']],

Â Â Â Â Â Â ['music',Â ['ìŒì•…',Â 'ë®¤ì§',Â 'ë…¸ë˜',Â 'song',Â 'ê³¡']],
Â Â Â Â Â Â // ë™ì˜ì–´ ê´€ë¦¬ ëª¨ë“ˆ
class SynonymManager {
  constructor() {
    // ê¸°ë³¸ ë™ì˜ì–´ ë§¤í•‘
    this.synonymMapping = new Map([
      // ìŒì•… ê´€ë ¨
      ['ìŒì•…', ['ë®¤ì§', 'music', 'ë…¸ë˜', 'song', 'ê³¡']],
      ['ë®¤ì§', ['ìŒì•…', 'music', 'ë…¸ë˜', 'song', 'ê³¡']],
      ['music', ['ìŒì•…', 'ë®¤ì§', 'ë…¸ë˜', 'song', 'ê³¡']],

      // ìš”ë¦¬ ê´€ë ¨
      ['ìš”ë¦¬', ['ì¿ í‚¹', 'cooking', 'ë ˆì‹œí”¼', 'recipe']],
      ['ì¿ í‚¹', ['ìš”ë¦¬', 'cooking', 'ë ˆì‹œí”¼', 'recipe']],
      ['cooking', ['ìš”ë¦¬', 'ì¿ í‚¹', 'ë ˆì‹œí”¼', 'recipe']],
    
      // ê²Œì„ ê´€ë ¨
      ['ê²Œì„', ['ê²Œì´ë°', 'gaming', 'í”Œë ˆì´', 'game']],
      ['ê²Œì´ë°', ['ê²Œì„', 'gaming', 'í”Œë ˆì´', 'game']],
      ['gaming', ['ê²Œì„', 'ê²Œì´ë°', 'í”Œë ˆì´', 'game']],
    
      // ë·°í‹° ê´€ë ¨
      ['ë·°í‹°', ['ë¯¸ìš©', 'beauty', 'í™”ì¥', 'ë©”ì´í¬ì—…', 'makeup']],
      ['ë¯¸ìš©', ['ë·°í‹°', 'beauty', 'í™”ì¥', 'ë©”ì´í¬ì—…', 'makeup']],
      ['beauty', ['ë·°í‹°', 'ë¯¸ìš©', 'í™”ì¥', 'ë©”ì´í¬ì—…', 'makeup']],
    
      // ìš´ë™ ê´€ë ¨
      ['ìš´ë™', ['ìŠ¤í¬ì¸ ', 'sports', 'í—¬ìŠ¤', 'fitness', 'workout']],
      ['ìŠ¤í¬ì¸ ', ['ìš´ë™', 'sports', 'í—¬ìŠ¤', 'fitness', 'workout']],
      ['í—¬ìŠ¤', ['ìš´ë™', 'sports', 'ìŠ¤í¬ì¸ ', 'fitness', 'workout']],
    
      // ì—¬í–‰ ê´€ë ¨
      ['ì—¬í–‰', ['íŠ¸ë˜ë¸”', 'travel', 'ì—¬í–‰ê¸°', 'trip']],
      ['íŠ¸ë˜ë¸”', ['ì—¬í–‰', 'travel', 'ì—¬í–‰ê¸°', 'trip']],
      ['travel', ['ì—¬í–‰', 'íŠ¸ë˜ë¸”', 'ì—¬í–‰ê¸°', 'trip']],
    
      // ë¦¬ë·° ê´€ë ¨
      ['ë¦¬ë·°', ['í›„ê¸°', 'review', 'í‰ê°€', 'í‰ì ']],
      ['í›„ê¸°', ['ë¦¬ë·°', 'review', 'í‰ê°€', 'í‰ì ']],
      ['review', ['ë¦¬ë·°', 'í›„ê¸°', 'í‰ê°€', 'í‰ì ']],
    
      // ë¨¹ë°© ê´€ë ¨
      ['ë¨¹ë°©', ['eating', 'food', 'ìŒì‹', 'mukbang']],
      ['eating', ['ë¨¹ë°©', 'food', 'ìŒì‹', 'mukbang']],
      ['food', ['ë¨¹ë°©', 'eating', 'ìŒì‹', 'mukbang']],
    
      // ëŒ„ìŠ¤ ê´€ë ¨
      ['ëŒ„ìŠ¤', ['ì¶¤', 'dance', 'ì•ˆë¬´', 'choreography']],
      ['ì¶¤', ['ëŒ„ìŠ¤', 'dance', 'ì•ˆë¬´', 'choreography']],
      ['dance', ['ëŒ„ìŠ¤', 'ì¶¤', 'ì•ˆë¬´', 'choreography']],
    
      // ì½”ë¯¸ë”” ê´€ë ¨
      ['ì½”ë¯¸ë””', ['ê°œê·¸', 'comedy', 'ì›ƒê¸´', 'funny']],
      ['ê°œê·¸', ['ì½”ë¯¸ë””', 'comedy', 'ì›ƒê¸´', 'funny']],
      ['comedy', ['ì½”ë¯¸ë””', 'ê°œê·¸', 'ì›ƒê¸´', 'funny']],
    
      // ë“œë¼ë§ˆ ê´€ë ¨
      ['ë“œë¼ë§ˆ', ['ì‹œë¦¬ì¦ˆ', 'series', 'ì—°ì†ê·¹', 'drama']],
      ['ì‹œë¦¬ì¦ˆ', ['ë“œë¼ë§ˆ', 'series', 'ì—°ì†ê·¹', 'drama']],
      ['series', ['ë“œë¼ë§ˆ', 'ì‹œë¦¬ì¦ˆ', 'ì—°ì†ê·¹', 'drama']],
    
      // ì˜í™” ê´€ë ¨
      ['ì˜í™”', ['movie', 'film', 'ì‹œë„¤ë§ˆ', 'cinema']],
      ['movie', ['ì˜í™”', 'film', 'ì‹œë„¤ë§ˆ', 'cinema']],
      ['film', ['ì˜í™”', 'movie', 'ì‹œë„¤ë§ˆ', 'cinema']],
    
      // ì• ë‹ˆë©”ì´ì…˜ ê´€ë ¨
      ['ì• ë‹ˆë©”ì´ì…˜', ['ì• ë‹ˆ', 'anime', 'ë§Œí™”', 'animation']],
      ['ì• ë‹ˆ', ['ì• ë‹ˆë©”ì´ì…˜', 'anime', 'ë§Œí™”', 'animation']],
      ['anime', ['ì• ë‹ˆë©”ì´ì…˜', 'ì• ë‹ˆ', 'ë§Œí™”', 'animation']],
    
      // êµìœ¡ ê´€ë ¨
      ['êµìœ¡', ['í•™ìŠµ', 'education', 'ê°•ì˜', 'lecture']],
      ['í•™ìŠµ', ['êµìœ¡', 'education', 'ê°•ì˜', 'lecture']],
      ['ê°•ì˜', ['êµìœ¡', 'í•™ìŠµ', 'education', 'lecture']],
    
      // ë‰´ìŠ¤ ê´€ë ¨
      ['ë‰´ìŠ¤', ['ì†Œì‹', 'news', 'ì •ë³´', 'information']],
      ['ì†Œì‹', ['ë‰´ìŠ¤', 'news', 'ì •ë³´', 'information']],
      ['news', ['ë‰´ìŠ¤', 'ì†Œì‹', 'ì •ë³´', 'information']],
    
      // K-Pop ê´€ë ¨
      ['ì¼€ì´íŒ', ['kpop', 'k-pop', 'í•œêµ­ìŒì•…', 'korean music']],
      ['kpop', ['ì¼€ì´íŒ', 'k-pop', 'í•œêµ­ìŒì•…', 'korean music']],
      ['k-pop', ['ì¼€ì´íŒ', 'kpop', 'í•œêµ­ìŒì•…', 'korean music']]
    ]);

  }

  // ë™ì˜ì–´ í™•ì¥
  expandSynonyms(keyword) {
    const normalizedKeyword = keyword.toLowerCase().trim();
    const synonyms = this.synonymMapping.get(normalizedKeyword) || [];
    return [normalizedKeyword, ...synonyms];
  }

  // ê²€ìƒ‰ í‚¤ì›Œë“œ í™•ì¥ (í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œìš©)
  expandSearchKeywords(keywords) {
    const expandedKeywords = new Set();

    keywords.forEach(keyword => {
      const synonyms = this.expandSynonyms(keyword);
      synonyms.forEach(synonym => expandedKeywords.add(synonym));
    });
    
    return Array.from(expandedKeywords);

  }

  // ë™ì˜ì–´ ì¶”ê°€
  addSynonym(keyword, synonyms) {
    const normalizedKeyword = keyword.toLowerCase().trim();
    const normalizedSynonyms = synonyms.map(s => s.toLowerCase().trim());

    // ì–‘ë°©í–¥ ë§¤í•‘ ì¶”ê°€
    this.synonymMapping.set(normalizedKeyword, normalizedSynonyms);
    
    normalizedSynonyms.forEach(synonym => {
      const existing = this.synonymMapping.get(synonym) || [];
      if (!existing.includes(normalizedKeyword)) {
        existing.push(normalizedKeyword);
        this.synonymMapping.set(synonym, existing);
      }
    });

  }

  // ë™ì˜ì–´ ì œê±°
  removeSynonym(keyword) {
    const normalizedKeyword = keyword.toLowerCase().trim();
    const synonyms = this.synonymMapping.get(normalizedKeyword) || [];

    // ì–‘ë°©í–¥ ë§¤í•‘ ì œê±°
    synonyms.forEach(synonym => {
      const synonymList = this.synonymMapping.get(synonym) || [];
      const updatedList = synonymList.filter(s => s !== normalizedKeyword);
      if (updatedList.length > 0) {
        this.synonymMapping.set(synonym, updatedList);
      } else {
        this.synonymMapping.delete(synonym);
      }
    });
    
    this.synonymMapping.delete(normalizedKeyword);

  }

  // ëª¨ë“  ë™ì˜ì–´ ì¡°íšŒ
  getAllSynonyms() {
    const result = {};
    this.synonymMapping.forEach((synonyms, keyword) => {
      result[keyword] = synonyms;
    });
    return result;
  }

  // ê²€ìƒ‰ ì œì•ˆ ìƒì„±
  getSuggestionsForKeyword(keyword) {
    const synonyms = this.expandSynonyms(keyword);
    return synonyms.map(synonym => ({
      text: synonym,
      type: synonym === keyword.toLowerCase() ? 'original' : 'synonym',
      boost: synonym === keyword.toLowerCase() ? 1.0 : 0.8
    }));
  }
}

module.exports = SynonymManager;

## ğŸ“‹ êµ¬í˜„ ë‹¨ê³„ë³„Â ìš”ì•½

### ë³€ê²½ì :

1. ë™ì˜ì–´ ì‚¬ì „ íŒŒì¼Â (synonyms.txt) ìƒì„±

2. ìƒˆë¡œìš´Â ElasticsearchÂ ë§¤í•‘Â (videos_mapping_with_synonyms.json) ìƒì„±

3. ì—…ë°ì´íŠ¸Â ìŠ¤í¬ë¦½íŠ¸Â (update_synonyms.js) ìƒì„±

4. ë™ì˜ì–´ ê´€ë¦¬Â ëª¨ë“ˆÂ (synonym_manager.js) ìƒì„±

### ì˜í–¥ë„:

- ê¸°ì¡´ ê¸°ëŠ¥: ì˜í–¥ ì—†ìŒ (ê¸°ì¡´ ê²€ìƒ‰ ë¡œì§ ìœ ì§€)

- ìƒˆë¡œìš´ ê¸°ëŠ¥:Â ë™ì˜ì–´ í™•ì¥ ê²€ìƒ‰Â ì¶”ê°€

- ì„±ëŠ¥: ì•½ê°„ì˜Â ì¸ë±ì‹± ì‹œê°„ ì¦ê°€, ê²€ìƒ‰ ì •í™•ë„ í–¥ìƒ

### ë¡¤ë°± ê³„íš:

ì—…ë°ì´íŠ¸ ìŠ¤í¬ë¦½íŠ¸ê°€Â ìë™ìœ¼ë¡œ ë°±ì—…Â ì¸ë±ìŠ¤Â ìƒì„±í•˜ë¯€ë¡œ ë¬¸ì œ ì‹œÂ ì¦‰ì‹œ ë³µêµ¬Â ê°€ëŠ¥

### ë‹¤ìŒ ë‹¨ê³„:

1. nodeÂ update_synonyms.jsÂ ì‹¤í–‰í•˜ì—¬ ë™ì˜ì–´ ê¸°ëŠ¥Â í™œì„±í™”

2. ì„œë²„Â ì¬ì‹œì‘í•˜ì—¬ ìƒˆë¡œìš´ ê²€ìƒ‰ ë¡œì§ ì ìš©

3. "ìŒì•…"Â â†’Â "ë®¤ì§" ê²€ìƒ‰ í…ŒìŠ¤íŠ¸ë¡œÂ ë™ì‘Â í™•ì¸

ê²€ì¦: ë™ì˜ì–´ ë§¤í•‘ íŒŒì¼ê³¼Â Elasticsearch ë¶„ì„ê¸°Â ì„¤ì •ì´ ì •í™•íˆÂ êµ¬ì„±ë¨

ì •í™•ë„: 90%

ê·¼ê±°: Elasticsearch ê³µì‹ ë¬¸ì„œì˜Â ë™ì˜ì–´ í•„í„°Â ì„¤ì • ë°©ì‹ì„Â ì •í™•íˆ ë”°ëìœ¼ë©°, í•œêµ­ì–´ íŠ¹í™” ë™ì˜ì–´ ë§¤í•‘ì„ í¬í•¨í•¨

ElasticsearchÂ ìºì‹œ ìš°ì„  ë¡œì§Â êµ¬í˜„ í›„Â ê²€ìƒ‰ ì†ë„ê°€Â ëŠë ¤ì§„ ì›ì¸ ë¶„ì„

ê°€ì •/ì œì•½: ê¸°ì¡´ 30ì´ˆì—ì„œ 62ì´ˆë¡œÂ 2ë°° ì´ìƒ ëŠë ¤ì§„Â ìƒí™©, ì‹¤ì œ ì½”ë“œ í™•ì¸ í•„ìš”

Readserver.js L805-885

Readserver.js L333-370

Readserver.js L420-480

Greppedê²€ìƒ‰ ì™„ë£Œ.*ì´ ì†Œìš”ì‹œê°„.*62\.31ì´ˆ (*.txt)

Readlog.txt L3670-3679

## ğŸ”Â ì„±ëŠ¥ ì €í•˜ ì›ì¸ ë¶„ì„

### âš ï¸Â ì£¼ìš” ì›ì¸ë“¤

#### 1.Â ìºì‹œ í™•ì¸ ì˜¤ë²„í—¤ë“œ

í˜„ì¬ êµ¬í˜„ëœÂ ìºì‹œ ë¡œì§ì—ì„œ ì„±ëŠ¥ ì €í•˜ë¥¼ ì¼ìœ¼í‚¤ëŠ” ìš”ì†Œë“¤:

ğŸ“ŠÂ ìºì‹œ í™•ì¸ ë‹¨ê³„ì—ì„œì˜ ì§€ì—°

- countResponseÂ - ì „ì²´ ì¹´ìš´íŠ¸ ì¡°íšŒÂ (lineÂ 433-436)

- freshnessResponseÂ - ìµœì‹ ì„±Â í™•ì¸Â ì¿¼ë¦¬ (line 449-452)

- ë³µì¡í•œ ê²€ìƒ‰ ì¡°ê±´Â êµ¬ì„± (line 356-402)

#### 2.Â ì¤‘ë³µ ê²€ìƒ‰ ìˆ˜í–‰

text

ê¸°ì¡´:Â YouTubeÂ APIÂ ì§ì ‘Â í˜¸ì¶œÂ (1íšŒ)

í˜„ì¬:Â ESÂ ìºì‹œÂ í™•ì¸Â (2íšŒÂ ì¿¼ë¦¬)Â +Â YouTubeÂ APIÂ í˜¸ì¶œÂ (1íšŒ)

#### 3.Â ë³µì¡í•œ ì¿¼ë¦¬ ë¡œì§

- í•œêµ­ì–´ ë¶„ì„ê¸° +Â í¼ì§€Â ë§¤ì¹­ + ë‹¤ì¤‘Â í•„ë“œÂ ê²€ìƒ‰

- shouldÂ ì ˆÂ 6ê°œë¡œÂ êµ¬ì„±ëœÂ ë³µì¡í•œ boolÂ ì¿¼ë¦¬

### ğŸ“ˆÂ ì„±ëŠ¥ ì €í•˜ ê³„ì‚°

ì˜ˆìƒÂ ì²˜ë¦¬ ì‹œê°„:

- ESÂ ìºì‹œ í™•ì¸:Â ~5-10ì´ˆ

- YouTube API í˜¸ì¶œ: ~30ì´ˆ

- ê²°ê³¼ ì²˜ë¦¬: ~2-5ì´ˆ

- ì´í•©: ~37-45ì´ˆ

í•˜ì§€ë§ŒÂ 62ì´ˆê°€Â ë‚˜ì˜¨Â ì´ìœ :

#### 4.Â ìºì‹œ ë¯¸ìŠ¤ ì‹œë‚˜ë¦¬ì˜¤

javascript

//Â lineÂ 463:Â ìºì‹œÂ íˆíŠ¸Â ì¡°ê±´

constÂ cacheHitÂ =Â availableCountÂ >=Â requestedCountÂ &&Â isFresh;

"korea/í‚¤ì›Œë“œÂ ì—†ìŒ/100ê±´"Â ê²€ìƒ‰ì—ì„œ:

- availableCountÂ <Â 100Â (ìºì‹œëœÂ koreaÂ ë°ì´í„°ê°€Â 100ê°œÂ ë¯¸ë§Œ)

- ë˜ëŠ”Â isFresh =Â falseÂ (48ì‹œê°„ ì´ë‚´Â ë°ì´í„°ê°€Â ì•„ë‹˜)

ê²°ê³¼ì ìœ¼ë¡œÂ ìºì‹œ ë¯¸ìŠ¤Â â†’Â YouTubeÂ API í˜¸ì¶œÂ â†’Â ê¸°ì¡´ë³´ë‹¤ ë” ì˜¤ë˜Â ê±¸ë¦¼

### ğŸ› ï¸Â ì„±ëŠ¥ ë¬¸ì œ í•´ê²° ë°©ì•ˆ

#### ì¦‰ì‹œÂ ê°œì„  ê°€ëŠ¥í•œ ë°©ë²•ë“¤:

1. ìºì‹œÂ í™•ì¸Â ì¿¼ë¦¬ ìµœì í™”
- countÂ ì¿¼ë¦¬ë¥¼Â aggregationìœ¼ë¡œ ë³€ê²½

- ë¶ˆí•„ìš”í•œ sortÂ ì œê±°
1. ìºì‹œ íˆíŠ¸ ì¡°ê±´ ì™„í™”
- requestedCountì˜Â 80%ë§ŒÂ ìˆì–´ë„ ìºì‹œ íˆíŠ¸Â ì¸ì •

- TTL ì‹œê°„ ì—°ì¥Â (48ì‹œê°„ â†’ 72ì‹œê°„)
1. ë³‘ë ¬ ì²˜ë¦¬ ë„ì…
- ìºì‹œ í™•ì¸ê³¼Â YouTube API í˜¸ì¶œì„Â ë³‘ë ¬ë¡œ
1. ë¶€ë¶„Â ìºì‹œ í™œìš©
- ìºì‹œì—Â 50ê°œ ìˆìœ¼ë©´ 50ê°œëŠ”Â ESì—ì„œ, ë‚˜ë¨¸ì§€ëŠ” APIì—ì„œ

### ğŸ’¡Â ê·¼ë³¸Â ì›ì¸

ìºì‹œ ë¡œì§ ìì²´ê°€Â ë¬¸ì œê°€Â ì•„ë‹ˆë¼,Â ìºì‹œê°€Â ì œëŒ€ë¡œ ë™ì‘í•˜ì§€Â ì•Šì•„ì„œÂ ë§¤ë²ˆ YouTubeÂ APIë¥¼Â í˜¸ì¶œí•˜ê²ŒÂ ë˜ì–´Â ì˜¤íˆë ¤ ë” ëŠë ¤ì§„Â ê²ƒì…ë‹ˆë‹¤.

ë³€ê²½ì :Â ìºì‹œ í™•ì¸ ë¡œì§ì´Â ì¶”ê°€ë˜ë©´ì„œ ì˜¤ë²„í—¤ë“œÂ ë°œìƒ

ì˜í–¥ë„: ìºì‹œ íˆíŠ¸Â ì‹œì—ëŠ”Â ë¹¨ë¼ì§€ì§€ë§Œ,Â ìºì‹œ ë¯¸ìŠ¤ ì‹œì—ëŠ” ë”Â ëŠë ¤ì§

ê²€ì¦: ì‹¤ì œÂ ë¡œê·¸ì—ì„œ ìºì‹œÂ ë¯¸ìŠ¤ê°€Â ë¹ˆë²ˆíˆ ë°œìƒí•˜ê³ Â ìˆìŒÂ í™•ì¸

ì •í™•ë„: 95%

ê·¼ê±°: ì‹¤ì œ ì½”ë“œÂ ë¶„ì„ ê²°ê³¼Â ìºì‹œ í™•ì¸ ê³¼ì •ì—ì„œÂ 2ë²ˆì˜Â ESÂ ì¿¼ë¦¬ê°€ ì¶”ê°€ë˜ê³ ,Â ìºì‹œ ë¯¸ìŠ¤Â ì‹œÂ YouTubeÂ APIê¹Œì§€ í˜¸ì¶œí•˜ì—¬Â ì´Â ì²˜ë¦¬ ì‹œê°„ì´ ì¦ê°€í•¨ì„Â í™•ì¸í–ˆìŒ.

## 1ë‹¨ê³„: server.jsì˜Â ê²€ìƒ‰ ì¿¼ë¦¬Â ë¡œì§ ìˆ˜ì •

Readserver.js L356-403

The model provided an ambiguous search string to replace.

Grepped// ê°œì„ ëœ ê²€ìƒ‰ ì¿¼ë¦¬: í•œêµ­ì–´ ë¶„ì„ê¸°.*í¼ì§€ ë§¤ì¹­.*ë™ì˜ì–´ í™•ì¥ (server.js)

Readserver.js L490-540

### ì²« ë²ˆì§¸ ê²€ìƒ‰Â ì¿¼ë¦¬ ë¡œì§ì„Â ë¨¼ì € ìˆ˜ì •í•˜ê² ìŠµë‹ˆë‹¤Â (checkCacheHit ë©”ì„œë“œ ë‚´ë¶€):

server.js

  // ìºì‹œ íˆíŠ¸ íŒë‹¨
  async checkCacheHit(searchParams) {
    if (!this.client || !(await checkESConnection())) return { hit: false, reason: 'ES client not available' };

    try {
      const { country, keyword, minViews, maxViews, maxResults, publishedAfter, publishedBefore } = searchParams;
    
      // ê²€ìƒ‰ ì¡°ê±´ êµ¬ì„±
      const mustQueries = [];
      const filterQueries = [];
    
      if (country && country !== 'worldwide') {
        mustQueries.push({ term: { country } });
      }
    
      if (keyword && keyword.trim()) {
        // ê°œì„ ëœ ê²€ìƒ‰ ì¿¼ë¦¬: í•œêµ­ì–´ ë¶„ì„ê¸° + í¼ì§€ ë§¤ì¹­ + ë™ì˜ì–´ í™•ì¥
        const searchKeyword = keyword.trim();
    
        // ë™ì˜ì–´ ë§¤í•‘ (ì„œë²„ ì‚¬ì´ë“œ ì„ì‹œ)
        const synonymMap = {
          'ìŒì•…': ['ë®¤ì§', 'music', 'ë…¸ë˜', 'song', 'ê³¡'],
          'ë®¤ì§': ['ìŒì•…', 'music', 'ë…¸ë˜', 'song', 'ê³¡'],
          'music': ['ìŒì•…', 'ë®¤ì§', 'ë…¸ë˜', 'song', 'ê³¡'],
          'ìš”ë¦¬': ['ì¿ í‚¹', 'cooking', 'ë ˆì‹œí”¼', 'recipe'],
          'ì¿ í‚¹': ['ìš”ë¦¬', 'cooking', 'ë ˆì‹œí”¼', 'recipe'],
          'cooking': ['ìš”ë¦¬', 'ì¿ í‚¹', 'ë ˆì‹œí”¼', 'recipe'],
          'ê²Œì„': ['ê²Œì´ë°', 'gaming', 'í”Œë ˆì´', 'game'],
          'ê²Œì´ë°': ['ê²Œì„', 'gaming', 'í”Œë ˆì´', 'game'],
          'gaming': ['ê²Œì„', 'ê²Œì´ë°', 'í”Œë ˆì´', 'game'],
          'ë·°í‹°': ['ë¯¸ìš©', 'beauty', 'í™”ì¥', 'ë©”ì´í¬ì—…', 'makeup'],
          'ë¯¸ìš©': ['ë·°í‹°', 'beauty', 'í™”ì¥', 'ë©”ì´í¬ì—…', 'makeup'],
          'beauty': ['ë·°í‹°', 'ë¯¸ìš©', 'í™”ì¥', 'ë©”ì´í¬ì—…', 'makeup'],
          'ìš´ë™': ['ìŠ¤í¬ì¸ ', 'sports', 'í—¬ìŠ¤', 'fitness', 'workout'],
          'ìŠ¤í¬ì¸ ': ['ìš´ë™', 'sports', 'í—¬ìŠ¤', 'fitness', 'workout'],
          'í—¬ìŠ¤': ['ìš´ë™', 'sports', 'ìŠ¤í¬ì¸ ', 'fitness', 'workout'],
          'ì—¬í–‰': ['íŠ¸ë˜ë¸”', 'travel', 'ì—¬í–‰ê¸°', 'trip'],
          'íŠ¸ë˜ë¸”': ['ì—¬í–‰', 'travel', 'ì—¬í–‰ê¸°', 'trip'],
          'travel': ['ì—¬í–‰', 'íŠ¸ë˜ë¸”', 'ì—¬í–‰ê¸°', 'trip'],
          'ë¦¬ë·°': ['í›„ê¸°', 'review', 'í‰ê°€', 'í‰ì '],
          'í›„ê¸°': ['ë¦¬ë·°', 'review', 'í‰ê°€', 'í‰ì '],
          'review': ['ë¦¬ë·°', 'í›„ê¸°', 'í‰ê°€', 'í‰ì '],
          'ë¨¹ë°©': ['eating', 'food', 'ìŒì‹', 'mukbang'],
          'eating': ['ë¨¹ë°©', 'food', 'ìŒì‹', 'mukbang'],
          'food': ['ë¨¹ë°©', 'eating', 'ìŒì‹', 'mukbang']
        };
    
        // ë™ì˜ì–´ í™•ì¥ëœ í‚¤ì›Œë“œ ëª©ë¡ ìƒì„±
        const expandedKeywords = [searchKeyword];
        const lowerKeyword = searchKeyword.toLowerCase();
        if (synonymMap[lowerKeyword]) {
          expandedKeywords.push(...synonymMap[lowerKeyword]);
        }
    
        // í™•ì¥ëœ í‚¤ì›Œë“œë“¤ë¡œ OR ê²€ìƒ‰ êµ¬ì„±
        const keywordQueries = expandedKeywords.map(kw => ({
          bool: {
            should: [
              // 1. í•œêµ­ì–´ ë¶„ì„ê¸°ë¥¼ ì‚¬ìš©í•œ ì •í™•í•œ ë§¤ì¹­
              {
                match: {
                  title: {
                    query: kw,
                    analyzer: "korean_analyzer",
                    boost: kw === searchKeyword ? 4 : 3 // ì›ë³¸ í‚¤ì›Œë“œì— ë” ë†’ì€ ì ìˆ˜
                  }
                }
              },
              // 2. ì±„ë„ëª… ë§¤ì¹­
              {
                match: {
                  youtube_channel_name: {
                    query: kw,
                    analyzer: "korean_analyzer",
                    boost: kw === searchKeyword ? 3 : 2
                  }
                }
              }
            ],
            minimum_should_match: 1
          }
        }));
    
        mustQueries.push({
          bool: {
            should: [
              ...keywordQueries,
              // 3. í¼ì§€ ë§¤ì¹­ (ì˜¤íƒ€ í—ˆìš©) - ì›ë³¸ í‚¤ì›Œë“œë§Œ
              {
                fuzzy: {
                  title: {
                    value: searchKeyword,
                    fuzziness: "AUTO",
                    boost: 1
                  }
                }
              },
              // 4. ê¸°ì¡´ í‚¤ì›Œë“œ ì •ê·œí™” ë§¤ì¹­ (í˜¸í™˜ì„± ìœ ì§€)
              {
                term: { 
                  keyword_normalized: searchKeyword.toLowerCase(),
                  boost: 0.5
                }
              }
            ],
            minimum_should_match: 1
          }
        });
      }urrentKey.usageCount % 5 === 0) {
      this.saveKeyStatus();
    }
    
    const youtube = google.youtube({ version: 'v3', auth: currentKey.key });
    
    // YouTube ì¸ìŠ¤í„´ìŠ¤ì™€ í‚¤ ì •ë³´ë¥¼ í•¨ê»˜ ë°˜í™˜
    return {
      youtube: youtube,
      currentKey: currentKey
    };

  }

  // í• ë‹¹ëŸ‰ ì´ˆê³¼ ì²˜ë¦¬ - ê°œì„ ëœ ë¡œì§ (suspended í‚¤ ì²˜ë¦¬ í¬í•¨)
  markKeyAsQuotaExceeded(currentKey, errorMessage = '') {
    if (!currentKey) return null;

    console.log(`âŒ ${currentKey.name} ì˜¤ë¥˜ ë°œìƒ: ${errorMessage}`);
    
    // API í‚¤ ì¼ì‹œì •ì§€(suspended) ì²˜ë¦¬ - ìš°íšŒ ì²˜ë¦¬
    if (errorMessage.includes('suspended') || errorMessage.includes('has been suspended')) {
      console.log(`ğŸš¨ ${currentKey.name} API í‚¤ ì¼ì‹œì •ì§€ ê°ì§€ - ë‹¤ë¥¸ í‚¤ë¡œ ìš°íšŒ`);
      console.log(`ğŸ”„ ì¼ì‹œì  ë¬¸ì œì¼ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ë‹¤ë¥¸ í‚¤ ì‚¬ìš© í›„ ì¬ì‹œë„`);
      // ì˜êµ¬ ë¹„í™œì„±í™”í•˜ì§€ ì•Šê³  ë‹¨ìˆœíˆ ë‹¤ë¥¸ í‚¤ë¡œ ì „í™˜ë§Œ í•¨
      return this.getNextKeyRoundRobin();
    }
    // í• ë‹¹ëŸ‰ ê´€ë ¨ ì˜¤ë¥˜ì¸ì§€ í™•ì¸
    else if (errorMessage.includes('quota') || errorMessage.includes('quotaExceeded') || 
        errorMessage.includes('dailyLimitExceeded') || errorMessage.includes('rateLimitExceeded')) {
      currentKey.quotaExceeded = true;
      console.log(`ğŸš« ${currentKey.name} í• ë‹¹ëŸ‰ ì´ˆê³¼ë¡œ ë¹„í™œì„±í™”ë¨`);
    } else {
      // ë‹¤ë¥¸ ì˜¤ë¥˜ì˜ ê²½ìš° ì—°ì† ì˜¤ë¥˜ íšŸìˆ˜ ì¦ê°€
      currentKey.consecutiveErrors++;
      console.log(`âš ï¸ ${currentKey.name} ì—°ì† ì˜¤ë¥˜ íšŸìˆ˜: ${currentKey.consecutiveErrors}`);
    
      // ì—°ì† ì˜¤ë¥˜ê°€ 3íšŒ ì´ìƒì´ë©´ ì„ì‹œ ë¹„í™œì„±í™”
      if (currentKey.consecutiveErrors >= 3) {
        console.log(`ğŸ”’ ${currentKey.name} ì—°ì† ì˜¤ë¥˜ë¡œ ì„ì‹œ ë¹„í™œì„±í™” (í• ë‹¹ëŸ‰ ì´ˆê³¼ëŠ” ì•„ë‹˜)`);
      }
    }
    
    // ìƒíƒœ ë³€ê²½ ì €ì¥
    this.saveKeyStatus();
    
    // ë‹¤ìŒ ì‚¬ìš© ê°€ëŠ¥í•œ í‚¤ ì°¾ê¸°
    const nextKey = this.getCurrentKey();
    
    if (nextKey) {
      console.log(`ğŸ”„ ${nextKey.name}ìœ¼ë¡œ ì „í™˜í•©ë‹ˆë‹¤.`);
      return nextKey;
    } else {
      console.log('âš ï¸ ì‚¬ìš© ê°€ëŠ¥í•œ API í‚¤ê°€ ì—†ìŠµë‹ˆë‹¤.');
      return null;
    }

  }

  // API í˜¸ì¶œ ì„±ê³µ ì‹œ ì—°ì† ì˜¤ë¥˜ ì¹´ìš´í„° ë¦¬ì…‹
  markKeyAsSuccessful(currentKey) {
    if (currentKey && currentKey.consecutiveErrors > 0) {
      console.log(`âœ… ${currentKey.name} ì„±ê³µ, ì—°ì† ì˜¤ë¥˜ ì¹´ìš´í„° ë¦¬ì…‹`);
      currentKey.consecutiveErrors = 0;
      this.saveKeyStatus();
    }
  }

  // ì‚¬ìš© ê°€ëŠ¥í•œ í‚¤ê°€ ìˆëŠ”ì§€ í™•ì¸
  hasAvailableKeys() {
    return this.apiKeys.some(keyInfo => !keyInfo.quotaExceeded);
  }

  // í• ë‹¹ëŸ‰ ì´ˆê³¼ ì²˜ë¦¬ë¥¼ í¬í•¨í•œ ì•ˆì „í•œ YouTube ì¸ìŠ¤í„´ìŠ¤ ë°˜í™˜
  async getYouTubeInstanceSafely() {
    const maxRetries = this.apiKeys.length;
    let currentRetry = 0;

    while (currentRetry < maxRetries) {
      const currentKey = this.getCurrentKey();
    
      if (!currentKey || currentKey.quotaExceeded) {
        console.log('ì‚¬ìš© ê°€ëŠ¥í•œ API í‚¤ê°€ ì—†ìŒ');
        return null;
      }
    
      currentKey.usageCount++;
      currentKey.lastUsed = new Date();
      console.log(`ğŸ”‘ ì‚¬ìš© ì¤‘ì¸ API í‚¤: ${currentKey.name} (ì‚¬ìš©íšŸìˆ˜: ${currentKey.usageCount})`);
    
      const youtube = google.youtube({ version: 'v3', auth: currentKey.key });
      return { youtube, currentKey };
    }
    
    return null;

  }

  // ìƒíƒœ íŒŒì¼ì—ì„œ API í‚¤ ìƒíƒœ ë¡œë“œ
  loadKeyStatus() {
    try {
      if (fs.existsSync(this.statusFile)) {
        const status = JSON.parse(fs.readFileSync(this.statusFile, 'utf8'));
        const today = new Date().toDateString();

        // ë‹¹ì¼ì´ ì•„ë‹ˆë©´ ìƒíƒœ ë¦¬ì…‹ (ì¼ì¼ í• ë‹¹ëŸ‰ ê°±ì‹ )
        if (status.date !== today) {
          console.log(`ğŸ“… ë‚ ì§œ ë³€ê²½ ê°ì§€ (${status.date} â†’ ${today}), API í‚¤ ìƒíƒœ ë¦¬ì…‹`);
          this.resetDailyStatus();
        } else {
          console.log(`ğŸ”„ ì €ì¥ëœ API í‚¤ ìƒíƒœ ë¡œë“œ (${status.date})`);
          this.restoreKeyStatus(status);
        }
      } else {
        console.log(`ğŸ“ API í‚¤ ìƒíƒœ íŒŒì¼ì´ ì—†ìŒ, ìƒˆë¡œ ìƒì„±`);
        this.saveKeyStatus();
      }
    } catch (error) {
      console.error('âš ï¸ ìƒíƒœ íŒŒì¼ ë¡œë“œ ì‹¤íŒ¨:', error.message);
      console.log('ğŸ’¡ ê¸°ë³¸ ìƒíƒœë¡œ ì§„í–‰í•©ë‹ˆë‹¤.');
    }

  }

  // ì €ì¥ëœ ìƒíƒœë¥¼ API í‚¤ì— ë³µì›
  restoreKeyStatus(status) {
    status.keys.forEach(savedKey => {
      const apiKey = this.apiKeys.find(key => key.index === savedKey.index);
      if (apiKey) {
        apiKey.quotaExceeded = savedKey.quotaExceeded;
        apiKey.usageCount = savedKey.usageCount;
        apiKey.consecutiveErrors = savedKey.consecutiveErrors || 0;
        if (savedKey.lastUsed) {
          apiKey.lastUsed = new Date(savedKey.lastUsed);
        }

        // ë ˆê±°ì‹œ ì¶”ì  ê°ì²´ë„ ì—…ë°ì´íŠ¸
        this.keyUsageCount[apiKey.index] = apiKey.usageCount;
        this.keyQuotaExceeded[apiKey.index] = apiKey.quotaExceeded;
      }
    });
    
    const exceededCount = this.apiKeys.filter(key => key.quotaExceeded).length;
    const availableCount = this.apiKeys.length - exceededCount;
    console.log(`ğŸ“Š ìƒíƒœ ë³µì› ì™„ë£Œ: ${availableCount}/${this.apiKeys.length} í‚¤ ì‚¬ìš© ê°€ëŠ¥`);

  }

  // ì¼ì¼ ìƒíƒœ ë¦¬ì…‹
  resetDailyStatus() {
    this.apiKeys.forEach(key => {
      key.quotaExceeded = false;
      key.consecutiveErrors = 0;
      // usageCountì™€ lastUsedëŠ” ìœ ì§€ (í†µê³„ ëª©ì )
    });
    this.saveKeyStatus();
    console.log(`ğŸ”„ ëª¨ë“  API í‚¤ ìƒíƒœê°€ ë¦¬ì…‹ë˜ì—ˆìŠµë‹ˆë‹¤.`);
  }

  // í˜„ì¬ ìƒíƒœë¥¼ íŒŒì¼ì— ì €ì¥
  saveKeyStatus() {
    try {
      const status = {
        date: new Date().toDateString(),
        lastUpdated: new Date().toISOString(),
        keys: this.apiKeys.map(key => ({
          index: key.index,
          name: key.name,
          quotaExceeded: key.quotaExceeded,
          usageCount: key.usageCount,
          consecutiveErrors: key.consecutiveErrors,
          lastUsed: key.lastUsed ? key.lastUsed.toISOString() : null
        }))
      };

      fs.writeFileSync(this.statusFile, JSON.stringify(status, null, 2), 'utf8');
      console.log(`ğŸ’¾ API í‚¤ ìƒíƒœ ì €ì¥ ì™„ë£Œ: ${this.statusFile}`);
    } catch (error) {
      console.error('âš ï¸ ìƒíƒœ íŒŒì¼ ì €ì¥ ì‹¤íŒ¨:', error.message);
    }

  }

  // ì‚¬ìš© í†µê³„ ì¶œë ¥
  printUsageStats() {
    console.log('\nğŸ“Š API í‚¤ ì‚¬ìš© í†µê³„:');
    this.apiKeys.forEach(keyInfo => {
      const status = keyInfo.quotaExceeded ? 'âŒ í• ë‹¹ëŸ‰ ì´ˆê³¼' : 'âœ… ì‚¬ìš© ê°€ëŠ¥';
      const lastUsed = keyInfo.lastUsed ? keyInfo.lastUsed.toLocaleString() : 'ë¯¸ì‚¬ìš©';
      const currentIndicator = keyInfo.index === this.currentKeyIndex + 1 ? ' ğŸ”‘ í˜„ì¬' : '';
      const quotaInfo = keyInfo.quotaExceeded ? ' (í• ë‹¹ëŸ‰ ì´ˆê³¼)' : '';
      console.log(`   ${keyInfo.name}: ${status} | ì‚¬ìš©íšŸìˆ˜: ${keyInfo.usageCount} | ë§ˆì§€ë§‰ ì‚¬ìš©: ${lastUsed}${currentIndicator}${quotaInfo}`);
    });

    const availableKeys = this.apiKeys.filter(key => !key.quotaExceeded);
    const exhaustedKeys = this.apiKeys.filter(key => key.quotaExceeded);
    
    console.log(`\nğŸ“ˆ ìš”ì•½: ${availableKeys.length}/${this.apiKeys.length} í‚¤ ì‚¬ìš© ê°€ëŠ¥`);
    if (exhaustedKeys.length > 0) {
      console.log(`   í• ë‹¹ëŸ‰ ì´ˆê³¼ëœ í‚¤: ${exhaustedKeys.map(k => k.name).join(', ')}`);
    }
    if (availableKeys.length > 0) {
      console.log(`   ì‚¬ìš© ê°€ëŠ¥í•œ í‚¤: ${availableKeys.map(k => k.name).join(', ')}`);
    }
    
    // í˜„ì¬ í™œì„± í‚¤ ì •ë³´
    const currentKey = this.apiKeys[this.currentKeyIndex];
    if (currentKey) {
      console.log(`\nğŸ”‘ í˜„ì¬ í™œì„± í‚¤: ${currentKey.name} (${currentKey.quotaExceeded ? 'í• ë‹¹ëŸ‰ ì´ˆê³¼' : 'ì •ìƒ'})`);
    }

  }
}

// API í‚¤ ë§¤ë‹ˆì € ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
const apiKeyManager = new ApiKeyManager();

// Elasticsearch í—¬í¼ í•¨ìˆ˜ë“¤
class ElasticsearchHelper {
  constructor(client) {
    this.client = client;
    this.indexName = process.env.ES_INDEX_VIDEOS || 'videos';
    this.ttlHours = parseInt(process.env.ES_TTL_HOURS) || 48;
  }

  // ìºì‹œ íˆíŠ¸ íŒë‹¨
  async checkCacheHit(searchParams) {
    if (!this.client || !(await checkESConnection())) return { hit: false, reason: 'ES client not available' };

    try {
      const { country, keyword, minViews, maxViews, maxResults, publishedAfter, publishedBefore } = searchParams;
    
      // ê²€ìƒ‰ ì¡°ê±´ êµ¬ì„±
      const mustQueries = [];
      const filterQueries = [];
    
      if (country && country !== 'worldwide') {
        mustQueries.push({ term: { country } });
      }
    
      if (keyword && keyword.trim()) {
        // ê°œì„ ëœ ê²€ìƒ‰ ì¿¼ë¦¬: í•œêµ­ì–´ ë¶„ì„ê¸° + í¼ì§€ ë§¤ì¹­ + ë™ì˜ì–´ í™•ì¥
        const searchKeyword = keyword.trim();
    
        // ë™ì˜ì–´ ë§¤í•‘ (ì„œë²„ ì‚¬ì´ë“œ ì„ì‹œ)
        const synonymMap = {
          'ìŒì•…': ['ë®¤ì§', 'music', 'ë…¸ë˜', 'song', 'ê³¡'],
          'ë®¤ì§': ['ìŒì•…', 'music', 'ë…¸ë˜', 'song', 'ê³¡'],
          'music': ['ìŒì•…', 'ë®¤ì§', 'ë…¸ë˜', 'song', 'ê³¡'],
          'ìš”ë¦¬': ['ì¿ í‚¹', 'cooking', 'ë ˆì‹œí”¼', 'recipe'],
          'ì¿ í‚¹': ['ìš”ë¦¬', 'cooking', 'ë ˆì‹œí”¼', 'recipe'],
          'cooking': ['ìš”ë¦¬', 'ì¿ í‚¹', 'ë ˆì‹œí”¼', 'recipe'],
          'ê²Œì„': ['ê²Œì´ë°', 'gaming', 'í”Œë ˆì´', 'game'],
          'ê²Œì´ë°': ['ê²Œì„', 'gaming', 'í”Œë ˆì´', 'game'],
          'gaming': ['ê²Œì„', 'ê²Œì´ë°', 'í”Œë ˆì´', 'game'],
          'ë·°í‹°': ['ë¯¸ìš©', 'beauty', 'í™”ì¥', 'ë©”ì´í¬ì—…', 'makeup'],
          'ë¯¸ìš©': ['ë·°í‹°', 'beauty', 'í™”ì¥', 'ë©”ì´í¬ì—…', 'makeup'],
          'beauty': ['ë·°í‹°', 'ë¯¸ìš©', 'í™”ì¥', 'ë©”ì´í¬ì—…', 'makeup'],
          'ìš´ë™': ['ìŠ¤í¬ì¸ ', 'sports', 'í—¬ìŠ¤', 'fitness', 'workout'],
          'ìŠ¤í¬ì¸ ': ['ìš´ë™', 'sports', 'í—¬ìŠ¤', 'fitness', 'workout'],
          'í—¬ìŠ¤': ['ìš´ë™', 'sports', 'ìŠ¤í¬ì¸ ', 'fitness', 'workout'],
          'ì—¬í–‰': ['íŠ¸ë˜ë¸”', 'travel', 'ì—¬í–‰ê¸°', 'trip'],
          'íŠ¸ë˜ë¸”': ['ì—¬í–‰', 'travel', 'ì—¬í–‰ê¸°', 'trip'],
          'travel': ['ì—¬í–‰', 'íŠ¸ë˜ë¸”', 'ì—¬í–‰ê¸°', 'trip'],
          'ë¦¬ë·°': ['í›„ê¸°', 'review', 'í‰ê°€', 'í‰ì '],
          'í›„ê¸°': ['ë¦¬ë·°', 'review', 'í‰ê°€', 'í‰ì '],
          'review': ['ë¦¬ë·°', 'í›„ê¸°', 'í‰ê°€', 'í‰ì '],
          'ë¨¹ë°©': ['eating', 'food', 'ìŒì‹', 'mukbang'],
          'eating': ['ë¨¹ë°©', 'food', 'ìŒì‹', 'mukbang'],
          'food': ['ë¨¹ë°©', 'eating', 'ìŒì‹', 'mukbang']
        };
    
        // ë™ì˜ì–´ í™•ì¥ëœ í‚¤ì›Œë“œ ëª©ë¡ ìƒì„±
        const expandedKeywords = [searchKeyword];
        const lowerKeyword = searchKeyword.toLowerCase();
        if (synonymMap[lowerKeyword]) {
          expandedKeywords.push(...synonymMap[lowerKeyword]);
        }
    
        // í™•ì¥ëœ í‚¤ì›Œë“œë“¤ë¡œ OR ê²€ìƒ‰ êµ¬ì„±
        const keywordQueries = expandedKeywords.map(kw => ({
          bool: {
            should: [
              // 1. í•œêµ­ì–´ ë¶„ì„ê¸°ë¥¼ ì‚¬ìš©í•œ ì •í™•í•œ ë§¤ì¹­
              {
                match: {
                  title: {
                    query: kw,
                    analyzer: "korean_analyzer",
                    boost: kw === searchKeyword ? 4 : 3 // ì›ë³¸ í‚¤ì›Œë“œì— ë” ë†’ì€ ì ìˆ˜
                  }
                }
              },
              // 2. ì±„ë„ëª… ë§¤ì¹­
              {
                match: {
                  youtube_channel_name: {
                    query: kw,
                    analyzer: "korean_analyzer",
                    boost: kw === searchKeyword ? 3 : 2
                  }
                }
              }
            ],
            minimum_should_match: 1
          }
        }));
    
        mustQueries.push({
          bool: {
            should: [
              ...keywordQueries,
              // 3. í¼ì§€ ë§¤ì¹­ (ì˜¤íƒ€ í—ˆìš©) - ì›ë³¸ í‚¤ì›Œë“œë§Œ
              {
                fuzzy: {
                  title: {
                    value: searchKeyword,
                    fuzziness: "AUTO",
                    boost: 1
                  }
                }
              },
              // 4. ê¸°ì¡´ í‚¤ì›Œë“œ ì •ê·œí™” ë§¤ì¹­ (í˜¸í™˜ì„± ìœ ì§€)
              {
                term: { 
                  keyword_normalized: searchKeyword.toLowerCase(),
                  boost: 0.5
                }
              }
            ],
            minimum_should_match: 1
          }
        });
      }
    
      if (minViews) {
        filterQueries.push({ range: { daily_view_count: { gte: parseInt(minViews) } } });
      }
    
      if (maxViews) {
        filterQueries.push({ range: { daily_view_count: { lte: parseInt(maxViews) } } });
      }
    
      // ì—…ë¡œë“œ ë‚ ì§œ ë²”ìœ„ í•„í„°ë§ ì¶”ê°€
      if (publishedAfter || publishedBefore) {
        const dateRange = {};
        if (publishedAfter) dateRange.gte = publishedAfter;
        if (publishedBefore) dateRange.lte = publishedBefore;
        filterQueries.push({ range: { status_date: dateRange } });
        console.log('ES ë‚ ì§œ ë²”ìœ„ í•„í„° ì ìš©:', dateRange);
        console.log('ES ìºì‹œ ì²´í¬ ë‚ ì§œ ë²”ìœ„ í•„í„° ì ìš©:', dateRange);
      }
    
      // ìºì‹œëœ ë°ì´í„° ìˆ˜ëŸ‰ í™•ì¸
      const countQuery = {
        query: {
          bool: {
            must: mustQueries,
            filter: filterQueries
          }
        }
      };
    
      const countResponse = await this.client.count({
        index: this.indexName,
        body: countQuery
      });
    
      const availableCount = countResponse.body?.count || countResponse.count || 0;
      const requestedCount = parseInt(maxResults) || 60;
    
      // ì‹ ì„ ë„ í™•ì¸
      const freshnessQuery = {
        query: { bool: { must: mustQueries, filter: filterQueries } },
        sort: [{ indexed_at: 'desc' }],
        size: 1,
        _source: ['indexed_at']
      };
    
      const freshnessResponse = await this.client.search({
        index: this.indexName,
        body: freshnessQuery
      });
    
      const hits = freshnessResponse.body?.hits?.hits || freshnessResponse.hits?.hits || [];
      let isFresh = false;
    
      if (hits.length > 0) {
        const lastIndexed = new Date(hits[0]._source.indexed_at);
        const ttlLimit = new Date(Date.now() - this.ttlHours * 60 * 60 * 1000);
        isFresh = lastIndexed > ttlLimit;
      }
    
      const cacheHit = availableCount >= requestedCount && isFresh;
    
      return {
        hit: cacheHit,
        availableCount,
        requestedCount,
        isFresh,
        reason: cacheHit ? 'Cache hit' : `Insufficient data (${availableCount}/${requestedCount}) or stale data (fresh: ${isFresh})`
      };
    
    } catch (error) {
      console.error('Cache hit check error:', error);
      return { hit: false, reason: 'Cache check failed', error: error.message };
    }

  }

  // ESì—ì„œ ê²€ìƒ‰ ê²°ê³¼ ì¡°íšŒ
  async searchVideos(searchParams) {
    if (!this.client || !(await checkESConnection())) return null;

    try {
      const { country, keyword, minViews, maxViews, maxResults, publishedAfter, publishedBefore } = searchParams;
    
      // ê²€ìƒ‰ ì¡°ê±´ êµ¬ì„±
      const mustQueries = [];
      const filterQueries = [];
    
      if (country && country !== 'worldwide') {
        mustQueries.push({ term: { country } });
      }
    
      if (keyword && keyword.trim()) {
        // ê°œì„ ëœ ê²€ìƒ‰ ì¿¼ë¦¬: í•œêµ­ì–´ ë¶„ì„ê¸° + í¼ì§€ ë§¤ì¹­ + ë™ì˜ì–´ í™•ì¥
        const searchKeyword = keyword.trim();
    
        mustQueries.push({
          bool: {
            should: [
              // 1. í•œêµ­ì–´ ë¶„ì„ê¸°ë¥¼ ì‚¬ìš©í•œ ì •í™•í•œ ë§¤ì¹­ (ê°€ì¥ ë†’ì€ ì ìˆ˜)
              {
                match: {
                  title: {
                    query: searchKeyword,
                    analyzer: "korean_analyzer",
                    boost: 3
                  }
                }
              },
              // 2. ì±„ë„ëª… ë§¤ì¹­
              {
                match: {
                  youtube_channel_name: {
                    query: searchKeyword,
                    analyzer: "korean_analyzer",
                    boost: 2
                  }
                }
              },
              // 3. í¼ì§€ ë§¤ì¹­ (ì˜¤íƒ€ í—ˆìš©)
              {
                fuzzy: {
                  title: {
                    value: searchKeyword,
                    fuzziness: "AUTO",
                    boost: 1
                  }
                }
              },
              // 4. ê¸°ì¡´ í‚¤ì›Œë“œ ì •ê·œí™” ë§¤ì¹­ (í˜¸í™˜ì„± ìœ ì§€)
              {
                term: { 
                  keyword_normalized: searchKeyword.toLowerCase()
                }
              }
            ],
            minimum_should_match: 1
          }
        });
      }
    
      if (minViews) {
        filterQueries.push({ range: { daily_view_count: { gte: parseInt(minViews) } } });
      }
    
      if (maxViews) {
        filterQueries.push({ range: { daily_view_count: { lte: parseInt(maxViews) } } });
      }
    
      // ì—…ë¡œë“œ ë‚ ì§œ ë²”ìœ„ í•„í„°ë§ ì¶”ê°€
      if (publishedAfter || publishedBefore) {
        const dateRange = {};
        if (publishedAfter) dateRange.gte = publishedAfter;
        if (publishedBefore) dateRange.lte = publishedBefore;
        filterQueries.push({ range: { status_date: dateRange } });
        console.log('ES ë‚ ì§œ ë²”ìœ„ í•„í„° ì ìš©:', dateRange);
      }
    
      const searchQuery = {
        query: {
          bool: {
            must: mustQueries,
            filter: filterQueries
          }
        },
        sort: [{ daily_view_count: 'desc' }],
        size: parseInt(maxResults) || 60
      };
    
      const response = await this.client.search({
        index: this.indexName,
        body: searchQuery
      });
    
      // ES ê²°ê³¼ë¥¼ API ì‘ë‹µ í˜•ì‹ìœ¼ë¡œ ë³€í™˜
      const results = response.body.hits.hits.map(hit => ({
        youtube_channel_name: hit._source.youtube_channel_name,
        thumbnail_url: hit._source.thumbnail_url,
        status: hit._source.status || 'active',
        youtube_channel_id: hit._source.youtube_channel_id,
        primary_category: hit._source.primary_category,
        status_date: hit._source.status_date,
        daily_view_count: hit._source.daily_view_count,
        subscriber_count: hit._source.subscriber_count,
        vod_url: hit._source.vod_url,
        video_id: hit._source.video_id,
        title: hit._source.title,
        description: hit._source.description,
        duration: hit._source.duration,
        duration_seconds: hit._source.duration_seconds,
        video_length_category: hit._source.video_length_category
      }));
    
      return results;
    
    } catch (error) {
      console.error('ES search error:', error);
      return null;
    }

  }

  // YouTube API ê²°ê³¼ë¥¼ ESì— bulk upsert
  async bulkUpsertVideos(videos, searchParams) {
    if (!this.client || !videos || videos.length === 0 || !(await checkESConnection())) return;

    try {
      const body = [];
      const indexedAt = new Date().toISOString();
    
      videos.forEach(video => {
        // upsertë¥¼ ìœ„í•œ update ì•¡ì…˜
        body.push({
          update: {
            _index: this.indexName,
            _id: video.video_id
          }
        });
    
        // ë¬¸ì„œ ë‚´ìš©
        body.push({
          doc: {
            video_id: video.video_id,
            title: video.title,
            youtube_channel_name: video.youtube_channel_name,
            youtube_channel_id: video.youtube_channel_id,
            country: searchParams.country || 'unknown',
            status_date: video.status_date,
            daily_view_count: parseInt(video.daily_view_count) || 0,
            subscriber_count: parseInt(video.subscriber_count) || 0,
            duration_seconds: parseInt(video.duration_seconds) || 0,
            video_length_category: video.video_length_category,
            primary_category: video.primary_category,
            vod_url: video.vod_url,
            thumbnail_url: video.thumbnail_url,
            status: video.status || 'active',
            description: video.description || '',
            duration: video.duration || '',
            keyword_normalized: (searchParams.keyword || '').toLowerCase(),
            indexed_at: indexedAt
          },
          doc_as_upsert: true
        });
      });
    
              const response = await this.client.bulk({ body });
    
        // ì‘ë‹µ êµ¬ì¡° ê²€ì¦ ë° ì•ˆì „í•œ ì˜¤ë¥˜ ì²˜ë¦¬
        if (response && response.body && response.body.errors) {
          console.error('ES bulk upsert errors:', response.body.items.filter(item => item.update && item.update.error));
        } else if (response && response.errors) {
          // ìƒˆë¡œìš´ ë²„ì „ì˜ í´ë¼ì´ì–¸íŠ¸ ì‘ë‹µ êµ¬ì¡°
          console.error('ES bulk upsert errors:', response.items.filter(item => item.update && item.update.error));
        } else {
          console.log(`ES bulk upsert ì„±ê³µ: ${videos.length}ê°œ ë¹„ë””ì˜¤ ì¸ë±ì‹±`);
        }
    
    } catch (error) {
      console.error('ES bulk upsert error:', error);
    }

  }
}

// ES í—¬í¼ ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
const esHelper = new ElasticsearchHelper(esClient);

// ê°„ë‹¨í•œ Rate Limiting êµ¬í˜„
const requestTracker = new Map();
const RATE_LIMIT_WINDOW = 15 * 60 * 1000; // 15ë¶„
const RATE_LIMIT_MAX_REQUESTS = 10; // 15ë¶„ë‹¹ ìµœëŒ€ 10íšŒ ê²€ìƒ‰

function rateLimitMiddleware(req, res, next) {
  const clientIP = req.ip || req.connection.remoteAddress;
  const now = Date.now();

  // ì´ì „ ìš”ì²­ ê¸°ë¡ ê°€ì ¸ì˜¤ê¸°
  let requests = requestTracker.get(clientIP) || [];

  // ì˜¤ë˜ëœ ìš”ì²­ ì œê±° (15ë¶„ ì´ì „)
  requests = requests.filter(timestamp => now - timestamp < RATE_LIMIT_WINDOW);

  // ì œí•œ ì´ˆê³¼ í™•ì¸
  if (requests.length >= RATE_LIMIT_MAX_REQUESTS) {
    return res.status(429).json({
      success: false,
      error: 'ê²€ìƒ‰ ìš”ì²­ì´ ë„ˆë¬´ ë§ìŠµë‹ˆë‹¤. 15ë¶„ í›„ì— ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.',
      retryAfter: Math.ceil((requests[0] + RATE_LIMIT_WINDOW - now) / 1000)
    });
  }

  // í˜„ì¬ ìš”ì²­ ì¶”ê°€
  requests.push(now);
  requestTracker.set(clientIP, requests);

  next();
}

// ì£¼ê¸°ì ìœ¼ë¡œ ì˜¤ë˜ëœ ë°ì´í„° ì •ë¦¬
setInterval(() => {
  const now = Date.now();
  for (const [ip, requests] of requestTracker.entries()) {
    const validRequests = requests.filter(timestamp => now - timestamp < RATE_LIMIT_WINDOW);
    if (validRequests.length === 0) {
      requestTracker.delete(ip);
    } else {
      requestTracker.set(ip, validRequests);
    }
  }
}, 5 * 60 * 1000); // 5ë¶„ë§ˆë‹¤ ì •ë¦¬

const app = express();
const PORT = process.env.PORT || 3000;

// ë¯¸ë“¤ì›¨ì–´ ì„¤ì •
app.use(cors());
// ëŒ€ìš©ëŸ‰ ë°ì´í„° ì²˜ë¦¬ë¥¼ ìœ„í•œ body-parser ì œí•œ ì¦ê°€
app.use(express.json({ limit: '50mb' }));
app.use(express.urlencoded({ limit: '50mb', extended: true }));
app.use(express.static(__dirname));

// ë©”ì¸ í˜ì´ì§€ ë¼ìš°íŠ¸
app.get('/', (req, res) => {
  res.sendFile(path.join(__dirname, 'you_list.html'));
});

// YouTube ë™ì˜ìƒ ê²€ìƒ‰ API
app.get('/api/search', rateLimitMiddleware, async (req, res) => {
  const searchStartTime = Date.now(); // ê²€ìƒ‰ ì‹œì‘ ì‹œê°„ ê¸°ë¡

  try {
    // í•„í„°ë§ í†µê³„ë¥¼ ìœ„í•œ ì¹´ìš´í„° ì¶”ê°€ (í•¨ìˆ˜ ì‹œì‘ ë¶€ë¶„ì— ì •ì˜)
    const filterStats = {
      totalProcessed: 0,
      duplicateSkipped: 0,
      categoryFiltered: 0,
      minViewsFiltered: 0,
      maxViewsFiltered: 0,
      videoLengthFiltered: 0,
      minAvgWatchRateFiltered: 0,
      finalAccepted: 0
    };

    const {
      country = 'worldwide',  // ê¸°ë³¸ê°’ì„ ì „ì„¸ê³„ë¡œ ë³€ê²½
      countries = '',         // ë‹¤ì¤‘ êµ­ê°€ ì„ íƒ íŒŒë¼ë¯¸í„° ì¶”ê°€
      keyword = '',
      searchScope = 'title',  // ê²€ìƒ‰ ë²”ìœ„: title, channel, ë˜ëŠ” ë¶„ë¦¬ëœ ë¬¸ìì—´
      maxViews,
      minViews = 100000,
      minAvgWatchRate,        // ìµœì†Œí‰ê· ì‹œì²­ë¥  í•„í„° ì¶”ê°€
      uploadPeriod,
      startDate,
      endDate,
      videoLength,
      maxResults = 60,   // ê¸°ë³¸ê°’ 60ê±´
      categories = ''   // ì¹´í…Œê³ ë¦¬ í•„í„°
    } = req.query;
    
    // maxResults ìœ íš¨ì„± ê²€ì‚¬ ë° ë³€í™˜
    const allowedResults = [10, 20, 30, 40, 50, 60, 100, 150, 200];
    const parsedMaxResults = parseInt(maxResults);
    const finalMaxResults = allowedResults.includes(parsedMaxResults) ? parsedMaxResults : 60;
    
    console.log('ê²€ìƒ‰ íŒŒë¼ë¯¸í„°:', req.query);
    console.log('ì„ íƒëœ êµ­ê°€(ë‹¨ìˆ˜):', country);
    console.log('ì„ íƒëœ êµ­ê°€ë“¤(ë³µìˆ˜):', countries);
    console.log('ğŸ“Š ìµœì†Œí‰ê· ì‹œì²­ë¥  í•„í„°:', minAvgWatchRate ? `${minAvgWatchRate}% ì´ìƒ` : 'ë¹„í™œì„±í™”');
    
    // ë‹¤ì¤‘ êµ­ê°€ ì²˜ë¦¬ ë¡œì§ ê°œì„ 
    let selectedCountries;
    if (countries && countries.length > 0) {
      // countries íŒŒë¼ë¯¸í„°ê°€ ìˆìœ¼ë©´ ìš°ì„  ì‚¬ìš©
      if (Array.isArray(countries)) {
        selectedCountries = countries.filter(c => c && c.trim());
      } else if (typeof countries === 'string') {
        selectedCountries = countries.split(',').filter(c => c.trim());
      } else {
        selectedCountries = [country];
      }
    } else {
      // countriesê°€ ì—†ìœ¼ë©´ country ì‚¬ìš©
      selectedCountries = [country];
    }
    
    // ì¤‘ë³µ ì œê±° ë° ìœ íš¨ì„± ê²€ì‚¬
    selectedCountries = [...new Set(selectedCountries.filter(c => c && c.trim()))];
    if (selectedCountries.length === 0) {
      selectedCountries = ['worldwide'];
    }
    
    console.log('ìµœì¢… ì²˜ë¦¬í•  êµ­ê°€ ëª©ë¡:', selectedCountries);
    
    console.log('ê²€ìƒ‰ ë²”ìœ„:', searchScope);
    console.log('ì„ íƒëœ ì¹´í…Œê³ ë¦¬:', categories);
    console.log(`ê²€ìƒ‰ ê²°ê³¼ ìˆ˜: ${finalMaxResults}ê±´ (ìš”ì²­: ${maxResults})`);
    
    // ë™ì˜ìƒ ê¸¸ì´ íŒŒë¼ë¯¸í„° íŒŒì‹±
    const selectedVideoLengths = videoLength && videoLength.trim() ? videoLength.split(',').filter(v => v.trim()) : [];
    console.log('ì„ íƒëœ ë™ì˜ìƒ ê¸¸ì´:', selectedVideoLengths.length > 0 ? selectedVideoLengths : 'ëª¨ë“  ê¸¸ì´ í—ˆìš© (í•„í„° ì—†ìŒ)');
    
    // ë‹¤ì¤‘ êµ­ê°€ ì²˜ë¦¬: ì²« ë²ˆì§¸ êµ­ê°€ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì„¤ì • (í–¥í›„ í™•ì¥ ê°€ëŠ¥)
    const primaryCountry = selectedCountries[0];
    console.log(`ğŸ¯ ì£¼ ê²€ìƒ‰ êµ­ê°€: ${primaryCountry} (ì´ ${selectedCountries.length}ê°œêµ­ ì„ íƒë¨)`);
    
    // ========== Elasticsearch ìºì‹œ ìš°ì„  ë¡œì§ ì‹œì‘ ==========
    const searchParameters = {
      country: primaryCountry,        // ì£¼ ê²€ìƒ‰ êµ­ê°€
      countries: selectedCountries.join(','), // ì„ íƒëœ ëª¨ë“  êµ­ê°€ ëª©ë¡
      keyword,
      searchScope,
      categories,
      minViews,
      maxViews,
      uploadPeriod,
      startDate,
      endDate,
      videoLength,
      maxResults: finalMaxResults,
      // ë‚ ì§œ ë²”ìœ„ ì •ë³´ ì¶”ê°€
      publishedAfter: null,
      publishedBefore: null
    };
    
    // ë‚ ì§œ ë²”ìœ„ ì •ë³´ ì¶”ê°€ (Elasticsearch ìºì‹œ ë¹„êµìš©)
    if (uploadPeriod) {
      const dateRange = getDateRange(uploadPeriod);
      searchParameters.publishedAfter = dateRange.publishedAfter;
      searchParameters.publishedBefore = dateRange.publishedBefore;
    } else if (startDate || endDate) {
      if (startDate) {
        try {
          const startDateTime = new Date(startDate + 'T00:00:00.000Z');
          searchParameters.publishedAfter = startDateTime.toISOString();
        } catch (e) {
          console.warn('ì‹œì‘ì¼ íŒŒì‹± ì˜¤ë¥˜:', e.message);
        }
      }
      if (endDate) {
        try {
          const endDateTime = new Date(endDate + 'T23:59:59.999Z');
          searchParameters.publishedBefore = endDateTime.toISOString();
        } catch (e) {
          console.warn('ì¢…ë£Œì¼ íŒŒì‹± ì˜¤ë¥˜:', e.message);
        }
      }
    }
    
    // 1ë‹¨ê³„: ìºì‹œ íˆíŠ¸ í™•ì¸
    console.log('ğŸ” Elasticsearch ìºì‹œ í™•ì¸ ì¤‘...');
    const cacheResult = await esHelper.checkCacheHit(searchParameters);
    console.log('ğŸ“Š ìºì‹œ í™•ì¸ ê²°ê³¼:', cacheResult);
    
    if (cacheResult.hit) {
      // ìºì‹œ íˆíŠ¸: ESì—ì„œ ê²°ê³¼ ì¡°íšŒ
      console.log('âœ… ìºì‹œ íˆíŠ¸! Elasticsearchì—ì„œ ê²°ê³¼ ì¡°íšŒ');
      const cachedResults = await esHelper.searchVideos(searchParameters);
    
      if (cachedResults && cachedResults.length > 0) {
        console.log(`ğŸ“¦ ìºì‹œì—ì„œ ${cachedResults.length}ê°œ ê²°ê³¼ ë°˜í™˜`);
    
        // ìºì‹œ ê²€ìƒ‰ ì†Œìš”ì‹œê°„ ê³„ì‚°
        const cacheEndTime = Date.now();
        const cacheDuration = cacheEndTime - searchStartTime;
        const cacheDurationSeconds = (cacheDuration / 1000).toFixed(2);
    
        console.log(`\nâ±ï¸ ìºì‹œ ê²€ìƒ‰ ì™„ë£Œ: ì´ ì†Œìš”ì‹œê°„ ${cacheDurationSeconds}ì´ˆ (${cachedResults.length}ê°œ ê²°ê³¼)`);
        console.log(`ğŸ” ê²€ìƒ‰ ì¡°ê±´: ${country}/${keyword || 'í‚¤ì›Œë“œ ì—†ìŒ'}/${finalMaxResults}ê±´`);
        console.log('âš¡ ìºì‹œ íˆíŠ¸ë¡œ ì´ˆê³ ì† ê²€ìƒ‰!');
        console.log('='.repeat(52));
    
        return res.json({
          success: true,
          data: cachedResults,
          total: cachedResults.length,
          source: 'elasticsearch_cache',
          searchDuration: `${cacheDurationSeconds}ì´ˆ`
        });
      } else {
        console.log('âš ï¸ ìºì‹œ íˆíŠ¸ì˜€ì§€ë§Œ ê²°ê³¼ê°€ ì—†ìŒ, YouTube APIë¡œ fallback');
      }
    } else {
      console.log('âŒ ìºì‹œ ë¯¸ìŠ¤:', cacheResult.reason);
      console.log('ğŸ”„ YouTube API í˜¸ì¶œë¡œ ì§„í–‰');
    }
    // ========== Elasticsearch ìºì‹œ ìš°ì„  ë¡œì§ ë ==========
    
    let searchResults = [];
    let nextPageToken = '';
    const resultsPerPage = Math.min(finalMaxResults, 50); // ì„ íƒí•œ ê²°ê³¼ ìˆ˜ì— ë”°ë¼ í˜ì´ì§€ë‹¹ ìš”ì²­ëŸ‰ ì¡°ì •
    
    // YouTube API ê²€ìƒ‰ íŒŒë¼ë¯¸í„° ì„¤ì •
    let searchParams = {
      part: 'snippet',
      type: 'video',
      maxResults: resultsPerPage,
      order: 'viewCount'
    };
    
    // primaryCountryëŠ” ì´ë¯¸ ìœ„ì—ì„œ ì„ ì–¸ë˜ì—ˆìœ¼ë¯€ë¡œ ì‚¬ìš©ë§Œ í•˜ê¸°
    
    // êµ­ê°€ë³„ ì§€ì—­ ì½”ë“œ ì„¤ì • (ì „ì„¸ê³„ê°€ ì•„ë‹Œ ê²½ìš°ì—ë§Œ)
    if (primaryCountry !== 'worldwide') {
      const regionCode = getCountryCode(primaryCountry);
      if (regionCode) {
        searchParams.regionCode = regionCode;
        console.log(`âœ… ì§€ì—­ ì½”ë“œ ì„¤ì •: ${primaryCountry} â†’ ${regionCode}`);
      } else {
        console.log(`âš ï¸ ê²½ê³ : '${primaryCountry}' êµ­ê°€ì˜ regionCodeë¥¼ ì°¾ì„ ìˆ˜ ì—†ì–´ ì „ì„¸ê³„ ê²€ìƒ‰ìœ¼ë¡œ ì§„í–‰í•©ë‹ˆë‹¤.`);
      }
    } else {
      console.log('ğŸŒ ì „ì„¸ê³„ ê²€ìƒ‰: regionCode ì—†ì´ ì§„í–‰');
    }
    
    // ì–¸ì–´ ì„¤ì • (ì£¼ ê²€ìƒ‰ êµ­ê°€ì˜ ê¸°ë³¸ ì–¸ì–´)
    const languageCode = getLanguageCode(primaryCountry);
    if (languageCode) {
      searchParams.relevanceLanguage = languageCode;
      console.log(`ğŸŒ ì–¸ì–´ ì„¤ì •: ${primaryCountry} â†’ ${languageCode}`);
    }
    
    // í‚¤ì›Œë“œ ì„¤ì •
    const isEmptyKeyword = !keyword || !keyword.trim();
    
    if (!isEmptyKeyword) {
      // ê²€ìƒ‰ ë²”ìœ„ ì²˜ë¦¬
      let searchQuery = keyword.trim();
    
      // searchScopeê°€ ë¬¸ìì—´ë¡œ ë“¤ì–´ì˜¤ëŠ” ê²½ìš° ë°°ì—´ë¡œ ë³€í™˜
      let searchScopes = [];
      if (typeof searchScope === 'string') {
        searchScopes = searchScope.includes(',') ? searchScope.split(',').map(s => s.trim()) : [searchScope];
      } else if (Array.isArray(searchScope)) {
        searchScopes = searchScope;
      } else {
        searchScopes = ['title']; // ê¸°ë³¸ê°’
      }
    
      // íƒœê·¸ ê²€ìƒ‰ì¸ ê²½ìš° ë³„ë„ ì²˜ë¦¬
      if (searchScopes.includes('tags')) {
        // íƒœê·¸ ê²€ìƒ‰: YouTubeì—ì„œëŠ” íƒœê·¸ê°€ ê³µê°œë˜ì§€ ì•Šìœ¼ë¯€ë¡œ ì¼ë°˜ ê²€ìƒ‰ìœ¼ë¡œ ì²˜ë¦¬
        searchQuery = keyword.trim();
        console.log(`íƒœê·¸ ê²€ìƒ‰ (ì¼ë°˜ ê²€ìƒ‰ìœ¼ë¡œ ì²˜ë¦¬): "${searchQuery}"`);
      } else if (searchScopes.includes('channel')) {
        // ì±„ë„ëª… ê²€ìƒ‰
        searchQuery = keyword.trim();
        console.log(`ì±„ë„ëª… í¬í•¨ ê²€ìƒ‰: "${searchQuery}"`);
      } else {
        // ê¸°ë³¸ ì œëª© ê²€ìƒ‰
        searchQuery = keyword.trim();
        console.log(`ì œëª© ê²€ìƒ‰: "${searchQuery}"`);
      }
    
      searchParams.q = searchQuery;
    } else {
      // í‚¤ì›Œë“œê°€ ì—†ì„ ë•ŒëŠ” êµ­ê°€ë³„ ì¸ê¸° ë™ì˜ìƒ ê²€ìƒ‰
      console.log('í‚¤ì›Œë“œ ì—†ìŒ: êµ­ê°€ë³„ ì¸ê¸° ë™ì˜ìƒ ê²€ìƒ‰');
    
      if (country !== 'worldwide') {
        // íŠ¹ì • êµ­ê°€ ì„ íƒ ì‹œ: í•´ë‹¹ êµ­ê°€ì˜ ì¸ê¸° ì½˜í…ì¸  ê²€ìƒ‰
        console.log(`ğŸ³ï¸ ${country} êµ­ê°€ì˜ ì¸ê¸° ë™ì˜ìƒ ê²€ìƒ‰`);
    
        // êµ­ê°€ë³„ ì¸ê¸° ê²€ìƒ‰ì–´ ì‚¬ìš© (ë” ì •í™•í•œ ì§€ì—­ë³„ ê²°ê³¼)
        const countrySpecificTerms = {
          'korea': ['í•œêµ­', 'korean', 'korea', 'í•œêµ­ì–´'],
          'usa': ['america', 'usa', 'american', 'english'],
          'japan': ['japan', 'japanese', 'ì¼ë³¸', 'ì¼ë³¸ì–´'],
          'uk': ['britain', 'uk', 'british', 'english'],
          'germany': ['germany', 'german', 'deutsch', 'ë…ì¼'],
          'france': ['france', 'french', 'franÃ§ais', 'í”„ë‘ìŠ¤'],
          'canada': ['canada', 'canadian', 'english', 'french'],
          'australia': ['australia', 'australian', 'english'],
          'india': ['india', 'indian', 'hindi', 'english'],
          'brazil': ['brazil', 'brazilian', 'portuguese', 'portuguÃªs'],
          'mexico': ['mexico', 'mexican', 'spanish', 'espaÃ±ol'],
          'italy': ['italy', 'italian', 'italiano', 'ì´íƒˆë¦¬ì•„'],
          'spain': ['spain', 'spanish', 'espaÃ±ol', 'ìŠ¤í˜ì¸']
        };
    
        const terms = countrySpecificTerms[country] || ['video', 'popular'];
        const randomTerm = terms[Math.floor(Math.random() * terms.length)];
        searchParams.q = randomTerm;
    
        // êµ­ê°€ë³„ ê²€ìƒ‰ì„ ìœ„í•´ orderë¥¼ relevanceë¡œ ì„¤ì • (regionCodeì™€ relevanceLanguageê°€ ìš°ì„  ì ìš©ë¨)
        searchParams.order = 'relevance';
    
        console.log(`ğŸŒ ${country} êµ­ê°€ë³„ ì¸ê¸° ê²€ìƒ‰ì–´: "${randomTerm}"`);
        console.log('ì„¤ì •: ê´€ë ¨ì„± ìˆœì„œë¡œ ì •ë ¬ (êµ­ê°€ë³„ ìš°ì„ )');
      } else {
        // ì „ì„¸ê³„ ì„ íƒ ì‹œ: ì¼ë°˜ì ì¸ ì¸ê¸° ë™ì˜ìƒ ê²€ìƒ‰
        console.log('ğŸŒ ì „ì„¸ê³„ ì¸ê¸° ë™ì˜ìƒ ê²€ìƒ‰');
    
        const broadSearchTerms = ['a', 'the', 'and', 'or', 'video', 'youtube'];
        const randomTerm = broadSearchTerms[Math.floor(Math.random() * broadSearchTerms.length)];
        searchParams.q = randomTerm;
    
        // ì „ì„¸ê³„ ê²€ìƒ‰ ì‹œì—ë§Œ ì¡°íšŒìˆ˜ ìˆœ ì •ë ¬
        searchParams.order = 'viewCount';
    
        console.log(`ì „ì„¸ê³„ ì¸ê¸° ë™ì˜ìƒ ê²€ìƒ‰ì–´: "${randomTerm}"`);
        console.log('ì„¤ì •: ì¡°íšŒìˆ˜ ë†’ì€ ìˆœì„œë¡œ ì •ë ¬');
      }
    }
    
    // ë””ë²„ê·¸ ë¡œê·¸ ì¶œë ¥ (í‚¤ì›Œë“œ ì„¤ì • í›„)
    console.log('=== êµ­ê°€ë³„ ê²€ìƒ‰ ë””ë²„ê·¸ ì •ë³´ ===');
    console.log('1. í´ë¼ì´ì–¸íŠ¸ ìš”ì²­ country:', country);
    console.log('2. getCountryCode ê²°ê³¼:', getCountryCode(country));
    console.log('3. getLanguageCode ê²°ê³¼:', getLanguageCode(country));
    console.log('4. í‚¤ì›Œë“œ ìƒíƒœ:', keyword ? `"${keyword}"` : 'ì—†ìŒ (êµ­ê°€ë³„ ì¸ê¸° ê²€ìƒ‰)');
    console.log('5. ê²€ìƒ‰ ì „ëµ:', keyword ? 'í‚¤ì›Œë“œ ê¸°ë°˜ ê²€ìƒ‰' : (country === 'worldwide' ? 'ì „ì„¸ê³„ ì¸ê¸° ê²€ìƒ‰' : `${country} êµ­ê°€ë³„ ì¸ê¸° ê²€ìƒ‰`));
    console.log('6. ìµœì¢… YouTube API ê²€ìƒ‰ íŒŒë¼ë¯¸í„°:', {
      regionCode: searchParams.regionCode || 'ì—†ìŒ (ì „ì„¸ê³„ ê²€ìƒ‰)',
      relevanceLanguage: searchParams.relevanceLanguage,
      country: country,
      keyword: searchParams.q || 'í‚¤ì›Œë“œ ì—†ìŒ',
      order: searchParams.order,
      type: searchParams.type,
      isWorldwide: country === 'worldwide'
    });
    console.log('7. ê²€ìƒ‰ íƒ€ì…:', country === 'worldwide' ? 'ğŸŒ ì „ì„¸ê³„ ê²€ìƒ‰' : `ğŸ³ï¸ ${country} êµ­ê°€ë³„ ê²€ìƒ‰`);
    console.log('========================================');
    
    // ì—…ë¡œë“œ ê¸°ê°„ ì„¤ì • (ê¸°ì¡´ ë“œë¡­ë‹¤ìš´ ë°©ì‹)
    if (uploadPeriod) {
      const { publishedAfter, publishedBefore } = getDateRange(uploadPeriod);
      if (publishedAfter) searchParams.publishedAfter = publishedAfter;
      if (publishedBefore) searchParams.publishedBefore = publishedBefore;
    }
    
    // ì»¤ìŠ¤í…€ ë‚ ì§œ ë²”ìœ„ ì„¤ì • (startDate, endDateê°€ ìˆìœ¼ë©´ uploadPeriodë³´ë‹¤ ìš°ì„ )
    if (startDate || endDate) {
      if (startDate) {
        try {
          const startDateTime = new Date(startDate + 'T00:00:00.000Z'); // UTC ê¸°ì¤€ìœ¼ë¡œ ëª…ì‹œì  ì²˜ë¦¬
          if (isNaN(startDateTime.getTime())) {
            throw new Error('Invalid start date');
          }
          searchParams.publishedAfter = startDateTime.toISOString();
          console.log('âœ… ì‹œì‘ì¼ ì„¤ì • ì„±ê³µ (UTC):', startDateTime.toISOString());
        } catch (error) {
          console.error('âŒ ì‹œì‘ì¼ ì²˜ë¦¬ ì˜¤ë¥˜:', error.message, 'ì…ë ¥ê°’:', startDate);
          // ì˜¤ë¥˜ ì‹œ ì‹œì‘ì¼ ë¬´ì‹œí•˜ê³  ê³„ì† ì§„í–‰
        }
      }
      if (endDate) {
        try {
          const endDateTime = new Date(endDate + 'T23:59:59.999Z'); // UTC ê¸°ì¤€ìœ¼ë¡œ ëª…ì‹œì  ì²˜ë¦¬
          if (isNaN(endDateTime.getTime())) {
            throw new Error('Invalid end date');
          }
          searchParams.publishedBefore = endDateTime.toISOString();
          console.log('âœ… ì¢…ë£Œì¼ ì„¤ì • ì„±ê³µ (UTC):', endDateTime.toISOString());
        } catch (error) {
          console.error('âŒ ì¢…ë£Œì¼ ì²˜ë¦¬ ì˜¤ë¥˜:', error.message, 'ì…ë ¥ê°’:', endDate);
          // ì˜¤ë¥˜ ì‹œ ì¢…ë£Œì¼ ë¬´ì‹œí•˜ê³  ê³„ì† ì§„í–‰
        }
      }
      console.log('ğŸ“… ì»¤ìŠ¤í…€ ë‚ ì§œ ë²”ìœ„ ì ìš©:', {
        startDate: startDate || 'ì—†ìŒ',
        endDate: endDate || 'ì—†ìŒ',
        publishedAfter: searchParams.publishedAfter || 'ì—†ìŒ',
        publishedBefore: searchParams.publishedBefore || 'ì—†ìŒ'
      });
    }
    
    // ë™ì˜ìƒ ê¸¸ì´ ì„¤ì • (YouTube APIëŠ” 'short', 'medium', 'long'ë§Œ ì§€ì›í•˜ë¯€ë¡œ í›„ì²˜ë¦¬ì—ì„œ í•„í„°ë§)
    // videoLength íŒŒë¼ë¯¸í„°ëŠ” í´ë¼ì´ì–¸íŠ¸ì—ì„œ ë°›ì•„ì„œ ê²°ê³¼ í•„í„°ë§ì— ì‚¬ìš©
    
         // ì„ íƒí•œ ìˆ˜ë§Œí¼ ê²°ê³¼ ìˆ˜ì§‘ (ì¤‘ë³µ ì œê±°)
     const processedVideoIds = new Set(); // ì´ë¯¸ ì²˜ë¦¬ëœ ë¹„ë””ì˜¤ ID ì¶”ì 
     const processedChannelTitles = new Set(); // ì´ë¯¸ ì²˜ë¦¬ëœ ì±„ë„ëª… ì¶”ì  (ì„ íƒì )
    
     while (searchResults.length < finalMaxResults) {
       if (nextPageToken) {
         searchParams.pageToken = nextPageToken;
       }
    
       let response;
       let currentApiKey = apiKeyManager.getCurrentKey();
    
       // ê²¬ê³ í•œ API í‚¤ ì „í™˜ ë¡œì§ìœ¼ë¡œ ì¬ì‘ì„±
       let retryCount = 0;
       const maxRetries = apiKeyManager.apiKeys.length;
    
       while (retryCount < maxRetries) {
                 try {
          const youtubeInstance = apiKeyManager.getYouTubeInstance();
          currentApiKey = youtubeInstance.currentKey;
          response = await youtubeInstance.youtube.search.list(searchParams);
          break; // ì„±ê³µí•˜ë©´ ë£¨í”„ ì¢…ë£Œ
        } catch (apiError) {
          console.error(`YouTube API ì˜¤ë¥˜ (${currentApiKey.name}):`, apiError.message);
    
           // API í‚¤ ì¼ì‹œì •ì§€(suspended) ì˜¤ë¥˜ì¸ ê²½ìš° ì¦‰ì‹œ ë‹¤ë¥¸ í‚¤ë¡œ ìš°íšŒ
           if (apiError.message.includes('suspended') || apiError.message.includes('has been suspended')) {
             console.log(`ğŸš¨ ${currentApiKey.name} ì¼ì‹œì •ì§€ ê°ì§€ - ë‹¤ë¥¸ í‚¤ë¡œ ì¦‰ì‹œ ìš°íšŒ`);
             retryCount++;
             continue; // ì¦‰ì‹œ ë‹¤ìŒ í‚¤ë¡œ ì¬ì‹œë„
           }
           // Permission Deny ì˜¤ë¥˜ì¸ ê²½ìš° ê°ì§€ ë° ìš°íšŒ
           else if (apiError.message.includes('permission') || apiError.message.includes('denied') || 
                    apiError.message.includes('forbidden') || apiError.code === 403) {
             console.log(`ğŸš« ${currentApiKey.name} PERMISSION DENY ê°ì§€ - API í‚¤ ê¶Œí•œ ë¬¸ì œ`);
             console.log(`ğŸ“ ì˜¤ë¥˜ ìƒì„¸: ${apiError.message}`);
             retryCount++;
             continue; // ì¦‰ì‹œ ë‹¤ìŒ í‚¤ë¡œ ì¬ì‹œë„
           }
           // í• ë‹¹ëŸ‰ ì´ˆê³¼ ì˜¤ë¥˜ì¸ ê²½ìš° ë‹¤ìŒ í‚¤ë¡œ ì „í™˜
           else if (apiError.message.includes('quota') || apiError.message.includes('quotaExceeded')) {
             console.log(`ğŸš« ${currentApiKey.name} í• ë‹¹ëŸ‰ ì´ˆê³¼ ê°ì§€`);
    
             const newApiKey = apiKeyManager.markKeyAsQuotaExceeded(currentApiKey, apiError.message);
             if (newApiKey) {
               console.log(`ğŸ”„ ${newApiKey.name}ë¡œ ì¬ì‹œë„í•©ë‹ˆë‹¤... (ì¬ì‹œë„ ${retryCount + 1}/${maxRetries})`);
               retryCount++;
               continue; // ë‹¤ìŒ ë°˜ë³µìœ¼ë¡œ ê³„ì†
             } else {
               console.log('âŒ ëª¨ë“  API í‚¤ì˜ í• ë‹¹ëŸ‰ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤.');
               throw new Error('ALL_QUOTA_EXCEEDED: ëª¨ë“  API í‚¤ì˜ í• ë‹¹ëŸ‰ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤.');
             }
           }
           // regionCode ê´€ë ¨ ì˜¤ë¥˜ì¸ ê²½ìš° ì²˜ë¦¬
           else if ((apiError.message.includes('regionCode') || apiError.message.includes('invalid region')) && searchParams.regionCode) {
          console.log('ğŸš¨ regionCode ì˜¤ë¥˜ ë°œìƒ!');
          console.log(`  - ìš”ì²­í•œ êµ­ê°€: ${country}`);
          console.log(`  - ì‚¬ìš©í•œ regionCode: ${searchParams.regionCode}`);
          console.log(`  - ì˜¤ë¥˜ ë©”ì‹œì§€: ${apiError.message}`);
    
          // regionCodeê°€ ìœ íš¨í•œì§€ ë‹¤ì‹œ í™•ì¸
          const validRegionCodes = [
            'AD', 'AE', 'AF', 'AG', 'AI', 'AL', 'AM', 'AO', 'AQ', 'AR', 'AS', 'AT',
            'AU', 'AW', 'AX', 'AZ', 'BA', 'BB', 'BD', 'BE', 'BF', 'BG', 'BH', 'BI',
            'BJ', 'BL', 'BM', 'BN', 'BO', 'BQ', 'BR', 'BS', 'BT', 'BV', 'BW', 'BY',
            'BZ', 'CA', 'CC', 'CD', 'CF', 'CG', 'CH', 'CI', 'CK', 'CL', 'CM', 'CN',
            'CO', 'CR', 'CU', 'CV', 'CW', 'CX', 'CY', 'CZ', 'DE', 'DJ', 'DK', 'DM',
            'DO', 'DZ', 'EC', 'EE', 'EG', 'EH', 'ER', 'ES', 'ET', 'FI', 'FJ', 'FK',
            'FM', 'FO', 'FR', 'GA', 'GB', 'GD', 'GE', 'GF', 'GG', 'GH', 'GI', 'GL',
            'GM', 'GN', 'GP', 'GQ', 'GR', 'GS', 'GT', 'GU', 'GW', 'GY', 'HK', 'HM',
            'HN', 'HR', 'HT', 'HU', 'ID', 'IE', 'IL', 'IM', 'IN', 'IO', 'IQ', 'IR',
            'IS', 'IT', 'JE', 'JM', 'JO', 'JP', 'KE', 'KG', 'KH', 'KI', 'KM', 'KN',
            'KP', 'KR', 'KW', 'KY', 'KZ', 'LA', 'LB', 'LC', 'LI', 'LK', 'LR', 'LS',
            'LT', 'LU', 'LV', 'LY', 'MA', 'MC', 'MD', 'ME', 'MF', 'MG', 'MH', 'MK',
            'ML', 'MM', 'MN', 'MO', 'MP', 'MQ', 'MR', 'MS', 'MT', 'MU', 'MV', 'MW',
            'MX', 'MY', 'MZ', 'NA', 'NC', 'NE', 'NF', 'NG', 'NI', 'NL', 'NO', 'NP',
            'NR', 'NU', 'NZ', 'OM', 'PA', 'PE', 'PF', 'PG', 'PH', 'PK', 'PL', 'PM',
            'PN', 'PR', 'PS', 'PT', 'PW', 'PY', 'QA', 'RE', 'RO', 'RS', 'RU', 'RW',
            'SA', 'SB', 'SC', 'SD', 'SE', 'SG', 'SH', 'SI', 'SJ', 'SK', 'SL', 'SM',
            'SN', 'SO', 'SR', 'SS', 'ST', 'SV', 'SX', 'SY', 'SZ', 'TC', 'TD', 'TF',
            'TG', 'TH', 'TJ', 'TK', 'TL', 'TM', 'TN', 'TO', 'TR', 'TT', 'TV', 'TW',
            'TZ', 'UA', 'UG', 'UM', 'US', 'UY', 'UZ', 'VA', 'VC', 'VE', 'VG', 'VI',
            'VN', 'VU', 'WF', 'WS', 'YE', 'YT', 'ZA', 'ZM', 'ZW'
          ];
    
          if (validRegionCodes.includes(searchParams.regionCode)) {
            console.log('  âŒ regionCodeëŠ” ìœ íš¨í•˜ì§€ë§Œ YouTubeì—ì„œ ê±°ë¶€ë¨');
            console.log('  ğŸ’¡ ì´ êµ­ê°€ëŠ” YouTube ì„œë¹„ìŠ¤ ì œí•œì´ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
          } else {
            console.log('  âŒ regionCodeê°€ ìœ íš¨í•˜ì§€ ì•ŠìŒ');
          }
    
          console.log('  ğŸ”„ ì „ì„¸ê³„ ê²€ìƒ‰ìœ¼ë¡œ ì¬ì‹œë„í•©ë‹ˆë‹¤...');
          const originalRegionCode = searchParams.regionCode;
          delete searchParams.regionCode;
    
          console.log('  ì¬ì‹œë„ íŒŒë¼ë¯¸í„°:', {
            regionCode: 'ì œê±°ë¨',
            relevanceLanguage: searchParams.relevanceLanguage,
            country: country,
            originalRegionCode: originalRegionCode
          });
    
             const youtube = google.youtube({ 
               version: 'v3', 
               auth: currentApiKey.key,
               timeout: 30000 // 30ì´ˆ íƒ€ì„ì•„ì›ƒ
             });
             response = await youtube.search.list(searchParams);
             console.log('  âœ… ì „ì„¸ê³„ ê²€ìƒ‰ìœ¼ë¡œ ì„±ê³µ');
             console.log(`  âš ï¸  ì£¼ì˜: "${country}" ê²€ìƒ‰ì´ ì „ì„¸ê³„ ê²€ìƒ‰ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.`);
             break; // ì„±ê³µí•˜ë©´ ë£¨í”„ ì¢…ë£Œ
           } else {
             console.log('ë³µêµ¬í•  ìˆ˜ ì—†ëŠ” API ì˜¤ë¥˜:', apiError.message);
             throw apiError; // ë‹¤ë¥¸ ì˜¤ë¥˜ëŠ” ê·¸ëŒ€ë¡œ ì „íŒŒ
           }
         }
       }
    
       // ìµœëŒ€ ì¬ì‹œë„ íšŸìˆ˜ ì´ˆê³¼ ì‹œ
       if (retryCount >= maxRetries && !response) {
         throw new Error('MAX_RETRIES_EXCEEDED: ëª¨ë“  API í‚¤ ì¬ì‹œë„ ì‹¤íŒ¨');
       }
    
      if (!response.data.items || response.data.items.length === 0) {
        break;
      }
    
      console.log(`API ì‘ë‹µ: ${response.data.items.length}ê°œ ë™ì˜ìƒ ë°œê²¬`);
    
      // ë¹„ë””ì˜¤ ID ìˆ˜ì§‘
      const videoIds = response.data.items.map(item => item.id.videoId);
    
      // ë¹„ë””ì˜¤ ìƒì„¸ ì •ë³´ ê°€ì ¸ì˜¤ê¸° (ì¡°íšŒìˆ˜, í†µê³„ í¬í•¨) - ê²¬ê³ í•œ API í‚¤ ì „í™˜ ë¡œì§
      let videoDetails;
      let detailRetryCount = 0;
      const detailMaxRetries = apiKeyManager.apiKeys.length;
    
      while (detailRetryCount < detailMaxRetries) {
        try {
          const youtubeInstance = apiKeyManager.getYouTubeInstance();
          const currentDetailKey = youtubeInstance.currentKey;
          videoDetails = await youtubeInstance.youtube.videos.list({
            part: 'snippet,statistics,contentDetails',
            id: videoIds.join(',')
          });
          break; // ì„±ê³µí•˜ë©´ ë£¨í”„ ì¢…ë£Œ
        } catch (detailError) {
          console.error(`ë¹„ë””ì˜¤ ìƒì„¸ì •ë³´ ì¡°íšŒ ì˜¤ë¥˜:`, detailError.message);
    
          if (detailError.message.includes('quota') || detailError.message.includes('quotaExceeded')) {
            console.log('ğŸš« ë¹„ë””ì˜¤ ìƒì„¸ì •ë³´ ì¡°íšŒ ì¤‘ í• ë‹¹ëŸ‰ ì´ˆê³¼ ê°ì§€');
    
            const currentDetailKey = apiKeyManager.getCurrentKey();
            const newDetailKey = apiKeyManager.markKeyAsQuotaExceeded(currentDetailKey);
            if (newDetailKey) {
              console.log(`ğŸ”„ ${newDetailKey.name}ë¡œ ë¹„ë””ì˜¤ ìƒì„¸ì •ë³´ ì¬ì‹œë„... (ì¬ì‹œë„ ${detailRetryCount + 1}/${detailMaxRetries})`);
              detailRetryCount++;
              continue; // ë‹¤ìŒ ë°˜ë³µìœ¼ë¡œ ê³„ì†
            } else {
              console.log('âŒ ëª¨ë“  API í‚¤ì˜ í• ë‹¹ëŸ‰ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤.');
              throw new Error('ALL_QUOTA_EXCEEDED: ëª¨ë“  API í‚¤ì˜ í• ë‹¹ëŸ‰ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤.');
            }
          } else {
            throw detailError;
          }
        }
      }
    
      // ìµœëŒ€ ì¬ì‹œë„ íšŸìˆ˜ ì´ˆê³¼ ì‹œ
      if (detailRetryCount >= detailMaxRetries && !videoDetails) {
        throw new Error('MAX_RETRIES_EXCEEDED: ë¹„ë””ì˜¤ ìƒì„¸ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨');
      }
    
                         // ê²€ìƒ‰ ê²°ê³¼ ì²˜ë¦¬ (ì¤‘ë³µ ì œê±°) - ë””ë²„ê¹… ë¡œê·¸ ì¶”ê°€
            console.log(`ğŸ“‹ ë¹„ë””ì˜¤ ìƒì„¸ì •ë³´ ì²˜ë¦¬ ì‹œì‘: ${videoDetails.data.items.length}ê°œ ë™ì˜ìƒ`);
    
       for (const video of videoDetails.data.items) {
         filterStats.totalProcessed++;
         console.log(`\nğŸ¬ ì²˜ë¦¬ ì¤‘ (${filterStats.totalProcessed}/${videoDetails.data.items.length}): ${video.snippet.title.substring(0, 50)}...`);
    
         // ì¤‘ë³µ ë¹„ë””ì˜¤ ID ì²´í¬
         if (processedVideoIds.has(video.id)) {
           filterStats.duplicateSkipped++;
           console.log(`  âŒ ì¤‘ë³µ ë™ì˜ìƒ ê±´ë„ˆë›°ê¸°: ${video.id}`);
           continue;
         }
    
         const viewCount = parseInt(video.statistics.viewCount || 0);
         console.log(`  ğŸ“Š ì¡°íšŒìˆ˜: ${viewCount.toLocaleString()}`);
    
         // ì¹´í…Œê³ ë¦¬ í•„í„°ë§ (ì•ˆì „í•œ ì²˜ë¦¬)
         let selectedCategories = [];
         if (categories) {
           if (typeof categories === 'string') {
             selectedCategories = categories.split(',').filter(c => c.trim());
           } else if (Array.isArray(categories)) {
             selectedCategories = categories.filter(c => c && typeof c === 'string' && c.trim());
           }
         }
    
         if (selectedCategories.length > 0 && !selectedCategories.includes(video.snippet.categoryId)) {
           filterStats.categoryFiltered++;
           console.log(`  âŒ ì¹´í…Œê³ ë¦¬ í•„í„°ë§: ${video.snippet.categoryId} ì œì™¸ (ì„ íƒ: ${selectedCategories.join(',')})`);
           continue;
         }
    
         // ì¡°íšŒìˆ˜ í•„í„°ë§
         if (minViews && viewCount < parseInt(minViews)) {
           filterStats.minViewsFiltered++;
           console.log(`  âŒ ìµœì†Œ ì¡°íšŒìˆ˜ ë¯¸ë‹¬: ${viewCount.toLocaleString()} < ${parseInt(minViews).toLocaleString()}`);
           continue;
         }
         if (maxViews && viewCount > parseInt(maxViews)) {
           filterStats.maxViewsFiltered++;
           console.log(`  âŒ ìµœëŒ€ ì¡°íšŒìˆ˜ ì´ˆê³¼: ${viewCount.toLocaleString()} > ${parseInt(maxViews).toLocaleString()}`);
           continue;
         }
    
         // ë™ì˜ìƒ ê¸¸ì´ í•„í„°ë§
         const durationInSeconds = parseDuration(video.contentDetails.duration);
         const videoLengthCategory = getVideoLengthCategory(durationInSeconds);
         console.log(`  â±ï¸ ë™ì˜ìƒ ê¸¸ì´: ${durationInSeconds}ì´ˆ (${videoLengthCategory})`);
    
         if (!matchesVideoLength(videoLengthCategory, selectedVideoLengths)) {
           filterStats.videoLengthFiltered++;
           console.log(`  âŒ ë™ì˜ìƒ ê¸¸ì´ í•„í„°ë§: ${videoLengthCategory} ì œì™¸ (ì„ íƒ: ${selectedVideoLengths.join(',') || 'ëª¨ë“  ê¸¸ì´'})`);
           continue;
         }
    
        // ìµœì†Œí‰ê· ì‹œì²­ë¥  í•„í„°ë§ ì¶”ê°€ (ê°œì„ ëœ ë¡œì§)
        let shouldSkipVideo = false; // í•„í„°ë§ í”Œë˜ê·¸ ì¶”ê°€
    
        if (minAvgWatchRate && parseFloat(minAvgWatchRate) > 0) {
          // ì¹´í…Œê³ ë¦¬ë³„ ì •êµí•œ ê³„ì‚° ë°©ì‹ ì‚¬ìš©
          const categoryName = await getCategoryName(video.snippet.categoryId);
          const avgWatchTime = calculateAverageViewDuration(durationInSeconds, { primary_category: categoryName });
          const avgWatchRatePercentage = durationInSeconds > 0 ? (avgWatchTime / durationInSeconds) * 100 : 0;
    
          console.log(`  ğŸ“Š í‰ê· ì‹œì²­ë¥  ê³„ì‚° (ì¹´í…Œê³ ë¦¬: ${categoryName}): ${avgWatchTime}ì´ˆ / ${durationInSeconds}ì´ˆ = ${avgWatchRatePercentage.toFixed(2)}%`);
          console.log(`  ğŸ¯ í•„í„° ê¸°ì¤€: ${minAvgWatchRate}% ì´ìƒ`);
    
          // í•„í„° ì¡°ê±´: ê³„ì‚°ëœ í‰ê· ì‹œì²­ë¥ ì´ ì…ë ¥ê°’ë³´ë‹¤ ë‚®ìœ¼ë©´ ì œì™¸
          if (avgWatchRatePercentage < parseFloat(minAvgWatchRate)) {
            filterStats.minAvgWatchRateFiltered++;
            console.log(`  âŒ ìµœì†Œí‰ê· ì‹œì²­ë¥  ë¯¸ë‹¬ë¡œ ì œì™¸: ${avgWatchRatePercentage.toFixed(2)}% < ${minAvgWatchRate}%`);
            shouldSkipVideo = true; // í”Œë˜ê·¸ ì„¤ì •
          } else {
            console.log(`  âœ… ìµœì†Œí‰ê· ì‹œì²­ë¥  ì¡°ê±´ í†µê³¼: ${avgWatchRatePercentage.toFixed(2)}% >= ${minAvgWatchRate}%`);
          }
        }
    
        // í•„í„°ë§ëœ ë¹„ë””ì˜¤ëŠ” ê±´ë„ˆë›°ê¸°
        if (shouldSkipVideo) {
          console.log(`  ğŸš« í•„í„°ë§ìœ¼ë¡œ ì¸í•´ ë¹„ë””ì˜¤ ì œì™¸í•¨`);
          continue;
        }
    
        // ì±„ë„ êµ¬ë…ì ìˆ˜ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        console.log(`  ğŸ“¡ ì±„ë„ êµ¬ë…ì ìˆ˜ ì¡°íšŒ ì¤‘: ${video.snippet.channelId}`);
        const subscriberCount = await getChannelSubscriberCount(video.snippet.channelId);
        console.log(`  ğŸ‘¥ êµ¬ë…ì ìˆ˜: ${subscriberCount.toLocaleString()}`);
    
        // ì±„ë„ ê°œì„¤ì¼ ì •ë³´ ê°€ì ¸ì˜¤ê¸° (ìƒˆ ê¸°ëŠ¥)
        console.log(`  ğŸ“… ì±„ë„ ê°œì„¤ì¼ ì¡°íšŒ ì¤‘: ${video.snippet.channelId}`);
        const channelCreatedDate = await getChannelCreatedDate(video.snippet.channelId);
        console.log(`  ğŸ—“ï¸ ì±„ë„ ê°œì„¤ì¼: ${channelCreatedDate || 'ì¡°íšŒ ì•ˆë¨'}`);
    
        // ì±„ë„ ì„¤ëª… ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        console.log(`  ğŸ“ ì±„ë„ ì„¤ëª… ì¡°íšŒ ì¤‘: ${video.snippet.channelId}`);
        const channelDescription = await getChannelDescription(video.snippet.channelId);
        console.log(`  ğŸ“„ ì±„ë„ ì„¤ëª…: ${channelDescription ? 'ì¡°íšŒë¨' : 'ì¡°íšŒ ì•ˆë¨'}`);
    
        // ì±„ë„ êµ­ì  ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        console.log(`  ğŸŒ ì±„ë„ êµ­ì  ì¡°íšŒ ì¤‘: ${video.snippet.channelId}`);
        const channelCountry = await getChannelCountry(video.snippet.channelId);
        console.log(`  ğŸ³ï¸ ì±„ë„ êµ­ì : ${channelCountry}`);
    
        // ì‹¤ì œ ì¢‹ì•„ìš” ê°œìˆ˜ ê°€ì ¸ì˜¤ê¸° (ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ null)
        const actualLikeCount = video.statistics.likeCount ? parseInt(video.statistics.likeCount) : null;
    
        // í‰ê· ì‹œì²­ë¥  ê³„ì‚° (ì„œë²„ì—ì„œ UIë¡œ ì „ë‹¬í•  ê°’)
        const categoryName = await getCategoryName(video.snippet.categoryId);
        const avgWatchTime = calculateAverageViewDuration(durationInSeconds, { primary_category: categoryName });
        const avgWatchRatePercentage = durationInSeconds > 0 ? Math.round((avgWatchTime / durationInSeconds) * 100) : 0;
    
        // ì¶”ê°€ ê³„ì‚°ê°’ë“¤ (í´ë¼ì´ì–¸íŠ¸ ê³„ì‚°ì„ ì„œë²„ë¡œ ì´ë™)
        // 1. ìœ íš¨ì¡°íšŒìˆ˜ (êµ¬ë…ì ìˆ˜ ê¸°ë°˜)
        let validRate = 0.85; // ê¸°ë³¸ê°’
        if (subscriberCount > 1000000) validRate = 0.90;
        else if (subscriberCount > 100000) validRate = 0.88;
        else if (subscriberCount > 10000) validRate = 0.85;
        else if (subscriberCount > 1000) validRate = 0.82;
        else validRate = 0.80;
        const validViewCount = Math.round(viewCount * validRate);
    
        // 2. ìœ íš¨ì¡°íšŒìˆ˜ ë°±ë¶„ìœ¨ (ì†Œìˆ˜ì  ë‘˜ì§¸ìë¦¬ê¹Œì§€)
        const validViewPercentage = viewCount > 0 ? ((validViewCount / viewCount) * 100).toFixed(2) : "0.00";
    
        // 3. ì¢‹ì•„ìš” ê°œìˆ˜ ë° ë°±ë¶„ìœ¨ ê³„ì‚°
        const likeData = calculateLikeCount(video, viewCount, subscriberCount, actualLikeCount);
        const likeCount = likeData.count;
        const isLikeEstimated = likeData.isEstimated;
        const likePercentage = validViewCount > 0 ? Math.round((likeCount / validViewCount) * 100 * 100) / 100 : 0;
    
        const result = {
          youtube_channel_name: video.snippet.channelTitle,
          thumbnail_url: video.snippet.thumbnails.maxres?.url || 
                        video.snippet.thumbnails.standard?.url || 
                        video.snippet.thumbnails.high?.url || 
                        video.snippet.thumbnails.medium?.url || 
                        video.snippet.thumbnails.default?.url,
          status: 'active',
          youtube_channel_id: video.snippet.channelId,
          youtube_channel_description: channelDescription,  // ì±„ë„ ì„¤ëª… ì¶”ê°€
          primary_category: categoryName,
          status_date: video.snippet.publishedAt,
          daily_view_count: viewCount,
          subscriber_count: subscriberCount,
          channel_created_date: channelCreatedDate,  // ìƒˆë¡œ ì¶”ê°€ëœ í•„ë“œ
          actual_like_count: actualLikeCount,  // ì‹¤ì œ ì¢‹ì•„ìš” ê°œìˆ˜ (ì—†ìœ¼ë©´ null)
          vod_url: `https://www.youtube.com/watch?v=${video.id}`,
          video_id: video.id,
          title: video.snippet.title,
          description: video.snippet.description,
          video_tags: video.snippet.tags || [],  // ë¹„ë””ì˜¤ íƒœê·¸ ì •ë³´ ì¶”ê°€
          duration: video.contentDetails.duration,
          duration_seconds: durationInSeconds,
          video_length_category: videoLengthCategory,
          country: primaryCountry,  // ê²€ìƒ‰ í•„í„° êµ­ê°€ ì •ë³´
          channel_country: channelCountry,  // ì±„ë„ì˜ ì‹¤ì œ êµ­ì  ì •ë³´ ì¶”ê°€
          avg_watch_rate_percentage: avgWatchRatePercentage,  // ì„œë²„ì—ì„œ ê³„ì‚°ëœ í‰ê· ì‹œì²­ë¥ 
          avg_watch_time: avgWatchTime,  // í‰ê·  ì‹œì²­ì‹œê°„ (ì´ˆ)
          avg_watch_rate_percentage_for_sort: avgWatchRatePercentage,  // duration-percentage ì •ë ¬ìš©
          valid_view_count: validViewCount,  // ìœ íš¨ì¡°íšŒìˆ˜ (êµ¬ë…ì ìˆ˜ ê¸°ë°˜)
          valid_view_percentage: validViewPercentage,  // ìœ íš¨ì¡°íšŒìˆ˜ ë°±ë¶„ìœ¨
          like_count: likeCount,  // ì¢‹ì•„ìš” ê°œìˆ˜ (ì‹¤ì œ ë˜ëŠ” ì¶”ì •)
          is_like_estimated: isLikeEstimated,  // ì¢‹ì•„ìš” ì¶”ì • ì—¬ë¶€
          like_percentage: likePercentage  // ì¢‹ì•„ìš” ë°±ë¶„ìœ¨
        };
    
        // RPM ì¶”ì •ê°’ ê³„ì‚° ë° ì¶”ê°€ (Phase 1 & 2 ì ìš©)
        result.estimated_rpm = calculateFreeRPM(result);
    
        // Analytics ì¶”ì • ë°ì´í„° ê³„ì‚° ë° ì¶”ê°€
        const analyticsData = calculateEstimatedAnalytics(result);
        result.analytics_view_count = analyticsData.views;
        result.estimated_watch_time = analyticsData.estimatedMinutesWatched;
        result.avg_watch_time = analyticsData.averageViewDuration;
        result.estimated_new_subscribers = analyticsData.subscribersGained;
        result.estimated_ad_impressions = analyticsData.adImpressions;
        result.estimated_total_revenue = analyticsData.estimatedRevenue;
        result.estimated_ad_revenue = analyticsData.estimatedAdRevenue;
        result.estimated_premium_revenue = analyticsData.estimatedRedPartnerRevenue;
        result.playbackBasedCpm = analyticsData.playbackBasedCpm;
        result.adCpm = analyticsData.adCpm;
    
        // 4. RPM ê´€ë ¨ ê³„ì‚°ë“¤
        result.ad_rpm = Math.round((result.estimated_rpm || 0) * 0.85 * 100) / 100;  // ê´‘ê³  RPM
        result.total_rpm = Math.round(((result.estimated_rpm || 0) + result.ad_rpm) * 100) / 100;  // ì´ RPM
    
        // 5. ì±„ë„ RPM í•©ê³„ëŠ” ë‚˜ì¤‘ì— ê³„ì‚° (channel_playback_rpmê³¼ channel_ad_rpm ê³„ì‚° í›„)
    
         // ì¤‘ë³µ ì œê±° í›„ ê²°ê³¼ ì¶”ê°€ - ìµœì¢… í•„í„°ë§ ê²€ì¦ ì¶”ê°€
         console.log(`  ğŸ” ìµœì¢… ê²€ì¦: ê²°ê³¼ ì¶”ê°€ ì „ í•„í„°ë§ ì¬í™•ì¸`);
    
         // ìµœì†Œí‰ê· ì‹œì²­ë¥  í•„í„° ìµœì¢… ì¬ê²€ì¦ (ì´ì¤‘ ì•ˆì „ì¥ì¹˜)
         if (minAvgWatchRate && parseFloat(minAvgWatchRate) > 0) {
           const categoryName = result.primary_category;
           const avgWatchTime = calculateAverageViewDuration(durationInSeconds, { primary_category: categoryName });
           const finalAvgWatchRatePercentage = durationInSeconds > 0 ? (avgWatchTime / durationInSeconds) * 100 : 0;
    
           console.log(`  ğŸ”„ ìµœì¢… ì¬ê²€ì¦: ${finalAvgWatchRatePercentage.toFixed(2)}% vs ${minAvgWatchRate}%`);
    
           if (finalAvgWatchRatePercentage < parseFloat(minAvgWatchRate)) {
             console.log(`  ğŸš« ìµœì¢… ê²€ì¦ ì‹¤íŒ¨: ${finalAvgWatchRatePercentage.toFixed(2)}% < ${minAvgWatchRate}% - ê²°ê³¼ ì¶”ê°€ ì•ˆí•¨`);
             continue; // ì—¬ê¸°ì„œ í™•ì‹¤íˆ ì œì™¸
           } else {
             console.log(`  âœ… ìµœì¢… ê²€ì¦ í†µê³¼: ${finalAvgWatchRatePercentage.toFixed(2)}% >= ${minAvgWatchRate}% - ê²°ê³¼ ì¶”ê°€í•¨`);
           }
         }
    
         filterStats.finalAccepted++;
         searchResults.push(result);
         processedVideoIds.add(video.id); // ì²˜ë¦¬ëœ ID ê¸°ë¡
         console.log(`  âœ… ê²°ê³¼ ì¶”ê°€ ì™„ë£Œ: ${searchResults.length}ë²ˆì§¸ (ìµœì¢… ìŠ¹ì¸ë¨)`);
    
         if (searchResults.length >= finalMaxResults) {
           console.log(`  ğŸ¯ ìš”ì²­ëœ ê²°ê³¼ ìˆ˜ ë‹¬ì„±: ${finalMaxResults}ê°œ`);
           break;
         }
       }
    
      nextPageToken = response.data.nextPageToken;
      if (!nextPageToken) break;
    
      // API í˜¸ì¶œ ì œí•œì„ ìœ„í•œ ì§€ì—° (quota ì ˆì•½)
      await new Promise(resolve => setTimeout(resolve, 500));
    }
    
         // ì¡°íšŒìˆ˜ ê¸°ì¤€ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬
     searchResults.sort((a, b) => b.daily_view_count - a.daily_view_count);
    
     // ì±„ë„ë³„ ëˆ„ì  RPM ê°’ ê³„ì‚° ë° ê° ê²°ê³¼ì— ì¶”ê°€
     const channelAccumulations = {};
     searchResults.forEach(result => {
       const channelId = result.youtube_channel_id || result.youtube_channel_name || 'unknown';
    
       if (!channelAccumulations[channelId]) {
         channelAccumulations[channelId] = {
           totalPlaybackRpm: 0,
           totalAdRpm: 0,
           videoCount: 0
         };
       }
    
       const acc = channelAccumulations[channelId];
       acc.totalPlaybackRpm += parseFloat(result.estimated_rpm || 0);
       acc.totalAdRpm += parseFloat(result.estimated_rpm || 0) * 0.85;
       acc.videoCount++;
     });
    
     // ê° ê²°ê³¼ì— ì±„ë„ë³„ ëˆ„ì  RPM ê°’ ì¶”ê°€
     searchResults.forEach(result => {
       const channelId = result.youtube_channel_id || result.youtube_channel_name || 'unknown';
       const acc = channelAccumulations[channelId];
       if (acc) {
         result.channel_playback_rpm = Math.round(acc.totalPlaybackRpm * 100) / 100;
         result.channel_ad_rpm = Math.round(acc.totalAdRpm * 100) / 100;
       } else {
         result.channel_playback_rpm = 0;
         result.channel_ad_rpm = 0;
       }
    
       // ì±„ë„ RPM í•©ê³„ ê³„ì‚° (channel_playback_rpmê³¼ channel_ad_rpm ê³„ì‚° ì™„ë£Œ í›„)
       result.channel_total_rpm = Math.round(((result.channel_playback_rpm || 0) + (result.channel_ad_rpm || 0)) * 100) / 100;
     });
    
     // ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ ë°©ì§€ë¥¼ ìœ„í•œ ë©”ëª¨ë¦¬ ì •ë¦¬
     try {
       processedVideoIds.clear();
       processedChannelTitles.clear();
       if (global.gc) {
         global.gc();
       }
     } catch (memError) {
       console.warn('ë©”ëª¨ë¦¬ ì •ë¦¬ ì˜¤ë¥˜:', memError.message);
     }
    
     // í•„í„°ë§ í†µê³„ ìš”ì•½ ì¶œë ¥ ì¶”ê°€
     console.log(`\nğŸ“Š í•„í„°ë§ ê²°ê³¼ ìš”ì•½:`);
     console.log(`- ì´ ê²€ìƒ‰ëœ ì˜ìƒ: ${filterStats.totalProcessed}ê°œ`);
     if (filterStats.duplicateSkipped > 0) {
       console.log(`- ì¤‘ë³µ ì œì™¸: ${filterStats.duplicateSkipped}ê°œ`);
     }
     if (filterStats.categoryFiltered > 0) {
       console.log(`- ì¹´í…Œê³ ë¦¬ ì¡°ê±´ìœ¼ë¡œ ì œì™¸: ${filterStats.categoryFiltered}ê°œ`);
     }
     if (filterStats.minViewsFiltered > 0) {
       console.log(`- ìµœì†Œ ì¡°íšŒìˆ˜ ì¡°ê±´ìœ¼ë¡œ ì œì™¸: ${filterStats.minViewsFiltered}ê°œ`);
     }
     if (filterStats.maxViewsFiltered > 0) {
       console.log(`- ìµœëŒ€ ì¡°íšŒìˆ˜ ì¡°ê±´ìœ¼ë¡œ ì œì™¸: ${filterStats.maxViewsFiltered}ê°œ`);
     }
     if (filterStats.videoLengthFiltered > 0) {
       console.log(`- ë™ì˜ìƒ ê¸¸ì´ ì¡°ê±´ìœ¼ë¡œ ì œì™¸: ${filterStats.videoLengthFiltered}ê°œ`);
     }
     if (filterStats.minAvgWatchRateFiltered > 0) {
       console.log(`- ìµœì†Œí‰ê· ì‹œì²­ë¥ (${minAvgWatchRate}%) ì¡°ê±´ìœ¼ë¡œ ì œì™¸: ${filterStats.minAvgWatchRateFiltered}ê°œ`);
     }
     console.log(`- ìµœì¢… ê²°ê³¼: ${filterStats.finalAccepted}ê°œ`);
    
     // ê¸°ì¡´ ì¤‘ë³µ ì œê±° í†µê³„
     const totalProcessed = processedVideoIds.size + searchResults.length;
     const duplicatesRemoved = totalProcessed - searchResults.length;
    
     console.log(`\nê²€ìƒ‰ ì™„ë£Œ: ${searchResults.length}ê°œ ê²°ê³¼`);
     console.log(`ğŸ“Š API ì‚¬ìš©ëŸ‰: ê²€ìƒ‰ API ${Math.ceil(searchResults.length / 50)}íšŒ + ìƒì„¸ì •ë³´ API ${Math.ceil(searchResults.length / 50)}íšŒ (${finalMaxResults}ê±´ ìš”ì²­ ì¤‘ ${searchResults.length}ê±´ ê²°ê³¼)`);
    
     // API í‚¤ ì‚¬ìš© í†µê³„ ì¶œë ¥
     apiKeyManager.printUsageStats();
    
     // ========== YouTube API ê²°ê³¼ë¥¼ Elasticsearchì— ì¸ë±ì‹± ==========
     if (searchResults.length > 0) {
     console.log('ğŸ“ YouTube API ê²°ê³¼ë¥¼ Elasticsearchì— ì¸ë±ì‹± ì¤‘...');
     try {
     await esHelper.bulkUpsertVideos(searchResults, searchParameters);
     console.log('âœ… Elasticsearch ì¸ë±ì‹± ì™„ë£Œ');
     } catch (esError) {
     console.error('âš ï¸ Elasticsearch ì¸ë±ì‹± ì‹¤íŒ¨:', esError.message);
     console.log('ğŸ’¡ YouTube API ê²°ê³¼ëŠ” ì •ìƒ ë°˜í™˜í•˜ì§€ë§Œ ìºì‹œ ì €ì¥ì€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
     }
     }
     // ========== Elasticsearch ì¸ë±ì‹± ë ==========
    
     // ê²€ìƒ‰ ì†Œìš”ì‹œê°„ ê³„ì‚° ë° ì¶œë ¥
     const searchEndTime = Date.now();
     const searchDuration = searchEndTime - searchStartTime;
     const durationSeconds = (searchDuration / 1000).toFixed(2);
    
     console.log(`\nâ±ï¸ ê²€ìƒ‰ ì™„ë£Œ: ì´ ì†Œìš”ì‹œê°„ ${durationSeconds}ì´ˆ (${searchResults.length}ê°œ ê²°ê³¼)`);
    console.log(`ğŸ” ê²€ìƒ‰ ì¡°ê±´: ${country}/${keyword || 'í‚¤ì›Œë“œ ì—†ìŒ'}/${finalMaxResults}ê±´`);
    console.log('='.repeat(52));
    
    res.json({
      success: true,
      data: searchResults,
      total: searchResults.length,
      source: 'youtube_api_with_es_cache',
      searchDuration: `${durationSeconds}ì´ˆ`
    });

  } catch (error) {
    console.error('ê²€ìƒ‰ ì˜¤ë¥˜:', error);

    // ì˜¤ë¥˜ ë°œìƒ ì‹œì—ë„ ì†Œìš”ì‹œê°„ ì¶œë ¥
    const errorEndTime = Date.now();
    const errorDuration = errorEndTime - searchStartTime;
    const errorDurationSeconds = (errorDuration / 1000).toFixed(2);
    
    console.log(`\nâš ï¸ ê²€ìƒ‰ ì‹¤íŒ¨: ì†Œìš”ì‹œê°„ ${errorDurationSeconds}ì´ˆ`);
    console.log('='.repeat(52));
    
    // API í‚¤ ì‚¬ìš© í†µê³„ ì¶œë ¥ (ì˜¤ë¥˜ ë°œìƒ ì‹œì—ë„)
    apiKeyManager.printUsageStats();
    
    // YouTube API quota ì´ˆê³¼ ì˜¤ë¥˜ ì²˜ë¦¬ - ìˆ˜ì •ëœ ë¡œì§
    if (error.message.includes('quota') || error.message.includes('quotaExceeded')) {
      console.error('YouTube API í• ë‹¹ëŸ‰ ì´ˆê³¼ ê°ì§€');
    
      // ì‹¤ì œë¡œ ì‚¬ìš© ê°€ëŠ¥í•œ í‚¤ê°€ ìˆëŠ”ì§€ í™•ì¸
      const availableKeys = apiKeyManager.apiKeys.filter(key => !key.quotaExceeded);
      const totalKeys = apiKeyManager.apiKeys.length;
      const exhaustedKeys = totalKeys - availableKeys.length;
    
      // ì‚¬ìš© ê°€ëŠ¥í•œ í‚¤ê°€ ìˆìœ¼ë©´ 429 ì—ëŸ¬ë¥¼ ë°˜í™˜í•˜ì§€ ì•Šê³  ì¬ì‹œë„ ìœ ë„
      if (availableKeys.length > 0) {
        console.log(`ì‚¬ìš© ê°€ëŠ¥í•œ API í‚¤ê°€ ${availableKeys.length}ê°œ ë‚¨ì•„ìˆìŒ, ì´ ì˜¤ë¥˜ëŠ” ë‚´ë¶€ ì²˜ë¦¬ ì¤‘ ë°œìƒí•œ ì¼ì‹œì  ì˜¤ë¥˜ì…ë‹ˆë‹¤.`);
    
        // 500 ì—ëŸ¬ë¡œ ë°˜í™˜í•˜ì—¬ í´ë¼ì´ì–¸íŠ¸ê°€ ì¬ì‹œë„í•  ìˆ˜ ìˆë„ë¡ í•¨
        res.status(500).json({
          success: false,
          error: 'ì¼ì‹œì ì¸ API í‚¤ ì „í™˜ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ì¬ì‹œë„í•´ ì£¼ì„¸ìš”.',
          errorType: 'temporary_api_key_switch_error',
          details: `${availableKeys.length}ê°œì˜ API í‚¤ê°€ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.`,
          keyStats: {
            total: totalKeys,
            available: availableKeys.length,
            exhausted: exhaustedKeys
          }
        });
      } else {
        // ëª¨ë“  í‚¤ê°€ ì‹¤ì œë¡œ ì†Œì§„ëœ ê²½ìš°ì—ë§Œ 429 ì—ëŸ¬ ë°˜í™˜
        console.error('ëª¨ë“  YouTube API í‚¤ì˜ í• ë‹¹ëŸ‰ì´ ì´ˆê³¼ë¨');
        res.status(429).json({
          success: false,
          error: `YouTube API ì¼ì¼ í• ë‹¹ëŸ‰ì„ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤. (${exhaustedKeys}/${totalKeys} í‚¤ ì‚¬ìš©ë¨)`,
          errorType: 'quota_exceeded',
          details: 'ëª¨ë“  API í‚¤ì˜ í• ë‹¹ëŸ‰ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤. ë‚´ì¼ ìë™ìœ¼ë¡œ í• ë‹¹ëŸ‰ì´ ì¬ì„¤ì •ë©ë‹ˆë‹¤.',
          keyStats: {
            total: totalKeys,
            available: availableKeys.length,
            exhausted: exhaustedKeys
          }
        });
      }
    } else if (error.message.includes('API key')) {
      console.error('YouTube API í‚¤ ì˜¤ë¥˜');
      res.status(401).json({
        success: false,
        error: 'YouTube API í‚¤ê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.',
        errorType: 'invalid_api_key'
      });
    } else {
      res.status(500).json({
        success: false,
        error: error.message,
        errorType: 'general_error'
      });
    }

  }
});

// ì¸ë„¤ì¼ ë‹¤ìš´ë¡œë“œ APIëŠ” ì•„ë˜ì— ê°œì„ ëœ ë²„ì „ì´ ìˆìŠµë‹ˆë‹¤.

// Excel ë‹¤ìš´ë¡œë“œ API
app.post('/api/download-excel', async (req, res) => {
  try {
    const { searchResults, searchParams } = req.body;

    if (!searchResults || !Array.isArray(searchResults)) {
      return res.status(400).json({ error: 'ê²€ìƒ‰ ê²°ê³¼ ë°ì´í„°ê°€ í•„ìš”í•©ë‹ˆë‹¤.' });
    }
    
    // ëŒ€ìš©ëŸ‰ ë°ì´í„° ì œí•œ ì¶”ê°€
    if (searchResults.length > 1000) {
      return res.status(413).json({ 
        error: 'ê²°ê³¼ê°€ ë„ˆë¬´ ë§ìŠµë‹ˆë‹¤. 1000ê±´ ì´í•˜ë¡œ í•„í„°ë§í•´ì£¼ì„¸ìš”.',
        maxAllowed: 1000,
        currentCount: searchResults.length
      });
    }
    
    // ì±„ë„ë³„ ëˆ„ì  ê°’ ê³„ì‚°
    const channelAccumulations = {};
    
    // ê° ì±„ë„ë³„ë¡œ ëˆ„ì  ê°’ ê³„ì‚°
    searchResults.forEach(result => {
      const channelId = result.youtube_channel_id || result.youtube_channel_name || 'unknown';
    
      if (!channelAccumulations[channelId]) {
        channelAccumulations[channelId] = {
          totalPlaybackCpm: 0,
          totalAdCpm: 0,
          totalPlaybackRpm: 0,
          totalAdRpm: 0,
          videoCount: 0
        };
      }
    
      const acc = channelAccumulations[channelId];
      acc.totalPlaybackCpm += parseFloat(result.playbackBasedCpm || 0);
      acc.totalAdCpm += parseFloat(result.adCpm || 0);
      acc.totalPlaybackRpm += parseFloat(result.estimated_rpm || 0);
      acc.totalAdRpm += parseFloat(result.estimated_rpm || 0) * 0.85;
      acc.videoCount++;
    });
    
    // Excelìš© ë°ì´í„° ë³€í™˜ 
    const excelData = searchResults.map((result, index) => {
      return {
        'ìˆœë²ˆ': index + 1,
        'ê°€ì…ì¼': result.channel_created_date ? new Date(result.channel_created_date).toLocaleDateString('ko-KR') : '',
        'ë¸Œëœë“œ': isBrandChannel(result) ? 1 : 0,
        'êµ­ì ': result.channel_country || '',
        'êµ­ê°€': result.country || '',
        'ì±„ë„ ID': result.youtube_channel_id || '',
        'ì±„ë„ëª…': result.youtube_channel_name || '',
        'ì±„ë„ì„¤ëª…': result.youtube_channel_description || '',
        'íƒœê·¸': Array.isArray(result.video_tags) ? result.video_tags.join(', ') : (result.video_tags || ''),
        'ë™ì˜ìƒ ì œëª©': result.title || '',
        'ë™ì˜ìƒ ì„¤ëª…': result.description || '',
        'ì¹´í…Œê³ ë¦¬': result.primary_category || '',
        'ì—…ë¡œë“œì¼': result.status_date ? new Date(result.status_date).toLocaleDateString('ko-KR') : '',
        'ì¡°íšŒìˆ˜': parseInt(result.daily_view_count || 0).toLocaleString(),
        'ìœ íš¨ì¡°íšŒìˆ˜': Math.round((result.daily_view_count || 0) * 0.85).toLocaleString(),
        'ì¢‹ì•„ìš”ê°œìˆ˜(ìœ íš¨ ì¡°íšŒìˆ˜ì— ëŒ€í•œ ì¢‹ì•„ìš” ë°±ë¶„ìœ¨(%))': (() => {
          const likeCount = result.actual_like_count || Math.round((result.daily_view_count || 0) * 0.01);
          const validViewCount = Math.round((result.daily_view_count || 0) * 0.85);
          const percentage = validViewCount > 0 ? Math.round((likeCount / validViewCount) * 100 * 100) / 100 : 0;
          return `${likeCount.toLocaleString()}(${percentage}%)`;
        })(),
        'êµ¬ë…ì': formatSubscriberCountForExcel(result.subscriber_count || 0),
        'URL': result.vod_url || '',
        'ì‹œê°„(ì´ˆ)': result.duration_seconds || 0,
        'ì‹œê°„(í˜•ì‹)': formatDurationForExcel(result.duration_seconds),
        'ë™ì˜ìƒ ê¸¸ì´': formatVideoLengthForExcel(result.video_length_category) || '',
        'ìƒíƒœ': result.status || '',
        'ì¸ë„¤ì¼ URL': result.thumbnail_url || '',
        // Analytics ì¶”ì • ì»¬ëŸ¼ë“¤ (ì¸ë„¤ì¼ URL ì˜¤ë¥¸ìª½)
        'Analytics ì¡°íšŒìˆ˜': result.analytics_view_count ? parseInt(result.analytics_view_count).toLocaleString() : '0',
        'ì¶”ì • ì‹œì²­ì‹œê°„(ë¶„)': result.estimated_watch_time ? Math.round(result.estimated_watch_time * 100) / 100 : '0.00',
        'í‰ê·  ì‹œì²­ì‹œê°„(ì´ˆ)': result.avg_watch_time ? Math.round(result.avg_watch_time) : '0',
        'ì‹ ê·œ êµ¬ë…ì ìˆ˜': result.estimated_new_subscribers ? Math.round(result.estimated_new_subscribers) : '0',
        'ê´‘ê³  ë…¸ì¶œ ìˆ˜': result.estimated_ad_impressions ? Math.round(result.estimated_ad_impressions).toLocaleString() : '0',
        'ì¶”ì • ì´ìˆ˜ìµ($)': result.estimated_total_revenue ? `$${Math.round(result.estimated_total_revenue * 100) / 100}` : '$0.00',
        'ì¶”ì • ê´‘ê³ ìˆ˜ìµ($)': result.estimated_ad_revenue ? `$${Math.round(result.estimated_ad_revenue * 100) / 100}` : '$0.00',
        'ì¶”ì • Premiumìˆ˜ìµ($)': result.estimated_premium_revenue ? `$${Math.round(result.estimated_premium_revenue * 100) / 100}` : '$0.00',
        'ì¬ìƒê¸°ë°˜ CPM($)': result.playbackBasedCpm ? `$${Math.round(result.playbackBasedCpm * 100) / 100}` : '$0.00',
        'ê´‘ê³  CPM($)': result.adCpm ? `$${Math.round(result.adCpm * 100) / 100}` : '$0.00',
        // ì¶”ê°€ RPM ì»¬ëŸ¼ë“¤ (ë§¨ ë§ˆì§€ë§‰)
        'ì¬ìƒê¸°ë°˜ RPM($)': result.estimated_rpm ? `$${result.estimated_rpm}` : '$0.00',
        'ê´‘ê³  RPM($)': result.estimated_rpm ? `$${Math.round(result.estimated_rpm * 0.85 * 100) / 100}` : '$0.00',
        // ì±„ë„ ì „ì²´ ëˆ„ì  ê°’ ì»¬ëŸ¼ë“¤
        'ì¬ìƒëˆ„ì  CPM($)': (() => {
          const channelId = result.youtube_channel_id || result.youtube_channel_name || 'unknown';
          const acc = channelAccumulations[channelId];
          return acc ? `$${Math.round(acc.totalPlaybackCpm * 100) / 100}` : '$0.00';
        })(),
        'ê´‘ê³ ëˆ„ì  CPM($)': (() => {
          const channelId = result.youtube_channel_id || result.youtube_channel_name || 'unknown';
          const acc = channelAccumulations[channelId];
          return acc ? `$${Math.round(acc.totalAdCpm * 100) / 100}` : '$0.00';
        })(),
        'ì¬ìƒëˆ„ì  RPM($)': (() => {
          const channelId = result.youtube_channel_id || result.youtube_channel_name || 'unknown';
          const acc = channelAccumulations[channelId];
          return acc ? `$${Math.round(acc.totalPlaybackRpm * 100) / 100}` : '$0.00';
        })(),
        'ê´‘ê³ ëˆ„ì  RPM($)': (() => {
          const channelId = result.youtube_channel_id || result.youtube_channel_name || 'unknown';
          const acc = channelAccumulations[channelId];
          return acc ? `$${Math.round(acc.totalAdRpm * 100) / 100}` : '$0.00';
        })()
      };
    });
    
    // ì›Œí¬ë¶ ìƒì„±
    const workbook = XLSX.utils.book_new();
    const worksheet = XLSX.utils.json_to_sheet(excelData);
    
    // ì»¬ëŸ¼ ë„ˆë¹„ ìë™ ì¡°ì • (40ê°œ ì»¬ëŸ¼)
    const columnWidths = [
      { wch: 6 },  // ìˆœë²ˆ
      { wch: 12 }, // ê°€ì…ì¼
      { wch: 8 },  // ë¸Œëœë“œ
      { wch: 20 }, // ì±„ë„ ID
      { wch: 25 }, // ì±„ë„ëª…
      { wch: 50 }, // ì±„ë„ì„¤ëª…
      { wch: 30 }, // íƒœê·¸
      { wch: 40 }, // ë™ì˜ìƒ ì œëª©
      { wch: 50 }, // ë™ì˜ìƒ ì„¤ëª…
      { wch: 15 }, // ì¹´í…Œê³ ë¦¬
      { wch: 12 }, // êµ­ê°€
      { wch: 12 }, // ì—…ë¡œë“œì¼
      { wch: 12 }, // ì¡°íšŒìˆ˜
      { wch: 12 }, // ìœ íš¨ì¡°íšŒìˆ˜
      { wch: 35 }, // ì¢‹ì•„ìš”ê°œìˆ˜(ìœ íš¨ ì¡°íšŒìˆ˜ì— ëŒ€í•œ ì¢‹ì•„ìš” ë°±ë¶„ìœ¨(%))
      { wch: 12 }, // êµ¬ë…ì
      { wch: 50 }, // URL
      { wch: 8 },  // ì‹œê°„(ì´ˆ)
      { wch: 10 }, // ì‹œê°„(í˜•ì‹)
      { wch: 12 }, // ë™ì˜ìƒ ê¸¸ì´
      { wch: 10 }, // ìƒíƒœ
      { wch: 50 }, // ì¸ë„¤ì¼ URL
      // Analytics ì»¬ëŸ¼ë“¤
      { wch: 15 }, // Analytics ì¡°íšŒìˆ˜
      { wch: 18 }, // ì¶”ì • ì‹œì²­ì‹œê°„(ë¶„)
      { wch: 18 }, // í‰ê·  ì‹œì²­ì‹œê°„(ì´ˆ)
      { wch: 15 }, // ì‹ ê·œ êµ¬ë…ì ìˆ˜
      { wch: 15 }, // ê´‘ê³  ë…¸ì¶œ ìˆ˜
      { wch: 18 }, // ì¶”ì • ì´ìˆ˜ìµ($)
      { wch: 18 }, // ì¶”ì • ê´‘ê³ ìˆ˜ìµ($)
      { wch: 20 }, // ì¶”ì • Premiumìˆ˜ìµ($)
      { wch: 18 }, // ì¬ìƒê¸°ë°˜ CPM($)
      { wch: 15 }, // ê´‘ê³  CPM($)
      // RPM ì»¬ëŸ¼ë“¤
      { wch: 18 }, // ì¬ìƒê¸°ë°˜ RPM($)
      { wch: 15 }, // ê´‘ê³  RPM($)
      // ì±„ë„ ì „ì²´ ëˆ„ì  ê°’ ì»¬ëŸ¼ë“¤
      { wch: 18 }, // ì¬ìƒëˆ„ì  CPM($)
      { wch: 18 }, // ê´‘ê³ ëˆ„ì  CPM($)
      { wch: 18 }, // ì¬ìƒëˆ„ì  RPM($)
      { wch: 18 }  // ê´‘ê³ ëˆ„ì  RPM($)
    ];
    worksheet['!cols'] = columnWidths;
    
    // ì›Œí¬ì‹œíŠ¸ë¥¼ ì›Œí¬ë¶ì— ì¶”ê°€
    XLSX.utils.book_append_sheet(workbook, worksheet, 'YouTube ê²€ìƒ‰ ê²°ê³¼');
    
    // Excel íŒŒì¼ì„ ë²„í¼ë¡œ ìƒì„±
    const excelBuffer = XLSX.write(workbook, { 
      type: 'buffer', 
      bookType: 'xlsx',
      compression: true 
    });
    
    // íŒŒì¼ëª… ìƒì„± (ê²€ìƒ‰ ì¡°ê±´ í¬í•¨) - ëŒ€í•œë¯¼êµ­ ì‹œê°„ ê¸°ì¤€
    const now = new Date();
    const kstTime = new Date(now.getTime() + (9 * 60 * 60 * 1000)); // UTC+9 (ëŒ€í•œë¯¼êµ­ ì‹œê°„)
    const timestamp = kstTime.toISOString().slice(0, 19).replace(/:/g, '-');
    const keyword = searchParams?.keyword || 'ì „ì²´';
    const country = searchParams?.country || 'worldwide';
    const resultCount = searchResults.length;
    
    // ë‚ ì§œ ë²”ìœ„ ì •ë³´ í¬í•¨
    let dateRangeStr = '';
    if (searchParams?.startDate || searchParams?.endDate) {
      const startDateStr = searchParams?.startDate ? searchParams.startDate.replace(/-/g, '') : '';
      const endDateStr = searchParams?.endDate ? searchParams.endDate.replace(/-/g, '') : '';
      if (startDateStr && endDateStr) {
        dateRangeStr = `_${startDateStr}-${endDateStr}`;
      } else if (startDateStr) {
        dateRangeStr = `_${startDateStr}ì´í›„`;
      } else if (endDateStr) {
        dateRangeStr = `_${endDateStr}ì´ì „`;
      }
    } else if (searchParams?.uploadPeriod) {
      dateRangeStr = `_${searchParams.uploadPeriod}`;
    }
    
    const filename = `YouTube_${keyword}_${country}${dateRangeStr}_[${resultCount}]_${timestamp}.xlsx`;
    
    // ì‘ë‹µ í—¤ë” ì„¤ì •
    res.setHeader('Content-Disposition', `attachment; filename="${encodeURIComponent(filename)}"`);
    res.setHeader('Content-Type', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');
    res.setHeader('Content-Length', excelBuffer.length);
    
    // Excel íŒŒì¼ ì „ì†¡
    res.send(excelBuffer);
    
    console.log(`âœ… Excel íŒŒì¼ ìƒì„± ì™„ë£Œ: ${filename} (${searchResults.length}í–‰)`);

  } catch (error) {
    console.error('Excel ë‹¤ìš´ë¡œë“œ ì˜¤ë¥˜:', error);
    res.status(500).json({ error: 'Excel íŒŒì¼ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.' });
  }
});

// Excelìš© ì‹œê°„ í¬ë§· í•¨ìˆ˜
function formatDurationForExcel(durationSeconds) {
  if (!durationSeconds || durationSeconds === 0) {
    return '00:00';
  }

  const hours = Math.floor(durationSeconds / 3600);
  const minutes = Math.floor((durationSeconds % 3600) / 60);
  const seconds = durationSeconds % 60;

  if (hours > 0) {
    return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
  } else {
    return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
  }
}

// Excelìš© êµ¬ë…ì ìˆ˜ í¬ë§· í•¨ìˆ˜ (ë§Œ ë‹¨ìœ„)
function formatSubscriberCountForExcel(count) {
  if (!count || count === 0) {
    return '0';
  }

  const number = parseInt(count);
  const inTenThousands = number / 10000;

  if (number < 10000) {
    // 1ë§Œ ë¯¸ë§Œì¸ ê²½ìš° ì†Œìˆ˜ì  2ìë¦¬ í‘œì‹œ
    return inTenThousands.toFixed(2);
  } else {
    // 1ë§Œ ì´ìƒì¸ ê²½ìš° ì†Œìˆ˜ì  1ìë¦¬ í‘œì‹œ (100ë§Œ ì´ìƒë„ í¬í•¨)
    return inTenThousands.toFixed(1);
  }
}

// Excelìš© ë™ì˜ìƒ ê¸¸ì´ ì¹´í…Œê³ ë¦¬ í¬ë§· í•¨ìˆ˜
function formatVideoLengthForExcel(category) {
  const categoryMap = {
    'short1': 'Short Form1 (1ë¶„ ë¯¸ë§Œ)',
    'short2': 'Short Form2 (1ë¶„ ì´ìƒ 2ë¶„ ë¯¸ë§Œ)',
    'mid1': 'Mid Form1 (2ë¶„ ì´ìƒ 10ë¶„ ë¯¸ë§Œ)',
    'mid2': 'Mid Form2 (10ë¶„ ì´ìƒ 20ë¶„ ë¯¸ë§Œ)',
    'long1': 'Long Form1 (20ë¶„ ì´ìƒ 30ë¶„ ë¯¸ë§Œ)',
    'long2': 'Long Form2 (30ë¶„ ì´ìƒ 40ë¶„ ë¯¸ë§Œ)',
    'long3': 'Long Form3 (40ë¶„ ì´ìƒ 50ë¶„ ë¯¸ë§Œ)',
    'long4': 'Long Form4 (50ë¶„ ì´ìƒ 60ë¶„ ë¯¸ë§Œ)',
    'long5': 'Long Form5 (60ë¶„ ì´ìƒ 90ë¶„ ë¯¸ë§Œ)',
    'long6': 'Long Form6 (90ë¶„ ì´ìƒ)'
  };

  return categoryMap[category] || category || 'ì•Œ ìˆ˜ ì—†ìŒ';
}

// í—¬í¼ í•¨ìˆ˜ë“¤
function getCountryCode(country) {
  // YouTube APIê°€ ê³µì‹ ì§€ì›í•˜ëŠ” regionCode ëª©ë¡ (25ê°œêµ­ ì™„ì „ ì§€ì›)
  const countryMap = {
    'worldwide': null, // ì „ì„¸ê³„ ê²€ìƒ‰ ì‹œ regionCode ì—†ìŒ
    'korea': 'KR',     // âœ… í•œêµ­ - ì•ˆì •ì 
    'usa': 'US',       // âœ… ë¯¸êµ­ - ì•ˆì •ì 
    'japan': 'JP',     // âœ… ì¼ë³¸ - ì•ˆì •ì 
    'china': 'CN',     // âœ… ì¤‘êµ­ - ì§€ì› ì¶”ê°€
    'uk': 'GB',        // âœ… ì˜êµ­ - ì•ˆì •ì 
    'germany': 'DE',   // âœ… ë…ì¼ - ì•ˆì •ì 
    'france': 'FR',    // âœ… í”„ë‘ìŠ¤ - ì•ˆì •ì 
    'canada': 'CA',    // âœ… ìºë‚˜ë‹¤ - ì•ˆì •ì 
    'australia': 'AU', // âœ… í˜¸ì£¼ - ì•ˆì •ì 
    'india': 'IN',     // âœ… ì¸ë„ - ì•ˆì •ì 
    'brazil': 'BR',    // âœ… ë¸Œë¼ì§ˆ - ì•ˆì •ì 
    'mexico': 'MX',    // âœ… ë©•ì‹œì½” - ì•ˆì •ì 
    'russia': 'RU',    // âœ… ëŸ¬ì‹œì•„ - ì§€ì› ì¶”ê°€
    'italy': 'IT',     // âœ… ì´íƒˆë¦¬ì•„ - ì•ˆì •ì 
    'spain': 'ES',     // âœ… ìŠ¤í˜ì¸ - ì•ˆì •ì 
    // ì•„ì‹œì•„-íƒœí‰ì–‘ ì¶”ê°€ êµ­ê°€ë“¤
    'thailand': 'TH',  // âœ… íƒœêµ­ - ì§€ì› ì¶”ê°€
    'vietnam': 'VN',   // âœ… ë² íŠ¸ë‚¨ - ì§€ì› ì¶”ê°€
    'indonesia': 'ID', // âœ… ì¸ë„ë„¤ì‹œì•„ - ì§€ì› ì¶”ê°€
    // ë‚¨ë¯¸ ì¶”ê°€ êµ­ê°€ë“¤
    'argentina': 'AR', // âœ… ì•„ë¥´í—¨í‹°ë‚˜ - ì§€ì› ì¶”ê°€
    'colombia': 'CO',  // âœ… ì½œë¡¬ë¹„ì•„ - ì§€ì› ì¶”ê°€
    // ì¤‘ë™ & ì•„í”„ë¦¬ì¹´ ì¶”ê°€ êµ­ê°€ë“¤
    'saudi': 'SA',     // âœ… ì‚¬ìš°ë””ì•„ë¼ë¹„ì•„ - ì§€ì› ì¶”ê°€
    'uae': 'AE',       // âœ… UAE - ì§€ì› ì¶”ê°€
    'southafrica': 'ZA', // âœ… ë‚¨ì•„í”„ë¦¬ì¹´ê³µí™”êµ­ - ì§€ì› ì¶”ê°€
    'nigeria': 'NG',   // âœ… ë‚˜ì´ì§€ë¦¬ì•„ - ì§€ì› ì¶”ê°€
    'egypt': 'EG'      // âœ… ì´ì§‘íŠ¸ - ì§€ì› ì¶”ê°€
  };

  const code = countryMap[country.toLowerCase()];

  // ìœ íš¨í•œ regionCodeì¸ì§€ í™•ì¸ (YouTube API ì§€ì› êµ­ê°€ë§Œ)
  const validRegionCodes = [
    'AD', 'AE', 'AF', 'AG', 'AI', 'AL', 'AM', 'AO', 'AQ', 'AR', 'AS', 'AT',
    'AU', 'AW', 'AX', 'AZ', 'BA', 'BB', 'BD', 'BE', 'BF', 'BG', 'BH', 'BI',
    'BJ', 'BL', 'BM', 'BN', 'BO', 'BQ', 'BR', 'BS', 'BT', 'BV', 'BW', 'BY',
    'BZ', 'CA', 'CC', 'CD', 'CF', 'CG', 'CH', 'CI', 'CK', 'CL', 'CM', 'CN',
    'CO', 'CR', 'CU', 'CV', 'CW', 'CX', 'CY', 'CZ', 'DE', 'DJ', 'DK', 'DM',
    'DO', 'DZ', 'EC', 'EE', 'EG', 'EH', 'ER', 'ES', 'ET', 'FI', 'FJ', 'FK',
    'FM', 'FO', 'FR', 'GA', 'GB', 'GD', 'GE', 'GF', 'GG', 'GH', 'GI', 'GL',
    'GM', 'GN', 'GP', 'GQ', 'GR', 'GS', 'GT', 'GU', 'GW', 'GY', 'HK', 'HM',
    'HN', 'HR', 'HT', 'HU', 'ID', 'IE', 'IL', 'IM', 'IN', 'IO', 'IQ', 'IR',
    'IS', 'IT', 'JE', 'JM', 'JO', 'JP', 'KE', 'KG', 'KH', 'KI', 'KM', 'KN',
    'KP', 'KR', 'KW', 'KY', 'KZ', 'LA', 'LB', 'LC', 'LI', 'LK', 'LR', 'LS',
    'LT', 'LU', 'LV', 'LY', 'MA', 'MC', 'MD', 'ME', 'MF', 'MG', 'MH', 'MK',
    'ML', 'MM', 'MN', 'MO', 'MP', 'MQ', 'MR', 'MS', 'MT', 'MU', 'MV', 'MW',
    'MX', 'MY', 'MZ', 'NA', 'NC', 'NE', 'NF', 'NG', 'NI', 'NL', 'NO', 'NP',
    'NR', 'NU', 'NZ', 'OM', 'PA', 'PE', 'PF', 'PG', 'PH', 'PK', 'PL', 'PM',
    'PN', 'PR', 'PS', 'PT', 'PW', 'PY', 'QA', 'RE', 'RO', 'RS', 'RU', 'RW',
    'SA', 'SB', 'SC', 'SD', 'SE', 'SG', 'SH', 'SI', 'SJ', 'SK', 'SL', 'SM',
    'SN', 'SO', 'SR', 'SS', 'ST', 'SV', 'SX', 'SY', 'SZ', 'TC', 'TD', 'TF',
    'TG', 'TH', 'TJ', 'TK', 'TL', 'TM', 'TN', 'TO', 'TR', 'TT', 'TV', 'TW',
    'TZ', 'UA', 'UG', 'UM', 'US', 'UY', 'UZ', 'VA', 'VC', 'VE', 'VG', 'VI',
    'VN', 'VU', 'WF', 'WS', 'YE', 'YT', 'ZA', 'ZM', 'ZW'
  ];

  // ìœ íš¨í•œ ì½”ë“œë§Œ ë°˜í™˜, ê·¸ë ‡ì§€ ì•Šìœ¼ë©´ null
  return code && validRegionCodes.includes(code) ? code : null;
}

function getLanguageCode(country) {
  const languageMap = {
    'worldwide': 'en', // ì „ì„¸ê³„ëŠ” ì˜ì–´ ê¸°ë³¸
    'korea': 'ko',     // í•œêµ­ì–´
    'usa': 'en',       // ì˜ì–´
    'japan': 'ja',     // ì¼ë³¸ì–´
    'china': 'zh',     // ì¤‘êµ­ì–´ (YouTube ì ‘ê·¼ ì œí•œ ê³ ë ¤)
    'uk': 'en',        // ì˜ì–´
    'germany': 'de',   // ë…ì¼ì–´
    'france': 'fr',    // í”„ë‘ìŠ¤ì–´
    'canada': 'en',    // ì˜ì–´ (ìºë‚˜ë‹¤ëŠ” ì˜ì–´/í”„ë‘ìŠ¤ì–´ í˜¼ìš©ì´ì§€ë§Œ ì˜ì–´ ìš°ì„ )
    'australia': 'en', // ì˜ì–´
    'india': 'en',     // ì˜ì–´ (íŒë””ì–´ ë“± ì—¬ëŸ¬ ì–¸ì–´ ìˆì§€ë§Œ ì˜ì–´ ìš°ì„ )
    'brazil': 'pt',    // í¬ë¥´íˆ¬ê°ˆì–´
    'mexico': 'es',    // ìŠ¤í˜ì¸ì–´
    'russia': 'en',    // ëŸ¬ì‹œì•„ëŠ” ì„œë¹„ìŠ¤ ì œí•œìœ¼ë¡œ ì˜ì–´ ì‚¬ìš©
    'italy': 'it',     // ì´íƒˆë¦¬ì•„ì–´
    'spain': 'es'      // ìŠ¤í˜ì¸ì–´
  };

  return languageMap[country.toLowerCase()] || 'en';
}

function getDateRange(period) {
  const now = new Date();
  let publishedAfter = null;

  console.log(`ì—…ë¡œë“œ ê¸°ê°„ ì„¤ì •: ${period}`);

  switch (period) {
    case '1day':
      publishedAfter = new Date(now.getTime() - 24 * 60 * 60 * 1000);
      break;
    case '2days':
      publishedAfter = new Date(now.getTime() - 2 * 24 * 60 * 60 * 1000);
      break;
    case '3days':
      publishedAfter = new Date(now.getTime() - 3 * 24 * 60 * 60 * 1000);
      break;
    case '1week':
      publishedAfter = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
      break;
    case '2weeks':
      publishedAfter = new Date(now.getTime() - 14 * 24 * 60 * 60 * 1000);
      break;
    case '3weeks':
      publishedAfter = new Date(now.getTime() - 21 * 24 * 60 * 60 * 1000);
      break;
    case '1month':
      publishedAfter = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
      break;
    case '3months':
      publishedAfter = new Date(now.getTime() - 90 * 24 * 60 * 60 * 1000);
      break;
    case '6months':
      publishedAfter = new Date(now.getTime() - 180 * 24 * 60 * 60 * 1000);
      break;
    case '1year':
      publishedAfter = new Date(now.getTime() - 365 * 24 * 60 * 60 * 1000);
      break;
    case '2years':
      publishedAfter = new Date(now.getTime() - 2 * 365 * 24 * 60 * 60 * 1000);
      break;
    case '3years':
      publishedAfter = new Date(now.getTime() - 3 * 365 * 24 * 60 * 60 * 1000);
      break;
    case '4years':
      publishedAfter = new Date(now.getTime() - 4 * 365 * 24 * 60 * 60 * 1000);
      break;
    case '5years':
      publishedAfter = new Date(now.getTime() - 5 * 365 * 24 * 60 * 60 * 1000);
      break;
    case '6years':
      publishedAfter = new Date(now.getTime() - 6 * 365 * 24 * 60 * 60 * 1000);
      break;
    case '7years':
      publishedAfter = new Date(now.getTime() - 7 * 365 * 24 * 60 * 60 * 1000);
      break;
    case '8years':
      publishedAfter = new Date(now.getTime() - 8 * 365 * 24 * 60 * 60 * 1000);
      break;
    case '9years':
      publishedAfter = new Date(now.getTime() - 9 * 365 * 24 * 60 * 60 * 1000);
      break;
    case '10years':
      publishedAfter = new Date(now.getTime() - 10 * 365 * 24 * 60 * 60 * 1000);
      break;
  }

  const result = {
    publishedAfter: publishedAfter ? publishedAfter.toISOString() : null,
    publishedBefore: null
  };

  if (publishedAfter) {
    console.log(`ì—…ë¡œë“œ ê¸°ê°„ í•„í„°ë§ ì ìš©ë¨: ${publishedAfter.toISOString()} ì´í›„`);
  }

  return result;
}

// YouTube duration (ISO 8601)ì„ ì´ˆë¡œ ë³€í™˜í•˜ëŠ” í•¨ìˆ˜
function parseDuration(duration) {
  const regex = /PT(?:(\d+)H)?(?:(\d+)M)?(?:(\d+)S)?/;
  const matches = duration.match(regex);

  if (!matches) return 0;

  const hours = parseInt(matches[1]) || 0;
  const minutes = parseInt(matches[2]) || 0;
  const seconds = parseInt(matches[3]) || 0;

  return hours * 3600 + minutes * 60 + seconds;
}

// ë™ì˜ìƒ ê¸¸ì´ ë¶„ë¥˜ í•¨ìˆ˜
function getVideoLengthCategory(durationInSeconds) {
  if (durationInSeconds < 60) return 'short1';       // 1ë¶„ ë¯¸ë§Œ
  if (durationInSeconds < 240) return 'short2';      // 1ë¶„ ì´ìƒ 4ë¶„ ë¯¸ë§Œ
  if (durationInSeconds < 600) return 'mid1';        // 4ë¶„ ì´ìƒ 10ë¶„ ë¯¸ë§Œ
  if (durationInSeconds < 1200) return 'mid2';       // 10ë¶„ ì´ìƒ 20ë¶„ ë¯¸ë§Œ
  if (durationInSeconds < 1800) return 'long1';      // 20ë¶„ ì´ìƒ 30ë¶„ ë¯¸ë§Œ
  if (durationInSeconds < 2400) return 'long2';      // 30ë¶„ ì´ìƒ 40ë¶„ ë¯¸ë§Œ
  if (durationInSeconds < 3000) return 'long3';      // 40ë¶„ ì´ìƒ 50ë¶„ ë¯¸ë§Œ
  if (durationInSeconds < 3600) return 'long4';      // 50ë¶„ ì´ìƒ 60ë¶„ ë¯¸ë§Œ
  if (durationInSeconds < 5400) return 'long5';      // 60ë¶„ ì´ìƒ 90ë¶„ ë¯¸ë§Œ
  return 'long6';                                    // 90ë¶„ ì´ìƒ
}

// ì„ íƒëœ ê¸¸ì´ ì¹´í…Œê³ ë¦¬ì™€ ë§¤ì¹˜ë˜ëŠ”ì§€ í™•ì¸
function matchesVideoLength(videoLengthCategory, selectedLengths) {
  if (!selectedLengths || selectedLengths.length === 0) return true;
  return selectedLengths.includes(videoLengthCategory);
}

// ë¸Œëœë“œ ì±„ë„ ê°ì§€ í•¨ìˆ˜
function isBrandChannel(result) {
  const channelName = result.youtube_channel_name || '';
  const subscriberCount = parseInt(result.subscriber_count) || 0;

  // êµ¬ë…ì ìˆ˜ê°€ 100ë§Œ ì´ìƒì´ë©´ ë¸Œëœë“œ ì±„ë„ë¡œ íŒë³„
  if (subscriberCount >= 1000000) {
    return true;
  }

  // íŠ¹ì • í‚¤ì›Œë“œê°€ í¬í•¨ëœ ê²½ìš° ë¸Œëœë“œ ì±„ë„ë¡œ íŒë³„
  const brandKeywords = [
    'official', 'entertainment', 'music', 'news', 'media',
    'tv', 'channel', 'network', 'studios', 'productions',
    'ê³µì‹', 'ì—”í„°í…Œì¸ë¨¼íŠ¸', 'ë®¤ì§', 'ë‰´ìŠ¤', 'ë¯¸ë””ì–´'
  ];

  const lowerChannelName = channelName.toLowerCase();
  return brandKeywords.some(keyword => lowerChannelName.includes(keyword));
}

// ì±„ë„ êµ­ì  ì •ë³´ ê°€ì ¸ì˜¤ê¸°
async function getChannelCountry(channelId) {
  try {
    const youtubeInstance = apiKeyManager.getYouTubeInstance();
    const channelResponse = await youtubeInstance.youtube.channels.list({
      part: 'snippet,brandingSettings',
      id: channelId
    });

    if (channelResponse.data.items && channelResponse.data.items.length > 0) {
      const channelData = channelResponse.data.items[0];
    
      // êµ­ì  ì •ë³´ ì¶”ì¶œ (snippet.country ë˜ëŠ” brandingSettings.channel.country)
      let channelCountry = channelData.snippet.country || 
                          channelData.brandingSettings?.channel?.country || 
                          'unknown';
    
      console.log(`ğŸŒ ì±„ë„ êµ­ì : ${channelCountry} (${channelId})`);
      return channelCountry;
    }
    
    return 'unknown';

  } catch (error) {
    console.error(`âŒ ì±„ë„ êµ­ì  ì¡°íšŒ ì˜¤ë¥˜ (${channelId}):`, error.message);
    return 'unknown';
  }
}

// ì±„ë„ ê°œì„¤ì¼ ê°€ì ¸ì˜¤ê¸° (ìƒˆ ê¸°ëŠ¥) - ë””ë²„ê¹… ê°•í™”
async function getChannelCreatedDate(channelId) {
  try {
    const youtubeInstance = apiKeyManager.getYouTubeInstance();
    const currentKey = youtubeInstance.currentKey;

    console.log(`ğŸ” ì±„ë„ ê°œì„¤ì¼ API í˜¸ì¶œ: ${channelId} (í‚¤: ${currentKey.name})`);
    
    // snippetê³¼ contentDetailsë¥¼ ëª¨ë‘ ìš”ì²­í•˜ì—¬ ë” ë§ì€ ì •ë³´ í™•ì¸
    const channelResponse = await youtubeInstance.youtube.channels.list({
      part: 'snippet,contentDetails,statistics,status',
      id: channelId
    });
    
    console.log(`ğŸ“¡ API ì‘ë‹µ ìƒíƒœ: ${channelResponse.status}`);
    console.log(`ğŸ“¦ ì‘ë‹µ ë°ì´í„°:`, {
      itemsCount: channelResponse.data.items?.length || 0,
      channelId: channelId,
      hasSnippet: !!channelResponse.data.items?.[0]?.snippet,
      publishedAt: channelResponse.data.items?.[0]?.snippet?.publishedAt,
      channelTitle: channelResponse.data.items?.[0]?.snippet?.title,
      hasContentDetails: !!channelResponse.data.items?.[0]?.contentDetails,
      hasStatistics: !!channelResponse.data.items?.[0]?.statistics,
      hasStatus: !!channelResponse.data.items?.[0]?.status
    });
    
    // ì „ì²´ snippet ì •ë³´ ì¶œë ¥ (ë””ë²„ê¹…ìš©)
    if (channelResponse.data.items?.[0]?.snippet) {
      console.log(`ğŸ” ì „ì²´ snippet ì •ë³´:`, JSON.stringify(channelResponse.data.items[0].snippet, null, 2));
    }
    
    if (channelResponse.data.items && channelResponse.data.items.length > 0) {
      const channelData = channelResponse.data.items[0];
      const publishedAt = channelData.snippet.publishedAt;
    
      // ìœ íš¨í•œ ë‚ ì§œì¸ì§€ ê²€ì¦ (1970.01.01 ë°©ì§€)
      let validCreatedDate = null;
      if (publishedAt) {
        const dateObj = new Date(publishedAt);
        const year = dateObj.getFullYear();
    
        // 1980ë…„ ì´ì „ ë‚ ì§œëŠ” ìœ íš¨í•˜ì§€ ì•Šë‹¤ê³  íŒë‹¨ (YouTubeëŠ” 2005ë…„ ì°½ë¦½)
        if (year >= 1980 && !isNaN(dateObj.getTime())) {
          validCreatedDate = publishedAt;
        } else {
          console.log(`âš ï¸ ìœ íš¨í•˜ì§€ ì•Šì€ ì±„ë„ ê°œì„¤ì¼ ê°ì§€: ${publishedAt} (${channelId})`);
        }
      }
    
      return validCreatedDate;
    }
    
    return null;

  } catch (error) {
    console.error(`âŒ ì±„ë„ ê°œì„¤ì¼ ì¡°íšŒ ì˜¤ë¥˜ (${channelId}):`, error.message);
    console.error(`ğŸ” ì˜¤ë¥˜ ìƒì„¸ ì •ë³´:`, {
      errorCode: error.code,
      errorStatus: error.status,
      errorDetails: error.errors?.[0]?.reason,
      channelId: channelId
    });

    // suspended í‚¤ì¸ ê²½ìš° ë‹¤ë¥¸ í‚¤ë¡œ ì¬ì‹œë„
    if (error.message.includes('suspended') || error.message.includes('has been suspended')) {
      console.log(`ğŸš¨ ì±„ë„ ê°œì„¤ì¼ ì¡°íšŒ ì¤‘ suspended í‚¤ ê°ì§€, ë‹¤ë¥¸ í‚¤ë¡œ ì¬ì‹œë„: ${channelId}`);
      try {
        const youtubeInstance = apiKeyManager.getYouTubeInstance();
        const channelResponse = await youtubeInstance.youtube.channels.list({
          part: 'snippet,contentDetails,statistics,status',
          id: channelId
        });
    
        if (channelResponse.data.items && channelResponse.data.items.length > 0) {
          const publishedAt = channelResponse.data.items[0].snippet.publishedAt;
    
          // ìœ íš¨í•œ ë‚ ì§œì¸ì§€ ê²€ì¦ (ì¬ì‹œë„ì—ì„œë„ ë™ì¼í•˜ê²Œ ì ìš©)
          if (publishedAt) {
            const dateObj = new Date(publishedAt);
            const year = dateObj.getFullYear();
    
            if (year >= 1980 && !isNaN(dateObj.getTime())) {
              return publishedAt;
            } else {
              console.log(`âš ï¸ ì¬ì‹œë„ì—ì„œë„ ìœ íš¨í•˜ì§€ ì•Šì€ ì±„ë„ ê°œì„¤ì¼: ${publishedAt} (${channelId})`);
            }
          }
        }
      } catch (retryError) {
        console.error(`ì±„ë„ ê°œì„¤ì¼ ì¬ì‹œë„ ì‹¤íŒ¨ (${channelId}):`, retryError.message);
      }
    }
    // Permission Deny ì˜¤ë¥˜ì¸ ê²½ìš° ë‹¤ë¥¸ í‚¤ë¡œ ì¬ì‹œë„
    else if (error.message.includes('permission') || error.message.includes('denied') || 
             error.message.includes('forbidden') || error.code === 403) {
      console.log(`ğŸš« ì±„ë„ ê°œì„¤ì¼ ì¡°íšŒ ì¤‘ PERMISSION DENY ê°ì§€: ${channelId}`);
      console.log(`ğŸ“ ê¶Œí•œ ì˜¤ë¥˜ ìƒì„¸: ${error.message}`);
      try {
        const youtubeInstance = apiKeyManager.getYouTubeInstance();
        const channelResponse = await youtubeInstance.youtube.channels.list({
          part: 'snippet,contentDetails,statistics,status',
          id: channelId
        });
    
        if (channelResponse.data.items && channelResponse.data.items.length > 0) {
          const publishedAt = channelResponse.data.items[0].snippet.publishedAt;
    
          if (publishedAt) {
            const dateObj = new Date(publishedAt);
            const year = dateObj.getFullYear();
    
            if (year >= 1980 && !isNaN(dateObj.getTime())) {
              console.log(`âœ… Permission Deny ìš°íšŒ ì„±ê³µ - ì±„ë„ ê°œì„¤ì¼ ì¡°íšŒë¨: ${channelId}`);
              return publishedAt;
            }
          }
        }
      } catch (retryError) {
        console.error(`ì±„ë„ ê°œì„¤ì¼ Permission Deny ì¬ì‹œë„ ì‹¤íŒ¨ (${channelId}):`, retryError.message);
      }
    }
    
    return null;

  }
}

// ì±„ë„ ì„¤ëª… ê°€ì ¸ì˜¤ê¸°
async function getChannelDescription(channelId) {
  try {
    const youtubeInstance = apiKeyManager.getYouTubeInstance();

    const channelResponse = await youtubeInstance.youtube.channels.list({
      part: 'snippet',
      id: channelId
    });
    
    if (channelResponse.data.items && channelResponse.data.items.length > 0) {
      const description = channelResponse.data.items[0].snippet.description;
      return description || '';
    }
    
    return '';

  } catch (error) {
    console.error(`ì±„ë„ ì„¤ëª… ì¡°íšŒ ì˜¤ë¥˜ (${channelId}):`, error.message);
    return '';
  }
}

// ë¬´ë£Œ RPM ì¶”ì • ë¡œì§ (Phase 1 & 2 í†µí•©)
function calculateFreeRPM(videoData) {
  try {
    // 1. ê¸°ë³¸ êµ­ê°€ë³„ RPM í…Œì´ë¸” (USD ê¸°ì¤€)
    const baseRPM = {
      'US': 3.5, 'KR': 2.8, 'JP': 3.2, 'DE': 3.0, 'GB': 3.8,
      'CA': 3.3, 'AU': 3.6, 'FR': 2.9, 'IT': 2.4, 'ES': 2.1,
      'NL': 3.1, 'SE': 3.4, 'NO': 4.2, 'DK': 3.3, 'FI': 3.0,
      'BR': 1.8, 'MX': 1.9, 'AR': 1.5, 'IN': 1.2, 'ID': 1.1,
      'TH': 1.4, 'VN': 1.0, 'PH': 1.3, 'MY': 1.6, 'SG': 2.8,
      'worldwide': 2.5
    };

    // 2. ì¹´í…Œê³ ë¦¬ë³„ ë°°ìœ¨ (Phase 2 ì„¸ë¶„í™” - 40ê°œ ì¹´í…Œê³ ë¦¬)
    const categoryMultiplier = {
      // ê¸°ë³¸ ì¹´í…Œê³ ë¦¬
      'News & Politics': 1.5, 'Education': 1.3, 'Science & Technology': 1.4,
      'Finance': 1.8, 'Business': 1.6, 'Autos & Vehicles': 1.2,
      'Travel & Events': 1.1, 'Howto & Style': 1.0, 'People & Blogs': 0.9,
      'Entertainment': 0.8, 'Music': 0.7, 'Gaming': 0.9,
      'Sports': 1.0, 'Film & Animation': 0.8, 'Comedy': 0.8,
      'Pets & Animals': 0.9, 'Nonprofits & Activism': 0.7,
    
      // ì„¸ë¶€ ì¹´í…Œê³ ë¦¬ ì¶”ê°€ (Phase 2)
      'Tech Reviews': 1.6, 'Crypto & Investment': 2.0, 'Real Estate': 1.7,
      'Online Learning': 1.4, 'Programming Tutorial': 1.5, 'Medical & Health': 1.3,
      'Luxury Cars': 1.4, 'Electric Vehicles': 1.3, 'Travel Vlog': 1.0,
      'Beauty & Makeup': 1.1, 'Fashion': 1.0, 'Fitness': 1.1,
      'ASMR': 0.6, 'Kids Content': 0.5, 'Music Cover': 0.6,
      'Esports': 1.1, 'Mobile Games': 0.8, 'PC Games': 0.9,
      'Cooking': 1.0, 'DIY': 1.1, 'Art & Crafts': 0.9,
      'Language Learning': 1.3, 'Stock Trading': 1.9, 'Insurance': 1.9,
      'Cryptocurrency': 2.0, 'Personal Finance': 1.7, 'Business Strategy': 1.6,
      'Marketing': 1.5, 'Productivity': 1.4, 'Self Development': 1.2,
      'Documentary': 1.2, 'True Crime': 1.0, 'History': 1.1,
      'Philosophy': 1.0, 'Psychology': 1.2, 'Motivation': 1.1
    };
    
    const country = videoData.country || 'worldwide';
    const category = videoData.primary_category || 'Entertainment';
    const views = parseInt(videoData.daily_view_count) || 0;
    
    // ê¸°ë³¸ RPM ê³„ì‚°
    let rpm = baseRPM[country] || baseRPM['worldwide'];
    rpm *= categoryMultiplier[category] || 1.0;
    
    // 3. ì¡°íšŒìˆ˜ ê¸°ë°˜ ê°€ì¤‘ì¹˜
    let viewMultiplier = 1.0;
    if (views < 10000) viewMultiplier = 0.7;          // ë§ˆì´í¬ë¡œ
    else if (views < 100000) viewMultiplier = 0.85;   // ìŠ¤ëª°
    else if (views < 1000000) viewMultiplier = 1.0;   // ë¯¸ë””ì—„
    else if (views < 10000000) viewMultiplier = 1.15; // ë¼ì§€
    else viewMultiplier = 1.3;                        // ë©”ê°€
    
    // Phase 1-1. ì‹œì²­ ì‹œê°„ ê°€ì¤‘ì¹˜ ì¶”ê°€
    const durationSeconds = parseInt(videoData.duration_seconds) || 0;
    let durationMultiplier = 1.0;
    if (durationSeconds < 60) durationMultiplier = 0.8;        // Shorts (ë‚®ì€ RPM)
    else if (durationSeconds < 300) durationMultiplier = 1.0;  // 5ë¶„ ë¯¸ë§Œ (í‘œì¤€)
    else if (durationSeconds < 600) durationMultiplier = 1.15; // 5-10ë¶„ (ìµœì )
    else if (durationSeconds < 1200) durationMultiplier = 1.25; // 10-20ë¶„ (ë†’ì€ RPM)
    else durationMultiplier = 1.1;                             // 20ë¶„ ì´ìƒ (ì•½ê°„ ê°ì†Œ)
    
    // 4. ì±„ë„ ì„±ìˆ™ë„ (ì±„ë„ ìƒì„±ì¼ ê¸°ë°˜)
    let ageMultiplier = 1.0;
    if (videoData.channel_created_date) {
      const channelAge = (Date.now() - new Date(videoData.channel_created_date)) / (365 * 24 * 60 * 60 * 1000);
      ageMultiplier = Math.min(1.2, 0.8 + (channelAge * 0.1));
    }
    
    // Phase 1-2. êµ¬ë…ì ë¹„ìœ¨ ë¶„ì„ ì¶”ê°€
    const subscriberCount = parseInt(videoData.subscriber_count) || 0;
    let subscriberMultiplier = 1.0;
    if (views > 0 && subscriberCount > 0) {
      const viewToSubscriberRatio = views / subscriberCount;
      if (viewToSubscriberRatio < 0.1) subscriberMultiplier = 0.85;       // ë‚®ì€ ë„ë‹¬ë¥ 
      else if (viewToSubscriberRatio < 0.5) subscriberMultiplier = 1.0;   // í‘œì¤€ ë„ë‹¬ë¥ 
      else if (viewToSubscriberRatio < 2.0) subscriberMultiplier = 1.15;  // ë†’ì€ ë„ë‹¬ë¥ 
      else if (viewToSubscriberRatio < 10.0) subscriberMultiplier = 1.3;  // ë°”ì´ëŸ´ ì½˜í…ì¸ 
      else subscriberMultiplier = 1.45;                                   // ìŠˆí¼ ë°”ì´ëŸ´
    }
    
    // Phase 1-3. ê³„ì ˆì„± íŒ¨í„´ ë°˜ì˜ ì¶”ê°€
    const currentMonth = new Date().getMonth() + 1; // 1-12ì›”
    let seasonalMultiplier = 1.0;
    if (currentMonth >= 10 && currentMonth <= 12) seasonalMultiplier = 1.25; // Q4 ìµœê³  (ê´‘ê³ ë¹„ ì„±ìˆ˜ê¸°)
    else if (currentMonth >= 1 && currentMonth <= 3) seasonalMultiplier = 1.15; // Q1 ë†’ìŒ
    else if (currentMonth >= 4 && currentMonth <= 6) seasonalMultiplier = 1.05; // Q2 ë³´í†µ
    else seasonalMultiplier = 0.9; // Q3 ë‚®ìŒ (ì—¬ë¦„ì²  ê´‘ê³ ë¹„ ê°ì†Œ)
    
    // Phase 2. ì°¸ì—¬ë„ ì ìˆ˜ ê°œì„  (ì¢‹ì•„ìš” ê¸°ë°˜ ì¶”ì •)
    let engagementMultiplier = 1.0;
    if (videoData.actual_like_count && views > 0) {
      const likeRate = videoData.actual_like_count / views;
      // ì¢‹ì•„ìš” ë¹„ìœ¨ì— ë”°ë¥¸ ê°€ì¤‘ì¹˜ (0.8 ~ 1.2 ë²”ìœ„)
      engagementMultiplier = 0.8 + Math.min(0.4, likeRate * 400); // 1% ì¢‹ì•„ìš”ìœ¨ = ìµœëŒ€ ê°€ì¤‘ì¹˜
    }
    
    // 7. ìµœì¢… RPM ê³„ì‚° (Phase 1 & 2 ëª¨ë“  ìš”ì†Œ í¬í•¨)
    const finalRPM = rpm * viewMultiplier * durationMultiplier * ageMultiplier * 
                     subscriberMultiplier * seasonalMultiplier * engagementMultiplier;
    
    return Math.round(finalRPM * 100) / 100; // ì†Œìˆ˜ì  2ìë¦¬

  } catch (error) {
    console.error('RPM ê³„ì‚° ì˜¤ë¥˜:', error);
    return 2.5; // ê¸°ë³¸ê°’
  }
}

// Analytics ì¶”ì • ê³„ì‚° ë©”ì¸ í•¨ìˆ˜
function calculateEstimatedAnalytics(videoData) {
  try {
    const estimatedRPM = calculateFreeRPM(videoData);
    const views = parseInt(videoData.daily_view_count) || 0;
    const duration = parseInt(videoData.duration_seconds) || 0;
    const subscriberCount = parseInt(videoData.subscriber_count) || 0;

    return {
      views: views, // ì‹¤ì œ ì¡°íšŒìˆ˜ (ê³µê°œ ë°ì´í„°)
      estimatedMinutesWatched: calculateEstimatedWatchTime(views, duration, videoData),
      averageViewDuration: calculateAverageViewDuration(duration, videoData),
      subscribersGained: calculateSubscribersGained(views, subscriberCount, videoData),
      adImpressions: calculateAdImpressions(views, videoData),
      estimatedRevenue: Math.round((views * estimatedRPM / 1000) * 100) / 100,
      estimatedAdRevenue: Math.round((views * estimatedRPM / 1000) * 0.85 * 100) / 100,
      estimatedRedPartnerRevenue: Math.round((views * estimatedRPM / 1000) * 0.15 * 100) / 100,
      playbackBasedCpm: calculatePlaybackCPM(estimatedRPM, videoData),
      adCpm: calculateAdCPM(estimatedRPM, videoData)
    };

  } catch (error) {
    console.log('Analytics ì¶”ì • ê³„ì‚° ì˜¤ë¥˜:', error.message);
    return {
      views: 0, estimatedMinutesWatched: 0, averageViewDuration: 0,
      subscribersGained: 0, adImpressions: 0, estimatedRevenue: 0,
      estimatedAdRevenue: 0, estimatedRedPartnerRevenue: 0,
      playbackBasedCpm: 0, adCpm: 0
    };
  }
}

// ì¶”ì • ì‹œì²­ ì‹œê°„ ê³„ì‚° (ë¶„ ë‹¨ìœ„)
function calculateEstimatedWatchTime(views, duration, videoData) {
  try {
    const avgViewDuration = calculateAverageViewDuration(duration, videoData);
    const totalWatchSeconds = views * avgViewDuration;
    return Math.round(totalWatchSeconds / 60); // ë¶„ ë‹¨ìœ„ë¡œ ë³€í™˜
  } catch (error) {
    return 0;
  }
}

// í‰ê·  ì‹œì²­ ì‹œê°„ ê³„ì‚° (ì´ˆ ë‹¨ìœ„)
function calculateAverageViewDuration(duration, videoData) {
  try {
    const category = videoData.primary_category || 'Entertainment';

    // ì¹´í…Œê³ ë¦¬ë³„ ì™„ì‹œì²­ë¥  íŒ¨í„´
    const retentionRates = {
      'Finance': 0.65, 'Business': 0.60, 'News & Politics': 0.55,
      'Science & Technology': 0.58, 'Education': 0.62, 'Howto & Style': 0.52,
      'Gaming': 0.48, 'Entertainment': 0.45, 'Music': 0.35,
      'Comedy': 0.42, 'Sports': 0.50, 'ASMR': 0.70, 'Kids Content': 0.40
    };
    
    // ë™ì˜ìƒ ê¸¸ì´ë³„ ì™„ì‹œì²­ë¥  ì¡°ì •
    let durationMultiplier = 1.0;
    if (duration < 60) durationMultiplier = 0.9;        // Shorts
    else if (duration < 300) durationMultiplier = 1.0;  // 5ë¶„ ë¯¸ë§Œ
    else if (duration < 600) durationMultiplier = 0.85; // 5-10ë¶„
    else if (duration < 1200) durationMultiplier = 0.7; // 10-20ë¶„
    else durationMultiplier = 0.6;                      // 20ë¶„ ì´ìƒ
    
    const baseRetention = retentionRates[category] || 0.45;
    const finalRetention = baseRetention * durationMultiplier;
    
    return Math.round(duration * finalRetention);

  } catch (error) {
    return Math.round(duration * 0.45); // ê¸°ë³¸ 45% ì™„ì‹œì²­ë¥ 
  }
}

// ì‹ ê·œ êµ¬ë…ì ìˆ˜ ì¶”ì •
function calculateSubscribersGained(views, subscriberCount, videoData) {
  try {
    const category = videoData.primary_category || 'Entertainment';

    // ì¹´í…Œê³ ë¦¬ë³„ êµ¬ë… ì „í™˜ìœ¨
    const conversionRates = {
      'Education': 0.008, 'Howto & Style': 0.007, 'Science & Technology': 0.006,
      'Finance': 0.005, 'Business': 0.005, 'Gaming': 0.004,
      'Entertainment': 0.003, 'Music': 0.002, 'Comedy': 0.003,
      'ASMR': 0.009, 'Kids Content': 0.001
    };
    
    // ì±„ë„ í¬ê¸°ë³„ êµ¬ë… ì „í™˜ìœ¨ ì¡°ì •
    let sizeMultiplier = 1.0;
    if (subscriberCount < 1000) sizeMultiplier = 1.5;      // ì†Œí˜• ì±„ë„
    else if (subscriberCount < 10000) sizeMultiplier = 1.2; // ì¤‘ì†Œí˜• ì±„ë„
    else if (subscriberCount < 100000) sizeMultiplier = 1.0; // ì¤‘í˜• ì±„ë„
    else if (subscriberCount < 1000000) sizeMultiplier = 0.8; // ëŒ€í˜• ì±„ë„
    else sizeMultiplier = 0.6;                              // ë©”ê°€ ì±„ë„
    
    const baseConversion = conversionRates[category] || 0.003;
    const finalConversion = baseConversion * sizeMultiplier;
    
    return Math.round(views * finalConversion);

  } catch (error) {
    return Math.round(views * 0.003); // ê¸°ë³¸ 0.3% ì „í™˜ìœ¨
  }
}

// ê´‘ê³  ë…¸ì¶œ ìˆ˜ ì¶”ì •
function calculateAdImpressions(views, videoData) {
  try {
    const category = videoData.primary_category || 'Entertainment';
    const duration = parseInt(videoData.duration_seconds) || 0;

    // ì¹´í…Œê³ ë¦¬ë³„ ê´‘ê³  ë…¸ì¶œë¥ 
    const adRates = {
      'Finance': 0.95, 'Business': 0.92, 'News & Politics': 0.90,
      'Science & Technology': 0.88, 'Education': 0.85, 'Howto & Style': 0.82,
      'Gaming': 0.75, 'Entertainment': 0.80, 'Music': 0.70,
      'Comedy': 0.78, 'ASMR': 0.60, 'Kids Content': 0.40
    };
    
    // ë™ì˜ìƒ ê¸¸ì´ë³„ ê´‘ê³  ê°œìˆ˜
    let adsPerView = 1.0;
    if (duration < 60) adsPerView = 0.8;        // Shorts
    else if (duration < 300) adsPerView = 1.0;  // 5ë¶„ ë¯¸ë§Œ
    else if (duration < 600) adsPerView = 1.5;  // 5-10ë¶„
    else if (duration < 1200) adsPerView = 2.0; // 10-20ë¶„
    else adsPerView = 2.5;                      // 20ë¶„ ì´ìƒ
    
    const adRate = adRates[category] || 0.80;
    const totalAds = views * adRate * adsPerView;
    
    return Math.round(totalAds);

  } catch (error) {
    return Math.round(views * 0.80); // ê¸°ë³¸ 80% ê´‘ê³  ë…¸ì¶œë¥ 
  }
}

// ì¬ìƒ ê¸°ë°˜ CPM ê³„ì‚°
function calculatePlaybackCPM(estimatedRPM, videoData) {
  try {
    const duration = parseInt(videoData.duration_seconds) || 0;

    // ì¬ìƒ ì‹œê°„ë³„ CPM ë°°ìœ¨ (CPMì´ RPMë³´ë‹¤ ë†’ì•„ì•¼ í•¨)
    let playbackMultiplier = 1.35; // ê¸°ë³¸ 35% ë†’ìŒ
    if (duration < 60) playbackMultiplier = 1.25;       // Shorts
    else if (duration < 300) playbackMultiplier = 1.35; // 5ë¶„ ë¯¸ë§Œ
    else if (duration < 600) playbackMultiplier = 1.45; // 5-10ë¶„
    else if (duration < 1200) playbackMultiplier = 1.55; // 10-20ë¶„
    else playbackMultiplier = 1.6;                      // 20ë¶„ ì´ìƒ
    
    const playbackCPM = estimatedRPM * playbackMultiplier;
    return Math.round(playbackCPM * 100) / 100;

  } catch (error) {
    return (estimatedRPM || 2.5) * 1.35;
  }
}

// ê´‘ê³  CPM ê³„ì‚°
function calculateAdCPM(estimatedRPM, videoData) {
  try {
    const category = videoData.primary_category || 'Entertainment';

    // ì¹´í…Œê³ ë¦¬ë³„ ê´‘ê³  CPM ë°°ìœ¨ (CPMì´ RPMë³´ë‹¤ ë†’ì•„ì•¼ í•¨)
    const adMultipliers = {
      'Finance': 2.1, 'Business': 1.9, 'Insurance': 2.3,
      'Real Estate': 2.0, 'Crypto & Investment': 2.2,
      'Science & Technology': 1.7, 'Education': 1.6,
      'Gaming': 1.4, 'Entertainment': 1.5, 'Music': 1.3,
      'ASMR': 1.2, 'Kids Content': 1.1
    };
    
    const adMultiplier = adMultipliers[category] || 1.5;
    const adCPM = estimatedRPM * adMultiplier;
    
    return Math.round(adCPM * 100) / 100;

  } catch (error) {
    return (estimatedRPM || 2.5) * 1.5;
  }
}

// ì±„ë„ êµ¬ë…ì ìˆ˜ ê°€ì ¸ì˜¤ê¸°
async function getChannelSubscriberCount(channelId) {
  try {
    const youtubeInstance = apiKeyManager.getYouTubeInstance();
    const currentKey = youtubeInstance.currentKey;
    const channelResponse = await youtubeInstance.youtube.channels.list({
      part: 'statistics',
      id: channelId
    });

    if (channelResponse.data.items && channelResponse.data.items.length > 0) {
      const subscriberCount = channelResponse.data.items[0].statistics.subscriberCount;
      return parseInt(subscriberCount) || 0;
    }
    
    return 0;

  } catch (error) {
    console.error(`ì±„ë„ êµ¬ë…ì ìˆ˜ ì¡°íšŒ ì˜¤ë¥˜ (${channelId}):`, error.message);

    // suspended í‚¤ì¸ ê²½ìš° ë‹¤ë¥¸ í‚¤ë¡œ ì¬ì‹œë„
    if (error.message.includes('suspended') || error.message.includes('has been suspended')) {
      console.log(`ğŸš¨ ì±„ë„ êµ¬ë…ì ìˆ˜ ì¡°íšŒ ì¤‘ suspended í‚¤ ê°ì§€, ë‹¤ë¥¸ í‚¤ë¡œ ì¬ì‹œë„: ${channelId}`);
      try {
        const youtubeInstance = apiKeyManager.getYouTubeInstance();
        const channelResponse = await youtubeInstance.youtube.channels.list({
          part: 'statistics',
          id: channelId
        });
    
        if (channelResponse.data.items && channelResponse.data.items.length > 0) {
          const subscriberCount = channelResponse.data.items[0].statistics.subscriberCount;
          return parseInt(subscriberCount) || 0;
        }
      } catch (retryError) {
        console.error(`ì±„ë„ êµ¬ë…ì ìˆ˜ ì¬ì‹œë„ ì‹¤íŒ¨ (${channelId}):`, retryError.message);
      }
    }
    
    return 0;

  }
}

async function getCategoryName(categoryId) {
  try {
    const categories = {
      '1': 'Film & Animation',
      '2': 'Autos & Vehicles',
      '10': 'Music',
      '15': 'Pets & Animals',
      '17': 'Sports',
      '19': 'Travel & Events',
      '20': 'Gaming',
      '22': 'People & Blogs',
      '23': 'Comedy',
      '24': 'Entertainment',
      '25': 'News & Politics',
      '26': 'Howto & Style',
      '27': 'Education',
      '28': 'Science & Technology',
      '29': 'Nonprofits & Activism'
    };

    return categories[categoryId] || 'Other';

  } catch (error) {
    return 'Other';
  }
}

// ì•ˆì „í•œ íŒŒì¼ëª… ìƒì„± í•¨ìˆ˜ (í•œê¸€ ë³´ì¡´)
function createSafeFilename(filename) {
  if (!filename) return 'thumbnail.jpg';

  let safe = filename
    .replace(/[<>:"/\\|?*\x00-\x1f]/g, '_') // ìœ„í—˜í•œ ë¬¸ìë§Œ ì œê±°
    .replace(/\s+/g, '_')
    .replace(/_{2,}/g, '_')
    .replace(/^_+|_+$/g, '')
    .substring(0, 100);

  // íŒŒì¼ëª…ì´ ë¹„ì–´ìˆê±°ë‚˜ ë„ˆë¬´ ì§§ìœ¼ë©´ ê¸°ë³¸ê°’
  if (safe.length < 3) safe = 'thumbnail';

  if (!safe.match(/\.(jpg|jpeg|png|webp|gif)$/i)) {
    safe += '.jpg';
  }

  return safe;
}

// ì¸ë„¤ì¼ ë‹¤ìš´ë¡œë“œ API (ERR_INVALID_CHAR ì˜¤ë¥˜ í•´ê²°)
app.get('/api/download-thumbnail', async (req, res) => {
try {
const { url, filename } = req.query;

console.log('ğŸ“¥ ì¸ë„¤ì¼ ë‹¤ìš´ë¡œë“œ ìš”ì²­:', { url, filename });

if (!url) {
      return res.status(400).json({ error: 'URLì´ í•„ìš”í•©ë‹ˆë‹¤.' });
}

// ì•ˆì „í•œ íŒŒì¼ëª… ìƒì„±
const safeFilename = createSafeFilename(filename);
console.log('ğŸ”§ ì•ˆì „í•œ íŒŒì¼ëª… ìƒì„±:', { original: filename, safe: safeFilename });

    const response = await axios.get(url, { 
      responseType: 'stream',
      timeout: 10000  // 10ì´ˆ íƒ€ì„ì•„ì›ƒ
    });
    
    // ì•ˆì „í•œ íŒŒì¼ëª…ë§Œ í—¤ë”ì— ì„¤ì •
    res.setHeader('Content-Disposition', `attachment; filename="${safeFilename}"`);
    res.setHeader('Content-Type', response.headers['content-type'] || 'image/jpeg');
    res.setHeader('Content-Length', response.headers['content-length'] || '');
    
    response.data.pipe(res);
    
    console.log(`âœ… ì¸ë„¤ì¼ ë‹¤ìš´ë¡œë“œ ì„±ê³µ: ${safeFilename}`);

  } catch (error) {
    console.error('ì¸ë„¤ì¼ ë‹¤ìš´ë¡œë“œ ì˜¤ë¥˜:', error);

    // êµ¬ì²´ì ì¸ ì˜¤ë¥˜ ì²˜ë¦¬
    if (error.code === 'ERR_INVALID_CHAR') {
      console.error('âŒ Content-Disposition í—¤ë” ì˜¤ë¥˜:', {
        originalFilename: req.query.filename,
        url: req.query.url,
        error: error.message
      });
      res.status(400).json({ 
        error: 'íŒŒì¼ëª…ì— ì‚¬ìš©í•  ìˆ˜ ì—†ëŠ” ë¬¸ìê°€ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤.',
        details: 'Invalid characters in filename for HTTP header'
      });
    } else if (error.response) {
      console.error('âŒ ì™¸ë¶€ ì„œë²„ ì˜¤ë¥˜:', error.response.status, error.response.statusText);
      res.status(502).json({ 
        error: 'ì¸ë„¤ì¼ ì„œë²„ì—ì„œ ì´ë¯¸ì§€ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.',
        details: `HTTP ${error.response.status}: ${error.response.statusText}`
      });
    } else if (error.request) {
      console.error('âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜:', error.message);
      res.status(503).json({ 
        error: 'ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ë¡œ ì¸ë„¤ì¼ ë‹¤ìš´ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.',
        details: 'Network timeout or connection error'
      });
    } else {
      console.error('âŒ ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜:', error.message);
      res.status(500).json({ 
        error: 'ì¸ë„¤ì¼ ë‹¤ìš´ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.',
        details: error.message
      });
    }

  }
});

// =================== ì¸ê¸°ê²€ìƒ‰ì–´ ë¶„ì„ API ===================

// ë¶ˆìš©ì–´ ë¦¬ìŠ¤íŠ¸ ì •ì˜
const STOPWORDS = {
  korean: [
    // ì¡°ì‚¬
    'ì´', 'ê°€', 'ì„', 'ë¥¼', 'ì—', 'ì—ì„œ', 'ìœ¼ë¡œ', 'ë¡œ', 'ì™€', 'ê³¼', 'ì˜', 'ë„', 'ë§Œ', 'ê¹Œì§€', 'ë¶€í„°', 'ë³´ë‹¤', 'ì²˜ëŸ¼', 'ê°™ì´', 'ì—ê²Œ', 'í•œí…Œ', 'ê»˜',
    // ì–´ë¯¸ ë° ì¡°ë™ì‚¬
    'í•˜ë‹¤', 'ë˜ë‹¤', 'ìˆë‹¤', 'ì—†ë‹¤', 'ê°™ë‹¤', 'ë‹¤ë¥¸', 'ê·¸ëŸ°', 'ì´ëŸ°', 'ì €ëŸ°', 'ì–´ë–¤', 'ë¬´ìŠ¨', 'ì•„ë¬´', 'ëª¨ë“ ', 'ì˜¨ê°–',
    // ëŒ€ëª…ì‚¬ ë° ì§€ì‹œì‚¬
    'ê·¸', 'ì´', 'ì €', 'ê²ƒ', 'ê±°', 'ìˆ˜', 'ë•Œ', 'ê³³', 'ë§', 'ì¼', 'ì ', 'ë“±', 'ë°', 'ë˜ëŠ”', 'í˜¹ì€', 'ê·¸ë¦¬ê³ ', 'í•˜ì§€ë§Œ', 'ê·¸ëŸ°ë°',
    // ìˆ«ì ë° ë‹¨ìœ„
    'í•˜ë‚˜', 'ë‘˜', 'ì…‹', 'ë„·', 'ë‹¤ì„¯', 'ê°œ', 'ëª…', 'ë²ˆ', 'ì°¨', 'íšŒ', 'ë…„', 'ì›”', 'ì¼', 'ì‹œ', 'ë¶„', 'ì´ˆ',
    // YouTube íŠ¹í™” ë¶ˆìš©ì–´
    'ë™ì˜ìƒ', 'ì˜ìƒ', 'ë¹„ë””ì˜¤', 'ì±„ë„', 'êµ¬ë…', 'ì¢‹ì•„ìš”', 'ëŒ“ê¸€', 'ì¡°íšŒìˆ˜', 'ì¬ìƒ', 'ì—…ë¡œë“œ', 'ë‹¤ìš´ë¡œë“œ',
    '1ë¶€', '2ë¶€', '3ë¶€', '4ë¶€', '5ë¶€', 'ìƒí¸', 'í•˜í¸', 'ì „í¸', 'í›„í¸', 'ì™„ê²°', 'ì‹œì¦Œ', 'ì—í”¼ì†Œë“œ',
    // ì¼ë°˜ì ì¸ í˜•ìš©ì‚¬/ë¶€ì‚¬
    'ë§¤ìš°', 'ì •ë§', 'ì§„ì§œ', 'ë„ˆë¬´', 'ì•„ì£¼', 'ì™„ì „', 'ì—„ì²­', 'ëŒ€ë°•', 'ìµœê³ ', 'ìµœì‹ ', 'ì‹ ê·œ', 'ìƒˆë¡œìš´'
  ],
  english: [
    // ê´€ì‚¬
    'a', 'an', 'the',
    // ì „ì¹˜ì‚¬
    'in', 'on', 'at', 'by', 'for', 'with', 'without', 'to', 'from', 'of', 'about', 'into', 'through', 'during', 'before', 'after', 'above', 'below', 'up', 'down', 'out', 'off', 'over', 'under', 'again', 'further', 'then', 'once',
    // ì ‘ì†ì‚¬
    'and', 'or', 'but', 'so', 'because', 'if', 'when', 'while', 'where', 'why', 'how', 'what', 'which', 'who', 'whom', 'whose',
    // ëŒ€ëª…ì‚¬
    'i', 'you', 'he', 'she', 'it', 'we', 'they', 'me', 'him', 'her', 'us', 'them', 'my', 'your', 'his', 'her', 'its', 'our', 'their', 'mine', 'yours', 'hers', 'ours', 'theirs',
    // ì§€ì‹œì‚¬
    'this', 'that', 'these', 'those', 'here', 'there', 'now', 'then',
    // beë™ì‚¬, ì¡°ë™ì‚¬
    'be', 'am', 'is', 'are', 'was', 'were', 'being', 'been', 'have', 'has', 'had', 'having', 'do', 'does', 'did', 'doing', 'will', 'would', 'could', 'should', 'may', 'might', 'must', 'can',
    // YouTube íŠ¹í™” ë¶ˆìš©ì–´
    'video', 'youtube', 'channel', 'subscribe', 'like', 'comment', 'view', 'watch', 'play', 'playlist', 'shorts', 'live', 'stream', 'upload', 'download',
    'part', 'ep', 'episode', 'season', 'series', 'full', 'complete', 'official', 'new', 'latest', 'update', 'review', 'reaction',
    // ì¼ë°˜ì ì¸ í˜•ìš©ì‚¬/ë¶€ì‚¬
    'very', 'really', 'quite', 'pretty', 'much', 'many', 'most', 'more', 'less', 'few', 'little', 'big', 'small', 'large', 'great', 'good', 'bad', 'best', 'worst', 'better', 'worse', 'first', 'last', 'next', 'previous', 'other', 'another', 'some', 'any', 'no', 'not'
  ],
  years: ['2020', '2021', '2022', '2023', '2024', '2025', '2026'],
  common: ['1', '2', '3', '4', '5', '6', '7', '8', '9', '0', 'vs', 'v']
};

// êµ¬ë‘ì  ë° íŠ¹ìˆ˜ë¬¸ì ì •ê·œì‹
const PUNCTUATION_REGEX = /[.,!?;:'""`()[\]{}#@$%^&*+=|\\\/~\-_<>""''â€"Â«Â»]/g;
const EMOJI_REGEX = /[\u{1F600}-\u{1F64F}]|[\u{1F300}-\u{1F5FF}]|[\u{1F680}-\u{1F6FF}]|[\u{1F1E0}-\u{1F1FF}]|[\u{2600}-\u{26FF}]|[\u{2700}-\u{27BF}]/gu;

// í‚¤ì›Œë“œ ì •ì œ í•¨ìˆ˜
function cleanKeyword(keyword) {
  if (!keyword || typeof keyword !== 'string') return '';

  // ì†Œë¬¸ì ë³€í™˜
  let cleaned = keyword.toLowerCase().trim();

  // êµ¬ë‘ì  ë° ì´ëª¨ì§€ ì œê±°
  cleaned = cleaned.replace(PUNCTUATION_REGEX, ' ');
  cleaned = cleaned.replace(EMOJI_REGEX, ' ');

  // ì—¬ëŸ¬ ê³µë°±ì„ í•˜ë‚˜ë¡œ ì •ë¦¬
  cleaned = cleaned.replace(/\s+/g, ' ').trim();

  return cleaned;
}

// ë¶ˆìš©ì–´ í•„í„°ë§ í•¨ìˆ˜
function filterStopwords(keywords) {
  const allStopwords = new Set([
    ...STOPWORDS.korean,
    ...STOPWORDS.english,
    ...STOPWORDS.years,
    ...STOPWORDS.common
  ]);

  return keywords.filter(keyword => {
    const cleaned = cleanKeyword(keyword);

    // ë¹ˆ ë¬¸ìì—´, ìˆ«ìë§Œ ìˆëŠ” ë¬¸ìì—´, í•œ ê¸€ì ë¬¸ìì—´ ì œê±°
    if (!cleaned || cleaned.length <= 1 || /^\d+$/.test(cleaned)) {
      return false;
    }
    
    // ë¶ˆìš©ì–´ ì²´í¬
    if (allStopwords.has(cleaned)) {
      return false;
    }
    
    // ë‹¨ì–´ë³„ë¡œ ì²´í¬ (ë³µí•©ì–´ ì²˜ë¦¬)
    const words = cleaned.split(' ');
    const meaningfulWords = words.filter(word => 
      word.length > 1 && !allStopwords.has(word) && !/^\d+$/.test(word)
    );
    
    return meaningfulWords.length > 0;

  });
}

// í‚¤ì›Œë“œ ì¶”ì¶œ ë° ë¹ˆë„ ë¶„ì„ í•¨ìˆ˜
function extractKeywords(videos, requestedCount) {
  const keywordFreq = new Map();

  videos.forEach(video => {
    // ì œëª©ì—ì„œ í‚¤ì›Œë“œ ì¶”ì¶œ
    if (video.title) {
      const titleWords = video.title.split(/[\s\-_|:]+/);
      const cleanedTitle = filterStopwords(titleWords);

      cleanedTitle.forEach(word => {
        const cleaned = cleanKeyword(word);
        if (cleaned && cleaned.length > 1) {
          keywordFreq.set(cleaned, (keywordFreq.get(cleaned) || 0) + 3); // ì œëª©ì€ ê°€ì¤‘ì¹˜ 3
        }
      });
    }
    
    // íƒœê·¸ì—ì„œ í‚¤ì›Œë“œ ì¶”ì¶œ
    if (video.video_tags && Array.isArray(video.video_tags)) {
      const cleanedTags = filterStopwords(video.video_tags);
    
      cleanedTags.forEach(tag => {
        const cleaned = cleanKeyword(tag);
        if (cleaned && cleaned.length > 1) {
          keywordFreq.set(cleaned, (keywordFreq.get(cleaned) || 0) + 2); // íƒœê·¸ëŠ” ê°€ì¤‘ì¹˜ 2
        }
      });
    }
    
    // ì„¤ëª…ì—ì„œ í‚¤ì›Œë“œ ì¶”ì¶œ (ì²˜ìŒ 100ìë§Œ)
    if (video.description) {
      const descWords = video.description.substring(0, 100).split(/[\s\-_|:]+/);
      const cleanedDesc = filterStopwords(descWords);
    
      cleanedDesc.forEach(word => {
        const cleaned = cleanKeyword(word);
        if (cleaned && cleaned.length > 1) {
          keywordFreq.set(cleaned, (keywordFreq.get(cleaned) || 0) + 1); // ì„¤ëª…ì€ ê°€ì¤‘ì¹˜ 1
        }
      });
    }

  });

  // ë¹ˆë„ìˆœìœ¼ë¡œ ì •ë ¬í•˜ì—¬ ìƒìœ„ í‚¤ì›Œë“œ ë°˜í™˜
  const sortedKeywords = Array.from(keywordFreq.entries())
    .sort((a, b) => b[1] - a[1])
    .slice(0, requestedCount)
    .map(([word, frequency]) => ({ word, frequency }));

  return sortedKeywords;
}

// ì¸ê¸°ê²€ìƒ‰ì–´ ë¶„ì„ API ì—”ë“œí¬ì¸íŠ¸
app.post('/api/trending-keywords', async (req, res) => {
  try {
    const { count = 50, videoCount = 250 } = req.body;

    console.log(`ğŸ”¥ ì¸ê¸°ê²€ìƒ‰ì–´ ë¶„ì„ ì‹œì‘: ${count}ê°œ í‚¤ì›Œë“œ, ${videoCount}ê°œ ë™ì˜ìƒ ë¶„ì„`);
    
    // YouTube APIë¡œ ì¸ê¸° ë™ì˜ìƒ ìˆ˜ì§‘
    const videos = await fetchTrendingVideos(videoCount);
    
    if (!videos || videos.length === 0) {
      return res.status(404).json({
        success: false,
        error: 'ì¸ê¸° ë™ì˜ìƒì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.',
        keywords: [],
        videoCount: 0
      });
    }
    
    console.log(`ğŸ“Š ${videos.length}ê°œ ë™ì˜ìƒì—ì„œ í‚¤ì›Œë“œ ì¶”ì¶œ ì¤‘...`);
    
    // í‚¤ì›Œë“œ ì¶”ì¶œ ë° ë¶„ì„
    const keywords = extractKeywords(videos, count);
    
    console.log(`âœ… ${keywords.length}ê°œ ì¸ê¸° í‚¤ì›Œë“œ ì¶”ì¶œ ì™„ë£Œ`);
    console.log('ìƒìœ„ 10ê°œ í‚¤ì›Œë“œ:', keywords.slice(0, 10).map(k => `${k.word}(${k.frequency})`).join(', '));
    
    res.json({
      success: true,
      keywords: keywords,
      videoCount: videos.length,
      analysisInfo: `${videos.length}ê°œ ë™ì˜ìƒì—ì„œ ${keywords.length}ê°œ í‚¤ì›Œë“œ ë¶„ì„ ì™„ë£Œ`,
      timestamp: new Date().toISOString()
    });

  } catch (error) {
    console.error('ì¸ê¸°ê²€ìƒ‰ì–´ ë¶„ì„ ì˜¤ë¥˜:', error);
    res.status(500).json({
      success: false,
      error: error.message,
      keywords: [],
      videoCount: 0
    });
  }
});

// YouTube ì¸ê¸° ë™ì˜ìƒ ìˆ˜ì§‘ í•¨ìˆ˜
async function fetchTrendingVideos(maxResults = 250) {
  try {
    const youtubeInstance = apiKeyManager.getYouTubeInstance();

    // YouTube íŠ¸ë Œë”© ë™ì˜ìƒ ê²€ìƒ‰ (ì§€ì—­ë³„ë¡œ ë‹¤ì–‘í•˜ê²Œ)
    const regions = ['KR', 'US', 'GB', 'JP', 'DE', 'FR']; // ì£¼ìš” êµ­ê°€ë“¤
    const allVideos = [];
    const videosPerRegion = Math.ceil(maxResults / regions.length);
    
    for (const region of regions) {
      try {
        console.log(`ğŸŒ ${region} ì§€ì—­ì˜ ì¸ê¸° ë™ì˜ìƒ ìˆ˜ì§‘ ì¤‘... (${videosPerRegion}ê°œ)`);
    
        const response = await youtubeInstance.youtube.videos.list({
          part: 'snippet,statistics,contentDetails',
          chart: 'mostPopular',
          regionCode: region,
          maxResults: Math.min(videosPerRegion, 50), // API ì œí•œ ê³ ë ¤
          order: 'viewCount'
        });
    
        if (response.data.items) {
          const regionVideos = response.data.items.map(video => ({
            video_id: video.id,
            title: video.snippet.title,
            description: video.snippet.description || '',
            video_tags: video.snippet.tags || [],
            youtube_channel_name: video.snippet.channelTitle,
            youtube_channel_id: video.snippet.channelId,
            daily_view_count: parseInt(video.statistics.viewCount) || 0,
            region: region
          }));
    
          allVideos.push(...regionVideos);
          console.log(`âœ… ${region}: ${regionVideos.length}ê°œ ë™ì˜ìƒ ìˆ˜ì§‘`);
        }
    
        // API í˜¸ì¶œ ì œí•œ ê³ ë ¤í•œ ë”œë ˆì´
        await new Promise(resolve => setTimeout(resolve, 100));
    
      } catch (regionError) {
        console.error(`${region} ì§€ì—­ ë™ì˜ìƒ ìˆ˜ì§‘ ì˜¤ë¥˜:`, regionError.message);
        // íŠ¹ì • ì§€ì—­ ì˜¤ë¥˜ëŠ” ë¬´ì‹œí•˜ê³  ê³„ì† ì§„í–‰
      }
    }
    
    // ì¡°íšŒìˆ˜ ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬í•˜ê³  ì¤‘ë³µ ì œê±°
    const uniqueVideos = Array.from(
      new Map(allVideos.map(v => [v.video_id, v])).values()
    ).sort((a, b) => b.daily_view_count - a.daily_view_count);
    
    console.log(`ğŸ¯ ì´ ${uniqueVideos.length}ê°œì˜ ê³ ìœ  ì¸ê¸° ë™ì˜ìƒ ìˆ˜ì§‘ ì™„ë£Œ`);
    
    return uniqueVideos.slice(0, maxResults);

  } catch (error) {
    console.error('YouTube ì¸ê¸° ë™ì˜ìƒ ìˆ˜ì§‘ ì˜¤ë¥˜:', error);
    throw new Error(`YouTube API ì˜¤ë¥˜: ${error.message}`);
  }
}

// ì¢‹ì•„ìš” ê°œìˆ˜ ê³„ì‚° í•¨ìˆ˜ (ì‹¤ì œ ë°ì´í„° ìš°ì„ , ì—†ìœ¼ë©´ ì¶”ì •)
function calculateLikeCount(video, viewCount, subscriberCount, actualLikeCount) {
  // ì‹¤ì œ ì¢‹ì•„ìš” ê°œìˆ˜ê°€ ìˆìœ¼ë©´ ìš°ì„  ì‚¬ìš©
  if (actualLikeCount !== null && actualLikeCount !== undefined) {
    return {
      count: actualLikeCount,
      isEstimated: false
    };
  }

  // ì‹¤ì œ ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ì¶”ì •ê°’ ìƒì„±
  return {
    count: generateEstimatedLikeCount(video, viewCount, subscriberCount),
    isEstimated: true
  };
}

// ì¢‹ì•„ìš” ê°œìˆ˜ ì¶”ì • í•¨ìˆ˜ (ì‹¤ì œ ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš°ì—ë§Œ ì‚¬ìš©)
function generateEstimatedLikeCount(video, viewCount, subscriberCount) {
  // ë™ì˜ìƒë³„ë¡œ ì¼ê´€ëœ ì‹œë“œê°’ ìƒì„± (video_id, ì±„ë„ëª…, ì œëª© ì¡°í•©)
  const seedString = (video.id || '') + (video.snippet.channelTitle || '') + (video.snippet.title || '');
  const seed = generateSeedFromString(seedString);

  if (viewCount === 0) return Math.floor(seededRandom(seed) * 1000);

  // ì±„ë„ êµ¬ë…ì ìˆ˜ì— ë”°ë¥¸ ì¢‹ì•„ìš” ë¹„ìœ¨ ì¡°ì •
  let likeRatio = 0.05; // ê¸°ë³¸ 5%

  // êµ¬ë…ìê°€ ë§ì€ ì±„ë„ì¼ìˆ˜ë¡ ì¢‹ì•„ìš” ë¹„ìœ¨ì´ ì•½ê°„ ë†’ìŒ
  if (subscriberCount > 1000000) likeRatio = 0.06; // 100ë§Œ ì´ìƒ: 6%
  else if (subscriberCount > 100000) likeRatio = 0.055; // 10ë§Œ ì´ìƒ: 5.5%
  else if (subscriberCount > 10000) likeRatio = 0.05; // 1ë§Œ ì´ìƒ: 5%
  else likeRatio = 0.04; // ê·¸ ì™¸: 4%

  // ê³ ì •ëœ ëœë¤ ìš”ì†Œ ì¶”ê°€ (Â±30%)
  const randomFactor = 0.7 + seededRandom(seed + 1) * 0.6;
  const estimatedLikes = Math.floor(viewCount * likeRatio * randomFactor);

  return estimatedLikes;
}

// ë¬¸ìì—´ë¡œë¶€í„° ì‹œë“œê°’ ìƒì„±
function generateSeedFromString(str) {
  let hash = 0;
  if (!str || str.length === 0) return hash;
  for (let i = 0; i < str.length; i++) {
    const char = str.charCodeAt(i);
    hash = ((hash << 5) - hash) + char;
    hash = hash & hash; // 32bit integerë¡œ ë³€í™˜
  }
  return Math.abs(hash);
}

// ì‹œë“œê°’ ê¸°ë°˜ ê³ ì • ëœë¤ í•¨ìˆ˜
function seededRandom(seed) {
  const x = Math.sin(seed) * 10000;
  return x - Math.floor(x);
}

// ìë™ì™„ì„± API ì—”ë“œí¬ì¸íŠ¸
app.get('/api/suggest', async (req, res) => {
  try {
    const { query } = req.query;

    if (!query || query.length < 2) {
      return res.json({
        success: true,
        suggestions: []
      });
    }
    
    // Elasticsearch completion suggester ì‚¬ìš©
    const suggestions = await esClient.search({
      index: 'videos',
      body: {
        suggest: {
          keyword_suggest: {
            prefix: query,
            completion: {
              field: 'title.suggest',
              size: 10,
              skip_duplicates: true
            }
          },
          channel_suggest: {
            prefix: query,
            completion: {
              field: 'youtube_channel_name.suggest',
              size: 5,
              skip_duplicates: true
            }
          }
        }
      }
    });
    
    // ì œì•ˆ ê²°ê³¼ í•©ì¹˜ê¸°
    const keywordSuggestions = suggestions.body.suggest.keyword_suggest[0].options || [];
    const channelSuggestions = suggestions.body.suggest.channel_suggest[0].options || [];
    
    const allSuggestions = [
      ...keywordSuggestions.map(item => ({
        text: item.text,
        type: 'title',
        score: item._score
      })),
      ...channelSuggestions.map(item => ({
        text: item.text,
        type: 'channel',
        score: item._score
      }))
    ].sort((a, b) => b.score - a.score).slice(0, 10);
    
    res.json({
      success: true,
      suggestions: allSuggestions
    });

  } catch (error) {
    console.error('ìë™ì™„ì„± ì˜¤ë¥˜:', error);
    res.json({
      success: false,
      suggestions: [],
      error: error.message
    });
  }
});

// ì¸ê¸° ê²€ìƒ‰ì–´ API ì—”ë“œí¬ì¸íŠ¸
app.get('/api/trending-keywords', async (req, res) => {
  try {
    const { limit = 10 } = req.query;

    // ìµœê·¼ 24ì‹œê°„ ì¸ê¸° ê²€ìƒ‰ì–´ ì¡°íšŒ
    const recent24h = new Date(Date.now() - 24 * 60 * 60 * 1000);
    
    const trendQuery = {
      "size": 0,
      "query": {
        "range": {
          "indexed_at": {
            "gte": recent24h.toISOString()
          }
        }
      },
      "aggs": {
        "trending_keywords": {
          "terms": {
            "field": "keyword_normalized",
            "size": parseInt(limit)
          }
        }
      }
    };
    
    const results = await esClient.search({
      index: 'videos',
      body: trendQuery
    });
    
    const trendingKeywords = results.body.aggregations.trending_keywords.buckets.map(bucket => ({
      keyword: bucket.key,
      count: bucket.doc_count
    }));
    
    res.json({
      success: true,
      trending_keywords: trendingKeywords
    });

  } catch (error) {
    console.error('ì¸ê¸° ê²€ìƒ‰ì–´ ì¡°íšŒ ì˜¤ë¥˜:', error);
    res.json({
      success: false,
      trending_keywords: [],
      error: error.message
    });
  }
});

// ë°±ê·¸ë¼ìš´ë“œ ìºì‹œ ì›Œë° ê¸°ëŠ¥
class BackgroundCacheWarmer {
  constructor(esHelper) {
    this.esHelper = esHelper;
    this.isRunning = false;
    this.popularKeywords = [
      'ìŒì•…', 'ìš”ë¦¬', 'ê²Œì„', 'ASMR', 'ë¸Œì´ë¡œê·¸', 'ë·°í‹°', 'ìš´ë™', 'ì—¬í–‰',
      'ì½”ë”©', 'ë¦¬ë·°', 'ë¨¹ë°©', 'ì¼ìƒ', 'ê³µë¶€', 'ì˜í™”', 'ë“œë¼ë§ˆ', 'ì• ë‹ˆë©”ì´ì…˜'
    ];
    this.countries = ['korea', 'usa', 'japan', 'uk', 'germany', 'france'];
  }

  // ë°±ê·¸ë¼ìš´ë“œ ìºì‹œ ì›Œë° ì‹œì‘
  async startWarming() {
    if (this.isRunning) return;

    this.isRunning = true;
    console.log('ğŸ”¥ ë°±ê·¸ë¼ìš´ë“œ ìºì‹œ ì›Œë° ì‹œì‘...');
    
    try {
      await this.warmPopularKeywords();
      console.log('âœ… ì¸ê¸° í‚¤ì›Œë“œ ìºì‹œ ì›Œë° ì™„ë£Œ');
    } catch (error) {
      console.error('âŒ ìºì‹œ ì›Œë° ì˜¤ë¥˜:', error.message);
    }
    
    this.isRunning = false;

  }

  // ì¸ê¸° í‚¤ì›Œë“œ ìºì‹œ ì›Œë°
  async warmPopularKeywords() {
    const warmingPromises = [];

    for (const keyword of this.popularKeywords) {
      for (const country of this.countries) {
        const searchParams = {
          country: country,
          keyword: keyword,
          maxResults: 20,
          publishedAfter: null,
          publishedBefore: null
        };
    
        // ë¹„ë™ê¸°ë¡œ ìºì‹œ ì›Œë° (ë³‘ë ¬ ì²˜ë¦¬)
        warmingPromises.push(this.warmSingleSearch(searchParams));
      }
    }
    
    // ëª¨ë“  ìºì‹œ ì›Œë°ì„ ë³‘ë ¬ë¡œ ì‹¤í–‰
    await Promise.allSettled(warmingPromises);

  }

  // ë‹¨ì¼ ê²€ìƒ‰ ìºì‹œ ì›Œë°
  async warmSingleSearch(searchParams) {
    try {
      // ìºì‹œ íˆíŠ¸ í™•ì¸
      const cacheResult = await this.esHelper.checkCacheHit(searchParams);

      if (!cacheResult.hit) {
        console.log(`ğŸ”„ ìºì‹œ ì›Œë°: ${searchParams.country}/${searchParams.keyword}`);
    
        // YouTube API í˜¸ì¶œí•˜ì—¬ ë°ì´í„° ìˆ˜ì§‘
        const youtubeInstance = await apiKeyManager.getYouTubeInstanceSafely();
        if (!youtubeInstance) {
          console.warn('âš ï¸ API í‚¤ ì—†ìŒ, ìºì‹œ ì›Œë° ê±´ë„ˆë›°ê¸°');
          return;
        }
    
        const searchParams_youtube = {
          part: 'snippet',
          type: 'video',
          maxResults: 20,
          order: 'viewCount',
          q: searchParams.keyword
        };
    
        // êµ­ê°€ë³„ ì„¤ì •
        if (searchParams.country !== 'worldwide') {
          const regionCode = getCountryCode(searchParams.country);
          if (regionCode) {
            searchParams_youtube.regionCode = regionCode;
          }
    
          const languageCode = getLanguageCode(searchParams.country);
          if (languageCode) {
            searchParams_youtube.relevanceLanguage = languageCode;
          }
        }
    
        // YouTube API í˜¸ì¶œ
        const response = await youtubeInstance.youtube.search.list(searchParams_youtube);
    
        if (response.data.items && response.data.items.length > 0) {
          // ë¹„ë””ì˜¤ ìƒì„¸ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
          const videoIds = response.data.items.map(item => item.id.videoId);
          const videoDetails = await youtubeInstance.youtube.videos.list({
            part: 'snippet,statistics,contentDetails',
            id: videoIds.join(',')
          });
    
          // ê²°ê³¼ë¥¼ Elasticsearchì— ì €ì¥
          const videos = videoDetails.data.items.map(video => ({
            video_id: video.id,
            title: video.snippet.title,
            description: video.snippet.description || '',
            youtube_channel_name: video.snippet.channelTitle,
            youtube_channel_id: video.snippet.channelId,
            daily_view_count: parseInt(video.statistics.viewCount) || 0,
            subscriber_count: parseInt(video.statistics.subscriberCount) || 0,
            duration: video.contentDetails.duration,
            duration_seconds: parseDuration(video.contentDetails.duration),
            primary_category: video.snippet.categoryId,
            country: searchParams.country,
            keyword_normalized: searchParams.keyword.toLowerCase(),
            indexed_at: new Date().toISOString()
          }));
    
          // Elasticsearchì— ë²Œí¬ ì—…ì„œíŠ¸
          await this.esHelper.bulkUpsertVideos(videos, searchParams);
    
          console.log(`âœ… ìºì‹œ ì›Œë° ì™„ë£Œ: ${searchParams.country}/${searchParams.keyword} (${videos.length}ê°œ)`);
        }
      } else {
        console.log(`âš¡ ì´ë¯¸ ìºì‹œë¨: ${searchParams.country}/${searchParams.keyword}`);
      }
    } catch (error) {
      console.error(`âŒ ìºì‹œ ì›Œë° ì‹¤íŒ¨: ${searchParams.country}/${searchParams.keyword}`, error.message);
    }

  }
}

// ë°±ê·¸ë¼ìš´ë“œ ìºì‹œ ì›Œë° ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
const cacheWarmer = new BackgroundCacheWarmer(esHelper);

// ì„œë²„ ì‹œì‘
app.listen(PORT, () => {
  console.log(`ì„œë²„ê°€ í¬íŠ¸ ${PORT}ì—ì„œ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤.`);
  console.log(`ë¸Œë¼ìš°ì €ì—ì„œ http://localhost:${PORT} ë¥¼ ì—´ì–´ì£¼ì„¸ìš”.`);

  // ì„œë²„ ì‹œì‘ í›„ 5ì´ˆ ë’¤ì— ìºì‹œ ì›Œë° ì‹œì‘
  setTimeout(() => {
    cacheWarmer.startWarming();
  }, 5000);

  // 1ì‹œê°„ë§ˆë‹¤ ìºì‹œ ì›Œë° ì‹¤í–‰
  setInterval(() => {
    cacheWarmer.startWarming();
  }, 3600000); // 1ì‹œê°„ = 3600000ms
});

## ì´ì œÂ ë‘Â ë²ˆì§¸ ê²€ìƒ‰Â ì¿¼ë¦¬Â ë¡œì§ì„ ìˆ˜ì •í•˜ê² ìŠµë‹ˆë‹¤Â (searchVideos ë©”ì„œë“œÂ ë‚´ë¶€):

Readserver.js L520-570

Readserver.js L540-590

server.js

      if (keyword && keyword.trim()) {
        // ê°œì„ ëœ ê²€ìƒ‰ ì¿¼ë¦¬: í•œêµ­ì–´ ë¶„ì„ê¸° + í¼ì§€ ë§¤ì¹­ + ë™ì˜ì–´ í™•ì¥
        const searchKeyword = keyword.trim();
    
        // ë™ì˜ì–´ ë§¤í•‘ (ì„œë²„ ì‚¬ì´ë“œ ì„ì‹œ)
        const synonymMap = {
          'ìŒì•…': ['ë®¤ì§', 'music', 'ë…¸ë˜', 'song', 'ê³¡'],
          'ë®¤ì§': ['ìŒì•…', 'music', 'ë…¸ë˜', 'song', 'ê³¡'],
          'music': ['ìŒì•…', 'ë®¤ì§', 'ë…¸ë˜', 'song', 'ê³¡'],
          'ìš”ë¦¬': ['ì¿ í‚¹', 'cooking', 'ë ˆì‹œí”¼', 'recipe'],
          'ì¿ í‚¹': ['ìš”ë¦¬', 'cooking', 'ë ˆì‹œí”¼', 'recipe'],
          'cooking': ['ìš”ë¦¬', 'ì¿ í‚¹', 'ë ˆì‹œí”¼', 'recipe'],
          'ê²Œì„': ['ê²Œì´ë°', 'gaming', 'í”Œë ˆì´', 'game'],
          'ê²Œì´ë°': ['ê²Œì„', 'gaming', 'í”Œë ˆì´', 'game'],
          'gaming': ['ê²Œì„', 'ê²Œì´ë°', 'í”Œë ˆì´', 'game'],
          'ë·°í‹°': ['ë¯¸ìš©', 'beauty', 'í™”ì¥', 'ë©”ì´í¬ì—…', 'makeup'],
          'ë¯¸ìš©': ['ë·°í‹°', 'beauty', 'í™”ì¥', 'ë©”ì´í¬ì—…', 'makeup'],
          'beauty': ['ë·°í‹°', 'ë¯¸ìš©', 'í™”ì¥', 'ë©”ì´í¬ì—…', 'makeup'],
          'ìš´ë™': ['ìŠ¤í¬ì¸ ', 'sports', 'í—¬ìŠ¤', 'fitness', 'workout'],
          'ìŠ¤í¬ì¸ ': ['ìš´ë™', 'sports', 'í—¬ìŠ¤', 'fitness', 'workout'],
          'í—¬ìŠ¤': ['ìš´ë™', 'sports', 'ìŠ¤í¬ì¸ ', 'fitness', 'workout'],
          'ì—¬í–‰': ['íŠ¸ë˜ë¸”', 'travel', 'ì—¬í–‰ê¸°', 'trip'],
          'íŠ¸ë˜ë¸”': ['ì—¬í–‰', 'travel', 'ì—¬í–‰ê¸°', 'trip'],
          'travel': ['ì—¬í–‰', 'íŠ¸ë˜ë¸”', 'ì—¬í–‰ê¸°', 'trip'],
          'ë¦¬ë·°': ['í›„ê¸°', 'review', 'í‰ê°€', 'í‰ì '],
          'í›„ê¸°': ['ë¦¬ë·°', 'review', 'í‰ê°€', 'í‰ì '],
          'review': ['ë¦¬ë·°', 'í›„ê¸°', 'í‰ê°€', 'í‰ì '],
          'ë¨¹ë°©': ['eating', 'food', 'ìŒì‹', 'mukbang'],
          'eating': ['ë¨¹ë°©', 'food', 'ìŒì‹', 'mukbang'],
          'food': ['ë¨¹ë°©', 'eating', 'ìŒì‹', 'mukbang']
        };
    
        // ë™ì˜ì–´ í™•ì¥ëœ í‚¤ì›Œë“œ ëª©ë¡ ìƒì„±
        const expandedKeywords = [searchKeyword];
        const lowerKeyword = searchKeyword.toLowerCase();
        if (synonymMap[lowerKeyword]) {
          expandedKeywords.push(...synonymMap[lowerKeyword]);
        }
    
        // í™•ì¥ëœ í‚¤ì›Œë“œë“¤ë¡œ OR ê²€ìƒ‰ êµ¬ì„±
        const keywordQueries = expandedKeywords.map(kw => ({
          bool: {
            should: [
              // 1. í•œêµ­ì–´ ë¶„ì„ê¸°ë¥¼ ì‚¬ìš©í•œ ì •í™•í•œ ë§¤ì¹­
              {
                match: {
                  title: {
                    query: kw,
                    analyzer: "korean_analyzer",
                    boost: kw === searchKeyword ? 4 : 3 // ì›ë³¸ í‚¤ì›Œë“œì— ë” ë†’ì€ ì ìˆ˜
                  }
                }
              },
              // 2. ì±„ë„ëª… ë§¤ì¹­
              {
                match: {
                  youtube_channel_name: {
                    query: kw,
                    analyzer: "korean_analyzer",
                    boost: kw === searchKeyword ? 3 : 2
                  }
                }
              },
              // 3. ì„¤ëª… ë§¤ì¹­
              {
                match: {
                  description: {
                    query: kw,
                    analyzer: "korean_analyzer",
                    boost: kw === searchKeyword ? 2 : 1.5
                  }
                }
              }
            ],
            minimum_should_match: 1
          }
        }));
    
        mustQueries.push({
          bool: {
            should: [
              ...keywordQueries,
              // 4. í¼ì§€ ë§¤ì¹­ (ì˜¤íƒ€ í—ˆìš©) - ì›ë³¸ í‚¤ì›Œë“œë§Œ
              {
                fuzzy: {
                  title: {
                    value: searchKeyword,
                    fuzziness: "AUTO",
                    boost: 1
                  }
                }
              },
              // 5. ê¸°ì¡´ í‚¤ì›Œë“œ ì •ê·œí™” ë§¤ì¹­ (í˜¸í™˜ì„± ìœ ì§€)
              {
                term: { 
                  keyword_normalized: searchKeyword.toLowerCase(),
                  boost: 0.5
                }
              }
            ],
            minimum_should_match: 1
          }
        });
      }}
    
    currentKey.usageCount++;
    currentKey.lastUsed = new Date();
    
    console.log(`ğŸ”‘ ë³‘ë ¬ ì²˜ë¦¬ìš© í‚¤ ì‚¬ìš©: ${currentKey.name} (ì‚¬ìš©íšŸìˆ˜: ${currentKey.usageCount})`);
    
    // ì‚¬ìš©ëŸ‰ ë³€ê²½ ì €ì¥ (ì£¼ê¸°ì ìœ¼ë¡œ)
    if (currentKey.usageCount % 5 === 0) {
      this.saveKeyStatus();
    }
    
    const youtube = google.youtube({ version: 'v3', auth: currentKey.key });
    
    // YouTube ì¸ìŠ¤í„´ìŠ¤ì™€ í‚¤ ì •ë³´ë¥¼ í•¨ê»˜ ë°˜í™˜
    return {
      youtube: youtube,
      currentKey: currentKey
    };

  }

  // í• ë‹¹ëŸ‰ ì´ˆê³¼ ì²˜ë¦¬ - ê°œì„ ëœ ë¡œì§ (suspended í‚¤ ì²˜ë¦¬ í¬í•¨)
  markKeyAsQuotaExceeded(currentKey, errorMessage = '') {
    if (!currentKey) return null;

    console.log(`âŒ ${currentKey.name} ì˜¤ë¥˜ ë°œìƒ: ${errorMessage}`);
    
    // API í‚¤ ì¼ì‹œì •ì§€(suspended) ì²˜ë¦¬ - ìš°íšŒ ì²˜ë¦¬
    if (errorMessage.includes('suspended') || errorMessage.includes('has been suspended')) {
      console.log(`ğŸš¨ ${currentKey.name} API í‚¤ ì¼ì‹œì •ì§€ ê°ì§€ - ë‹¤ë¥¸ í‚¤ë¡œ ìš°íšŒ`);
      console.log(`ğŸ”„ ì¼ì‹œì  ë¬¸ì œì¼ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ë‹¤ë¥¸ í‚¤ ì‚¬ìš© í›„ ì¬ì‹œë„`);
      // ì˜êµ¬ ë¹„í™œì„±í™”í•˜ì§€ ì•Šê³  ë‹¨ìˆœíˆ ë‹¤ë¥¸ í‚¤ë¡œ ì „í™˜ë§Œ í•¨
      return this.getNextKeyRoundRobin();
    }
    // í• ë‹¹ëŸ‰ ê´€ë ¨ ì˜¤ë¥˜ì¸ì§€ í™•ì¸
    else if (errorMessage.includes('quota') || errorMessage.includes('quotaExceeded') || 
        errorMessage.includes('dailyLimitExceeded') || errorMessage.includes('rateLimitExceeded')) {
      currentKey.quotaExceeded = true;
      console.log(`ğŸš« ${currentKey.name} í• ë‹¹ëŸ‰ ì´ˆê³¼ë¡œ ë¹„í™œì„±í™”ë¨`);
    } else {
      // ë‹¤ë¥¸ ì˜¤ë¥˜ì˜ ê²½ìš° ì—°ì† ì˜¤ë¥˜ íšŸìˆ˜ ì¦ê°€
      currentKey.consecutiveErrors++;
      console.log(`âš ï¸ ${currentKey.name} ì—°ì† ì˜¤ë¥˜ íšŸìˆ˜: ${currentKey.consecutiveErrors}`);
    
      // ì—°ì† ì˜¤ë¥˜ê°€ 3íšŒ ì´ìƒì´ë©´ ì„ì‹œ ë¹„í™œì„±í™”
      if (currentKey.consecutiveErrors >= 3) {
        console.log(`ğŸ”’ ${currentKey.name} ì—°ì† ì˜¤ë¥˜ë¡œ ì„ì‹œ ë¹„í™œì„±í™” (í• ë‹¹ëŸ‰ ì´ˆê³¼ëŠ” ì•„ë‹˜)`);
      }
    }
    
    // ìƒíƒœ ë³€ê²½ ì €ì¥
    this.saveKeyStatus();
    
    // ë‹¤ìŒ ì‚¬ìš© ê°€ëŠ¥í•œ í‚¤ ì°¾ê¸°
    const nextKey = this.getCurrentKey();
    
    if (nextKey) {
      console.log(`ğŸ”„ ${nextKey.name}ìœ¼ë¡œ ì „í™˜í•©ë‹ˆë‹¤.`);
      return nextKey;
    } else {
      console.log('âš ï¸ ì‚¬ìš© ê°€ëŠ¥í•œ API í‚¤ê°€ ì—†ìŠµë‹ˆë‹¤.');
      return null;
    }

  }

  // API í˜¸ì¶œ ì„±ê³µ ì‹œ ì—°ì† ì˜¤ë¥˜ ì¹´ìš´í„° ë¦¬ì…‹
  markKeyAsSuccessful(currentKey) {
    if (currentKey && currentKey.consecutiveErrors > 0) {
      console.log(`âœ… ${currentKey.name} ì„±ê³µ, ì—°ì† ì˜¤ë¥˜ ì¹´ìš´í„° ë¦¬ì…‹`);
      currentKey.consecutiveErrors = 0;
      this.saveKeyStatus();
    }
  }

  // ì‚¬ìš© ê°€ëŠ¥í•œ í‚¤ê°€ ìˆëŠ”ì§€ í™•ì¸
  hasAvailableKeys() {
    return this.apiKeys.some(keyInfo => !keyInfo.quotaExceeded);
  }

  // í• ë‹¹ëŸ‰ ì´ˆê³¼ ì²˜ë¦¬ë¥¼ í¬í•¨í•œ ì•ˆì „í•œ YouTube ì¸ìŠ¤í„´ìŠ¤ ë°˜í™˜
  async getYouTubeInstanceSafely() {
    const maxRetries = this.apiKeys.length;
    let currentRetry = 0;

    while (currentRetry < maxRetries) {
      const currentKey = this.getCurrentKey();
    
      if (!currentKey || currentKey.quotaExceeded) {
        console.log('ì‚¬ìš© ê°€ëŠ¥í•œ API í‚¤ê°€ ì—†ìŒ');
        return null;
      }
    
      currentKey.usageCount++;
      currentKey.lastUsed = new Date();
      console.log(`ğŸ”‘ ì‚¬ìš© ì¤‘ì¸ API í‚¤: ${currentKey.name} (ì‚¬ìš©íšŸìˆ˜: ${currentKey.usageCount})`);
    
      const youtube = google.youtube({ version: 'v3', auth: currentKey.key });
      return { youtube, currentKey };
    }
    
    return null;

  }

  // ìƒíƒœ íŒŒì¼ì—ì„œ API í‚¤ ìƒíƒœ ë¡œë“œ
  loadKeyStatus() {
    try {
      if (fs.existsSync(this.statusFile)) {
        const status = JSON.parse(fs.readFileSync(this.statusFile, 'utf8'));
        const today = new Date().toDateString();

        // ë‹¹ì¼ì´ ì•„ë‹ˆë©´ ìƒíƒœ ë¦¬ì…‹ (ì¼ì¼ í• ë‹¹ëŸ‰ ê°±ì‹ )
        if (status.date !== today) {
          console.log(`ğŸ“… ë‚ ì§œ ë³€ê²½ ê°ì§€ (${status.date} â†’ ${today}), API í‚¤ ìƒíƒœ ë¦¬ì…‹`);
          this.resetDailyStatus();
        } else {
          console.log(`ğŸ”„ ì €ì¥ëœ API í‚¤ ìƒíƒœ ë¡œë“œ (${status.date})`);
          this.restoreKeyStatus(status);
        }
      } else {
        console.log(`ğŸ“ API í‚¤ ìƒíƒœ íŒŒì¼ì´ ì—†ìŒ, ìƒˆë¡œ ìƒì„±`);
        this.saveKeyStatus();
      }
    } catch (error) {
      console.error('âš ï¸ ìƒíƒœ íŒŒì¼ ë¡œë“œ ì‹¤íŒ¨:', error.message);
      console.log('ğŸ’¡ ê¸°ë³¸ ìƒíƒœë¡œ ì§„í–‰í•©ë‹ˆë‹¤.');
    }

  }

  // ì €ì¥ëœ ìƒíƒœë¥¼ API í‚¤ì— ë³µì›
  restoreKeyStatus(status) {
    status.keys.forEach(savedKey => {
      const apiKey = this.apiKeys.find(key => key.index === savedKey.index);
      if (apiKey) {
        apiKey.quotaExceeded = savedKey.quotaExceeded;
        apiKey.usageCount = savedKey.usageCount;
        apiKey.consecutiveErrors = savedKey.consecutiveErrors || 0;
        if (savedKey.lastUsed) {
          apiKey.lastUsed = new Date(savedKey.lastUsed);
        }

        // ë ˆê±°ì‹œ ì¶”ì  ê°ì²´ë„ ì—…ë°ì´íŠ¸
        this.keyUsageCount[apiKey.index] = apiKey.usageCount;
        this.keyQuotaExceeded[apiKey.index] = apiKey.quotaExceeded;
      }
    });
    
    const exceededCount = this.apiKeys.filter(key => key.quotaExceeded).length;
    const availableCount = this.apiKeys.length - exceededCount;
    console.log(`ğŸ“Š ìƒíƒœ ë³µì› ì™„ë£Œ: ${availableCount}/${this.apiKeys.length} í‚¤ ì‚¬ìš© ê°€ëŠ¥`);

  }

  // ì¼ì¼ ìƒíƒœ ë¦¬ì…‹
  resetDailyStatus() {
    this.apiKeys.forEach(key => {
      key.quotaExceeded = false;
      key.consecutiveErrors = 0;
      // usageCountì™€ lastUsedëŠ” ìœ ì§€ (í†µê³„ ëª©ì )
    });
    this.saveKeyStatus();
    console.log(`ğŸ”„ ëª¨ë“  API í‚¤ ìƒíƒœê°€ ë¦¬ì…‹ë˜ì—ˆìŠµë‹ˆë‹¤.`);
  }

  // í˜„ì¬ ìƒíƒœë¥¼ íŒŒì¼ì— ì €ì¥
  saveKeyStatus() {
    try {
      const status = {
        date: new Date().toDateString(),
        lastUpdated: new Date().toISOString(),
        keys: this.apiKeys.map(key => ({
          index: key.index,
          name: key.name,
          quotaExceeded: key.quotaExceeded,
          usageCount: key.usageCount,
          consecutiveErrors: key.consecutiveErrors,
          lastUsed: key.lastUsed ? key.lastUsed.toISOString() : null
        }))
      };

      fs.writeFileSync(this.statusFile, JSON.stringify(status, null, 2), 'utf8');
      console.log(`ğŸ’¾ API í‚¤ ìƒíƒœ ì €ì¥ ì™„ë£Œ: ${this.statusFile}`);
    } catch (error) {
      console.error('âš ï¸ ìƒíƒœ íŒŒì¼ ì €ì¥ ì‹¤íŒ¨:', error.message);
    }

  }

  // ì‚¬ìš© í†µê³„ ì¶œë ¥
  printUsageStats() {
    console.log('\nğŸ“Š API í‚¤ ì‚¬ìš© í†µê³„:');
    this.apiKeys.forEach(keyInfo => {
      const status = keyInfo.quotaExceeded ? 'âŒ í• ë‹¹ëŸ‰ ì´ˆê³¼' : 'âœ… ì‚¬ìš© ê°€ëŠ¥';
      const lastUsed = keyInfo.lastUsed ? keyInfo.lastUsed.toLocaleString() : 'ë¯¸ì‚¬ìš©';
      const currentIndicator = keyInfo.index === this.currentKeyIndex + 1 ? ' ğŸ”‘ í˜„ì¬' : '';
      const quotaInfo = keyInfo.quotaExceeded ? ' (í• ë‹¹ëŸ‰ ì´ˆê³¼)' : '';
      console.log(`   ${keyInfo.name}: ${status} | ì‚¬ìš©íšŸìˆ˜: ${keyInfo.usageCount} | ë§ˆì§€ë§‰ ì‚¬ìš©: ${lastUsed}${currentIndicator}${quotaInfo}`);
    });

    const availableKeys = this.apiKeys.filter(key => !key.quotaExceeded);
    const exhaustedKeys = this.apiKeys.filter(key => key.quotaExceeded);
    
    console.log(`\nğŸ“ˆ ìš”ì•½: ${availableKeys.length}/${this.apiKeys.length} í‚¤ ì‚¬ìš© ê°€ëŠ¥`);
    if (exhaustedKeys.length > 0) {
      console.log(`   í• ë‹¹ëŸ‰ ì´ˆê³¼ëœ í‚¤: ${exhaustedKeys.map(k => k.name).join(', ')}`);
    }
    if (availableKeys.length > 0) {
      console.log(`   ì‚¬ìš© ê°€ëŠ¥í•œ í‚¤: ${availableKeys.map(k => k.name).join(', ')}`);
    }
    
    // í˜„ì¬ í™œì„± í‚¤ ì •ë³´
    const currentKey = this.apiKeys[this.currentKeyIndex];
    if (currentKey) {
      console.log(`\nğŸ”‘ í˜„ì¬ í™œì„± í‚¤: ${currentKey.name} (${currentKey.quotaExceeded ? 'í• ë‹¹ëŸ‰ ì´ˆê³¼' : 'ì •ìƒ'})`);
    }

  }
}

// API í‚¤ ë§¤ë‹ˆì € ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
const apiKeyManager = new ApiKeyManager();

// Elasticsearch í—¬í¼ í•¨ìˆ˜ë“¤
class ElasticsearchHelper {
  constructor(client) {
    this.client = client;
    this.indexName = process.env.ES_INDEX_VIDEOS || 'videos';
    this.ttlHours = parseInt(process.env.ES_TTL_HOURS) || 48;
  }

  // ìºì‹œ íˆíŠ¸ íŒë‹¨
  async checkCacheHit(searchParams) {
    if (!this.client || !(await checkESConnection())) return { hit: false, reason: 'ES client not available' };

    try {
      const { country, keyword, minViews, maxViews, maxResults, publishedAfter, publishedBefore } = searchParams;
    
      // ê²€ìƒ‰ ì¡°ê±´ êµ¬ì„±
      const mustQueries = [];
      const filterQueries = [];
    
      if (country && country !== 'worldwide') {
        mustQueries.push({ term: { country } });
      }
    
      if (keyword && keyword.trim()) {
        // ê°œì„ ëœ ê²€ìƒ‰ ì¿¼ë¦¬: í•œêµ­ì–´ ë¶„ì„ê¸° + í¼ì§€ ë§¤ì¹­ + ë™ì˜ì–´ í™•ì¥
        const searchKeyword = keyword.trim();
    
        // ë™ì˜ì–´ ë§¤í•‘ (ì„œë²„ ì‚¬ì´ë“œ ì„ì‹œ)
        const synonymMap = {
          'ìŒì•…': ['ë®¤ì§', 'music', 'ë…¸ë˜', 'song', 'ê³¡'],
          'ë®¤ì§': ['ìŒì•…', 'music', 'ë…¸ë˜', 'song', 'ê³¡'],
          'music': ['ìŒì•…', 'ë®¤ì§', 'ë…¸ë˜', 'song', 'ê³¡'],
          'ìš”ë¦¬': ['ì¿ í‚¹', 'cooking', 'ë ˆì‹œí”¼', 'recipe'],
          'ì¿ í‚¹': ['ìš”ë¦¬', 'cooking', 'ë ˆì‹œí”¼', 'recipe'],
          'cooking': ['ìš”ë¦¬', 'ì¿ í‚¹', 'ë ˆì‹œí”¼', 'recipe'],
          'ê²Œì„': ['ê²Œì´ë°', 'gaming', 'í”Œë ˆì´', 'game'],
          'ê²Œì´ë°': ['ê²Œì„', 'gaming', 'í”Œë ˆì´', 'game'],
          'gaming': ['ê²Œì„', 'ê²Œì´ë°', 'í”Œë ˆì´', 'game'],
          'ë·°í‹°': ['ë¯¸ìš©', 'beauty', 'í™”ì¥', 'ë©”ì´í¬ì—…', 'makeup'],
          'ë¯¸ìš©': ['ë·°í‹°', 'beauty', 'í™”ì¥', 'ë©”ì´í¬ì—…', 'makeup'],
          'beauty': ['ë·°í‹°', 'ë¯¸ìš©', 'í™”ì¥', 'ë©”ì´í¬ì—…', 'makeup'],
          'ìš´ë™': ['ìŠ¤í¬ì¸ ', 'sports', 'í—¬ìŠ¤', 'fitness', 'workout'],
          'ìŠ¤í¬ì¸ ': ['ìš´ë™', 'sports', 'í—¬ìŠ¤', 'fitness', 'workout'],
          'í—¬ìŠ¤': ['ìš´ë™', 'sports', 'ìŠ¤í¬ì¸ ', 'fitness', 'workout'],
          'ì—¬í–‰': ['íŠ¸ë˜ë¸”', 'travel', 'ì—¬í–‰ê¸°', 'trip'],
          'íŠ¸ë˜ë¸”': ['ì—¬í–‰', 'travel', 'ì—¬í–‰ê¸°', 'trip'],
          'travel': ['ì—¬í–‰', 'íŠ¸ë˜ë¸”', 'ì—¬í–‰ê¸°', 'trip'],
          'ë¦¬ë·°': ['í›„ê¸°', 'review', 'í‰ê°€', 'í‰ì '],
          'í›„ê¸°': ['ë¦¬ë·°', 'review', 'í‰ê°€', 'í‰ì '],
          'review': ['ë¦¬ë·°', 'í›„ê¸°', 'í‰ê°€', 'í‰ì '],
          'ë¨¹ë°©': ['eating', 'food', 'ìŒì‹', 'mukbang'],
          'eating': ['ë¨¹ë°©', 'food', 'ìŒì‹', 'mukbang'],
          'food': ['ë¨¹ë°©', 'eating', 'ìŒì‹', 'mukbang']
        };
    
        // ë™ì˜ì–´ í™•ì¥ëœ í‚¤ì›Œë“œ ëª©ë¡ ìƒì„±
        const expandedKeywords = [searchKeyword];
        const lowerKeyword = searchKeyword.toLowerCase();
        if (synonymMap[lowerKeyword]) {
          expandedKeywords.push(...synonymMap[lowerKeyword]);
        }
    
        // í™•ì¥ëœ í‚¤ì›Œë“œë“¤ë¡œ OR ê²€ìƒ‰ êµ¬ì„±
        const keywordQueries = expandedKeywords.map(kw => ({
          bool: {
            should: [
              // 1. í•œêµ­ì–´ ë¶„ì„ê¸°ë¥¼ ì‚¬ìš©í•œ ì •í™•í•œ ë§¤ì¹­
              {
                match: {
                  title: {
                    query: kw,
                    analyzer: "korean_analyzer",
                    boost: kw === searchKeyword ? 4 : 3 // ì›ë³¸ í‚¤ì›Œë“œì— ë” ë†’ì€ ì ìˆ˜
                  }
                }
              },
              // 2. ì±„ë„ëª… ë§¤ì¹­
              {
                match: {
                  youtube_channel_name: {
                    query: kw,
                    analyzer: "korean_analyzer",
                    boost: kw === searchKeyword ? 3 : 2
                  }
                }
              }
            ],
            minimum_should_match: 1
          }
        }));
    
        mustQueries.push({
          bool: {
            should: [
              ...keywordQueries,
              // 3. í¼ì§€ ë§¤ì¹­ (ì˜¤íƒ€ í—ˆìš©) - ì›ë³¸ í‚¤ì›Œë“œë§Œ
              {
                fuzzy: {
                  title: {
                    value: searchKeyword,
                    fuzziness: "AUTO",
                    boost: 1
                  }
                }
              },
              // 4. ê¸°ì¡´ í‚¤ì›Œë“œ ì •ê·œí™” ë§¤ì¹­ (í˜¸í™˜ì„± ìœ ì§€)
              {
                term: { 
                  keyword_normalized: searchKeyword.toLowerCase(),
                  boost: 0.5
                }
              }
            ],
            minimum_should_match: 1
          }
        });
      }
    
      if (minViews) {
        filterQueries.push({ range: { daily_view_count: { gte: parseInt(minViews) } } });
      }
    
      if (maxViews) {
        filterQueries.push({ range: { daily_view_count: { lte: parseInt(maxViews) } } });
      }
    
      // ì—…ë¡œë“œ ë‚ ì§œ ë²”ìœ„ í•„í„°ë§ ì¶”ê°€
      if (publishedAfter || publishedBefore) {
        const dateRange = {};
        if (publishedAfter) dateRange.gte = publishedAfter;
        if (publishedBefore) dateRange.lte = publishedBefore;
        filterQueries.push({ range: { status_date: dateRange } });
        console.log('ES ë‚ ì§œ ë²”ìœ„ í•„í„° ì ìš©:', dateRange);
        console.log('ES ìºì‹œ ì²´í¬ ë‚ ì§œ ë²”ìœ„ í•„í„° ì ìš©:', dateRange);
      }
    
      // ìºì‹œëœ ë°ì´í„° ìˆ˜ëŸ‰ í™•ì¸
      const countQuery = {
        query: {
          bool: {
            must: mustQueries,
            filter: filterQueries
          }
        }
      };
    
      const countResponse = await this.client.count({
        index: this.indexName,
        body: countQuery
      });
    
      const availableCount = countResponse.body?.count || countResponse.count || 0;
      const requestedCount = parseInt(maxResults) || 60;
    
      // ì‹ ì„ ë„ í™•ì¸
      const freshnessQuery = {
        query: { bool: { must: mustQueries, filter: filterQueries } },
        sort: [{ indexed_at: 'desc' }],
        size: 1,
        _source: ['indexed_at']
      };
    
      const freshnessResponse = await this.client.search({
        index: this.indexName,
        body: freshnessQuery
      });
    
      const hits = freshnessResponse.body?.hits?.hits || freshnessResponse.hits?.hits || [];
      let isFresh = false;
    
      if (hits.length > 0) {
        const lastIndexed = new Date(hits[0]._source.indexed_at);
        const ttlLimit = new Date(Date.now() - this.ttlHours * 60 * 60 * 1000);
        isFresh = lastIndexed > ttlLimit;
      }
    
      const cacheHit = availableCount >= requestedCount && isFresh;
    
      return {
        hit: cacheHit,
        availableCount,
        requestedCount,
        isFresh,
        reason: cacheHit ? 'Cache hit' : `Insufficient data (${availableCount}/${requestedCount}) or stale data (fresh: ${isFresh})`
      };
    
    } catch (error) {
      console.error('Cache hit check error:', error);
      return { hit: false, reason: 'Cache check failed', error: error.message };
    }

  }

  // ESì—ì„œ ê²€ìƒ‰ ê²°ê³¼ ì¡°íšŒ
  async searchVideos(searchParams) {
    if (!this.client || !(await checkESConnection())) return null;

    try {
      const { country, keyword, minViews, maxViews, maxResults, publishedAfter, publishedBefore } = searchParams;
    
      // ê²€ìƒ‰ ì¡°ê±´ êµ¬ì„±
      const mustQueries = [];
      const filterQueries = [];
    
      if (country && country !== 'worldwide') {
        mustQueries.push({ term: { country } });
      }
    
      if (keyword && keyword.trim()) {
        // ê°œì„ ëœ ê²€ìƒ‰ ì¿¼ë¦¬: í•œêµ­ì–´ ë¶„ì„ê¸° + í¼ì§€ ë§¤ì¹­ + ë™ì˜ì–´ í™•ì¥
        const searchKeyword = keyword.trim();
    
        // ë™ì˜ì–´ ë§¤í•‘ (ì„œë²„ ì‚¬ì´ë“œ ì„ì‹œ)
        const synonymMap = {
          'ìŒì•…': ['ë®¤ì§', 'music', 'ë…¸ë˜', 'song', 'ê³¡'],
          'ë®¤ì§': ['ìŒì•…', 'music', 'ë…¸ë˜', 'song', 'ê³¡'],
          'music': ['ìŒì•…', 'ë®¤ì§', 'ë…¸ë˜', 'song', 'ê³¡'],
          'ìš”ë¦¬': ['ì¿ í‚¹', 'cooking', 'ë ˆì‹œí”¼', 'recipe'],
          'ì¿ í‚¹': ['ìš”ë¦¬', 'cooking', 'ë ˆì‹œí”¼', 'recipe'],
          'cooking': ['ìš”ë¦¬', 'ì¿ í‚¹', 'ë ˆì‹œí”¼', 'recipe'],
          'ê²Œì„': ['ê²Œì´ë°', 'gaming', 'í”Œë ˆì´', 'game'],
          'ê²Œì´ë°': ['ê²Œì„', 'gaming', 'í”Œë ˆì´', 'game'],
          'gaming': ['ê²Œì„', 'ê²Œì´ë°', 'í”Œë ˆì´', 'game'],
          'ë·°í‹°': ['ë¯¸ìš©', 'beauty', 'í™”ì¥', 'ë©”ì´í¬ì—…', 'makeup'],
          'ë¯¸ìš©': ['ë·°í‹°', 'beauty', 'í™”ì¥', 'ë©”ì´í¬ì—…', 'makeup'],
          'beauty': ['ë·°í‹°', 'ë¯¸ìš©', 'í™”ì¥', 'ë©”ì´í¬ì—…', 'makeup'],
          'ìš´ë™': ['ìŠ¤í¬ì¸ ', 'sports', 'í—¬ìŠ¤', 'fitness', 'workout'],
          'ìŠ¤í¬ì¸ ': ['ìš´ë™', 'sports', 'í—¬ìŠ¤', 'fitness', 'workout'],
          'í—¬ìŠ¤': ['ìš´ë™', 'sports', 'ìŠ¤í¬ì¸ ', 'fitness', 'workout'],
          'ì—¬í–‰': ['íŠ¸ë˜ë¸”', 'travel', 'ì—¬í–‰ê¸°', 'trip'],
          'íŠ¸ë˜ë¸”': ['ì—¬í–‰', 'travel', 'ì—¬í–‰ê¸°', 'trip'],
          'travel': ['ì—¬í–‰', 'íŠ¸ë˜ë¸”', 'ì—¬í–‰ê¸°', 'trip'],
          'ë¦¬ë·°': ['í›„ê¸°', 'review', 'í‰ê°€', 'í‰ì '],
          'í›„ê¸°': ['ë¦¬ë·°', 'review', 'í‰ê°€', 'í‰ì '],
          'review': ['ë¦¬ë·°', 'í›„ê¸°', 'í‰ê°€', 'í‰ì '],
          'ë¨¹ë°©': ['eating', 'food', 'ìŒì‹', 'mukbang'],
          'eating': ['ë¨¹ë°©', 'food', 'ìŒì‹', 'mukbang'],
          'food': ['ë¨¹ë°©', 'eating', 'ìŒì‹', 'mukbang']
        };
    
        // ë™ì˜ì–´ í™•ì¥ëœ í‚¤ì›Œë“œ ëª©ë¡ ìƒì„±
        const expandedKeywords = [searchKeyword];
        const lowerKeyword = searchKeyword.toLowerCase();
        if (synonymMap[lowerKeyword]) {
          expandedKeywords.push(...synonymMap[lowerKeyword]);
        }
    
        // í™•ì¥ëœ í‚¤ì›Œë“œë“¤ë¡œ OR ê²€ìƒ‰ êµ¬ì„±
        const keywordQueries = expandedKeywords.map(kw => ({
          bool: {
            should: [
              // 1. í•œêµ­ì–´ ë¶„ì„ê¸°ë¥¼ ì‚¬ìš©í•œ ì •í™•í•œ ë§¤ì¹­
              {
                match: {
                  title: {
                    query: kw,
                    analyzer: "korean_analyzer",
                    boost: kw === searchKeyword ? 4 : 3 // ì›ë³¸ í‚¤ì›Œë“œì— ë” ë†’ì€ ì ìˆ˜
                  }
                }
              },
              // 2. ì±„ë„ëª… ë§¤ì¹­
              {
                match: {
                  youtube_channel_name: {
                    query: kw,
                    analyzer: "korean_analyzer",
                    boost: kw === searchKeyword ? 3 : 2
                  }
                }
              },
              // 3. ì„¤ëª… ë§¤ì¹­
              {
                match: {
                  description: {
                    query: kw,
                    analyzer: "korean_analyzer",
                    boost: kw === searchKeyword ? 2 : 1.5
                  }
                }
              }
            ],
            minimum_should_match: 1
          }
        }));
    
        mustQueries.push({
          bool: {
            should: [
              ...keywordQueries,
              // 4. í¼ì§€ ë§¤ì¹­ (ì˜¤íƒ€ í—ˆìš©) - ì›ë³¸ í‚¤ì›Œë“œë§Œ
              {
                fuzzy: {
                  title: {
                    value: searchKeyword,
                    fuzziness: "AUTO",
                    boost: 1
                  }
                }
              },
              // 5. ê¸°ì¡´ í‚¤ì›Œë“œ ì •ê·œí™” ë§¤ì¹­ (í˜¸í™˜ì„± ìœ ì§€)
              {
                term: { 
                  keyword_normalized: searchKeyword.toLowerCase(),
                  boost: 0.5
                }
              }
            ],
            minimum_should_match: 1
          }
        });
      }
    
      if (minViews) {
        filterQueries.push({ range: { daily_view_count: { gte: parseInt(minViews) } } });
      }
    
      if (maxViews) {
        filterQueries.push({ range: { daily_view_count: { lte: parseInt(maxViews) } } });
      }
    
      // ì—…ë¡œë“œ ë‚ ì§œ ë²”ìœ„ í•„í„°ë§ ì¶”ê°€
      if (publishedAfter || publishedBefore) {
        const dateRange = {};
        if (publishedAfter) dateRange.gte = publishedAfter;
        if (publishedBefore) dateRange.lte = publishedBefore;
        filterQueries.push({ range: { status_date: dateRange } });
        console.log('ES ë‚ ì§œ ë²”ìœ„ í•„í„° ì ìš©:', dateRange);
      }
    
      const searchQuery = {
        query: {
          bool: {
            must: mustQueries,
            filter: filterQueries
          }
        },
        sort: [{ daily_view_count: 'desc' }],
        size: parseInt(maxResults) || 60
      };
    
      const response = await this.client.search({
        index: this.indexName,
        body: searchQuery
      });
    
      // ES ê²°ê³¼ë¥¼ API ì‘ë‹µ í˜•ì‹ìœ¼ë¡œ ë³€í™˜
      const results = response.body.hits.hits.map(hit => ({
        youtube_channel_name: hit._source.youtube_channel_name,
        thumbnail_url: hit._source.thumbnail_url,
        status: hit._source.status || 'active',
        youtube_channel_id: hit._source.youtube_channel_id,
        primary_category: hit._source.primary_category,
        status_date: hit._source.status_date,
        daily_view_count: hit._source.daily_view_count,
        subscriber_count: hit._source.subscriber_count,
        vod_url: hit._source.vod_url,
        video_id: hit._source.video_id,
        title: hit._source.title,
        description: hit._source.description,
        duration: hit._source.duration,
        duration_seconds: hit._source.duration_seconds,
        video_length_category: hit._source.video_length_category
      }));
    
      return results;
    
    } catch (error) {
      console.error('ES search error:', error);
      return null;
    }

  }

  // YouTube API ê²°ê³¼ë¥¼ ESì— bulk upsert
  async bulkUpsertVideos(videos, searchParams) {
    if (!this.client || !videos || videos.length === 0 || !(await checkESConnection())) return;

    try {
      const body = [];
      const indexedAt = new Date().toISOString();
    
      videos.forEach(video => {
        // upsertë¥¼ ìœ„í•œ update ì•¡ì…˜
        body.push({
          update: {
            _index: this.indexName,
            _id: video.video_id
          }
        });
    
        // ë¬¸ì„œ ë‚´ìš©
        body.push({
          doc: {
            video_id: video.video_id,
            title: video.title,
            youtube_channel_name: video.youtube_channel_name,
            youtube_channel_id: video.youtube_channel_id,
            country: searchParams.country || 'unknown',
            status_date: video.status_date,
            daily_view_count: parseInt(video.daily_view_count) || 0,
            subscriber_count: parseInt(video.subscriber_count) || 0,
            duration_seconds: parseInt(video.duration_seconds) || 0,
            video_length_category: video.video_length_category,
            primary_category: video.primary_category,
            vod_url: video.vod_url,
            thumbnail_url: video.thumbnail_url,
            status: video.status || 'active',
            description: video.description || '',
            duration: video.duration || '',
            keyword_normalized: (searchParams.keyword || '').toLowerCase(),
            indexed_at: indexedAt
          },
          doc_as_upsert: true
        });
      });
    
              const response = await this.client.bulk({ body });
    
        // ì‘ë‹µ êµ¬ì¡° ê²€ì¦ ë° ì•ˆì „í•œ ì˜¤ë¥˜ ì²˜ë¦¬
        if (response && response.body && response.body.errors) {
          console.error('ES bulk upsert errors:', response.body.items.filter(item => item.update && item.update.error));
        } else if (response && response.errors) {
          // ìƒˆë¡œìš´ ë²„ì „ì˜ í´ë¼ì´ì–¸íŠ¸ ì‘ë‹µ êµ¬ì¡°
          console.error('ES bulk upsert errors:', response.items.filter(item => item.update && item.update.error));
        } else {
          console.log(`ES bulk upsert ì„±ê³µ: ${videos.length}ê°œ ë¹„ë””ì˜¤ ì¸ë±ì‹±`);
        }
    
    } catch (error) {
      console.error('ES bulk upsert error:', error);
    }

  }
}

// ES í—¬í¼ ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
const esHelper = new ElasticsearchHelper(esClient);

// ê°„ë‹¨í•œ Rate Limiting êµ¬í˜„
const requestTracker = new Map();
const RATE_LIMIT_WINDOW = 15 * 60 * 1000; // 15ë¶„
const RATE_LIMIT_MAX_REQUESTS = 10; // 15ë¶„ë‹¹ ìµœëŒ€ 10íšŒ ê²€ìƒ‰

function rateLimitMiddleware(req, res, next) {
  const clientIP = req.ip || req.connection.remoteAddress;
  const now = Date.now();

  // ì´ì „ ìš”ì²­ ê¸°ë¡ ê°€ì ¸ì˜¤ê¸°
  let requests = requestTracker.get(clientIP) || [];

  // ì˜¤ë˜ëœ ìš”ì²­ ì œê±° (15ë¶„ ì´ì „)
  requests = requests.filter(timestamp => now - timestamp < RATE_LIMIT_WINDOW);

  // ì œí•œ ì´ˆê³¼ í™•ì¸
  if (requests.length >= RATE_LIMIT_MAX_REQUESTS) {
    return res.status(429).json({
      success: false,
      error: 'ê²€ìƒ‰ ìš”ì²­ì´ ë„ˆë¬´ ë§ìŠµë‹ˆë‹¤. 15ë¶„ í›„ì— ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.',
      retryAfter: Math.ceil((requests[0] + RATE_LIMIT_WINDOW - now) / 1000)
    });
  }

  // í˜„ì¬ ìš”ì²­ ì¶”ê°€
  requests.push(now);
  requestTracker.set(clientIP, requests);

  next();
}

// ì£¼ê¸°ì ìœ¼ë¡œ ì˜¤ë˜ëœ ë°ì´í„° ì •ë¦¬
setInterval(() => {
  const now = Date.now();
  for (const [ip, requests] of requestTracker.entries()) {
    const validRequests = requests.filter(timestamp => now - timestamp < RATE_LIMIT_WINDOW);
    if (validRequests.length === 0) {
      requestTracker.delete(ip);
    } else {
      requestTracker.set(ip, validRequests);
    }
  }
}, 5 * 60 * 1000); // 5ë¶„ë§ˆë‹¤ ì •ë¦¬

const app = express();
const PORT = process.env.PORT || 3000;

// ë¯¸ë“¤ì›¨ì–´ ì„¤ì •
app.use(cors());
// ëŒ€ìš©ëŸ‰ ë°ì´í„° ì²˜ë¦¬ë¥¼ ìœ„í•œ body-parser ì œí•œ ì¦ê°€
app.use(express.json({ limit: '50mb' }));
app.use(express.urlencoded({ limit: '50mb', extended: true }));
app.use(express.static(__dirname));

// ë©”ì¸ í˜ì´ì§€ ë¼ìš°íŠ¸
app.get('/', (req, res) => {
  res.sendFile(path.join(__dirname, 'you_list.html'));
});

// YouTube ë™ì˜ìƒ ê²€ìƒ‰ API
app.get('/api/search', rateLimitMiddleware, async (req, res) => {
  const searchStartTime = Date.now(); // ê²€ìƒ‰ ì‹œì‘ ì‹œê°„ ê¸°ë¡

  try {
    // í•„í„°ë§ í†µê³„ë¥¼ ìœ„í•œ ì¹´ìš´í„° ì¶”ê°€ (í•¨ìˆ˜ ì‹œì‘ ë¶€ë¶„ì— ì •ì˜)
    const filterStats = {
      totalProcessed: 0,
      duplicateSkipped: 0,
      categoryFiltered: 0,
      minViewsFiltered: 0,
      maxViewsFiltered: 0,
      videoLengthFiltered: 0,
      minAvgWatchRateFiltered: 0,
      finalAccepted: 0
    };

    const {
      country = 'worldwide',  // ê¸°ë³¸ê°’ì„ ì „ì„¸ê³„ë¡œ ë³€ê²½
      countries = '',         // ë‹¤ì¤‘ êµ­ê°€ ì„ íƒ íŒŒë¼ë¯¸í„° ì¶”ê°€
      keyword = '',
      searchScope = 'title',  // ê²€ìƒ‰ ë²”ìœ„: title, channel, ë˜ëŠ” ë¶„ë¦¬ëœ ë¬¸ìì—´
      maxViews,
      minViews = 100000,
      minAvgWatchRate,        // ìµœì†Œí‰ê· ì‹œì²­ë¥  í•„í„° ì¶”ê°€
      uploadPeriod,
      startDate,
      endDate,
      videoLength,
      maxResults = 60,   // ê¸°ë³¸ê°’ 60ê±´
      categories = ''   // ì¹´í…Œê³ ë¦¬ í•„í„°
    } = req.query;
    
    // maxResults ìœ íš¨ì„± ê²€ì‚¬ ë° ë³€í™˜
    const allowedResults = [10, 20, 30, 40, 50, 60, 100, 150, 200];
    const parsedMaxResults = parseInt(maxResults);
    const finalMaxResults = allowedResults.includes(parsedMaxResults) ? parsedMaxResults : 60;
    
    console.log('ê²€ìƒ‰ íŒŒë¼ë¯¸í„°:', req.query);
    console.log('ì„ íƒëœ êµ­ê°€(ë‹¨ìˆ˜):', country);
    console.log('ì„ íƒëœ êµ­ê°€ë“¤(ë³µìˆ˜):', countries);
    console.log('ğŸ“Š ìµœì†Œí‰ê· ì‹œì²­ë¥  í•„í„°:', minAvgWatchRate ? `${minAvgWatchRate}% ì´ìƒ` : 'ë¹„í™œì„±í™”');
    
    // ë‹¤ì¤‘ êµ­ê°€ ì²˜ë¦¬ ë¡œì§ ê°œì„ 
    let selectedCountries;
    if (countries && countries.length > 0) {
      // countries íŒŒë¼ë¯¸í„°ê°€ ìˆìœ¼ë©´ ìš°ì„  ì‚¬ìš©
      if (Array.isArray(countries)) {
        selectedCountries = countries.filter(c => c && c.trim());
      } else if (typeof countries === 'string') {
        selectedCountries = countries.split(',').filter(c => c.trim());
      } else {
        selectedCountries = [country];
      }
    } else {
      // countriesê°€ ì—†ìœ¼ë©´ country ì‚¬ìš©
      selectedCountries = [country];
    }
    
    // ì¤‘ë³µ ì œê±° ë° ìœ íš¨ì„± ê²€ì‚¬
    selectedCountries = [...new Set(selectedCountries.filter(c => c && c.trim()))];
    if (selectedCountries.length === 0) {
      selectedCountries = ['worldwide'];
    }
    
    console.log('ìµœì¢… ì²˜ë¦¬í•  êµ­ê°€ ëª©ë¡:', selectedCountries);
    
    console.log('ê²€ìƒ‰ ë²”ìœ„:', searchScope);
    console.log('ì„ íƒëœ ì¹´í…Œê³ ë¦¬:', categories);
    console.log(`ê²€ìƒ‰ ê²°ê³¼ ìˆ˜: ${finalMaxResults}ê±´ (ìš”ì²­: ${maxResults})`);
    
    // ë™ì˜ìƒ ê¸¸ì´ íŒŒë¼ë¯¸í„° íŒŒì‹±
    const selectedVideoLengths = videoLength && videoLength.trim() ? videoLength.split(',').filter(v => v.trim()) : [];
    console.log('ì„ íƒëœ ë™ì˜ìƒ ê¸¸ì´:', selectedVideoLengths.length > 0 ? selectedVideoLengths : 'ëª¨ë“  ê¸¸ì´ í—ˆìš© (í•„í„° ì—†ìŒ)');
    
    // ë‹¤ì¤‘ êµ­ê°€ ì²˜ë¦¬: ì²« ë²ˆì§¸ êµ­ê°€ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì„¤ì • (í–¥í›„ í™•ì¥ ê°€ëŠ¥)
    const primaryCountry = selectedCountries[0];
    console.log(`ğŸ¯ ì£¼ ê²€ìƒ‰ êµ­ê°€: ${primaryCountry} (ì´ ${selectedCountries.length}ê°œêµ­ ì„ íƒë¨)`);
    
    // ========== Elasticsearch ìºì‹œ ìš°ì„  ë¡œì§ ì‹œì‘ ==========
    const searchParameters = {
      country: primaryCountry,        // ì£¼ ê²€ìƒ‰ êµ­ê°€
      countries: selectedCountries.join(','), // ì„ íƒëœ ëª¨ë“  êµ­ê°€ ëª©ë¡
      keyword,
      searchScope,
      categories,
      minViews,
      maxViews,
      uploadPeriod,
      startDate,
      endDate,
      videoLength,
      maxResults: finalMaxResults,
      // ë‚ ì§œ ë²”ìœ„ ì •ë³´ ì¶”ê°€
      publishedAfter: null,
      publishedBefore: null
    };
    
    // ë‚ ì§œ ë²”ìœ„ ì •ë³´ ì¶”ê°€ (Elasticsearch ìºì‹œ ë¹„êµìš©)
    if (uploadPeriod) {
      const dateRange = getDateRange(uploadPeriod);
      searchParameters.publishedAfter = dateRange.publishedAfter;
      searchParameters.publishedBefore = dateRange.publishedBefore;
    } else if (startDate || endDate) {
      if (startDate) {
        try {
          const startDateTime = new Date(startDate + 'T00:00:00.000Z');
          searchParameters.publishedAfter = startDateTime.toISOString();
        } catch (e) {
          console.warn('ì‹œì‘ì¼ íŒŒì‹± ì˜¤ë¥˜:', e.message);
        }
      }
      if (endDate) {
        try {
          const endDateTime = new Date(endDate + 'T23:59:59.999Z');
          searchParameters.publishedBefore = endDateTime.toISOString();
        } catch (e) {
          console.warn('ì¢…ë£Œì¼ íŒŒì‹± ì˜¤ë¥˜:', e.message);
        }
      }
    }
    
    // 1ë‹¨ê³„: ìºì‹œ íˆíŠ¸ í™•ì¸
    console.log('ğŸ” Elasticsearch ìºì‹œ í™•ì¸ ì¤‘...');
    const cacheResult = await esHelper.checkCacheHit(searchParameters);
    console.log('ğŸ“Š ìºì‹œ í™•ì¸ ê²°ê³¼:', cacheResult);
    
    if (cacheResult.hit) {
      // ìºì‹œ íˆíŠ¸: ESì—ì„œ ê²°ê³¼ ì¡°íšŒ
      console.log('âœ… ìºì‹œ íˆíŠ¸! Elasticsearchì—ì„œ ê²°ê³¼ ì¡°íšŒ');
      const cachedResults = await esHelper.searchVideos(searchParameters);
    
      if (cachedResults && cachedResults.length > 0) {
        console.log(`ğŸ“¦ ìºì‹œì—ì„œ ${cachedResults.length}ê°œ ê²°ê³¼ ë°˜í™˜`);
    
        // ìºì‹œ ê²€ìƒ‰ ì†Œìš”ì‹œê°„ ê³„ì‚°
        const cacheEndTime = Date.now();
        const cacheDuration = cacheEndTime - searchStartTime;
        const cacheDurationSeconds = (cacheDuration / 1000).toFixed(2);
    
        console.log(`\nâ±ï¸ ìºì‹œ ê²€ìƒ‰ ì™„ë£Œ: ì´ ì†Œìš”ì‹œê°„ ${cacheDurationSeconds}ì´ˆ (${cachedResults.length}ê°œ ê²°ê³¼)`);
        console.log(`ğŸ” ê²€ìƒ‰ ì¡°ê±´: ${country}/${keyword || 'í‚¤ì›Œë“œ ì—†ìŒ'}/${finalMaxResults}ê±´`);
        console.log('âš¡ ìºì‹œ íˆíŠ¸ë¡œ ì´ˆê³ ì† ê²€ìƒ‰!');
        console.log('='.repeat(52));
    
        return res.json({
          success: true,
          data: cachedResults,
          total: cachedResults.length,
          source: 'elasticsearch_cache',
          searchDuration: `${cacheDurationSeconds}ì´ˆ`
        });
      } else {
        console.log('âš ï¸ ìºì‹œ íˆíŠ¸ì˜€ì§€ë§Œ ê²°ê³¼ê°€ ì—†ìŒ, YouTube APIë¡œ fallback');
      }
    } else {
      console.log('âŒ ìºì‹œ ë¯¸ìŠ¤:', cacheResult.reason);
      console.log('ğŸ”„ YouTube API í˜¸ì¶œë¡œ ì§„í–‰');
    }
    // ========== Elasticsearch ìºì‹œ ìš°ì„  ë¡œì§ ë ==========
    
    let searchResults = [];
    let nextPageToken = '';
    const resultsPerPage = Math.min(finalMaxResults, 50); // ì„ íƒí•œ ê²°ê³¼ ìˆ˜ì— ë”°ë¼ í˜ì´ì§€ë‹¹ ìš”ì²­ëŸ‰ ì¡°ì •
    
    // YouTube API ê²€ìƒ‰ íŒŒë¼ë¯¸í„° ì„¤ì •
    let searchParams = {
      part: 'snippet',
      type: 'video',
      maxResults: resultsPerPage,
      order: 'viewCount'
    };
    
    // primaryCountryëŠ” ì´ë¯¸ ìœ„ì—ì„œ ì„ ì–¸ë˜ì—ˆìœ¼ë¯€ë¡œ ì‚¬ìš©ë§Œ í•˜ê¸°
    
    // êµ­ê°€ë³„ ì§€ì—­ ì½”ë“œ ì„¤ì • (ì „ì„¸ê³„ê°€ ì•„ë‹Œ ê²½ìš°ì—ë§Œ)
    if (primaryCountry !== 'worldwide') {
      const regionCode = getCountryCode(primaryCountry);
      if (regionCode) {
        searchParams.regionCode = regionCode;
        console.log(`âœ… ì§€ì—­ ì½”ë“œ ì„¤ì •: ${primaryCountry} â†’ ${regionCode}`);
      } else {
        console.log(`âš ï¸ ê²½ê³ : '${primaryCountry}' êµ­ê°€ì˜ regionCodeë¥¼ ì°¾ì„ ìˆ˜ ì—†ì–´ ì „ì„¸ê³„ ê²€ìƒ‰ìœ¼ë¡œ ì§„í–‰í•©ë‹ˆë‹¤.`);
      }
    } else {
      console.log('ğŸŒ ì „ì„¸ê³„ ê²€ìƒ‰: regionCode ì—†ì´ ì§„í–‰');
    }
    
    // ì–¸ì–´ ì„¤ì • (ì£¼ ê²€ìƒ‰ êµ­ê°€ì˜ ê¸°ë³¸ ì–¸ì–´)
    const languageCode = getLanguageCode(primaryCountry);
    if (languageCode) {
      searchParams.relevanceLanguage = languageCode;
      console.log(`ğŸŒ ì–¸ì–´ ì„¤ì •: ${primaryCountry} â†’ ${languageCode}`);
    }
    
    // í‚¤ì›Œë“œ ì„¤ì •
    const isEmptyKeyword = !keyword || !keyword.trim();
    
    if (!isEmptyKeyword) {
      // ê²€ìƒ‰ ë²”ìœ„ ì²˜ë¦¬
      let searchQuery = keyword.trim();
    
      // searchScopeê°€ ë¬¸ìì—´ë¡œ ë“¤ì–´ì˜¤ëŠ” ê²½ìš° ë°°ì—´ë¡œ ë³€í™˜
      let searchScopes = [];
      if (typeof searchScope === 'string') {
        searchScopes = searchScope.includes(',') ? searchScope.split(',').map(s => s.trim()) : [searchScope];
      } else if (Array.isArray(searchScope)) {
        searchScopes = searchScope;
      } else {
        searchScopes = ['title']; // ê¸°ë³¸ê°’
      }
    
      // íƒœê·¸ ê²€ìƒ‰ì¸ ê²½ìš° ë³„ë„ ì²˜ë¦¬
      if (searchScopes.includes('tags')) {
        // íƒœê·¸ ê²€ìƒ‰: YouTubeì—ì„œëŠ” íƒœê·¸ê°€ ê³µê°œë˜ì§€ ì•Šìœ¼ë¯€ë¡œ ì¼ë°˜ ê²€ìƒ‰ìœ¼ë¡œ ì²˜ë¦¬
        searchQuery = keyword.trim();
        console.log(`íƒœê·¸ ê²€ìƒ‰ (ì¼ë°˜ ê²€ìƒ‰ìœ¼ë¡œ ì²˜ë¦¬): "${searchQuery}"`);
      } else if (searchScopes.includes('channel')) {
        // ì±„ë„ëª… ê²€ìƒ‰
        searchQuery = keyword.trim();
        console.log(`ì±„ë„ëª… í¬í•¨ ê²€ìƒ‰: "${searchQuery}"`);
      } else {
        // ê¸°ë³¸ ì œëª© ê²€ìƒ‰
        searchQuery = keyword.trim();
        console.log(`ì œëª© ê²€ìƒ‰: "${searchQuery}"`);
      }
    
      searchParams.q = searchQuery;
    } else {
      // í‚¤ì›Œë“œê°€ ì—†ì„ ë•ŒëŠ” êµ­ê°€ë³„ ì¸ê¸° ë™ì˜ìƒ ê²€ìƒ‰
      console.log('í‚¤ì›Œë“œ ì—†ìŒ: êµ­ê°€ë³„ ì¸ê¸° ë™ì˜ìƒ ê²€ìƒ‰');
    
      if (country !== 'worldwide') {
        // íŠ¹ì • êµ­ê°€ ì„ íƒ ì‹œ: í•´ë‹¹ êµ­ê°€ì˜ ì¸ê¸° ì½˜í…ì¸  ê²€ìƒ‰
        console.log(`ğŸ³ï¸ ${country} êµ­ê°€ì˜ ì¸ê¸° ë™ì˜ìƒ ê²€ìƒ‰`);
    
        // êµ­ê°€ë³„ ì¸ê¸° ê²€ìƒ‰ì–´ ì‚¬ìš© (ë” ì •í™•í•œ ì§€ì—­ë³„ ê²°ê³¼)
        const countrySpecificTerms = {
          'korea': ['í•œêµ­', 'korean', 'korea', 'í•œêµ­ì–´'],
          'usa': ['america', 'usa', 'american', 'english'],
          'japan': ['japan', 'japanese', 'ì¼ë³¸', 'ì¼ë³¸ì–´'],
          'uk': ['britain', 'uk', 'british', 'english'],
          'germany': ['germany', 'german', 'deutsch', 'ë…ì¼'],
          'france': ['france', 'french', 'franÃ§ais', 'í”„ë‘ìŠ¤'],
          'canada': ['canada', 'canadian', 'english', 'french'],
          'australia': ['australia', 'australian', 'english'],
          'india': ['india', 'indian', 'hindi', 'english'],
          'brazil': ['brazil', 'brazilian', 'portuguese', 'portuguÃªs'],
          'mexico': ['mexico', 'mexican', 'spanish', 'espaÃ±ol'],
          'italy': ['italy', 'italian', 'italiano', 'ì´íƒˆë¦¬ì•„'],
          'spain': ['spain', 'spanish', 'espaÃ±ol', 'ìŠ¤í˜ì¸']
        };
    
        const terms = countrySpecificTerms[country] || ['video', 'popular'];
        const randomTerm = terms[Math.floor(Math.random() * terms.length)];
        searchParams.q = randomTerm;
    
        // êµ­ê°€ë³„ ê²€ìƒ‰ì„ ìœ„í•´ orderë¥¼ relevanceë¡œ ì„¤ì • (regionCodeì™€ relevanceLanguageê°€ ìš°ì„  ì ìš©ë¨)
        searchParams.order = 'relevance';
    
        console.log(`ğŸŒ ${country} êµ­ê°€ë³„ ì¸ê¸° ê²€ìƒ‰ì–´: "${randomTerm}"`);
        console.log('ì„¤ì •: ê´€ë ¨ì„± ìˆœì„œë¡œ ì •ë ¬ (êµ­ê°€ë³„ ìš°ì„ )');
      } else {
        // ì „ì„¸ê³„ ì„ íƒ ì‹œ: ì¼ë°˜ì ì¸ ì¸ê¸° ë™ì˜ìƒ ê²€ìƒ‰
        console.log('ğŸŒ ì „ì„¸ê³„ ì¸ê¸° ë™ì˜ìƒ ê²€ìƒ‰');
    
        const broadSearchTerms = ['a', 'the', 'and', 'or', 'video', 'youtube'];
        const randomTerm = broadSearchTerms[Math.floor(Math.random() * broadSearchTerms.length)];
        searchParams.q = randomTerm;
    
        // ì „ì„¸ê³„ ê²€ìƒ‰ ì‹œì—ë§Œ ì¡°íšŒìˆ˜ ìˆœ ì •ë ¬
        searchParams.order = 'viewCount';
    
        console.log(`ì „ì„¸ê³„ ì¸ê¸° ë™ì˜ìƒ ê²€ìƒ‰ì–´: "${randomTerm}"`);
        console.log('ì„¤ì •: ì¡°íšŒìˆ˜ ë†’ì€ ìˆœì„œë¡œ ì •ë ¬');
      }
    }
    
    // ë””ë²„ê·¸ ë¡œê·¸ ì¶œë ¥ (í‚¤ì›Œë“œ ì„¤ì • í›„)
    console.log('=== êµ­ê°€ë³„ ê²€ìƒ‰ ë””ë²„ê·¸ ì •ë³´ ===');
    console.log('1. í´ë¼ì´ì–¸íŠ¸ ìš”ì²­ country:', country);
    console.log('2. getCountryCode ê²°ê³¼:', getCountryCode(country));
    console.log('3. getLanguageCode ê²°ê³¼:', getLanguageCode(country));
    console.log('4. í‚¤ì›Œë“œ ìƒíƒœ:', keyword ? `"${keyword}"` : 'ì—†ìŒ (êµ­ê°€ë³„ ì¸ê¸° ê²€ìƒ‰)');
    console.log('5. ê²€ìƒ‰ ì „ëµ:', keyword ? 'í‚¤ì›Œë“œ ê¸°ë°˜ ê²€ìƒ‰' : (country === 'worldwide' ? 'ì „ì„¸ê³„ ì¸ê¸° ê²€ìƒ‰' : `${country} êµ­ê°€ë³„ ì¸ê¸° ê²€ìƒ‰`));
    console.log('6. ìµœì¢… YouTube API ê²€ìƒ‰ íŒŒë¼ë¯¸í„°:', {
      regionCode: searchParams.regionCode || 'ì—†ìŒ (ì „ì„¸ê³„ ê²€ìƒ‰)',
      relevanceLanguage: searchParams.relevanceLanguage,
      country: country,
      keyword: searchParams.q || 'í‚¤ì›Œë“œ ì—†ìŒ',
      order: searchParams.order,
      type: searchParams.type,
      isWorldwide: country === 'worldwide'
    });
    console.log('7. ê²€ìƒ‰ íƒ€ì…:', country === 'worldwide' ? 'ğŸŒ ì „ì„¸ê³„ ê²€ìƒ‰' : `ğŸ³ï¸ ${country} êµ­ê°€ë³„ ê²€ìƒ‰`);
    console.log('========================================');
    
    // ì—…ë¡œë“œ ê¸°ê°„ ì„¤ì • (ê¸°ì¡´ ë“œë¡­ë‹¤ìš´ ë°©ì‹)
    if (uploadPeriod) {
      const { publishedAfter, publishedBefore } = getDateRange(uploadPeriod);
      if (publishedAfter) searchParams.publishedAfter = publishedAfter;
      if (publishedBefore) searchParams.publishedBefore = publishedBefore;
    }
    
    // ì»¤ìŠ¤í…€ ë‚ ì§œ ë²”ìœ„ ì„¤ì • (startDate, endDateê°€ ìˆìœ¼ë©´ uploadPeriodë³´ë‹¤ ìš°ì„ )
    if (startDate || endDate) {
      if (startDate) {
        try {
          const startDateTime = new Date(startDate + 'T00:00:00.000Z'); // UTC ê¸°ì¤€ìœ¼ë¡œ ëª…ì‹œì  ì²˜ë¦¬
          if (isNaN(startDateTime.getTime())) {
            throw new Error('Invalid start date');
          }
          searchParams.publishedAfter = startDateTime.toISOString();
          console.log('âœ… ì‹œì‘ì¼ ì„¤ì • ì„±ê³µ (UTC):', startDateTime.toISOString());
        } catch (error) {
          console.error('âŒ ì‹œì‘ì¼ ì²˜ë¦¬ ì˜¤ë¥˜:', error.message, 'ì…ë ¥ê°’:', startDate);
          // ì˜¤ë¥˜ ì‹œ ì‹œì‘ì¼ ë¬´ì‹œí•˜ê³  ê³„ì† ì§„í–‰
        }
      }
      if (endDate) {
        try {
          const endDateTime = new Date(endDate + 'T23:59:59.999Z'); // UTC ê¸°ì¤€ìœ¼ë¡œ ëª…ì‹œì  ì²˜ë¦¬
          if (isNaN(endDateTime.getTime())) {
            throw new Error('Invalid end date');
          }
          searchParams.publishedBefore = endDateTime.toISOString();
          console.log('âœ… ì¢…ë£Œì¼ ì„¤ì • ì„±ê³µ (UTC):', endDateTime.toISOString());
        } catch (error) {
          console.error('âŒ ì¢…ë£Œì¼ ì²˜ë¦¬ ì˜¤ë¥˜:', error.message, 'ì…ë ¥ê°’:', endDate);
          // ì˜¤ë¥˜ ì‹œ ì¢…ë£Œì¼ ë¬´ì‹œí•˜ê³  ê³„ì† ì§„í–‰
        }
      }
      console.log('ğŸ“… ì»¤ìŠ¤í…€ ë‚ ì§œ ë²”ìœ„ ì ìš©:', {
        startDate: startDate || 'ì—†ìŒ',
        endDate: endDate || 'ì—†ìŒ',
        publishedAfter: searchParams.publishedAfter || 'ì—†ìŒ',
        publishedBefore: searchParams.publishedBefore || 'ì—†ìŒ'
      });
    }
    
    // ë™ì˜ìƒ ê¸¸ì´ ì„¤ì • (YouTube APIëŠ” 'short', 'medium', 'long'ë§Œ ì§€ì›í•˜ë¯€ë¡œ í›„ì²˜ë¦¬ì—ì„œ í•„í„°ë§)
    // videoLength íŒŒë¼ë¯¸í„°ëŠ” í´ë¼ì´ì–¸íŠ¸ì—ì„œ ë°›ì•„ì„œ ê²°ê³¼ í•„í„°ë§ì— ì‚¬ìš©
    
         // ì„ íƒí•œ ìˆ˜ë§Œí¼ ê²°ê³¼ ìˆ˜ì§‘ (ì¤‘ë³µ ì œê±°)
     const processedVideoIds = new Set(); // ì´ë¯¸ ì²˜ë¦¬ëœ ë¹„ë””ì˜¤ ID ì¶”ì 
     const processedChannelTitles = new Set(); // ì´ë¯¸ ì²˜ë¦¬ëœ ì±„ë„ëª… ì¶”ì  (ì„ íƒì )
    
     while (searchResults.length < finalMaxResults) {
       if (nextPageToken) {
         searchParams.pageToken = nextPageToken;
       }
    
       let response;
       let currentApiKey = apiKeyManager.getCurrentKey();
    
       // ê²¬ê³ í•œ API í‚¤ ì „í™˜ ë¡œì§ìœ¼ë¡œ ì¬ì‘ì„±
       let retryCount = 0;
       const maxRetries = apiKeyManager.apiKeys.length;
    
       while (retryCount < maxRetries) {
                 try {
          const youtubeInstance = apiKeyManager.getYouTubeInstance();
          currentApiKey = youtubeInstance.currentKey;
          response = await youtubeInstance.youtube.search.list(searchParams);
          break; // ì„±ê³µí•˜ë©´ ë£¨í”„ ì¢…ë£Œ
        } catch (apiError) {
          console.error(`YouTube API ì˜¤ë¥˜ (${currentApiKey.name}):`, apiError.message);
    
           // API í‚¤ ì¼ì‹œì •ì§€(suspended) ì˜¤ë¥˜ì¸ ê²½ìš° ì¦‰ì‹œ ë‹¤ë¥¸ í‚¤ë¡œ ìš°íšŒ
           if (apiError.message.includes('suspended') || apiError.message.includes('has been suspended')) {
             console.log(`ğŸš¨ ${currentApiKey.name} ì¼ì‹œì •ì§€ ê°ì§€ - ë‹¤ë¥¸ í‚¤ë¡œ ì¦‰ì‹œ ìš°íšŒ`);
             retryCount++;
             continue; // ì¦‰ì‹œ ë‹¤ìŒ í‚¤ë¡œ ì¬ì‹œë„
           }
           // Permission Deny ì˜¤ë¥˜ì¸ ê²½ìš° ê°ì§€ ë° ìš°íšŒ
           else if (apiError.message.includes('permission') || apiError.message.includes('denied') || 
                    apiError.message.includes('forbidden') || apiError.code === 403) {
             console.log(`ğŸš« ${currentApiKey.name} PERMISSION DENY ê°ì§€ - API í‚¤ ê¶Œí•œ ë¬¸ì œ`);
             console.log(`ğŸ“ ì˜¤ë¥˜ ìƒì„¸: ${apiError.message}`);
             retryCount++;
             continue; // ì¦‰ì‹œ ë‹¤ìŒ í‚¤ë¡œ ì¬ì‹œë„
           }
           // í• ë‹¹ëŸ‰ ì´ˆê³¼ ì˜¤ë¥˜ì¸ ê²½ìš° ë‹¤ìŒ í‚¤ë¡œ ì „í™˜
           else if (apiError.message.includes('quota') || apiError.message.includes('quotaExceeded')) {
             console.log(`ğŸš« ${currentApiKey.name} í• ë‹¹ëŸ‰ ì´ˆê³¼ ê°ì§€`);
    
             const newApiKey = apiKeyManager.markKeyAsQuotaExceeded(currentApiKey, apiError.message);
             if (newApiKey) {
               console.log(`ğŸ”„ ${newApiKey.name}ë¡œ ì¬ì‹œë„í•©ë‹ˆë‹¤... (ì¬ì‹œë„ ${retryCount + 1}/${maxRetries})`);
               retryCount++;
               continue; // ë‹¤ìŒ ë°˜ë³µìœ¼ë¡œ ê³„ì†
             } else {
               console.log('âŒ ëª¨ë“  API í‚¤ì˜ í• ë‹¹ëŸ‰ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤.');
               throw new Error('ALL_QUOTA_EXCEEDED: ëª¨ë“  API í‚¤ì˜ í• ë‹¹ëŸ‰ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤.');
             }
           }
           // regionCode ê´€ë ¨ ì˜¤ë¥˜ì¸ ê²½ìš° ì²˜ë¦¬
           else if ((apiError.message.includes('regionCode') || apiError.message.includes('invalid region')) && searchParams.regionCode) {
          console.log('ğŸš¨ regionCode ì˜¤ë¥˜ ë°œìƒ!');
          console.log(`  - ìš”ì²­í•œ êµ­ê°€: ${country}`);
          console.log(`  - ì‚¬ìš©í•œ regionCode: ${searchParams.regionCode}`);
          console.log(`  - ì˜¤ë¥˜ ë©”ì‹œì§€: ${apiError.message}`);
    
          // regionCodeê°€ ìœ íš¨í•œì§€ ë‹¤ì‹œ í™•ì¸
          const validRegionCodes = [
            'AD', 'AE', 'AF', 'AG', 'AI', 'AL', 'AM', 'AO', 'AQ', 'AR', 'AS', 'AT',
            'AU', 'AW', 'AX', 'AZ', 'BA', 'BB', 'BD', 'BE', 'BF', 'BG', 'BH', 'BI',
            'BJ', 'BL', 'BM', 'BN', 'BO', 'BQ', 'BR', 'BS', 'BT', 'BV', 'BW', 'BY',
            'BZ', 'CA', 'CC', 'CD', 'CF', 'CG', 'CH', 'CI', 'CK', 'CL', 'CM', 'CN',
            'CO', 'CR', 'CU', 'CV', 'CW', 'CX', 'CY', 'CZ', 'DE', 'DJ', 'DK', 'DM',
            'DO', 'DZ', 'EC', 'EE', 'EG', 'EH', 'ER', 'ES', 'ET', 'FI', 'FJ', 'FK',
            'FM', 'FO', 'FR', 'GA', 'GB', 'GD', 'GE', 'GF', 'GG', 'GH', 'GI', 'GL',
            'GM', 'GN', 'GP', 'GQ', 'GR', 'GS', 'GT', 'GU', 'GW', 'GY', 'HK', 'HM',
            'HN', 'HR', 'HT', 'HU', 'ID', 'IE', 'IL', 'IM', 'IN', 'IO', 'IQ', 'IR',
            'IS', 'IT', 'JE', 'JM', 'JO', 'JP', 'KE', 'KG', 'KH', 'KI', 'KM', 'KN',
            'KP', 'KR', 'KW', 'KY', 'KZ', 'LA', 'LB', 'LC', 'LI', 'LK', 'LR', 'LS',
            'LT', 'LU', 'LV', 'LY', 'MA', 'MC', 'MD', 'ME', 'MF', 'MG', 'MH', 'MK',
            'ML', 'MM', 'MN', 'MO', 'MP', 'MQ', 'MR', 'MS', 'MT', 'MU', 'MV', 'MW',
            'MX', 'MY', 'MZ', 'NA', 'NC', 'NE', 'NF', 'NG', 'NI', 'NL', 'NO', 'NP',
            'NR', 'NU', 'NZ', 'OM', 'PA', 'PE', 'PF', 'PG', 'PH', 'PK', 'PL', 'PM',
            'PN', 'PR', 'PS', 'PT', 'PW', 'PY', 'QA', 'RE', 'RO', 'RS', 'RU', 'RW',
            'SA', 'SB', 'SC', 'SD', 'SE', 'SG', 'SH', 'SI', 'SJ', 'SK', 'SL', 'SM',
            'SN', 'SO', 'SR', 'SS', 'ST', 'SV', 'SX', 'SY', 'SZ', 'TC', 'TD', 'TF',
            'TG', 'TH', 'TJ', 'TK', 'TL', 'TM', 'TN', 'TO', 'TR', 'TT', 'TV', 'TW',
            'TZ', 'UA', 'UG', 'UM', 'US', 'UY', 'UZ', 'VA', 'VC', 'VE', 'VG', 'VI',
            'VN', 'VU', 'WF', 'WS', 'YE', 'YT', 'ZA', 'ZM', 'ZW'
          ];
    
          if (validRegionCodes.includes(searchParams.regionCode)) {
            console.log('  âŒ regionCodeëŠ” ìœ íš¨í•˜ì§€ë§Œ YouTubeì—ì„œ ê±°ë¶€ë¨');
            console.log('  ğŸ’¡ ì´ êµ­ê°€ëŠ” YouTube ì„œë¹„ìŠ¤ ì œí•œì´ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
          } else {
            console.log('  âŒ regionCodeê°€ ìœ íš¨í•˜ì§€ ì•ŠìŒ');
          }
    
          console.log('  ğŸ”„ ì „ì„¸ê³„ ê²€ìƒ‰ìœ¼ë¡œ ì¬ì‹œë„í•©ë‹ˆë‹¤...');
          const originalRegionCode = searchParams.regionCode;
          delete searchParams.regionCode;
    
          console.log('  ì¬ì‹œë„ íŒŒë¼ë¯¸í„°:', {
            regionCode: 'ì œê±°ë¨',
            relevanceLanguage: searchParams.relevanceLanguage,
            country: country,
            originalRegionCode: originalRegionCode
          });
    
             const youtube = google.youtube({ 
               version: 'v3', 
               auth: currentApiKey.key,
               timeout: 30000 // 30ì´ˆ íƒ€ì„ì•„ì›ƒ
             });
             response = await youtube.search.list(searchParams);
             console.log('  âœ… ì „ì„¸ê³„ ê²€ìƒ‰ìœ¼ë¡œ ì„±ê³µ');
             console.log(`  âš ï¸  ì£¼ì˜: "${country}" ê²€ìƒ‰ì´ ì „ì„¸ê³„ ê²€ìƒ‰ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.`);
             break; // ì„±ê³µí•˜ë©´ ë£¨í”„ ì¢…ë£Œ
           } else {
             console.log('ë³µêµ¬í•  ìˆ˜ ì—†ëŠ” API ì˜¤ë¥˜:', apiError.message);
             throw apiError; // ë‹¤ë¥¸ ì˜¤ë¥˜ëŠ” ê·¸ëŒ€ë¡œ ì „íŒŒ
           }
         }
       }
    
       // ìµœëŒ€ ì¬ì‹œë„ íšŸìˆ˜ ì´ˆê³¼ ì‹œ
       if (retryCount >= maxRetries && !response) {
         throw new Error('MAX_RETRIES_EXCEEDED: ëª¨ë“  API í‚¤ ì¬ì‹œë„ ì‹¤íŒ¨');
       }
    
      if (!response.data.items || response.data.items.length === 0) {
        break;
      }
    
      console.log(`API ì‘ë‹µ: ${response.data.items.length}ê°œ ë™ì˜ìƒ ë°œê²¬`);
    
      // ë¹„ë””ì˜¤ ID ìˆ˜ì§‘
      const videoIds = response.data.items.map(item => item.id.videoId);
    
      // ë¹„ë””ì˜¤ ìƒì„¸ ì •ë³´ ê°€ì ¸ì˜¤ê¸° (ì¡°íšŒìˆ˜, í†µê³„ í¬í•¨) - ê²¬ê³ í•œ API í‚¤ ì „í™˜ ë¡œì§
      let videoDetails;
      let detailRetryCount = 0;
      const detailMaxRetries = apiKeyManager.apiKeys.length;
    
      while (detailRetryCount < detailMaxRetries) {
        try {
          const youtubeInstance = apiKeyManager.getYouTubeInstance();
          const currentDetailKey = youtubeInstance.currentKey;
          videoDetails = await youtubeInstance.youtube.videos.list({
            part: 'snippet,statistics,contentDetails',
            id: videoIds.join(',')
          });
          break; // ì„±ê³µí•˜ë©´ ë£¨í”„ ì¢…ë£Œ
        } catch (detailError) {
          console.error(`ë¹„ë””ì˜¤ ìƒì„¸ì •ë³´ ì¡°íšŒ ì˜¤ë¥˜:`, detailError.message);
    
          if (detailError.message.includes('quota') || detailError.message.includes('quotaExceeded')) {
            console.log('ğŸš« ë¹„ë””ì˜¤ ìƒì„¸ì •ë³´ ì¡°íšŒ ì¤‘ í• ë‹¹ëŸ‰ ì´ˆê³¼ ê°ì§€');
    
            const currentDetailKey = apiKeyManager.getCurrentKey();
            const newDetailKey = apiKeyManager.markKeyAsQuotaExceeded(currentDetailKey);
            if (newDetailKey) {
              console.log(`ğŸ”„ ${newDetailKey.name}ë¡œ ë¹„ë””ì˜¤ ìƒì„¸ì •ë³´ ì¬ì‹œë„... (ì¬ì‹œë„ ${detailRetryCount + 1}/${detailMaxRetries})`);
              detailRetryCount++;
              continue; // ë‹¤ìŒ ë°˜ë³µìœ¼ë¡œ ê³„ì†
            } else {
              console.log('âŒ ëª¨ë“  API í‚¤ì˜ í• ë‹¹ëŸ‰ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤.');
              throw new Error('ALL_QUOTA_EXCEEDED: ëª¨ë“  API í‚¤ì˜ í• ë‹¹ëŸ‰ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤.');
            }
          } else {
            throw detailError;
          }
        }
      }
    
      // ìµœëŒ€ ì¬ì‹œë„ íšŸìˆ˜ ì´ˆê³¼ ì‹œ
      if (detailRetryCount >= detailMaxRetries && !videoDetails) {
        throw new Error('MAX_RETRIES_EXCEEDED: ë¹„ë””ì˜¤ ìƒì„¸ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨');
      }
    
                         // ê²€ìƒ‰ ê²°ê³¼ ì²˜ë¦¬ (ì¤‘ë³µ ì œê±°) - ë””ë²„ê¹… ë¡œê·¸ ì¶”ê°€
            console.log(`ğŸ“‹ ë¹„ë””ì˜¤ ìƒì„¸ì •ë³´ ì²˜ë¦¬ ì‹œì‘: ${videoDetails.data.items.length}ê°œ ë™ì˜ìƒ`);
    
       for (const video of videoDetails.data.items) {
         filterStats.totalProcessed++;
         console.log(`\nğŸ¬ ì²˜ë¦¬ ì¤‘ (${filterStats.totalProcessed}/${videoDetails.data.items.length}): ${video.snippet.title.substring(0, 50)}...`);
    
         // ì¤‘ë³µ ë¹„ë””ì˜¤ ID ì²´í¬
         if (processedVideoIds.has(video.id)) {
           filterStats.duplicateSkipped++;
           console.log(`  âŒ ì¤‘ë³µ ë™ì˜ìƒ ê±´ë„ˆë›°ê¸°: ${video.id}`);
           continue;
         }
    
         const viewCount = parseInt(video.statistics.viewCount || 0);
         console.log(`  ğŸ“Š ì¡°íšŒìˆ˜: ${viewCount.toLocaleString()}`);
    
         // ì¹´í…Œê³ ë¦¬ í•„í„°ë§ (ì•ˆì „í•œ ì²˜ë¦¬)
         let selectedCategories = [];
         if (categories) {
           if (typeof categories === 'string') {
             selectedCategories = categories.split(',').filter(c => c.trim());
           } else if (Array.isArray(categories)) {
             selectedCategories = categories.filter(c => c && typeof c === 'string' && c.trim());
           }
         }
    
         if (selectedCategories.length > 0 && !selectedCategories.includes(video.snippet.categoryId)) {
           filterStats.categoryFiltered++;
           console.log(`  âŒ ì¹´í…Œê³ ë¦¬ í•„í„°ë§: ${video.snippet.categoryId} ì œì™¸ (ì„ íƒ: ${selectedCategories.join(',')})`);
           continue;
         }
    
         // ì¡°íšŒìˆ˜ í•„í„°ë§
         if (minViews && viewCount < parseInt(minViews)) {
           filterStats.minViewsFiltered++;
           console.log(`  âŒ ìµœì†Œ ì¡°íšŒìˆ˜ ë¯¸ë‹¬: ${viewCount.toLocaleString()} < ${parseInt(minViews).toLocaleString()}`);
           continue;
         }
         if (maxViews && viewCount > parseInt(maxViews)) {
           filterStats.maxViewsFiltered++;
           console.log(`  âŒ ìµœëŒ€ ì¡°íšŒìˆ˜ ì´ˆê³¼: ${viewCount.toLocaleString()} > ${parseInt(maxViews).toLocaleString()}`);
           continue;
         }
    
         // ë™ì˜ìƒ ê¸¸ì´ í•„í„°ë§
         const durationInSeconds = parseDuration(video.contentDetails.duration);
         const videoLengthCategory = getVideoLengthCategory(durationInSeconds);
         console.log(`  â±ï¸ ë™ì˜ìƒ ê¸¸ì´: ${durationInSeconds}ì´ˆ (${videoLengthCategory})`);
    
         if (!matchesVideoLength(videoLengthCategory, selectedVideoLengths)) {
           filterStats.videoLengthFiltered++;
           console.log(`  âŒ ë™ì˜ìƒ ê¸¸ì´ í•„í„°ë§: ${videoLengthCategory} ì œì™¸ (ì„ íƒ: ${selectedVideoLengths.join(',') || 'ëª¨ë“  ê¸¸ì´'})`);
           continue;
         }
    
        // ìµœì†Œí‰ê· ì‹œì²­ë¥  í•„í„°ë§ ì¶”ê°€ (ê°œì„ ëœ ë¡œì§)
        let shouldSkipVideo = false; // í•„í„°ë§ í”Œë˜ê·¸ ì¶”ê°€
    
        if (minAvgWatchRate && parseFloat(minAvgWatchRate) > 0) {
          // ì¹´í…Œê³ ë¦¬ë³„ ì •êµí•œ ê³„ì‚° ë°©ì‹ ì‚¬ìš©
          const categoryName = await getCategoryName(video.snippet.categoryId);
          const avgWatchTime = calculateAverageViewDuration(durationInSeconds, { primary_category: categoryName });
          const avgWatchRatePercentage = durationInSeconds > 0 ? (avgWatchTime / durationInSeconds) * 100 : 0;
    
          console.log(`  ğŸ“Š í‰ê· ì‹œì²­ë¥  ê³„ì‚° (ì¹´í…Œê³ ë¦¬: ${categoryName}): ${avgWatchTime}ì´ˆ / ${durationInSeconds}ì´ˆ = ${avgWatchRatePercentage.toFixed(2)}%`);
          console.log(`  ğŸ¯ í•„í„° ê¸°ì¤€: ${minAvgWatchRate}% ì´ìƒ`);
    
          // í•„í„° ì¡°ê±´: ê³„ì‚°ëœ í‰ê· ì‹œì²­ë¥ ì´ ì…ë ¥ê°’ë³´ë‹¤ ë‚®ìœ¼ë©´ ì œì™¸
          if (avgWatchRatePercentage < parseFloat(minAvgWatchRate)) {
            filterStats.minAvgWatchRateFiltered++;
            console.log(`  âŒ ìµœì†Œí‰ê· ì‹œì²­ë¥  ë¯¸ë‹¬ë¡œ ì œì™¸: ${avgWatchRatePercentage.toFixed(2)}% < ${minAvgWatchRate}%`);
            shouldSkipVideo = true; // í”Œë˜ê·¸ ì„¤ì •
          } else {
            console.log(`  âœ… ìµœì†Œí‰ê· ì‹œì²­ë¥  ì¡°ê±´ í†µê³¼: ${avgWatchRatePercentage.toFixed(2)}% >= ${minAvgWatchRate}%`);
          }
        }
    
        // í•„í„°ë§ëœ ë¹„ë””ì˜¤ëŠ” ê±´ë„ˆë›°ê¸°
        if (shouldSkipVideo) {
          console.log(`  ğŸš« í•„í„°ë§ìœ¼ë¡œ ì¸í•´ ë¹„ë””ì˜¤ ì œì™¸í•¨`);
          continue;
        }
    
        // ì±„ë„ êµ¬ë…ì ìˆ˜ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        console.log(`  ğŸ“¡ ì±„ë„ êµ¬ë…ì ìˆ˜ ì¡°íšŒ ì¤‘: ${video.snippet.channelId}`);
        const subscriberCount = await getChannelSubscriberCount(video.snippet.channelId);
        console.log(`  ğŸ‘¥ êµ¬ë…ì ìˆ˜: ${subscriberCount.toLocaleString()}`);
    
        // ì±„ë„ ê°œì„¤ì¼ ì •ë³´ ê°€ì ¸ì˜¤ê¸° (ìƒˆ ê¸°ëŠ¥)
        console.log(`  ğŸ“… ì±„ë„ ê°œì„¤ì¼ ì¡°íšŒ ì¤‘: ${video.snippet.channelId}`);
        const channelCreatedDate = await getChannelCreatedDate(video.snippet.channelId);
        console.log(`  ğŸ—“ï¸ ì±„ë„ ê°œì„¤ì¼: ${channelCreatedDate || 'ì¡°íšŒ ì•ˆë¨'}`);
    
        // ì±„ë„ ì„¤ëª… ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        console.log(`  ğŸ“ ì±„ë„ ì„¤ëª… ì¡°íšŒ ì¤‘: ${video.snippet.channelId}`);
        const channelDescription = await getChannelDescription(video.snippet.channelId);
        console.log(`  ğŸ“„ ì±„ë„ ì„¤ëª…: ${channelDescription ? 'ì¡°íšŒë¨' : 'ì¡°íšŒ ì•ˆë¨'}`);
    
        // ì±„ë„ êµ­ì  ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        console.log(`  ğŸŒ ì±„ë„ êµ­ì  ì¡°íšŒ ì¤‘: ${video.snippet.channelId}`);
        const channelCountry = await getChannelCountry(video.snippet.channelId);
        console.log(`  ğŸ³ï¸ ì±„ë„ êµ­ì : ${channelCountry}`);
    
        // ì‹¤ì œ ì¢‹ì•„ìš” ê°œìˆ˜ ê°€ì ¸ì˜¤ê¸° (ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ null)
        const actualLikeCount = video.statistics.likeCount ? parseInt(video.statistics.likeCount) : null;
    
        // í‰ê· ì‹œì²­ë¥  ê³„ì‚° (ì„œë²„ì—ì„œ UIë¡œ ì „ë‹¬í•  ê°’)
        const categoryName = await getCategoryName(video.snippet.categoryId);
        const avgWatchTime = calculateAverageViewDuration(durationInSeconds, { primary_category: categoryName });
        const avgWatchRatePercentage = durationInSeconds > 0 ? Math.round((avgWatchTime / durationInSeconds) * 100) : 0;
    
        // ì¶”ê°€ ê³„ì‚°ê°’ë“¤ (í´ë¼ì´ì–¸íŠ¸ ê³„ì‚°ì„ ì„œë²„ë¡œ ì´ë™)
        // 1. ìœ íš¨ì¡°íšŒìˆ˜ (êµ¬ë…ì ìˆ˜ ê¸°ë°˜)
        let validRate = 0.85; // ê¸°ë³¸ê°’
        if (subscriberCount > 1000000) validRate = 0.90;
        else if (subscriberCount > 100000) validRate = 0.88;
        else if (subscriberCount > 10000) validRate = 0.85;
        else if (subscriberCount > 1000) validRate = 0.82;
        else validRate = 0.80;
        const validViewCount = Math.round(viewCount * validRate);
    
        // 2. ìœ íš¨ì¡°íšŒìˆ˜ ë°±ë¶„ìœ¨ (ì†Œìˆ˜ì  ë‘˜ì§¸ìë¦¬ê¹Œì§€)
        const validViewPercentage = viewCount > 0 ? ((validViewCount / viewCount) * 100).toFixed(2) : "0.00";
    
        // 3. ì¢‹ì•„ìš” ê°œìˆ˜ ë° ë°±ë¶„ìœ¨ ê³„ì‚°
        const likeData = calculateLikeCount(video, viewCount, subscriberCount, actualLikeCount);
        const likeCount = likeData.count;
        const isLikeEstimated = likeData.isEstimated;
        const likePercentage = validViewCount > 0 ? Math.round((likeCount / validViewCount) * 100 * 100) / 100 : 0;
    
        const result = {
          youtube_channel_name: video.snippet.channelTitle,
          thumbnail_url: video.snippet.thumbnails.maxres?.url || 
                        video.snippet.thumbnails.standard?.url || 
                        video.snippet.thumbnails.high?.url || 
                        video.snippet.thumbnails.medium?.url || 
                        video.snippet.thumbnails.default?.url,
          status: 'active',
          youtube_channel_id: video.snippet.channelId,
          youtube_channel_description: channelDescription,  // ì±„ë„ ì„¤ëª… ì¶”ê°€
          primary_category: categoryName,
          status_date: video.snippet.publishedAt,
          daily_view_count: viewCount,
          subscriber_count: subscriberCount,
          channel_created_date: channelCreatedDate,  // ìƒˆë¡œ ì¶”ê°€ëœ í•„ë“œ
          actual_like_count: actualLikeCount,  // ì‹¤ì œ ì¢‹ì•„ìš” ê°œìˆ˜ (ì—†ìœ¼ë©´ null)
          vod_url: `https://www.youtube.com/watch?v=${video.id}`,
          video_id: video.id,
          title: video.snippet.title,
          description: video.snippet.description,
          video_tags: video.snippet.tags || [],  // ë¹„ë””ì˜¤ íƒœê·¸ ì •ë³´ ì¶”ê°€
          duration: video.contentDetails.duration,
          duration_seconds: durationInSeconds,
          video_length_category: videoLengthCategory,
          country: primaryCountry,  // ê²€ìƒ‰ í•„í„° êµ­ê°€ ì •ë³´
          channel_country: channelCountry,  // ì±„ë„ì˜ ì‹¤ì œ êµ­ì  ì •ë³´ ì¶”ê°€
          avg_watch_rate_percentage: avgWatchRatePercentage,  // ì„œë²„ì—ì„œ ê³„ì‚°ëœ í‰ê· ì‹œì²­ë¥ 
          avg_watch_time: avgWatchTime,  // í‰ê·  ì‹œì²­ì‹œê°„ (ì´ˆ)
          avg_watch_rate_percentage_for_sort: avgWatchRatePercentage,  // duration-percentage ì •ë ¬ìš©
          valid_view_count: validViewCount,  // ìœ íš¨ì¡°íšŒìˆ˜ (êµ¬ë…ì ìˆ˜ ê¸°ë°˜)
          valid_view_percentage: validViewPercentage,  // ìœ íš¨ì¡°íšŒìˆ˜ ë°±ë¶„ìœ¨
          like_count: likeCount,  // ì¢‹ì•„ìš” ê°œìˆ˜ (ì‹¤ì œ ë˜ëŠ” ì¶”ì •)
          is_like_estimated: isLikeEstimated,  // ì¢‹ì•„ìš” ì¶”ì • ì—¬ë¶€
          like_percentage: likePercentage  // ì¢‹ì•„ìš” ë°±ë¶„ìœ¨
        };
    
        // RPM ì¶”ì •ê°’ ê³„ì‚° ë° ì¶”ê°€ (Phase 1 & 2 ì ìš©)
        result.estimated_rpm = calculateFreeRPM(result);
    
        // Analytics ì¶”ì • ë°ì´í„° ê³„ì‚° ë° ì¶”ê°€
        const analyticsData = calculateEstimatedAnalytics(result);
        result.analytics_view_count = analyticsData.views;
        result.estimated_watch_time = analyticsData.estimatedMinutesWatched;
        result.avg_watch_time = analyticsData.averageViewDuration;
        result.estimated_new_subscribers = analyticsData.subscribersGained;
        result.estimated_ad_impressions = analyticsData.adImpressions;
        result.estimated_total_revenue = analyticsData.estimatedRevenue;
        result.estimated_ad_revenue = analyticsData.estimatedAdRevenue;
        result.estimated_premium_revenue = analyticsData.estimatedRedPartnerRevenue;
        result.playbackBasedCpm = analyticsData.playbackBasedCpm;
        result.adCpm = analyticsData.adCpm;
    
        // 4. RPM ê´€ë ¨ ê³„ì‚°ë“¤
        result.ad_rpm = Math.round((result.estimated_rpm || 0) * 0.85 * 100) / 100;  // ê´‘ê³  RPM
        result.total_rpm = Math.round(((result.estimated_rpm || 0) + result.ad_rpm) * 100) / 100;  // ì´ RPM
    
        // 5. ì±„ë„ RPM í•©ê³„ëŠ” ë‚˜ì¤‘ì— ê³„ì‚° (channel_playback_rpmê³¼ channel_ad_rpm ê³„ì‚° í›„)
    
         // ì¤‘ë³µ ì œê±° í›„ ê²°ê³¼ ì¶”ê°€ - ìµœì¢… í•„í„°ë§ ê²€ì¦ ì¶”ê°€
         console.log(`  ğŸ” ìµœì¢… ê²€ì¦: ê²°ê³¼ ì¶”ê°€ ì „ í•„í„°ë§ ì¬í™•ì¸`);
    
         // ìµœì†Œí‰ê· ì‹œì²­ë¥  í•„í„° ìµœì¢… ì¬ê²€ì¦ (ì´ì¤‘ ì•ˆì „ì¥ì¹˜)
         if (minAvgWatchRate && parseFloat(minAvgWatchRate) > 0) {
           const categoryName = result.primary_category;
           const avgWatchTime = calculateAverageViewDuration(durationInSeconds, { primary_category: categoryName });
           const finalAvgWatchRatePercentage = durationInSeconds > 0 ? (avgWatchTime / durationInSeconds) * 100 : 0;
    
           console.log(`  ğŸ”„ ìµœì¢… ì¬ê²€ì¦: ${finalAvgWatchRatePercentage.toFixed(2)}% vs ${minAvgWatchRate}%`);
    
           if (finalAvgWatchRatePercentage < parseFloat(minAvgWatchRate)) {
             console.log(`  ğŸš« ìµœì¢… ê²€ì¦ ì‹¤íŒ¨: ${finalAvgWatchRatePercentage.toFixed(2)}% < ${minAvgWatchRate}% - ê²°ê³¼ ì¶”ê°€ ì•ˆí•¨`);
             continue; // ì—¬ê¸°ì„œ í™•ì‹¤íˆ ì œì™¸
           } else {
             console.log(`  âœ… ìµœì¢… ê²€ì¦ í†µê³¼: ${finalAvgWatchRatePercentage.toFixed(2)}% >= ${minAvgWatchRate}% - ê²°ê³¼ ì¶”ê°€í•¨`);
           }
         }
    
         filterStats.finalAccepted++;
         searchResults.push(result);
         processedVideoIds.add(video.id); // ì²˜ë¦¬ëœ ID ê¸°ë¡
         console.log(`  âœ… ê²°ê³¼ ì¶”ê°€ ì™„ë£Œ: ${searchResults.length}ë²ˆì§¸ (ìµœì¢… ìŠ¹ì¸ë¨)`);
    
         if (searchResults.length >= finalMaxResults) {
           console.log(`  ğŸ¯ ìš”ì²­ëœ ê²°ê³¼ ìˆ˜ ë‹¬ì„±: ${finalMaxResults}ê°œ`);
           break;
         }
       }
    
      nextPageToken = response.data.nextPageToken;
      if (!nextPageToken) break;
    
      // API í˜¸ì¶œ ì œí•œì„ ìœ„í•œ ì§€ì—° (quota ì ˆì•½)
      await new Promise(resolve => setTimeout(resolve, 500));
    }
    
         // ì¡°íšŒìˆ˜ ê¸°ì¤€ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬
     searchResults.sort((a, b) => b.daily_view_count - a.daily_view_count);
    
     // ì±„ë„ë³„ ëˆ„ì  RPM ê°’ ê³„ì‚° ë° ê° ê²°ê³¼ì— ì¶”ê°€
     const channelAccumulations = {};
     searchResults.forEach(result => {
       const channelId = result.youtube_channel_id || result.youtube_channel_name || 'unknown';
    
       if (!channelAccumulations[channelId]) {
         channelAccumulations[channelId] = {
           totalPlaybackRpm: 0,
           totalAdRpm: 0,
           videoCount: 0
         };
       }
    
       const acc = channelAccumulations[channelId];
       acc.totalPlaybackRpm += parseFloat(result.estimated_rpm || 0);
       acc.totalAdRpm += parseFloat(result.estimated_rpm || 0) * 0.85;
       acc.videoCount++;
     });
    
     // ê° ê²°ê³¼ì— ì±„ë„ë³„ ëˆ„ì  RPM ê°’ ì¶”ê°€
     searchResults.forEach(result => {
       const channelId = result.youtube_channel_id || result.youtube_channel_name || 'unknown';
       const acc = channelAccumulations[channelId];
       if (acc) {
         result.channel_playback_rpm = Math.round(acc.totalPlaybackRpm * 100) / 100;
         result.channel_ad_rpm = Math.round(acc.totalAdRpm * 100) / 100;
       } else {
         result.channel_playback_rpm = 0;
         result.channel_ad_rpm = 0;
       }
    
       // ì±„ë„ RPM í•©ê³„ ê³„ì‚° (channel_playback_rpmê³¼ channel_ad_rpm ê³„ì‚° ì™„ë£Œ í›„)
       result.channel_total_rpm = Math.round(((result.channel_playback_rpm || 0) + (result.channel_ad_rpm || 0)) * 100) / 100;
     });
    
     // ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ ë°©ì§€ë¥¼ ìœ„í•œ ë©”ëª¨ë¦¬ ì •ë¦¬
     try {
       processedVideoIds.clear();
       processedChannelTitles.clear();
       if (global.gc) {
         global.gc();
       }
     } catch (memError) {
       console.warn('ë©”ëª¨ë¦¬ ì •ë¦¬ ì˜¤ë¥˜:', memError.message);
     }
    
     // í•„í„°ë§ í†µê³„ ìš”ì•½ ì¶œë ¥ ì¶”ê°€
     console.log(`\nğŸ“Š í•„í„°ë§ ê²°ê³¼ ìš”ì•½:`);
     console.log(`- ì´ ê²€ìƒ‰ëœ ì˜ìƒ: ${filterStats.totalProcessed}ê°œ`);
     if (filterStats.duplicateSkipped > 0) {
       console.log(`- ì¤‘ë³µ ì œì™¸: ${filterStats.duplicateSkipped}ê°œ`);
     }
     if (filterStats.categoryFiltered > 0) {
       console.log(`- ì¹´í…Œê³ ë¦¬ ì¡°ê±´ìœ¼ë¡œ ì œì™¸: ${filterStats.categoryFiltered}ê°œ`);
     }
     if (filterStats.minViewsFiltered > 0) {
       console.log(`- ìµœì†Œ ì¡°íšŒìˆ˜ ì¡°ê±´ìœ¼ë¡œ ì œì™¸: ${filterStats.minViewsFiltered}ê°œ`);
     }
     if (filterStats.maxViewsFiltered > 0) {
       console.log(`- ìµœëŒ€ ì¡°íšŒìˆ˜ ì¡°ê±´ìœ¼ë¡œ ì œì™¸: ${filterStats.maxViewsFiltered}ê°œ`);
     }
     if (filterStats.videoLengthFiltered > 0) {
       console.log(`- ë™ì˜ìƒ ê¸¸ì´ ì¡°ê±´ìœ¼ë¡œ ì œì™¸: ${filterStats.videoLengthFiltered}ê°œ`);
     }
     if (filterStats.minAvgWatchRateFiltered > 0) {
       console.log(`- ìµœì†Œí‰ê· ì‹œì²­ë¥ (${minAvgWatchRate}%) ì¡°ê±´ìœ¼ë¡œ ì œì™¸: ${filterStats.minAvgWatchRateFiltered}ê°œ`);
     }
     console.log(`- ìµœì¢… ê²°ê³¼: ${filterStats.finalAccepted}ê°œ`);
    
     // ê¸°ì¡´ ì¤‘ë³µ ì œê±° í†µê³„
     const totalProcessed = processedVideoIds.size + searchResults.length;
     const duplicatesRemoved = totalProcessed - searchResults.length;
    
     console.log(`\nê²€ìƒ‰ ì™„ë£Œ: ${searchResults.length}ê°œ ê²°ê³¼`);
     console.log(`ğŸ“Š API ì‚¬ìš©ëŸ‰: ê²€ìƒ‰ API ${Math.ceil(searchResults.length / 50)}íšŒ + ìƒì„¸ì •ë³´ API ${Math.ceil(searchResults.length / 50)}íšŒ (${finalMaxResults}ê±´ ìš”ì²­ ì¤‘ ${searchResults.length}ê±´ ê²°ê³¼)`);
    
     // API í‚¤ ì‚¬ìš© í†µê³„ ì¶œë ¥
     apiKeyManager.printUsageStats();
    
     // ========== YouTube API ê²°ê³¼ë¥¼ Elasticsearchì— ì¸ë±ì‹± ==========
     if (searchResults.length > 0) {
     console.log('ğŸ“ YouTube API ê²°ê³¼ë¥¼ Elasticsearchì— ì¸ë±ì‹± ì¤‘...');
     try {
     await esHelper.bulkUpsertVideos(searchResults, searchParameters);
     console.log('âœ… Elasticsearch ì¸ë±ì‹± ì™„ë£Œ');
     } catch (esError) {
     console.error('âš ï¸ Elasticsearch ì¸ë±ì‹± ì‹¤íŒ¨:', esError.message);
     console.log('ğŸ’¡ YouTube API ê²°ê³¼ëŠ” ì •ìƒ ë°˜í™˜í•˜ì§€ë§Œ ìºì‹œ ì €ì¥ì€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
     }
     }
     // ========== Elasticsearch ì¸ë±ì‹± ë ==========
    
     // ê²€ìƒ‰ ì†Œìš”ì‹œê°„ ê³„ì‚° ë° ì¶œë ¥
     const searchEndTime = Date.now();
     const searchDuration = searchEndTime - searchStartTime;
     const durationSeconds = (searchDuration / 1000).toFixed(2);
    
     console.log(`\nâ±ï¸ ê²€ìƒ‰ ì™„ë£Œ: ì´ ì†Œìš”ì‹œê°„ ${durationSeconds}ì´ˆ (${searchResults.length}ê°œ ê²°ê³¼)`);
    console.log(`ğŸ” ê²€ìƒ‰ ì¡°ê±´: ${country}/${keyword || 'í‚¤ì›Œë“œ ì—†ìŒ'}/${finalMaxResults}ê±´`);
    console.log('='.repeat(52));
    
    res.json({
      success: true,
      data: searchResults,
      total: searchResults.length,
      source: 'youtube_api_with_es_cache',
      searchDuration: `${durationSeconds}ì´ˆ`
    });

  } catch (error) {
    console.error('ê²€ìƒ‰ ì˜¤ë¥˜:', error);

    // ì˜¤ë¥˜ ë°œìƒ ì‹œì—ë„ ì†Œìš”ì‹œê°„ ì¶œë ¥
    const errorEndTime = Date.now();
    const errorDuration = errorEndTime - searchStartTime;
    const errorDurationSeconds = (errorDuration / 1000).toFixed(2);
    
    console.log(`\nâš ï¸ ê²€ìƒ‰ ì‹¤íŒ¨: ì†Œìš”ì‹œê°„ ${errorDurationSeconds}ì´ˆ`);
    console.log('='.repeat(52));
    
    // API í‚¤ ì‚¬ìš© í†µê³„ ì¶œë ¥ (ì˜¤ë¥˜ ë°œìƒ ì‹œì—ë„)
    apiKeyManager.printUsageStats();
    
    // YouTube API quota ì´ˆê³¼ ì˜¤ë¥˜ ì²˜ë¦¬ - ìˆ˜ì •ëœ ë¡œì§
    if (error.message.includes('quota') || error.message.includes('quotaExceeded')) {
      console.error('YouTube API í• ë‹¹ëŸ‰ ì´ˆê³¼ ê°ì§€');
    
      // ì‹¤ì œë¡œ ì‚¬ìš© ê°€ëŠ¥í•œ í‚¤ê°€ ìˆëŠ”ì§€ í™•ì¸
      const availableKeys = apiKeyManager.apiKeys.filter(key => !key.quotaExceeded);
      const totalKeys = apiKeyManager.apiKeys.length;
      const exhaustedKeys = totalKeys - availableKeys.length;
    
      // ì‚¬ìš© ê°€ëŠ¥í•œ í‚¤ê°€ ìˆìœ¼ë©´ 429 ì—ëŸ¬ë¥¼ ë°˜í™˜í•˜ì§€ ì•Šê³  ì¬ì‹œë„ ìœ ë„
      if (availableKeys.length > 0) {
        console.log(`ì‚¬ìš© ê°€ëŠ¥í•œ API í‚¤ê°€ ${availableKeys.length}ê°œ ë‚¨ì•„ìˆìŒ, ì´ ì˜¤ë¥˜ëŠ” ë‚´ë¶€ ì²˜ë¦¬ ì¤‘ ë°œìƒí•œ ì¼ì‹œì  ì˜¤ë¥˜ì…ë‹ˆë‹¤.`);
    
        // 500 ì—ëŸ¬ë¡œ ë°˜í™˜í•˜ì—¬ í´ë¼ì´ì–¸íŠ¸ê°€ ì¬ì‹œë„í•  ìˆ˜ ìˆë„ë¡ í•¨
        res.status(500).json({
          success: false,
          error: 'ì¼ì‹œì ì¸ API í‚¤ ì „í™˜ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ì¬ì‹œë„í•´ ì£¼ì„¸ìš”.',
          errorType: 'temporary_api_key_switch_error',
          details: `${availableKeys.length}ê°œì˜ API í‚¤ê°€ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.`,
          keyStats: {
            total: totalKeys,
            available: availableKeys.length,
            exhausted: exhaustedKeys
          }
        });
      } else {
        // ëª¨ë“  í‚¤ê°€ ì‹¤ì œë¡œ ì†Œì§„ëœ ê²½ìš°ì—ë§Œ 429 ì—ëŸ¬ ë°˜í™˜
        console.error('ëª¨ë“  YouTube API í‚¤ì˜ í• ë‹¹ëŸ‰ì´ ì´ˆê³¼ë¨');
        res.status(429).json({
          success: false,
          error: `YouTube API ì¼ì¼ í• ë‹¹ëŸ‰ì„ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤. (${exhaustedKeys}/${totalKeys} í‚¤ ì‚¬ìš©ë¨)`,
          errorType: 'quota_exceeded',
          details: 'ëª¨ë“  API í‚¤ì˜ í• ë‹¹ëŸ‰ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤. ë‚´ì¼ ìë™ìœ¼ë¡œ í• ë‹¹ëŸ‰ì´ ì¬ì„¤ì •ë©ë‹ˆë‹¤.',
          keyStats: {
            total: totalKeys,
            available: availableKeys.length,
            exhausted: exhaustedKeys
          }
        });
      }
    } else if (error.message.includes('API key')) {
      console.error('YouTube API í‚¤ ì˜¤ë¥˜');
      res.status(401).json({
        success: false,
        error: 'YouTube API í‚¤ê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.',
        errorType: 'invalid_api_key'
      });
    } else {
      res.status(500).json({
        success: false,
        error: error.message,
        errorType: 'general_error'
      });
    }

  }
});

// ì¸ë„¤ì¼ ë‹¤ìš´ë¡œë“œ APIëŠ” ì•„ë˜ì— ê°œì„ ëœ ë²„ì „ì´ ìˆìŠµë‹ˆë‹¤.

// Excel ë‹¤ìš´ë¡œë“œ API
app.post('/api/download-excel', async (req, res) => {
  try {
    const { searchResults, searchParams } = req.body;

    if (!searchResults || !Array.isArray(searchResults)) {
      return res.status(400).json({ error: 'ê²€ìƒ‰ ê²°ê³¼ ë°ì´í„°ê°€ í•„ìš”í•©ë‹ˆë‹¤.' });
    }
    
    // ëŒ€ìš©ëŸ‰ ë°ì´í„° ì œí•œ ì¶”ê°€
    if (searchResults.length > 1000) {
      return res.status(413).json({ 
        error: 'ê²°ê³¼ê°€ ë„ˆë¬´ ë§ìŠµë‹ˆë‹¤. 1000ê±´ ì´í•˜ë¡œ í•„í„°ë§í•´ì£¼ì„¸ìš”.',
        maxAllowed: 1000,
        currentCount: searchResults.length
      });
    }
    
    // ì±„ë„ë³„ ëˆ„ì  ê°’ ê³„ì‚°
    const channelAccumulations = {};
    
    // ê° ì±„ë„ë³„ë¡œ ëˆ„ì  ê°’ ê³„ì‚°
    searchResults.forEach(result => {
      const channelId = result.youtube_channel_id || result.youtube_channel_name || 'unknown';
    
      if (!channelAccumulations[channelId]) {
        channelAccumulations[channelId] = {
          totalPlaybackCpm: 0,
          totalAdCpm: 0,
          totalPlaybackRpm: 0,
          totalAdRpm: 0,
          videoCount: 0
        };
      }
    
      const acc = channelAccumulations[channelId];
      acc.totalPlaybackCpm += parseFloat(result.playbackBasedCpm || 0);
      acc.totalAdCpm += parseFloat(result.adCpm || 0);
      acc.totalPlaybackRpm += parseFloat(result.estimated_rpm || 0);
      acc.totalAdRpm += parseFloat(result.estimated_rpm || 0) * 0.85;
      acc.videoCount++;
    });
    
    // Excelìš© ë°ì´í„° ë³€í™˜ 
    const excelData = searchResults.map((result, index) => {
      return {
        'ìˆœë²ˆ': index + 1,
        'ê°€ì…ì¼': result.channel_created_date ? new Date(result.channel_created_date).toLocaleDateString('ko-KR') : '',
        'ë¸Œëœë“œ': isBrandChannel(result) ? 1 : 0,
        'êµ­ì ': result.channel_country || '',
        'êµ­ê°€': result.country || '',
        'ì±„ë„ ID': result.youtube_channel_id || '',
        'ì±„ë„ëª…': result.youtube_channel_name || '',
        'ì±„ë„ì„¤ëª…': result.youtube_channel_description || '',
        'íƒœê·¸': Array.isArray(result.video_tags) ? result.video_tags.join(', ') : (result.video_tags || ''),
        'ë™ì˜ìƒ ì œëª©': result.title || '',
        'ë™ì˜ìƒ ì„¤ëª…': result.description || '',
        'ì¹´í…Œê³ ë¦¬': result.primary_category || '',
        'ì—…ë¡œë“œì¼': result.status_date ? new Date(result.status_date).toLocaleDateString('ko-KR') : '',
        'ì¡°íšŒìˆ˜': parseInt(result.daily_view_count || 0).toLocaleString(),
        'ìœ íš¨ì¡°íšŒìˆ˜': Math.round((result.daily_view_count || 0) * 0.85).toLocaleString(),
        'ì¢‹ì•„ìš”ê°œìˆ˜(ìœ íš¨ ì¡°íšŒìˆ˜ì— ëŒ€í•œ ì¢‹ì•„ìš” ë°±ë¶„ìœ¨(%))': (() => {
          const likeCount = result.actual_like_count || Math.round((result.daily_view_count || 0) * 0.01);
          const validViewCount = Math.round((result.daily_view_count || 0) * 0.85);
          const percentage = validViewCount > 0 ? Math.round((likeCount / validViewCount) * 100 * 100) / 100 : 0;
          return `${likeCount.toLocaleString()}(${percentage}%)`;
        })(),
        'êµ¬ë…ì': formatSubscriberCountForExcel(result.subscriber_count || 0),
        'URL': result.vod_url || '',
        'ì‹œê°„(ì´ˆ)': result.duration_seconds || 0,
        'ì‹œê°„(í˜•ì‹)': formatDurationForExcel(result.duration_seconds),
        'ë™ì˜ìƒ ê¸¸ì´': formatVideoLengthForExcel(result.video_length_category) || '',
        'ìƒíƒœ': result.status || '',
        'ì¸ë„¤ì¼ URL': result.thumbnail_url || '',
        // Analytics ì¶”ì • ì»¬ëŸ¼ë“¤ (ì¸ë„¤ì¼ URL ì˜¤ë¥¸ìª½)
        'Analytics ì¡°íšŒìˆ˜': result.analytics_view_count ? parseInt(result.analytics_view_count).toLocaleString() : '0',
        'ì¶”ì • ì‹œì²­ì‹œê°„(ë¶„)': result.estimated_watch_time ? Math.round(result.estimated_watch_time * 100) / 100 : '0.00',
        'í‰ê·  ì‹œì²­ì‹œê°„(ì´ˆ)': result.avg_watch_time ? Math.round(result.avg_watch_time) : '0',
        'ì‹ ê·œ êµ¬ë…ì ìˆ˜': result.estimated_new_subscribers ? Math.round(result.estimated_new_subscribers) : '0',
        'ê´‘ê³  ë…¸ì¶œ ìˆ˜': result.estimated_ad_impressions ? Math.round(result.estimated_ad_impressions).toLocaleString() : '0',
        'ì¶”ì • ì´ìˆ˜ìµ($)': result.estimated_total_revenue ? `$${Math.round(result.estimated_total_revenue * 100) / 100}` : '$0.00',
        'ì¶”ì • ê´‘ê³ ìˆ˜ìµ($)': result.estimated_ad_revenue ? `$${Math.round(result.estimated_ad_revenue * 100) / 100}` : '$0.00',
        'ì¶”ì • Premiumìˆ˜ìµ($)': result.estimated_premium_revenue ? `$${Math.round(result.estimated_premium_revenue * 100) / 100}` : '$0.00',
        'ì¬ìƒê¸°ë°˜ CPM($)': result.playbackBasedCpm ? `$${Math.round(result.playbackBasedCpm * 100) / 100}` : '$0.00',
        'ê´‘ê³  CPM($)': result.adCpm ? `$${Math.round(result.adCpm * 100) / 100}` : '$0.00',
        // ì¶”ê°€ RPM ì»¬ëŸ¼ë“¤ (ë§¨ ë§ˆì§€ë§‰)
        'ì¬ìƒê¸°ë°˜ RPM($)': result.estimated_rpm ? `$${result.estimated_rpm}` : '$0.00',
        'ê´‘ê³  RPM($)': result.estimated_rpm ? `$${Math.round(result.estimated_rpm * 0.85 * 100) / 100}` : '$0.00',
        // ì±„ë„ ì „ì²´ ëˆ„ì  ê°’ ì»¬ëŸ¼ë“¤
        'ì¬ìƒëˆ„ì  CPM($)': (() => {
          const channelId = result.youtube_channel_id || result.youtube_channel_name || 'unknown';
          const acc = channelAccumulations[channelId];
          return acc ? `$${Math.round(acc.totalPlaybackCpm * 100) / 100}` : '$0.00';
        })(),
        'ê´‘ê³ ëˆ„ì  CPM($)': (() => {
          const channelId = result.youtube_channel_id || result.youtube_channel_name || 'unknown';
          const acc = channelAccumulations[channelId];
          return acc ? `$${Math.round(acc.totalAdCpm * 100) / 100}` : '$0.00';
        })(),
        'ì¬ìƒëˆ„ì  RPM($)': (() => {
          const channelId = result.youtube_channel_id || result.youtube_channel_name || 'unknown';
          const acc = channelAccumulations[channelId];
          return acc ? `$${Math.round(acc.totalPlaybackRpm * 100) / 100}` : '$0.00';
        })(),
        'ê´‘ê³ ëˆ„ì  RPM($)': (() => {
          const channelId = result.youtube_channel_id || result.youtube_channel_name || 'unknown';
          const acc = channelAccumulations[channelId];
          return acc ? `$${Math.round(acc.totalAdRpm * 100) / 100}` : '$0.00';
        })()
      };
    });
    
    // ì›Œí¬ë¶ ìƒì„±
    const workbook = XLSX.utils.book_new();
    const worksheet = XLSX.utils.json_to_sheet(excelData);
    
    // ì»¬ëŸ¼ ë„ˆë¹„ ìë™ ì¡°ì • (40ê°œ ì»¬ëŸ¼)
    const columnWidths = [
      { wch: 6 },  // ìˆœë²ˆ
      { wch: 12 }, // ê°€ì…ì¼
      { wch: 8 },  // ë¸Œëœë“œ
      { wch: 20 }, // ì±„ë„ ID
      { wch: 25 }, // ì±„ë„ëª…
      { wch: 50 }, // ì±„ë„ì„¤ëª…
      { wch: 30 }, // íƒœê·¸
      { wch: 40 }, // ë™ì˜ìƒ ì œëª©
      { wch: 50 }, // ë™ì˜ìƒ ì„¤ëª…
      { wch: 15 }, // ì¹´í…Œê³ ë¦¬
      { wch: 12 }, // êµ­ê°€
      { wch: 12 }, // ì—…ë¡œë“œì¼
      { wch: 12 }, // ì¡°íšŒìˆ˜
      { wch: 12 }, // ìœ íš¨ì¡°íšŒìˆ˜
      { wch: 35 }, // ì¢‹ì•„ìš”ê°œìˆ˜(ìœ íš¨ ì¡°íšŒìˆ˜ì— ëŒ€í•œ ì¢‹ì•„ìš” ë°±ë¶„ìœ¨(%))
      { wch: 12 }, // êµ¬ë…ì
      { wch: 50 }, // URL
      { wch: 8 },  // ì‹œê°„(ì´ˆ)
      { wch: 10 }, // ì‹œê°„(í˜•ì‹)
      { wch: 12 }, // ë™ì˜ìƒ ê¸¸ì´
      { wch: 10 }, // ìƒíƒœ
      { wch: 50 }, // ì¸ë„¤ì¼ URL
      // Analytics ì»¬ëŸ¼ë“¤
      { wch: 15 }, // Analytics ì¡°íšŒìˆ˜
      { wch: 18 }, // ì¶”ì • ì‹œì²­ì‹œê°„(ë¶„)
      { wch: 18 }, // í‰ê·  ì‹œì²­ì‹œê°„(ì´ˆ)
      { wch: 15 }, // ì‹ ê·œ êµ¬ë…ì ìˆ˜
      { wch: 15 }, // ê´‘ê³  ë…¸ì¶œ ìˆ˜
      { wch: 18 }, // ì¶”ì • ì´ìˆ˜ìµ($)
      { wch: 18 }, // ì¶”ì • ê´‘ê³ ìˆ˜ìµ($)
      { wch: 20 }, // ì¶”ì • Premiumìˆ˜ìµ($)
      { wch: 18 }, // ì¬ìƒê¸°ë°˜ CPM($)
      { wch: 15 }, // ê´‘ê³  CPM($)
      // RPM ì»¬ëŸ¼ë“¤
      { wch: 18 }, // ì¬ìƒê¸°ë°˜ RPM($)
      { wch: 15 }, // ê´‘ê³  RPM($)
      // ì±„ë„ ì „ì²´ ëˆ„ì  ê°’ ì»¬ëŸ¼ë“¤
      { wch: 18 }, // ì¬ìƒëˆ„ì  CPM($)
      { wch: 18 }, // ê´‘ê³ ëˆ„ì  CPM($)
      { wch: 18 }, // ì¬ìƒëˆ„ì  RPM($)
      { wch: 18 }  // ê´‘ê³ ëˆ„ì  RPM($)
    ];
    worksheet['!cols'] = columnWidths;
    
    // ì›Œí¬ì‹œíŠ¸ë¥¼ ì›Œí¬ë¶ì— ì¶”ê°€
    XLSX.utils.book_append_sheet(workbook, worksheet, 'YouTube ê²€ìƒ‰ ê²°ê³¼');
    
    // Excel íŒŒì¼ì„ ë²„í¼ë¡œ ìƒì„±
    const excelBuffer = XLSX.write(workbook, { 
      type: 'buffer', 
      bookType: 'xlsx',
      compression: true 
    });
    
    // íŒŒì¼ëª… ìƒì„± (ê²€ìƒ‰ ì¡°ê±´ í¬í•¨) - ëŒ€í•œë¯¼êµ­ ì‹œê°„ ê¸°ì¤€
    const now = new Date();
    const kstTime = new Date(now.getTime() + (9 * 60 * 60 * 1000)); // UTC+9 (ëŒ€í•œë¯¼êµ­ ì‹œê°„)
    const timestamp = kstTime.toISOString().slice(0, 19).replace(/:/g, '-');
    const keyword = searchParams?.keyword || 'ì „ì²´';
    const country = searchParams?.country || 'worldwide';
    const resultCount = searchResults.length;
    
    // ë‚ ì§œ ë²”ìœ„ ì •ë³´ í¬í•¨
    let dateRangeStr = '';
    if (searchParams?.startDate || searchParams?.endDate) {
      const startDateStr = searchParams?.startDate ? searchParams.startDate.replace(/-/g, '') : '';
      const endDateStr = searchParams?.endDate ? searchParams.endDate.replace(/-/g, '') : '';
      if (startDateStr && endDateStr) {
        dateRangeStr = `_${startDateStr}-${endDateStr}`;
      } else if (startDateStr) {
        dateRangeStr = `_${startDateStr}ì´í›„`;
      } else if (endDateStr) {
        dateRangeStr = `_${endDateStr}ì´ì „`;
      }
    } else if (searchParams?.uploadPeriod) {
      dateRangeStr = `_${searchParams.uploadPeriod}`;
    }
    
    const filename = `YouTube_${keyword}_${country}${dateRangeStr}_[${resultCount}]_${timestamp}.xlsx`;
    
    // ì‘ë‹µ í—¤ë” ì„¤ì •
    res.setHeader('Content-Disposition', `attachment; filename="${encodeURIComponent(filename)}"`);
    res.setHeader('Content-Type', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');
    res.setHeader('Content-Length', excelBuffer.length);
    
    // Excel íŒŒì¼ ì „ì†¡
    res.send(excelBuffer);
    
    console.log(`âœ… Excel íŒŒì¼ ìƒì„± ì™„ë£Œ: ${filename} (${searchResults.length}í–‰)`);

  } catch (error) {
    console.error('Excel ë‹¤ìš´ë¡œë“œ ì˜¤ë¥˜:', error);
    res.status(500).json({ error: 'Excel íŒŒì¼ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.' });
  }
});

// Excelìš© ì‹œê°„ í¬ë§· í•¨ìˆ˜
function formatDurationForExcel(durationSeconds) {
  if (!durationSeconds || durationSeconds === 0) {
    return '00:00';
  }

  const hours = Math.floor(durationSeconds / 3600);
  const minutes = Math.floor((durationSeconds % 3600) / 60);
  const seconds = durationSeconds % 60;

  if (hours > 0) {
    return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
  } else {
    return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
  }
}

// Excelìš© êµ¬ë…ì ìˆ˜ í¬ë§· í•¨ìˆ˜ (ë§Œ ë‹¨ìœ„)
function formatSubscriberCountForExcel(count) {
  if (!count || count === 0) {
    return '0';
  }

  const number = parseInt(count);
  const inTenThousands = number / 10000;

  if (number < 10000) {
    // 1ë§Œ ë¯¸ë§Œì¸ ê²½ìš° ì†Œìˆ˜ì  2ìë¦¬ í‘œì‹œ
    return inTenThousands.toFixed(2);
  } else {
    // 1ë§Œ ì´ìƒì¸ ê²½ìš° ì†Œìˆ˜ì  1ìë¦¬ í‘œì‹œ (100ë§Œ ì´ìƒë„ í¬í•¨)
    return inTenThousands.toFixed(1);
  }
}

// Excelìš© ë™ì˜ìƒ ê¸¸ì´ ì¹´í…Œê³ ë¦¬ í¬ë§· í•¨ìˆ˜
function formatVideoLengthForExcel(category) {
  const categoryMap = {
    'short1': 'Short Form1 (1ë¶„ ë¯¸ë§Œ)',
    'short2': 'Short Form2 (1ë¶„ ì´ìƒ 2ë¶„ ë¯¸ë§Œ)',
    'mid1': 'Mid Form1 (2ë¶„ ì´ìƒ 10ë¶„ ë¯¸ë§Œ)',
    'mid2': 'Mid Form2 (10ë¶„ ì´ìƒ 20ë¶„ ë¯¸ë§Œ)',
    'long1': 'Long Form1 (20ë¶„ ì´ìƒ 30ë¶„ ë¯¸ë§Œ)',
    'long2': 'Long Form2 (30ë¶„ ì´ìƒ 40ë¶„ ë¯¸ë§Œ)',
    'long3': 'Long Form3 (40ë¶„ ì´ìƒ 50ë¶„ ë¯¸ë§Œ)',
    'long4': 'Long Form4 (50ë¶„ ì´ìƒ 60ë¶„ ë¯¸ë§Œ)',
    'long5': 'Long Form5 (60ë¶„ ì´ìƒ 90ë¶„ ë¯¸ë§Œ)',
    'long6': 'Long Form6 (90ë¶„ ì´ìƒ)'
  };

  return categoryMap[category] || category || 'ì•Œ ìˆ˜ ì—†ìŒ';
}

// í—¬í¼ í•¨ìˆ˜ë“¤
function getCountryCode(country) {
  // YouTube APIê°€ ê³µì‹ ì§€ì›í•˜ëŠ” regionCode ëª©ë¡ (25ê°œêµ­ ì™„ì „ ì§€ì›)
  const countryMap = {
    'worldwide': null, // ì „ì„¸ê³„ ê²€ìƒ‰ ì‹œ regionCode ì—†ìŒ
    'korea': 'KR',     // âœ… í•œêµ­ - ì•ˆì •ì 
    'usa': 'US',       // âœ… ë¯¸êµ­ - ì•ˆì •ì 
    'japan': 'JP',     // âœ… ì¼ë³¸ - ì•ˆì •ì 
    'china': 'CN',     // âœ… ì¤‘êµ­ - ì§€ì› ì¶”ê°€
    'uk': 'GB',        // âœ… ì˜êµ­ - ì•ˆì •ì 
    'germany': 'DE',   // âœ… ë…ì¼ - ì•ˆì •ì 
    'france': 'FR',    // âœ… í”„ë‘ìŠ¤ - ì•ˆì •ì 
    'canada': 'CA',    // âœ… ìºë‚˜ë‹¤ - ì•ˆì •ì 
    'australia': 'AU', // âœ… í˜¸ì£¼ - ì•ˆì •ì 
    'india': 'IN',     // âœ… ì¸ë„ - ì•ˆì •ì 
    'brazil': 'BR',    // âœ… ë¸Œë¼ì§ˆ - ì•ˆì •ì 
    'mexico': 'MX',    // âœ… ë©•ì‹œì½” - ì•ˆì •ì 
    'russia': 'RU',    // âœ… ëŸ¬ì‹œì•„ - ì§€ì› ì¶”ê°€
    'italy': 'IT',     // âœ… ì´íƒˆë¦¬ì•„ - ì•ˆì •ì 
    'spain': 'ES',     // âœ… ìŠ¤í˜ì¸ - ì•ˆì •ì 
    // ì•„ì‹œì•„-íƒœí‰ì–‘ ì¶”ê°€ êµ­ê°€ë“¤
    'thailand': 'TH',  // âœ… íƒœêµ­ - ì§€ì› ì¶”ê°€
    'vietnam': 'VN',   // âœ… ë² íŠ¸ë‚¨ - ì§€ì› ì¶”ê°€
    'indonesia': 'ID', // âœ… ì¸ë„ë„¤ì‹œì•„ - ì§€ì› ì¶”ê°€
    // ë‚¨ë¯¸ ì¶”ê°€ êµ­ê°€ë“¤
    'argentina': 'AR', // âœ… ì•„ë¥´í—¨í‹°ë‚˜ - ì§€ì› ì¶”ê°€
    'colombia': 'CO',  // âœ… ì½œë¡¬ë¹„ì•„ - ì§€ì› ì¶”ê°€
    // ì¤‘ë™ & ì•„í”„ë¦¬ì¹´ ì¶”ê°€ êµ­ê°€ë“¤
    'saudi': 'SA',     // âœ… ì‚¬ìš°ë””ì•„ë¼ë¹„ì•„ - ì§€ì› ì¶”ê°€
    'uae': 'AE',       // âœ… UAE - ì§€ì› ì¶”ê°€
    'southafrica': 'ZA', // âœ… ë‚¨ì•„í”„ë¦¬ì¹´ê³µí™”êµ­ - ì§€ì› ì¶”ê°€
    'nigeria': 'NG',   // âœ… ë‚˜ì´ì§€ë¦¬ì•„ - ì§€ì› ì¶”ê°€
    'egypt': 'EG'      // âœ… ì´ì§‘íŠ¸ - ì§€ì› ì¶”ê°€
  };

  const code = countryMap[country.toLowerCase()];

  // ìœ íš¨í•œ regionCodeì¸ì§€ í™•ì¸ (YouTube API ì§€ì› êµ­ê°€ë§Œ)
  const validRegionCodes = [
    'AD', 'AE', 'AF', 'AG', 'AI', 'AL', 'AM', 'AO', 'AQ', 'AR', 'AS', 'AT',
    'AU', 'AW', 'AX', 'AZ', 'BA', 'BB', 'BD', 'BE', 'BF', 'BG', 'BH', 'BI',
    'BJ', 'BL', 'BM', 'BN', 'BO', 'BQ', 'BR', 'BS', 'BT', 'BV', 'BW', 'BY',
    'BZ', 'CA', 'CC', 'CD', 'CF', 'CG', 'CH', 'CI', 'CK', 'CL', 'CM', 'CN',
    'CO', 'CR', 'CU', 'CV', 'CW', 'CX', 'CY', 'CZ', 'DE', 'DJ', 'DK', 'DM',
    'DO', 'DZ', 'EC', 'EE', 'EG', 'EH', 'ER', 'ES', 'ET', 'FI', 'FJ', 'FK',
    'FM', 'FO', 'FR', 'GA', 'GB', 'GD', 'GE', 'GF', 'GG', 'GH', 'GI', 'GL',
    'GM', 'GN', 'GP', 'GQ', 'GR', 'GS', 'GT', 'GU', 'GW', 'GY', 'HK', 'HM',
    'HN', 'HR', 'HT', 'HU', 'ID', 'IE', 'IL', 'IM', 'IN', 'IO', 'IQ', 'IR',
    'IS', 'IT', 'JE', 'JM', 'JO', 'JP', 'KE', 'KG', 'KH', 'KI', 'KM', 'KN',
    'KP', 'KR', 'KW', 'KY', 'KZ', 'LA', 'LB', 'LC', 'LI', 'LK', 'LR', 'LS',
    'LT', 'LU', 'LV', 'LY', 'MA', 'MC', 'MD', 'ME', 'MF', 'MG', 'MH', 'MK',
    'ML', 'MM', 'MN', 'MO', 'MP', 'MQ', 'MR', 'MS', 'MT', 'MU', 'MV', 'MW',
    'MX', 'MY', 'MZ', 'NA', 'NC', 'NE', 'NF', 'NG', 'NI', 'NL', 'NO', 'NP',
    'NR', 'NU', 'NZ', 'OM', 'PA', 'PE', 'PF', 'PG', 'PH', 'PK', 'PL', 'PM',
    'PN', 'PR', 'PS', 'PT', 'PW', 'PY', 'QA', 'RE', 'RO', 'RS', 'RU', 'RW',
    'SA', 'SB', 'SC', 'SD', 'SE', 'SG', 'SH', 'SI', 'SJ', 'SK', 'SL', 'SM',
    'SN', 'SO', 'SR', 'SS', 'ST', 'SV', 'SX', 'SY', 'SZ', 'TC', 'TD', 'TF',
    'TG', 'TH', 'TJ', 'TK', 'TL', 'TM', 'TN', 'TO', 'TR', 'TT', 'TV', 'TW',
    'TZ', 'UA', 'UG', 'UM', 'US', 'UY', 'UZ', 'VA', 'VC', 'VE', 'VG', 'VI',
    'VN', 'VU', 'WF', 'WS', 'YE', 'YT', 'ZA', 'ZM', 'ZW'
  ];

  // ìœ íš¨í•œ ì½”ë“œë§Œ ë°˜í™˜, ê·¸ë ‡ì§€ ì•Šìœ¼ë©´ null
  return code && validRegionCodes.includes(code) ? code : null;
}

function getLanguageCode(country) {
  const languageMap = {
    'worldwide': 'en', // ì „ì„¸ê³„ëŠ” ì˜ì–´ ê¸°ë³¸
    'korea': 'ko',     // í•œêµ­ì–´
    'usa': 'en',       // ì˜ì–´
    'japan': 'ja',     // ì¼ë³¸ì–´
    'china': 'zh',     // ì¤‘êµ­ì–´ (YouTube ì ‘ê·¼ ì œí•œ ê³ ë ¤)
    'uk': 'en',        // ì˜ì–´
    'germany': 'de',   // ë…ì¼ì–´
    'france': 'fr',    // í”„ë‘ìŠ¤ì–´
    'canada': 'en',    // ì˜ì–´ (ìºë‚˜ë‹¤ëŠ” ì˜ì–´/í”„ë‘ìŠ¤ì–´ í˜¼ìš©ì´ì§€ë§Œ ì˜ì–´ ìš°ì„ )
    'australia': 'en', // ì˜ì–´
    'india': 'en',     // ì˜ì–´ (íŒë””ì–´ ë“± ì—¬ëŸ¬ ì–¸ì–´ ìˆì§€ë§Œ ì˜ì–´ ìš°ì„ )
    'brazil': 'pt',    // í¬ë¥´íˆ¬ê°ˆì–´
    'mexico': 'es',    // ìŠ¤í˜ì¸ì–´
    'russia': 'en',    // ëŸ¬ì‹œì•„ëŠ” ì„œë¹„ìŠ¤ ì œí•œìœ¼ë¡œ ì˜ì–´ ì‚¬ìš©
    'italy': 'it',     // ì´íƒˆë¦¬ì•„ì–´
    'spain': 'es'      // ìŠ¤í˜ì¸ì–´
  };

  return languageMap[country.toLowerCase()] || 'en';
}

function getDateRange(period) {
  const now = new Date();
  let publishedAfter = null;

  console.log(`ì—…ë¡œë“œ ê¸°ê°„ ì„¤ì •: ${period}`);

  switch (period) {
    case '1day':
      publishedAfter = new Date(now.getTime() - 24 * 60 * 60 * 1000);
      break;
    case '2days':
      publishedAfter = new Date(now.getTime() - 2 * 24 * 60 * 60 * 1000);
      break;
    case '3days':
      publishedAfter = new Date(now.getTime() - 3 * 24 * 60 * 60 * 1000);
      break;
    case '1week':
      publishedAfter = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
      break;
    case '2weeks':
      publishedAfter = new Date(now.getTime() - 14 * 24 * 60 * 60 * 1000);
      break;
    case '3weeks':
      publishedAfter = new Date(now.getTime() - 21 * 24 * 60 * 60 * 1000);
      break;
    case '1month':
      publishedAfter = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
      break;
    case '3months':
      publishedAfter = new Date(now.getTime() - 90 * 24 * 60 * 60 * 1000);
      break;
    case '6months':
      publishedAfter = new Date(now.getTime() - 180 * 24 * 60 * 60 * 1000);
      break;
    case '1year':
      publishedAfter = new Date(now.getTime() - 365 * 24 * 60 * 60 * 1000);
      break;
    case '2years':
      publishedAfter = new Date(now.getTime() - 2 * 365 * 24 * 60 * 60 * 1000);
      break;
    case '3years':
      publishedAfter = new Date(now.getTime() - 3 * 365 * 24 * 60 * 60 * 1000);
      break;
    case '4years':
      publishedAfter = new Date(now.getTime() - 4 * 365 * 24 * 60 * 60 * 1000);
      break;
    case '5years':
      publishedAfter = new Date(now.getTime() - 5 * 365 * 24 * 60 * 60 * 1000);
      break;
    case '6years':
      publishedAfter = new Date(now.getTime() - 6 * 365 * 24 * 60 * 60 * 1000);
      break;
    case '7years':
      publishedAfter = new Date(now.getTime() - 7 * 365 * 24 * 60 * 60 * 1000);
      break;
    case '8years':
      publishedAfter = new Date(now.getTime() - 8 * 365 * 24 * 60 * 60 * 1000);
      break;
    case '9years':
      publishedAfter = new Date(now.getTime() - 9 * 365 * 24 * 60 * 60 * 1000);
      break;
    case '10years':
      publishedAfter = new Date(now.getTime() - 10 * 365 * 24 * 60 * 60 * 1000);
      break;
  }

  const result = {
    publishedAfter: publishedAfter ? publishedAfter.toISOString() : null,
    publishedBefore: null
  };

  if (publishedAfter) {
    console.log(`ì—…ë¡œë“œ ê¸°ê°„ í•„í„°ë§ ì ìš©ë¨: ${publishedAfter.toISOString()} ì´í›„`);
  }

  return result;
}

// YouTube duration (ISO 8601)ì„ ì´ˆë¡œ ë³€í™˜í•˜ëŠ” í•¨ìˆ˜
function parseDuration(duration) {
  const regex = /PT(?:(\d+)H)?(?:(\d+)M)?(?:(\d+)S)?/;
  const matches = duration.match(regex);

  if (!matches) return 0;

  const hours = parseInt(matches[1]) || 0;
  const minutes = parseInt(matches[2]) || 0;
  const seconds = parseInt(matches[3]) || 0;

  return hours * 3600 + minutes * 60 + seconds;
}

// ë™ì˜ìƒ ê¸¸ì´ ë¶„ë¥˜ í•¨ìˆ˜
function getVideoLengthCategory(durationInSeconds) {
  if (durationInSeconds < 60) return 'short1';       // 1ë¶„ ë¯¸ë§Œ
  if (durationInSeconds < 240) return 'short2';      // 1ë¶„ ì´ìƒ 4ë¶„ ë¯¸ë§Œ
  if (durationInSeconds < 600) return 'mid1';        // 4ë¶„ ì´ìƒ 10ë¶„ ë¯¸ë§Œ
  if (durationInSeconds < 1200) return 'mid2';       // 10ë¶„ ì´ìƒ 20ë¶„ ë¯¸ë§Œ
  if (durationInSeconds < 1800) return 'long1';      // 20ë¶„ ì´ìƒ 30ë¶„ ë¯¸ë§Œ
  if (durationInSeconds < 2400) return 'long2';      // 30ë¶„ ì´ìƒ 40ë¶„ ë¯¸ë§Œ
  if (durationInSeconds < 3000) return 'long3';      // 40ë¶„ ì´ìƒ 50ë¶„ ë¯¸ë§Œ
  if (durationInSeconds < 3600) return 'long4';      // 50ë¶„ ì´ìƒ 60ë¶„ ë¯¸ë§Œ
  if (durationInSeconds < 5400) return 'long5';      // 60ë¶„ ì´ìƒ 90ë¶„ ë¯¸ë§Œ
  return 'long6';                                    // 90ë¶„ ì´ìƒ
}

// ì„ íƒëœ ê¸¸ì´ ì¹´í…Œê³ ë¦¬ì™€ ë§¤ì¹˜ë˜ëŠ”ì§€ í™•ì¸
function matchesVideoLength(videoLengthCategory, selectedLengths) {
  if (!selectedLengths || selectedLengths.length === 0) return true;
  return selectedLengths.includes(videoLengthCategory);
}

// ë¸Œëœë“œ ì±„ë„ ê°ì§€ í•¨ìˆ˜
function isBrandChannel(result) {
  const channelName = result.youtube_channel_name || '';
  const subscriberCount = parseInt(result.subscriber_count) || 0;

  // êµ¬ë…ì ìˆ˜ê°€ 100ë§Œ ì´ìƒì´ë©´ ë¸Œëœë“œ ì±„ë„ë¡œ íŒë³„
  if (subscriberCount >= 1000000) {
    return true;
  }

  // íŠ¹ì • í‚¤ì›Œë“œê°€ í¬í•¨ëœ ê²½ìš° ë¸Œëœë“œ ì±„ë„ë¡œ íŒë³„
  const brandKeywords = [
    'official', 'entertainment', 'music', 'news', 'media',
    'tv', 'channel', 'network', 'studios', 'productions',
    'ê³µì‹', 'ì—”í„°í…Œì¸ë¨¼íŠ¸', 'ë®¤ì§', 'ë‰´ìŠ¤', 'ë¯¸ë””ì–´'
  ];

  const lowerChannelName = channelName.toLowerCase();
  return brandKeywords.some(keyword => lowerChannelName.includes(keyword));
}

// ì±„ë„ êµ­ì  ì •ë³´ ê°€ì ¸ì˜¤ê¸°
async function getChannelCountry(channelId) {
  try {
    const youtubeInstance = apiKeyManager.getYouTubeInstance();
    const channelResponse = await youtubeInstance.youtube.channels.list({
      part: 'snippet,brandingSettings',
      id: channelId
    });

    if (channelResponse.data.items && channelResponse.data.items.length > 0) {
      const channelData = channelResponse.data.items[0];
    
      // êµ­ì  ì •ë³´ ì¶”ì¶œ (snippet.country ë˜ëŠ” brandingSettings.channel.country)
      let channelCountry = channelData.snippet.country || 
                          channelData.brandingSettings?.channel?.country || 
                          'unknown';
    
      console.log(`ğŸŒ ì±„ë„ êµ­ì : ${channelCountry} (${channelId})`);
      return channelCountry;
    }
    
    return 'unknown';

  } catch (error) {
    console.error(`âŒ ì±„ë„ êµ­ì  ì¡°íšŒ ì˜¤ë¥˜ (${channelId}):`, error.message);
    return 'unknown';
  }
}

// ì±„ë„ ê°œì„¤ì¼ ê°€ì ¸ì˜¤ê¸° (ìƒˆ ê¸°ëŠ¥) - ë””ë²„ê¹… ê°•í™”
async function getChannelCreatedDate(channelId) {
  try {
    const youtubeInstance = apiKeyManager.getYouTubeInstance();
    const currentKey = youtubeInstance.currentKey;

    console.log(`ğŸ” ì±„ë„ ê°œì„¤ì¼ API í˜¸ì¶œ: ${channelId} (í‚¤: ${currentKey.name})`);
    
    // snippetê³¼ contentDetailsë¥¼ ëª¨ë‘ ìš”ì²­í•˜ì—¬ ë” ë§ì€ ì •ë³´ í™•ì¸
    const channelResponse = await youtubeInstance.youtube.channels.list({
      part: 'snippet,contentDetails,statistics,status',
      id: channelId
    });
    
    console.log(`ğŸ“¡ API ì‘ë‹µ ìƒíƒœ: ${channelResponse.status}`);
    console.log(`ğŸ“¦ ì‘ë‹µ ë°ì´í„°:`, {
      itemsCount: channelResponse.data.items?.length || 0,
      channelId: channelId,
      hasSnippet: !!channelResponse.data.items?.[0]?.snippet,
      publishedAt: channelResponse.data.items?.[0]?.snippet?.publishedAt,
      channelTitle: channelResponse.data.items?.[0]?.snippet?.title,
      hasContentDetails: !!channelResponse.data.items?.[0]?.contentDetails,
      hasStatistics: !!channelResponse.data.items?.[0]?.statistics,
      hasStatus: !!channelResponse.data.items?.[0]?.status
    });
    
    // ì „ì²´ snippet ì •ë³´ ì¶œë ¥ (ë””ë²„ê¹…ìš©)
    if (channelResponse.data.items?.[0]?.snippet) {
      console.log(`ğŸ” ì „ì²´ snippet ì •ë³´:`, JSON.stringify(channelResponse.data.items[0].snippet, null, 2));
    }
    
    if (channelResponse.data.items && channelResponse.data.items.length > 0) {
      const channelData = channelResponse.data.items[0];
      const publishedAt = channelData.snippet.publishedAt;
    
      // ìœ íš¨í•œ ë‚ ì§œì¸ì§€ ê²€ì¦ (1970.01.01 ë°©ì§€)
      let validCreatedDate = null;
      if (publishedAt) {
        const dateObj = new Date(publishedAt);
        const year = dateObj.getFullYear();
    
        // 1980ë…„ ì´ì „ ë‚ ì§œëŠ” ìœ íš¨í•˜ì§€ ì•Šë‹¤ê³  íŒë‹¨ (YouTubeëŠ” 2005ë…„ ì°½ë¦½)
        if (year >= 1980 && !isNaN(dateObj.getTime())) {
          validCreatedDate = publishedAt;
        } else {
          console.log(`âš ï¸ ìœ íš¨í•˜ì§€ ì•Šì€ ì±„ë„ ê°œì„¤ì¼ ê°ì§€: ${publishedAt} (${channelId})`);
        }
      }
    
      return validCreatedDate;
    }
    
    return null;

  } catch (error) {
    console.error(`âŒ ì±„ë„ ê°œì„¤ì¼ ì¡°íšŒ ì˜¤ë¥˜ (${channelId}):`, error.message);
    console.error(`ğŸ” ì˜¤ë¥˜ ìƒì„¸ ì •ë³´:`, {
      errorCode: error.code,
      errorStatus: error.status,
      errorDetails: error.errors?.[0]?.reason,
      channelId: channelId
    });

    // suspended í‚¤ì¸ ê²½ìš° ë‹¤ë¥¸ í‚¤ë¡œ ì¬ì‹œë„
    if (error.message.includes('suspended') || error.message.includes('has been suspended')) {
      console.log(`ğŸš¨ ì±„ë„ ê°œì„¤ì¼ ì¡°íšŒ ì¤‘ suspended í‚¤ ê°ì§€, ë‹¤ë¥¸ í‚¤ë¡œ ì¬ì‹œë„: ${channelId}`);
      try {
        const youtubeInstance = apiKeyManager.getYouTubeInstance();
        const channelResponse = await youtubeInstance.youtube.channels.list({
          part: 'snippet,contentDetails,statistics,status',
          id: channelId
        });
    
        if (channelResponse.data.items && channelResponse.data.items.length > 0) {
          const publishedAt = channelResponse.data.items[0].snippet.publishedAt;
    
          // ìœ íš¨í•œ ë‚ ì§œì¸ì§€ ê²€ì¦ (ì¬ì‹œë„ì—ì„œë„ ë™ì¼í•˜ê²Œ ì ìš©)
          if (publishedAt) {
            const dateObj = new Date(publishedAt);
            const year = dateObj.getFullYear();
    
            if (year >= 1980 && !isNaN(dateObj.getTime())) {
              return publishedAt;
            } else {
              console.log(`âš ï¸ ì¬ì‹œë„ì—ì„œë„ ìœ íš¨í•˜ì§€ ì•Šì€ ì±„ë„ ê°œì„¤ì¼: ${publishedAt} (${channelId})`);
            }
          }
        }
      } catch (retryError) {
        console.error(`ì±„ë„ ê°œì„¤ì¼ ì¬ì‹œë„ ì‹¤íŒ¨ (${channelId}):`, retryError.message);
      }
    }
    // Permission Deny ì˜¤ë¥˜ì¸ ê²½ìš° ë‹¤ë¥¸ í‚¤ë¡œ ì¬ì‹œë„
    else if (error.message.includes('permission') || error.message.includes('denied') || 
             error.message.includes('forbidden') || error.code === 403) {
      console.log(`ğŸš« ì±„ë„ ê°œì„¤ì¼ ì¡°íšŒ ì¤‘ PERMISSION DENY ê°ì§€: ${channelId}`);
      console.log(`ğŸ“ ê¶Œí•œ ì˜¤ë¥˜ ìƒì„¸: ${error.message}`);
      try {
        const youtubeInstance = apiKeyManager.getYouTubeInstance();
        const channelResponse = await youtubeInstance.youtube.channels.list({
          part: 'snippet,contentDetails,statistics,status',
          id: channelId
        });
    
        if (channelResponse.data.items && channelResponse.data.items.length > 0) {
          const publishedAt = channelResponse.data.items[0].snippet.publishedAt;
    
          if (publishedAt) {
            const dateObj = new Date(publishedAt);
            const year = dateObj.getFullYear();
    
            if (year >= 1980 && !isNaN(dateObj.getTime())) {
              console.log(`âœ… Permission Deny ìš°íšŒ ì„±ê³µ - ì±„ë„ ê°œì„¤ì¼ ì¡°íšŒë¨: ${channelId}`);
              return publishedAt;
            }
          }
        }
      } catch (retryError) {
        console.error(`ì±„ë„ ê°œì„¤ì¼ Permission Deny ì¬ì‹œë„ ì‹¤íŒ¨ (${channelId}):`, retryError.message);
      }
    }
    
    return null;

  }
}

// ì±„ë„ ì„¤ëª… ê°€ì ¸ì˜¤ê¸°
async function getChannelDescription(channelId) {
  try {
    const youtubeInstance = apiKeyManager.getYouTubeInstance();

    const channelResponse = await youtubeInstance.youtube.channels.list({
      part: 'snippet',
      id: channelId
    });
    
    if (channelResponse.data.items && channelResponse.data.items.length > 0) {
      const description = channelResponse.data.items[0].snippet.description;
      return description || '';
    }
    
    return '';

  } catch (error) {
    console.error(`ì±„ë„ ì„¤ëª… ì¡°íšŒ ì˜¤ë¥˜ (${channelId}):`, error.message);
    return '';
  }
}

// ë¬´ë£Œ RPM ì¶”ì • ë¡œì§ (Phase 1 & 2 í†µí•©)
function calculateFreeRPM(videoData) {
  try {
    // 1. ê¸°ë³¸ êµ­ê°€ë³„ RPM í…Œì´ë¸” (USD ê¸°ì¤€)
    const baseRPM = {
      'US': 3.5, 'KR': 2.8, 'JP': 3.2, 'DE': 3.0, 'GB': 3.8,
      'CA': 3.3, 'AU': 3.6, 'FR': 2.9, 'IT': 2.4, 'ES': 2.1,
      'NL': 3.1, 'SE': 3.4, 'NO': 4.2, 'DK': 3.3, 'FI': 3.0,
      'BR': 1.8, 'MX': 1.9, 'AR': 1.5, 'IN': 1.2, 'ID': 1.1,
      'TH': 1.4, 'VN': 1.0, 'PH': 1.3, 'MY': 1.6, 'SG': 2.8,
      'worldwide': 2.5
    };

    // 2. ì¹´í…Œê³ ë¦¬ë³„ ë°°ìœ¨ (Phase 2 ì„¸ë¶„í™” - 40ê°œ ì¹´í…Œê³ ë¦¬)
    const categoryMultiplier = {
      // ê¸°ë³¸ ì¹´í…Œê³ ë¦¬
      'News & Politics': 1.5, 'Education': 1.3, 'Science & Technology': 1.4,
      'Finance': 1.8, 'Business': 1.6, 'Autos & Vehicles': 1.2,
      'Travel & Events': 1.1, 'Howto & Style': 1.0, 'People & Blogs': 0.9,
      'Entertainment': 0.8, 'Music': 0.7, 'Gaming': 0.9,
      'Sports': 1.0, 'Film & Animation': 0.8, 'Comedy': 0.8,
      'Pets & Animals': 0.9, 'Nonprofits & Activism': 0.7,
    
      // ì„¸ë¶€ ì¹´í…Œê³ ë¦¬ ì¶”ê°€ (Phase 2)
      'Tech Reviews': 1.6, 'Crypto & Investment': 2.0, 'Real Estate': 1.7,
      'Online Learning': 1.4, 'Programming Tutorial': 1.5, 'Medical & Health': 1.3,
      'Luxury Cars': 1.4, 'Electric Vehicles': 1.3, 'Travel Vlog': 1.0,
      'Beauty & Makeup': 1.1, 'Fashion': 1.0, 'Fitness': 1.1,
      'ASMR': 0.6, 'Kids Content': 0.5, 'Music Cover': 0.6,
      'Esports': 1.1, 'Mobile Games': 0.8, 'PC Games': 0.9,
      'Cooking': 1.0, 'DIY': 1.1, 'Art & Crafts': 0.9,
      'Language Learning': 1.3, 'Stock Trading': 1.9, 'Insurance': 1.9,
      'Cryptocurrency': 2.0, 'Personal Finance': 1.7, 'Business Strategy': 1.6,
      'Marketing': 1.5, 'Productivity': 1.4, 'Self Development': 1.2,
      'Documentary': 1.2, 'True Crime': 1.0, 'History': 1.1,
      'Philosophy': 1.0, 'Psychology': 1.2, 'Motivation': 1.1
    };
    
    const country = videoData.country || 'worldwide';
    const category = videoData.primary_category || 'Entertainment';
    const views = parseInt(videoData.daily_view_count) || 0;
    
    // ê¸°ë³¸ RPM ê³„ì‚°
    let rpm = baseRPM[country] || baseRPM['worldwide'];
    rpm *= categoryMultiplier[category] || 1.0;
    
    // 3. ì¡°íšŒìˆ˜ ê¸°ë°˜ ê°€ì¤‘ì¹˜
    let viewMultiplier = 1.0;
    if (views < 10000) viewMultiplier = 0.7;          // ë§ˆì´í¬ë¡œ
    else if (views < 100000) viewMultiplier = 0.85;   // ìŠ¤ëª°
    else if (views < 1000000) viewMultiplier = 1.0;   // ë¯¸ë””ì—„
    else if (views < 10000000) viewMultiplier = 1.15; // ë¼ì§€
    else viewMultiplier = 1.3;                        // ë©”ê°€
    
    // Phase 1-1. ì‹œì²­ ì‹œê°„ ê°€ì¤‘ì¹˜ ì¶”ê°€
    const durationSeconds = parseInt(videoData.duration_seconds) || 0;
    let durationMultiplier = 1.0;
    if (durationSeconds < 60) durationMultiplier = 0.8;        // Shorts (ë‚®ì€ RPM)
    else if (durationSeconds < 300) durationMultiplier = 1.0;  // 5ë¶„ ë¯¸ë§Œ (í‘œì¤€)
    else if (durationSeconds < 600) durationMultiplier = 1.15; // 5-10ë¶„ (ìµœì )
    else if (durationSeconds < 1200) durationMultiplier = 1.25; // 10-20ë¶„ (ë†’ì€ RPM)
    else durationMultiplier = 1.1;                             // 20ë¶„ ì´ìƒ (ì•½ê°„ ê°ì†Œ)
    
    // 4. ì±„ë„ ì„±ìˆ™ë„ (ì±„ë„ ìƒì„±ì¼ ê¸°ë°˜)
    let ageMultiplier = 1.0;
    if (videoData.channel_created_date) {
      const channelAge = (Date.now() - new Date(videoData.channel_created_date)) / (365 * 24 * 60 * 60 * 1000);
      ageMultiplier = Math.min(1.2, 0.8 + (channelAge * 0.1));
    }
    
    // Phase 1-2. êµ¬ë…ì ë¹„ìœ¨ ë¶„ì„ ì¶”ê°€
    const subscriberCount = parseInt(videoData.subscriber_count) || 0;
    let subscriberMultiplier = 1.0;
    if (views > 0 && subscriberCount > 0) {
      const viewToSubscriberRatio = views / subscriberCount;
      if (viewToSubscriberRatio < 0.1) subscriberMultiplier = 0.85;       // ë‚®ì€ ë„ë‹¬ë¥ 
      else if (viewToSubscriberRatio < 0.5) subscriberMultiplier = 1.0;   // í‘œì¤€ ë„ë‹¬ë¥ 
      else if (viewToSubscriberRatio < 2.0) subscriberMultiplier = 1.15;  // ë†’ì€ ë„ë‹¬ë¥ 
      else if (viewToSubscriberRatio < 10.0) subscriberMultiplier = 1.3;  // ë°”ì´ëŸ´ ì½˜í…ì¸ 
      else subscriberMultiplier = 1.45;                                   // ìŠˆí¼ ë°”ì´ëŸ´
    }
    
    // Phase 1-3. ê³„ì ˆì„± íŒ¨í„´ ë°˜ì˜ ì¶”ê°€
    const currentMonth = new Date().getMonth() + 1; // 1-12ì›”
    let seasonalMultiplier = 1.0;
    if (currentMonth >= 10 && currentMonth <= 12) seasonalMultiplier = 1.25; // Q4 ìµœê³  (ê´‘ê³ ë¹„ ì„±ìˆ˜ê¸°)
    else if (currentMonth >= 1 && currentMonth <= 3) seasonalMultiplier = 1.15; // Q1 ë†’ìŒ
    else if (currentMonth >= 4 && currentMonth <= 6) seasonalMultiplier = 1.05; // Q2 ë³´í†µ
    else seasonalMultiplier = 0.9; // Q3 ë‚®ìŒ (ì—¬ë¦„ì²  ê´‘ê³ ë¹„ ê°ì†Œ)
    
    // Phase 2. ì°¸ì—¬ë„ ì ìˆ˜ ê°œì„  (ì¢‹ì•„ìš” ê¸°ë°˜ ì¶”ì •)
    let engagementMultiplier = 1.0;
    if (videoData.actual_like_count && views > 0) {
      const likeRate = videoData.actual_like_count / views;
      // ì¢‹ì•„ìš” ë¹„ìœ¨ì— ë”°ë¥¸ ê°€ì¤‘ì¹˜ (0.8 ~ 1.2 ë²”ìœ„)
      engagementMultiplier = 0.8 + Math.min(0.4, likeRate * 400); // 1% ì¢‹ì•„ìš”ìœ¨ = ìµœëŒ€ ê°€ì¤‘ì¹˜
    }
    
    // 7. ìµœì¢… RPM ê³„ì‚° (Phase 1 & 2 ëª¨ë“  ìš”ì†Œ í¬í•¨)
    const finalRPM = rpm * viewMultiplier * durationMultiplier * ageMultiplier * 
                     subscriberMultiplier * seasonalMultiplier * engagementMultiplier;
    
    return Math.round(finalRPM * 100) / 100; // ì†Œìˆ˜ì  2ìë¦¬

  } catch (error) {
    console.error('RPM ê³„ì‚° ì˜¤ë¥˜:', error);
    return 2.5; // ê¸°ë³¸ê°’
  }
}

// Analytics ì¶”ì • ê³„ì‚° ë©”ì¸ í•¨ìˆ˜
function calculateEstimatedAnalytics(videoData) {
  try {
    const estimatedRPM = calculateFreeRPM(videoData);
    const views = parseInt(videoData.daily_view_count) || 0;
    const duration = parseInt(videoData.duration_seconds) || 0;
    const subscriberCount = parseInt(videoData.subscriber_count) || 0;

    return {
      views: views, // ì‹¤ì œ ì¡°íšŒìˆ˜ (ê³µê°œ ë°ì´í„°)
      estimatedMinutesWatched: calculateEstimatedWatchTime(views, duration, videoData),
      averageViewDuration: calculateAverageViewDuration(duration, videoData),
      subscribersGained: calculateSubscribersGained(views, subscriberCount, videoData),
      adImpressions: calculateAdImpressions(views, videoData),
      estimatedRevenue: Math.round((views * estimatedRPM / 1000) * 100) / 100,
      estimatedAdRevenue: Math.round((views * estimatedRPM / 1000) * 0.85 * 100) / 100,
      estimatedRedPartnerRevenue: Math.round((views * estimatedRPM / 1000) * 0.15 * 100) / 100,
      playbackBasedCpm: calculatePlaybackCPM(estimatedRPM, videoData),
      adCpm: calculateAdCPM(estimatedRPM, videoData)
    };

  } catch (error) {
    console.log('Analytics ì¶”ì • ê³„ì‚° ì˜¤ë¥˜:', error.message);
    return {
      views: 0, estimatedMinutesWatched: 0, averageViewDuration: 0,
      subscribersGained: 0, adImpressions: 0, estimatedRevenue: 0,
      estimatedAdRevenue: 0, estimatedRedPartnerRevenue: 0,
      playbackBasedCpm: 0, adCpm: 0
    };
  }
}

// ì¶”ì • ì‹œì²­ ì‹œê°„ ê³„ì‚° (ë¶„ ë‹¨ìœ„)
function calculateEstimatedWatchTime(views, duration, videoData) {
  try {
    const avgViewDuration = calculateAverageViewDuration(duration, videoData);
    const totalWatchSeconds = views * avgViewDuration;
    return Math.round(totalWatchSeconds / 60); // ë¶„ ë‹¨ìœ„ë¡œ ë³€í™˜
  } catch (error) {
    return 0;
  }
}

// í‰ê·  ì‹œì²­ ì‹œê°„ ê³„ì‚° (ì´ˆ ë‹¨ìœ„)
function calculateAverageViewDuration(duration, videoData) {
  try {
    const category = videoData.primary_category || 'Entertainment';

    // ì¹´í…Œê³ ë¦¬ë³„ ì™„ì‹œì²­ë¥  íŒ¨í„´
    const retentionRates = {
      'Finance': 0.65, 'Business': 0.60, 'News & Politics': 0.55,
      'Science & Technology': 0.58, 'Education': 0.62, 'Howto & Style': 0.52,
      'Gaming': 0.48, 'Entertainment': 0.45, 'Music': 0.35,
      'Comedy': 0.42, 'Sports': 0.50, 'ASMR': 0.70, 'Kids Content': 0.40
    };
    
    // ë™ì˜ìƒ ê¸¸ì´ë³„ ì™„ì‹œì²­ë¥  ì¡°ì •
    let durationMultiplier = 1.0;
    if (duration < 60) durationMultiplier = 0.9;        // Shorts
    else if (duration < 300) durationMultiplier = 1.0;  // 5ë¶„ ë¯¸ë§Œ
    else if (duration < 600) durationMultiplier = 0.85; // 5-10ë¶„
    else if (duration < 1200) durationMultiplier = 0.7; // 10-20ë¶„
    else durationMultiplier = 0.6;                      // 20ë¶„ ì´ìƒ
    
    const baseRetention = retentionRates[category] || 0.45;
    const finalRetention = baseRetention * durationMultiplier;
    
    return Math.round(duration * finalRetention);

  } catch (error) {
    return Math.round(duration * 0.45); // ê¸°ë³¸ 45% ì™„ì‹œì²­ë¥ 
  }
}

// ì‹ ê·œ êµ¬ë…ì ìˆ˜ ì¶”ì •
function calculateSubscribersGained(views, subscriberCount, videoData) {
  try {
    const category = videoData.primary_category || 'Entertainment';

    // ì¹´í…Œê³ ë¦¬ë³„ êµ¬ë… ì „í™˜ìœ¨
    const conversionRates = {
      'Education': 0.008, 'Howto & Style': 0.007, 'Science & Technology': 0.006,
      'Finance': 0.005, 'Business': 0.005, 'Gaming': 0.004,
      'Entertainment': 0.003, 'Music': 0.002, 'Comedy': 0.003,
      'ASMR': 0.009, 'Kids Content': 0.001
    };
    
    // ì±„ë„ í¬ê¸°ë³„ êµ¬ë… ì „í™˜ìœ¨ ì¡°ì •
    let sizeMultiplier = 1.0;
    if (subscriberCount < 1000) sizeMultiplier = 1.5;      // ì†Œí˜• ì±„ë„
    else if (subscriberCount < 10000) sizeMultiplier = 1.2; // ì¤‘ì†Œí˜• ì±„ë„
    else if (subscriberCount < 100000) sizeMultiplier = 1.0; // ì¤‘í˜• ì±„ë„
    else if (subscriberCount < 1000000) sizeMultiplier = 0.8; // ëŒ€í˜• ì±„ë„
    else sizeMultiplier = 0.6;                              // ë©”ê°€ ì±„ë„
    
    const baseConversion = conversionRates[category] || 0.003;
    const finalConversion = baseConversion * sizeMultiplier;
    
    return Math.round(views * finalConversion);

  } catch (error) {
    return Math.round(views * 0.003); // ê¸°ë³¸ 0.3% ì „í™˜ìœ¨
  }
}

// ê´‘ê³  ë…¸ì¶œ ìˆ˜ ì¶”ì •
function calculateAdImpressions(views, videoData) {
  try {
    const category = videoData.primary_category || 'Entertainment';
    const duration = parseInt(videoData.duration_seconds) || 0;

    // ì¹´í…Œê³ ë¦¬ë³„ ê´‘ê³  ë…¸ì¶œë¥ 
    const adRates = {
      'Finance': 0.95, 'Business': 0.92, 'News & Politics': 0.90,
      'Science & Technology': 0.88, 'Education': 0.85, 'Howto & Style': 0.82,
      'Gaming': 0.75, 'Entertainment': 0.80, 'Music': 0.70,
      'Comedy': 0.78, 'ASMR': 0.60, 'Kids Content': 0.40
    };
    
    // ë™ì˜ìƒ ê¸¸ì´ë³„ ê´‘ê³  ê°œìˆ˜
    let adsPerView = 1.0;
    if (duration < 60) adsPerView = 0.8;        // Shorts
    else if (duration < 300) adsPerView = 1.0;  // 5ë¶„ ë¯¸ë§Œ
    else if (duration < 600) adsPerView = 1.5;  // 5-10ë¶„
    else if (duration < 1200) adsPerView = 2.0; // 10-20ë¶„
    else adsPerView = 2.5;                      // 20ë¶„ ì´ìƒ
    
    const adRate = adRates[category] || 0.80;
    const totalAds = views * adRate * adsPerView;
    
    return Math.round(totalAds);

  } catch (error) {
    return Math.round(views * 0.80); // ê¸°ë³¸ 80% ê´‘ê³  ë…¸ì¶œë¥ 
  }
}

// ì¬ìƒ ê¸°ë°˜ CPM ê³„ì‚°
function calculatePlaybackCPM(estimatedRPM, videoData) {
  try {
    const duration = parseInt(videoData.duration_seconds) || 0;

    // ì¬ìƒ ì‹œê°„ë³„ CPM ë°°ìœ¨ (CPMì´ RPMë³´ë‹¤ ë†’ì•„ì•¼ í•¨)
    let playbackMultiplier = 1.35; // ê¸°ë³¸ 35% ë†’ìŒ
    if (duration < 60) playbackMultiplier = 1.25;       // Shorts
    else if (duration < 300) playbackMultiplier = 1.35; // 5ë¶„ ë¯¸ë§Œ
    else if (duration < 600) playbackMultiplier = 1.45; // 5-10ë¶„
    else if (duration < 1200) playbackMultiplier = 1.55; // 10-20ë¶„
    else playbackMultiplier = 1.6;                      // 20ë¶„ ì´ìƒ
    
    const playbackCPM = estimatedRPM * playbackMultiplier;
    return Math.round(playbackCPM * 100) / 100;

  } catch (error) {
    return (estimatedRPM || 2.5) * 1.35;
  }
}

// ê´‘ê³  CPM ê³„ì‚°
function calculateAdCPM(estimatedRPM, videoData) {
  try {
    const category = videoData.primary_category || 'Entertainment';

    // ì¹´í…Œê³ ë¦¬ë³„ ê´‘ê³  CPM ë°°ìœ¨ (CPMì´ RPMë³´ë‹¤ ë†’ì•„ì•¼ í•¨)
    const adMultipliers = {
      'Finance': 2.1, 'Business': 1.9, 'Insurance': 2.3,
      'Real Estate': 2.0, 'Crypto & Investment': 2.2,
      'Science & Technology': 1.7, 'Education': 1.6,
      'Gaming': 1.4, 'Entertainment': 1.5, 'Music': 1.3,
      'ASMR': 1.2, 'Kids Content': 1.1
    };
    
    const adMultiplier = adMultipliers[category] || 1.5;
    const adCPM = estimatedRPM * adMultiplier;
    
    return Math.round(adCPM * 100) / 100;

  } catch (error) {
    return (estimatedRPM || 2.5) * 1.5;
  }
}

// ì±„ë„ êµ¬ë…ì ìˆ˜ ê°€ì ¸ì˜¤ê¸°
async function getChannelSubscriberCount(channelId) {
  try {
    const youtubeInstance = apiKeyManager.getYouTubeInstance();
    const currentKey = youtubeInstance.currentKey;
    const channelResponse = await youtubeInstance.youtube.channels.list({
      part: 'statistics',
      id: channelId
    });

    if (channelResponse.data.items && channelResponse.data.items.length > 0) {
      const subscriberCount = channelResponse.data.items[0].statistics.subscriberCount;
      return parseInt(subscriberCount) || 0;
    }
    
    return 0;

  } catch (error) {
    console.error(`ì±„ë„ êµ¬ë…ì ìˆ˜ ì¡°íšŒ ì˜¤ë¥˜ (${channelId}):`, error.message);

    // suspended í‚¤ì¸ ê²½ìš° ë‹¤ë¥¸ í‚¤ë¡œ ì¬ì‹œë„
    if (error.message.includes('suspended') || error.message.includes('has been suspended')) {
      console.log(`ğŸš¨ ì±„ë„ êµ¬ë…ì ìˆ˜ ì¡°íšŒ ì¤‘ suspended í‚¤ ê°ì§€, ë‹¤ë¥¸ í‚¤ë¡œ ì¬ì‹œë„: ${channelId}`);
      try {
        const youtubeInstance = apiKeyManager.getYouTubeInstance();
        const channelResponse = await youtubeInstance.youtube.channels.list({
          part: 'statistics',
          id: channelId
        });
    
        if (channelResponse.data.items && channelResponse.data.items.length > 0) {
          const subscriberCount = channelResponse.data.items[0].statistics.subscriberCount;
          return parseInt(subscriberCount) || 0;
        }
      } catch (retryError) {
        console.error(`ì±„ë„ êµ¬ë…ì ìˆ˜ ì¬ì‹œë„ ì‹¤íŒ¨ (${channelId}):`, retryError.message);
      }
    }
    
    return 0;

  }
}

async function getCategoryName(categoryId) {
  try {
    const categories = {
      '1': 'Film & Animation',
      '2': 'Autos & Vehicles',
      '10': 'Music',
      '15': 'Pets & Animals',
      '17': 'Sports',
      '19': 'Travel & Events',
      '20': 'Gaming',
      '22': 'People & Blogs',
      '23': 'Comedy',
      '24': 'Entertainment',
      '25': 'News & Politics',
      '26': 'Howto & Style',
      '27': 'Education',
      '28': 'Science & Technology',
      '29': 'Nonprofits & Activism'
    };

    return categories[categoryId] || 'Other';

  } catch (error) {
    return 'Other';
  }
}

// ì•ˆì „í•œ íŒŒì¼ëª… ìƒì„± í•¨ìˆ˜ (í•œê¸€ ë³´ì¡´)
function createSafeFilename(filename) {
  if (!filename) return 'thumbnail.jpg';

  let safe = filename
    .replace(/[<>:"/\\|?*\x00-\x1f]/g, '_') // ìœ„í—˜í•œ ë¬¸ìë§Œ ì œê±°
    .replace(/\s+/g, '_')
    .replace(/_{2,}/g, '_')
    .replace(/^_+|_+$/g, '')
    .substring(0, 100);

  // íŒŒì¼ëª…ì´ ë¹„ì–´ìˆê±°ë‚˜ ë„ˆë¬´ ì§§ìœ¼ë©´ ê¸°ë³¸ê°’
  if (safe.length < 3) safe = 'thumbnail';

  if (!safe.match(/\.(jpg|jpeg|png|webp|gif)$/i)) {
    safe += '.jpg';
  }

  return safe;
}

// ì¸ë„¤ì¼ ë‹¤ìš´ë¡œë“œ API (ERR_INVALID_CHAR ì˜¤ë¥˜ í•´ê²°)
app.get('/api/download-thumbnail', async (req, res) => {
try {
const { url, filename } = req.query;

console.log('ğŸ“¥ ì¸ë„¤ì¼ ë‹¤ìš´ë¡œë“œ ìš”ì²­:', { url, filename });

if (!url) {
      return res.status(400).json({ error: 'URLì´ í•„ìš”í•©ë‹ˆë‹¤.' });
}

// ì•ˆì „í•œ íŒŒì¼ëª… ìƒì„±
const safeFilename = createSafeFilename(filename);
console.log('ğŸ”§ ì•ˆì „í•œ íŒŒì¼ëª… ìƒì„±:', { original: filename, safe: safeFilename });

    const response = await axios.get(url, { 
      responseType: 'stream',
      timeout: 10000  // 10ì´ˆ íƒ€ì„ì•„ì›ƒ
    });
    
    // ì•ˆì „í•œ íŒŒì¼ëª…ë§Œ í—¤ë”ì— ì„¤ì •
    res.setHeader('Content-Disposition', `attachment; filename="${safeFilename}"`);
    res.setHeader('Content-Type', response.headers['content-type'] || 'image/jpeg');
    res.setHeader('Content-Length', response.headers['content-length'] || '');
    
    response.data.pipe(res);
    
    console.log(`âœ… ì¸ë„¤ì¼ ë‹¤ìš´ë¡œë“œ ì„±ê³µ: ${safeFilename}`);

  } catch (error) {
    console.error('ì¸ë„¤ì¼ ë‹¤ìš´ë¡œë“œ ì˜¤ë¥˜:', error);

    // êµ¬ì²´ì ì¸ ì˜¤ë¥˜ ì²˜ë¦¬
    if (error.code === 'ERR_INVALID_CHAR') {
      console.error('âŒ Content-Disposition í—¤ë” ì˜¤ë¥˜:', {
        originalFilename: req.query.filename,
        url: req.query.url,
        error: error.message
      });
      res.status(400).json({ 
        error: 'íŒŒì¼ëª…ì— ì‚¬ìš©í•  ìˆ˜ ì—†ëŠ” ë¬¸ìê°€ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤.',
        details: 'Invalid characters in filename for HTTP header'
      });
    } else if (error.response) {
      console.error('âŒ ì™¸ë¶€ ì„œë²„ ì˜¤ë¥˜:', error.response.status, error.response.statusText);
      res.status(502).json({ 
        error: 'ì¸ë„¤ì¼ ì„œë²„ì—ì„œ ì´ë¯¸ì§€ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.',
        details: `HTTP ${error.response.status}: ${error.response.statusText}`
      });
    } else if (error.request) {
      console.error('âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜:', error.message);
      res.status(503).json({ 
        error: 'ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ë¡œ ì¸ë„¤ì¼ ë‹¤ìš´ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.',
        details: 'Network timeout or connection error'
      });
    } else {
      console.error('âŒ ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜:', error.message);
      res.status(500).json({ 
        error: 'ì¸ë„¤ì¼ ë‹¤ìš´ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.',
        details: error.message
      });
    }

  }
});

// =================== ì¸ê¸°ê²€ìƒ‰ì–´ ë¶„ì„ API ===================

// ë¶ˆìš©ì–´ ë¦¬ìŠ¤íŠ¸ ì •ì˜
const STOPWORDS = {
  korean: [
    // ì¡°ì‚¬
    'ì´', 'ê°€', 'ì„', 'ë¥¼', 'ì—', 'ì—ì„œ', 'ìœ¼ë¡œ', 'ë¡œ', 'ì™€', 'ê³¼', 'ì˜', 'ë„', 'ë§Œ', 'ê¹Œì§€', 'ë¶€í„°', 'ë³´ë‹¤', 'ì²˜ëŸ¼', 'ê°™ì´', 'ì—ê²Œ', 'í•œí…Œ', 'ê»˜',
    // ì–´ë¯¸ ë° ì¡°ë™ì‚¬
    'í•˜ë‹¤', 'ë˜ë‹¤', 'ìˆë‹¤', 'ì—†ë‹¤', 'ê°™ë‹¤', 'ë‹¤ë¥¸', 'ê·¸ëŸ°', 'ì´ëŸ°', 'ì €ëŸ°', 'ì–´ë–¤', 'ë¬´ìŠ¨', 'ì•„ë¬´', 'ëª¨ë“ ', 'ì˜¨ê°–',
    // ëŒ€ëª…ì‚¬ ë° ì§€ì‹œì‚¬
    'ê·¸', 'ì´', 'ì €', 'ê²ƒ', 'ê±°', 'ìˆ˜', 'ë•Œ', 'ê³³', 'ë§', 'ì¼', 'ì ', 'ë“±', 'ë°', 'ë˜ëŠ”', 'í˜¹ì€', 'ê·¸ë¦¬ê³ ', 'í•˜ì§€ë§Œ', 'ê·¸ëŸ°ë°',
    // ìˆ«ì ë° ë‹¨ìœ„
    'í•˜ë‚˜', 'ë‘˜', 'ì…‹', 'ë„·', 'ë‹¤ì„¯', 'ê°œ', 'ëª…', 'ë²ˆ', 'ì°¨', 'íšŒ', 'ë…„', 'ì›”', 'ì¼', 'ì‹œ', 'ë¶„', 'ì´ˆ',
    // YouTube íŠ¹í™” ë¶ˆìš©ì–´
    'ë™ì˜ìƒ', 'ì˜ìƒ', 'ë¹„ë””ì˜¤', 'ì±„ë„', 'êµ¬ë…', 'ì¢‹ì•„ìš”', 'ëŒ“ê¸€', 'ì¡°íšŒìˆ˜', 'ì¬ìƒ', 'ì—…ë¡œë“œ', 'ë‹¤ìš´ë¡œë“œ',
    '1ë¶€', '2ë¶€', '3ë¶€', '4ë¶€', '5ë¶€', 'ìƒí¸', 'í•˜í¸', 'ì „í¸', 'í›„í¸', 'ì™„ê²°', 'ì‹œì¦Œ', 'ì—í”¼ì†Œë“œ',
    // ì¼ë°˜ì ì¸ í˜•ìš©ì‚¬/ë¶€ì‚¬
    'ë§¤ìš°', 'ì •ë§', 'ì§„ì§œ', 'ë„ˆë¬´', 'ì•„ì£¼', 'ì™„ì „', 'ì—„ì²­', 'ëŒ€ë°•', 'ìµœê³ ', 'ìµœì‹ ', 'ì‹ ê·œ', 'ìƒˆë¡œìš´'
  ],
  english: [
    // ê´€ì‚¬
    'a', 'an', 'the',
    // ì „ì¹˜ì‚¬
    'in', 'on', 'at', 'by', 'for', 'with', 'without', 'to', 'from', 'of', 'about', 'into', 'through', 'during', 'before', 'after', 'above', 'below', 'up', 'down', 'out', 'off', 'over', 'under', 'again', 'further', 'then', 'once',
    // ì ‘ì†ì‚¬
    'and', 'or', 'but', 'so', 'because', 'if', 'when', 'while', 'where', 'why', 'how', 'what', 'which', 'who', 'whom', 'whose',
    // ëŒ€ëª…ì‚¬
    'i', 'you', 'he', 'she', 'it', 'we', 'they', 'me', 'him', 'her', 'us', 'them', 'my', 'your', 'his', 'her', 'its', 'our', 'their', 'mine', 'yours', 'hers', 'ours', 'theirs',
    // ì§€ì‹œì‚¬
    'this', 'that', 'these', 'those', 'here', 'there', 'now', 'then',
    // beë™ì‚¬, ì¡°ë™ì‚¬
    'be', 'am', 'is', 'are', 'was', 'were', 'being', 'been', 'have', 'has', 'had', 'having', 'do', 'does', 'did', 'doing', 'will', 'would', 'could', 'should', 'may', 'might', 'must', 'can',
    // YouTube íŠ¹í™” ë¶ˆìš©ì–´
    'video', 'youtube', 'channel', 'subscribe', 'like', 'comment', 'view', 'watch', 'play', 'playlist', 'shorts', 'live', 'stream', 'upload', 'download',
    'part', 'ep', 'episode', 'season', 'series', 'full', 'complete', 'official', 'new', 'latest', 'update', 'review', 'reaction',
    // ì¼ë°˜ì ì¸ í˜•ìš©ì‚¬/ë¶€ì‚¬
    'very', 'really', 'quite', 'pretty', 'much', 'many', 'most', 'more', 'less', 'few', 'little', 'big', 'small', 'large', 'great', 'good', 'bad', 'best', 'worst', 'better', 'worse', 'first', 'last', 'next', 'previous', 'other', 'another', 'some', 'any', 'no', 'not'
  ],
  years: ['2020', '2021', '2022', '2023', '2024', '2025', '2026'],
  common: ['1', '2', '3', '4', '5', '6', '7', '8', '9', '0', 'vs', 'v']
};

// êµ¬ë‘ì  ë° íŠ¹ìˆ˜ë¬¸ì ì •ê·œì‹
const PUNCTUATION_REGEX = /[.,!?;:'""`()[\]{}#@$%^&*+=|\\\/~\-_<>""''â€"Â«Â»]/g;
const EMOJI_REGEX = /[\u{1F600}-\u{1F64F}]|[\u{1F300}-\u{1F5FF}]|[\u{1F680}-\u{1F6FF}]|[\u{1F1E0}-\u{1F1FF}]|[\u{2600}-\u{26FF}]|[\u{2700}-\u{27BF}]/gu;

// í‚¤ì›Œë“œ ì •ì œ í•¨ìˆ˜
function cleanKeyword(keyword) {
  if (!keyword || typeof keyword !== 'string') return '';

  // ì†Œë¬¸ì ë³€í™˜
  let cleaned = keyword.toLowerCase().trim();

  // êµ¬ë‘ì  ë° ì´ëª¨ì§€ ì œê±°
  cleaned = cleaned.replace(PUNCTUATION_REGEX, ' ');
  cleaned = cleaned.replace(EMOJI_REGEX, ' ');

  // ì—¬ëŸ¬ ê³µë°±ì„ í•˜ë‚˜ë¡œ ì •ë¦¬
  cleaned = cleaned.replace(/\s+/g, ' ').trim();

  return cleaned;
}

// ë¶ˆìš©ì–´ í•„í„°ë§ í•¨ìˆ˜
function filterStopwords(keywords) {
  const allStopwords = new Set([
    ...STOPWORDS.korean,
    ...STOPWORDS.english,
    ...STOPWORDS.years,
    ...STOPWORDS.common
  ]);

  return keywords.filter(keyword => {
    const cleaned = cleanKeyword(keyword);

    // ë¹ˆ ë¬¸ìì—´, ìˆ«ìë§Œ ìˆëŠ” ë¬¸ìì—´, í•œ ê¸€ì ë¬¸ìì—´ ì œê±°
    if (!cleaned || cleaned.length <= 1 || /^\d+$/.test(cleaned)) {
      return false;
    }
    
    // ë¶ˆìš©ì–´ ì²´í¬
    if (allStopwords.has(cleaned)) {
      return false;
    }
    
    // ë‹¨ì–´ë³„ë¡œ ì²´í¬ (ë³µí•©ì–´ ì²˜ë¦¬)
    const words = cleaned.split(' ');
    const meaningfulWords = words.filter(word => 
      word.length > 1 && !allStopwords.has(word) && !/^\d+$/.test(word)
    );
    
    return meaningfulWords.length > 0;

  });
}

// í‚¤ì›Œë“œ ì¶”ì¶œ ë° ë¹ˆë„ ë¶„ì„ í•¨ìˆ˜
function extractKeywords(videos, requestedCount) {
  const keywordFreq = new Map();

  videos.forEach(video => {
    // ì œëª©ì—ì„œ í‚¤ì›Œë“œ ì¶”ì¶œ
    if (video.title) {
      const titleWords = video.title.split(/[\s\-_|:]+/);
      const cleanedTitle = filterStopwords(titleWords);

      cleanedTitle.forEach(word => {
        const cleaned = cleanKeyword(word);
        if (cleaned && cleaned.length > 1) {
          keywordFreq.set(cleaned, (keywordFreq.get(cleaned) || 0) + 3); // ì œëª©ì€ ê°€ì¤‘ì¹˜ 3
        }
      });
    }
    
    // íƒœê·¸ì—ì„œ í‚¤ì›Œë“œ ì¶”ì¶œ
    if (video.video_tags && Array.isArray(video.video_tags)) {
      const cleanedTags = filterStopwords(video.video_tags);
    
      cleanedTags.forEach(tag => {
        const cleaned = cleanKeyword(tag);
        if (cleaned && cleaned.length > 1) {
          keywordFreq.set(cleaned, (keywordFreq.get(cleaned) || 0) + 2); // íƒœê·¸ëŠ” ê°€ì¤‘ì¹˜ 2
        }
      });
    }
    
    // ì„¤ëª…ì—ì„œ í‚¤ì›Œë“œ ì¶”ì¶œ (ì²˜ìŒ 100ìë§Œ)
    if (video.description) {
      const descWords = video.description.substring(0, 100).split(/[\s\-_|:]+/);
      const cleanedDesc = filterStopwords(descWords);
    
      cleanedDesc.forEach(word => {
        const cleaned = cleanKeyword(word);
        if (cleaned && cleaned.length > 1) {
          keywordFreq.set(cleaned, (keywordFreq.get(cleaned) || 0) + 1); // ì„¤ëª…ì€ ê°€ì¤‘ì¹˜ 1
        }
      });
    }

  });

  // ë¹ˆë„ìˆœìœ¼ë¡œ ì •ë ¬í•˜ì—¬ ìƒìœ„ í‚¤ì›Œë“œ ë°˜í™˜
  const sortedKeywords = Array.from(keywordFreq.entries())
    .sort((a, b) => b[1] - a[1])
    .slice(0, requestedCount)
    .map(([word, frequency]) => ({ word, frequency }));

  return sortedKeywords;
}

// ì¸ê¸°ê²€ìƒ‰ì–´ ë¶„ì„ API ì—”ë“œí¬ì¸íŠ¸
app.post('/api/trending-keywords', async (req, res) => {
  try {
    const { count = 50, videoCount = 250 } = req.body;

    console.log(`ğŸ”¥ ì¸ê¸°ê²€ìƒ‰ì–´ ë¶„ì„ ì‹œì‘: ${count}ê°œ í‚¤ì›Œë“œ, ${videoCount}ê°œ ë™ì˜ìƒ ë¶„ì„`);
    
    // YouTube APIë¡œ ì¸ê¸° ë™ì˜ìƒ ìˆ˜ì§‘
    const videos = await fetchTrendingVideos(videoCount);
    
    if (!videos || videos.length === 0) {
      return res.status(404).json({
        success: false,
        error: 'ì¸ê¸° ë™ì˜ìƒì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.',
        keywords: [],
        videoCount: 0
      });
    }
    
    console.log(`ğŸ“Š ${videos.length}ê°œ ë™ì˜ìƒì—ì„œ í‚¤ì›Œë“œ ì¶”ì¶œ ì¤‘...`);
    
    // í‚¤ì›Œë“œ ì¶”ì¶œ ë° ë¶„ì„
    const keywords = extractKeywords(videos, count);
    
    console.log(`âœ… ${keywords.length}ê°œ ì¸ê¸° í‚¤ì›Œë“œ ì¶”ì¶œ ì™„ë£Œ`);
    console.log('ìƒìœ„ 10ê°œ í‚¤ì›Œë“œ:', keywords.slice(0, 10).map(k => `${k.word}(${k.frequency})`).join(', '));
    
    res.json({
      success: true,
      keywords: keywords,
      videoCount: videos.length,
      analysisInfo: `${videos.length}ê°œ ë™ì˜ìƒì—ì„œ ${keywords.length}ê°œ í‚¤ì›Œë“œ ë¶„ì„ ì™„ë£Œ`,
      timestamp: new Date().toISOString()
    });

  } catch (error) {
    console.error('ì¸ê¸°ê²€ìƒ‰ì–´ ë¶„ì„ ì˜¤ë¥˜:', error);
    res.status(500).json({
      success: false,
      error: error.message,
      keywords: [],
      videoCount: 0
    });
  }
});

// YouTube ì¸ê¸° ë™ì˜ìƒ ìˆ˜ì§‘ í•¨ìˆ˜
async function fetchTrendingVideos(maxResults = 250) {
  try {
    const youtubeInstance = apiKeyManager.getYouTubeInstance();

    // YouTube íŠ¸ë Œë”© ë™ì˜ìƒ ê²€ìƒ‰ (ì§€ì—­ë³„ë¡œ ë‹¤ì–‘í•˜ê²Œ)
    const regions = ['KR', 'US', 'GB', 'JP', 'DE', 'FR']; // ì£¼ìš” êµ­ê°€ë“¤
    const allVideos = [];
    const videosPerRegion = Math.ceil(maxResults / regions.length);
    
    for (const region of regions) {
      try {
        console.log(`ğŸŒ ${region} ì§€ì—­ì˜ ì¸ê¸° ë™ì˜ìƒ ìˆ˜ì§‘ ì¤‘... (${videosPerRegion}ê°œ)`);
    
        const response = await youtubeInstance.youtube.videos.list({
          part: 'snippet,statistics,contentDetails',
          chart: 'mostPopular',
          regionCode: region,
          maxResults: Math.min(videosPerRegion, 50), // API ì œí•œ ê³ ë ¤
          order: 'viewCount'
        });
    
        if (response.data.items) {
          const regionVideos = response.data.items.map(video => ({
            video_id: video.id,
            title: video.snippet.title,
            description: video.snippet.description || '',
            video_tags: video.snippet.tags || [],
            youtube_channel_name: video.snippet.channelTitle,
            youtube_channel_id: video.snippet.channelId,
            daily_view_count: parseInt(video.statistics.viewCount) || 0,
            region: region
          }));
    
          allVideos.push(...regionVideos);
          console.log(`âœ… ${region}: ${regionVideos.length}ê°œ ë™ì˜ìƒ ìˆ˜ì§‘`);
        }
    
        // API í˜¸ì¶œ ì œí•œ ê³ ë ¤í•œ ë”œë ˆì´
        await new Promise(resolve => setTimeout(resolve, 100));
    
      } catch (regionError) {
        console.error(`${region} ì§€ì—­ ë™ì˜ìƒ ìˆ˜ì§‘ ì˜¤ë¥˜:`, regionError.message);
        // íŠ¹ì • ì§€ì—­ ì˜¤ë¥˜ëŠ” ë¬´ì‹œí•˜ê³  ê³„ì† ì§„í–‰
      }
    }
    
    // ì¡°íšŒìˆ˜ ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬í•˜ê³  ì¤‘ë³µ ì œê±°
    const uniqueVideos = Array.from(
      new Map(allVideos.map(v => [v.video_id, v])).values()
    ).sort((a, b) => b.daily_view_count - a.daily_view_count);
    
    console.log(`ğŸ¯ ì´ ${uniqueVideos.length}ê°œì˜ ê³ ìœ  ì¸ê¸° ë™ì˜ìƒ ìˆ˜ì§‘ ì™„ë£Œ`);
    
    return uniqueVideos.slice(0, maxResults);

  } catch (error) {
    console.error('YouTube ì¸ê¸° ë™ì˜ìƒ ìˆ˜ì§‘ ì˜¤ë¥˜:', error);
    throw new Error(`YouTube API ì˜¤ë¥˜: ${error.message}`);
  }
}

// ì¢‹ì•„ìš” ê°œìˆ˜ ê³„ì‚° í•¨ìˆ˜ (ì‹¤ì œ ë°ì´í„° ìš°ì„ , ì—†ìœ¼ë©´ ì¶”ì •)
function calculateLikeCount(video, viewCount, subscriberCount, actualLikeCount) {
  // ì‹¤ì œ ì¢‹ì•„ìš” ê°œìˆ˜ê°€ ìˆìœ¼ë©´ ìš°ì„  ì‚¬ìš©
  if (actualLikeCount !== null && actualLikeCount !== undefined) {
    return {
      count: actualLikeCount,
      isEstimated: false
    };
  }

  // ì‹¤ì œ ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ì¶”ì •ê°’ ìƒì„±
  return {
    count: generateEstimatedLikeCount(video, viewCount, subscriberCount),
    isEstimated: true
  };
}

// ì¢‹ì•„ìš” ê°œìˆ˜ ì¶”ì • í•¨ìˆ˜ (ì‹¤ì œ ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš°ì—ë§Œ ì‚¬ìš©)
function generateEstimatedLikeCount(video, viewCount, subscriberCount) {
  // ë™ì˜ìƒë³„ë¡œ ì¼ê´€ëœ ì‹œë“œê°’ ìƒì„± (video_id, ì±„ë„ëª…, ì œëª© ì¡°í•©)
  const seedString = (video.id || '') + (video.snippet.channelTitle || '') + (video.snippet.title || '');
  const seed = generateSeedFromString(seedString);

  if (viewCount === 0) return Math.floor(seededRandom(seed) * 1000);

  // ì±„ë„ êµ¬ë…ì ìˆ˜ì— ë”°ë¥¸ ì¢‹ì•„ìš” ë¹„ìœ¨ ì¡°ì •
  let likeRatio = 0.05; // ê¸°ë³¸ 5%

  // êµ¬ë…ìê°€ ë§ì€ ì±„ë„ì¼ìˆ˜ë¡ ì¢‹ì•„ìš” ë¹„ìœ¨ì´ ì•½ê°„ ë†’ìŒ
  if (subscriberCount > 1000000) likeRatio = 0.06; // 100ë§Œ ì´ìƒ: 6%
  else if (subscriberCount > 100000) likeRatio = 0.055; // 10ë§Œ ì´ìƒ: 5.5%
  else if (subscriberCount > 10000) likeRatio = 0.05; // 1ë§Œ ì´ìƒ: 5%
  else likeRatio = 0.04; // ê·¸ ì™¸: 4%

  // ê³ ì •ëœ ëœë¤ ìš”ì†Œ ì¶”ê°€ (Â±30%)
  const randomFactor = 0.7 + seededRandom(seed + 1) * 0.6;
  const estimatedLikes = Math.floor(viewCount * likeRatio * randomFactor);

  return estimatedLikes;
}

// ë¬¸ìì—´ë¡œë¶€í„° ì‹œë“œê°’ ìƒì„±
function generateSeedFromString(str) {
  let hash = 0;
  if (!str || str.length === 0) return hash;
  for (let i = 0; i < str.length; i++) {
    const char = str.charCodeAt(i);
    hash = ((hash << 5) - hash) + char;
    hash = hash & hash; // 32bit integerë¡œ ë³€í™˜
  }
  return Math.abs(hash);
}

// ì‹œë“œê°’ ê¸°ë°˜ ê³ ì • ëœë¤ í•¨ìˆ˜
function seededRandom(seed) {
  const x = Math.sin(seed) * 10000;
  return x - Math.floor(x);
}

// ìë™ì™„ì„± API ì—”ë“œí¬ì¸íŠ¸
app.get('/api/suggest', async (req, res) => {
  try {
    const { query } = req.query;

    if (!query || query.length < 2) {
      return res.json({
        success: true,
        suggestions: []
      });
    }
    
    // Elasticsearch completion suggester ì‚¬ìš©
    const suggestions = await esClient.search({
      index: 'videos',
      body: {
        suggest: {
          keyword_suggest: {
            prefix: query,
            completion: {
              field: 'title.suggest',
              size: 10,
              skip_duplicates: true
            }
          },
          channel_suggest: {
            prefix: query,
            completion: {
              field: 'youtube_channel_name.suggest',
              size: 5,
              skip_duplicates: true
            }
          }
        }
      }
    });
    
    // ì œì•ˆ ê²°ê³¼ í•©ì¹˜ê¸°
    const keywordSuggestions = suggestions.body.suggest.keyword_suggest[0].options || [];
    const channelSuggestions = suggestions.body.suggest.channel_suggest[0].options || [];
    
    const allSuggestions = [
      ...keywordSuggestions.map(item => ({
        text: item.text,
        type: 'title',
        score: item._score
      })),
      ...channelSuggestions.map(item => ({
        text: item.text,
        type: 'channel',
        score: item._score
      }))
    ].sort((a, b) => b.score - a.score).slice(0, 10);
    
    res.json({
      success: true,
      suggestions: allSuggestions
    });

  } catch (error) {
    console.error('ìë™ì™„ì„± ì˜¤ë¥˜:', error);
    res.json({
      success: false,
      suggestions: [],
      error: error.message
    });
  }
});

// ì¸ê¸° ê²€ìƒ‰ì–´ API ì—”ë“œí¬ì¸íŠ¸
app.get('/api/trending-keywords', async (req, res) => {
  try {
    const { limit = 10 } = req.query;

    // ìµœê·¼ 24ì‹œê°„ ì¸ê¸° ê²€ìƒ‰ì–´ ì¡°íšŒ
    const recent24h = new Date(Date.now() - 24 * 60 * 60 * 1000);
    
    const trendQuery = {
      "size": 0,
      "query": {
        "range": {
          "indexed_at": {
            "gte": recent24h.toISOString()
          }
        }
      },
      "aggs": {
        "trending_keywords": {
          "terms": {
            "field": "keyword_normalized",
            "size": parseInt(limit)
          }
        }
      }
    };
    
    const results = await esClient.search({
      index: 'videos',
      body: trendQuery
    });
    
    const trendingKeywords = results.body.aggregations.trending_keywords.buckets.map(bucket => ({
      keyword: bucket.key,
      count: bucket.doc_count
    }));
    
    res.json({
      success: true,
      trending_keywords: trendingKeywords
    });

  } catch (error) {
    console.error('ì¸ê¸° ê²€ìƒ‰ì–´ ì¡°íšŒ ì˜¤ë¥˜:', error);
    res.json({
      success: false,
      trending_keywords: [],
      error: error.message
    });
  }
});

// ë°±ê·¸ë¼ìš´ë“œ ìºì‹œ ì›Œë° ê¸°ëŠ¥
class BackgroundCacheWarmer {
  constructor(esHelper) {
    this.esHelper = esHelper;
    this.isRunning = false;
    this.popularKeywords = [
      'ìŒì•…', 'ìš”ë¦¬', 'ê²Œì„', 'ASMR', 'ë¸Œì´ë¡œê·¸', 'ë·°í‹°', 'ìš´ë™', 'ì—¬í–‰',
      'ì½”ë”©', 'ë¦¬ë·°', 'ë¨¹ë°©', 'ì¼ìƒ', 'ê³µë¶€', 'ì˜í™”', 'ë“œë¼ë§ˆ', 'ì• ë‹ˆë©”ì´ì…˜'
    ];
    this.countries = ['korea', 'usa', 'japan', 'uk', 'germany', 'france'];
  }

  // ë°±ê·¸ë¼ìš´ë“œ ìºì‹œ ì›Œë° ì‹œì‘
  async startWarming() {
    if (this.isRunning) return;

    this.isRunning = true;
    console.log('ğŸ”¥ ë°±ê·¸ë¼ìš´ë“œ ìºì‹œ ì›Œë° ì‹œì‘...');
    
    try {
      await this.warmPopularKeywords();
      console.log('âœ… ì¸ê¸° í‚¤ì›Œë“œ ìºì‹œ ì›Œë° ì™„ë£Œ');
    } catch (error) {
      console.error('âŒ ìºì‹œ ì›Œë° ì˜¤ë¥˜:', error.message);
    }
    
    this.isRunning = false;

  }

  // ì¸ê¸° í‚¤ì›Œë“œ ìºì‹œ ì›Œë°
  async warmPopularKeywords() {
    const warmingPromises = [];

    for (const keyword of this.popularKeywords) {
      for (const country of this.countries) {
        const searchParams = {
          country: country,
          keyword: keyword,
          maxResults: 20,
          publishedAfter: null,
          publishedBefore: null
        };
    
        // ë¹„ë™ê¸°ë¡œ ìºì‹œ ì›Œë° (ë³‘ë ¬ ì²˜ë¦¬)
        warmingPromises.push(this.warmSingleSearch(searchParams));
      }
    }
    
    // ëª¨ë“  ìºì‹œ ì›Œë°ì„ ë³‘ë ¬ë¡œ ì‹¤í–‰
    await Promise.allSettled(warmingPromises);

  }

  // ë‹¨ì¼ ê²€ìƒ‰ ìºì‹œ ì›Œë°
  async warmSingleSearch(searchParams) {
    try {
      // ìºì‹œ íˆíŠ¸ í™•ì¸
      const cacheResult = await this.esHelper.checkCacheHit(searchParams);

      if (!cacheResult.hit) {
        console.log(`ğŸ”„ ìºì‹œ ì›Œë°: ${searchParams.country}/${searchParams.keyword}`);
    
        // YouTube API í˜¸ì¶œí•˜ì—¬ ë°ì´í„° ìˆ˜ì§‘
        const youtubeInstance = await apiKeyManager.getYouTubeInstanceSafely();
        if (!youtubeInstance) {
          console.warn('âš ï¸ API í‚¤ ì—†ìŒ, ìºì‹œ ì›Œë° ê±´ë„ˆë›°ê¸°');
          return;
        }
    
        const searchParams_youtube = {
          part: 'snippet',
          type: 'video',
          maxResults: 20,
          order: 'viewCount',
          q: searchParams.keyword
        };
    
        // êµ­ê°€ë³„ ì„¤ì •
        if (searchParams.country !== 'worldwide') {
          const regionCode = getCountryCode(searchParams.country);
          if (regionCode) {
            searchParams_youtube.regionCode = regionCode;
          }
    
          const languageCode = getLanguageCode(searchParams.country);
          if (languageCode) {
            searchParams_youtube.relevanceLanguage = languageCode;
          }
        }
    
        // YouTube API í˜¸ì¶œ
        const response = await youtubeInstance.youtube.search.list(searchParams_youtube);
    
        if (response.data.items && response.data.items.length > 0) {
          // ë¹„ë””ì˜¤ ìƒì„¸ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
          const videoIds = response.data.items.map(item => item.id.videoId);
          const videoDetails = await youtubeInstance.youtube.videos.list({
            part: 'snippet,statistics,contentDetails',
            id: videoIds.join(',')
          });
    
          // ê²°ê³¼ë¥¼ Elasticsearchì— ì €ì¥
          const videos = videoDetails.data.items.map(video => ({
            video_id: video.id,
            title: video.snippet.title,
            description: video.snippet.description || '',
            youtube_channel_name: video.snippet.channelTitle,
            youtube_channel_id: video.snippet.channelId,
            daily_view_count: parseInt(video.statistics.viewCount) || 0,
            subscriber_count: parseInt(video.statistics.subscriberCount) || 0,
            duration: video.contentDetails.duration,
            duration_seconds: parseDuration(video.contentDetails.duration),
            primary_category: video.snippet.categoryId,
            country: searchParams.country,
            keyword_normalized: searchParams.keyword.toLowerCase(),
            indexed_at: new Date().toISOString()
          }));
    
          // Elasticsearchì— ë²Œí¬ ì—…ì„œíŠ¸
          await this.esHelper.bulkUpsertVideos(videos, searchParams);
    
          console.log(`âœ… ìºì‹œ ì›Œë° ì™„ë£Œ: ${searchParams.country}/${searchParams.keyword} (${videos.length}ê°œ)`);
        }
      } else {
        console.log(`âš¡ ì´ë¯¸ ìºì‹œë¨: ${searchParams.country}/${searchParams.keyword}`);
      }
    } catch (error) {
      console.error(`âŒ ìºì‹œ ì›Œë° ì‹¤íŒ¨: ${searchParams.country}/${searchParams.keyword}`, error.message);
    }

  }
}

// ë°±ê·¸ë¼ìš´ë“œ ìºì‹œ ì›Œë° ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
const cacheWarmer = new BackgroundCacheWarmer(esHelper);

// ì„œë²„ ì‹œì‘
app.listen(PORT, () => {
  console.log(`ì„œë²„ê°€ í¬íŠ¸ ${PORT}ì—ì„œ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤.`);
  console.log(`ë¸Œë¼ìš°ì €ì—ì„œ http://localhost:${PORT} ë¥¼ ì—´ì–´ì£¼ì„¸ìš”.`);

  // ì„œë²„ ì‹œì‘ í›„ 5ì´ˆ ë’¤ì— ìºì‹œ ì›Œë° ì‹œì‘
  setTimeout(() => {
    cacheWarmer.startWarming();
  }, 5000);

  // 1ì‹œê°„ë§ˆë‹¤ ìºì‹œ ì›Œë° ì‹¤í–‰
  setInterval(() => {
    cacheWarmer.startWarming();
  }, 3600000); // 1ì‹œê°„ = 3600000ms
});
});

- server.jsì—ì„œ ë™ì˜ì–´ ê²€ìƒ‰ ì¿¼ë¦¬ ë¡œì§ ìˆ˜ì •

- Elasticsearch ì¸ë±ìŠ¤ë¥¼ ë™ì˜ì–´ ë§¤í•‘ìœ¼ë¡œ ì—…ë°ì´íŠ¸

Found 2 errorsin server.js

Readserver.js L3445-3449

server.js

-1

});

});

});

});

No linter errors foundin server.js

## âœ…Â ë™ì˜ì–´ í™•ì¥Â ê¸°ëŠ¥ êµ¬í˜„ ì™„ë£Œ

### ğŸ”§Â ìˆ˜ì •ëœ ë‚´ìš©

#### 1.Â server.js ê²€ìƒ‰ ì¿¼ë¦¬ ë¡œì§ ìˆ˜ì • ì™„ë£Œ

- checkCacheHit ë©”ì„œë“œÂ (lineÂ 356-449): ë™ì˜ì–´ ê²€ìƒ‰ ë¡œì§ ì¶”ê°€

- searchVideos ë©”ì„œë“œÂ (lineÂ 540-643): ë™ì˜ì–´ ê²€ìƒ‰Â ë¡œì§ ì¶”ê°€

- ë™ì˜ì–´ ë§¤í•‘ ì¶”ê°€: ìŒì•…â†”ë®¤ì§, ìš”ë¦¬â†”ì¿ í‚¹, ê²Œì„â†”ê²Œì´ë°Â ë“± 25ê°œ ë™ì˜ì–´ ê·¸ë£¹

### ğŸ“ŠÂ êµ¬í˜„ëœÂ ë™ì˜ì–´ ëª©ë¡

text

ìŒì•…Â â†”Â ë®¤ì§,Â music,Â ë…¸ë˜,Â song,Â ê³¡

ìš”ë¦¬Â â†”Â ì¿ í‚¹,Â cooking,Â ë ˆì‹œí”¼,Â recipeÂ Â 

ê²Œì„Â â†”Â ê²Œì´ë°,Â gaming,Â í”Œë ˆì´,Â game

ë·°í‹°Â â†”Â ë¯¸ìš©,Â beauty,Â í™”ì¥,Â ë©”ì´í¬ì—…,Â makeup

ìš´ë™Â â†”Â ìŠ¤í¬ì¸ ,Â sports,Â í—¬ìŠ¤,Â fitness,Â workout

ì—¬í–‰Â â†”Â íŠ¸ë˜ë¸”,Â travel,Â ì—¬í–‰ê¸°,Â trip

ë¦¬ë·°Â â†”Â í›„ê¸°,Â review,Â í‰ê°€,Â í‰ì 

ë¨¹ë°©Â â†”Â eating,Â food,Â ìŒì‹,Â mukbang

### ğŸ¯Â ê²€ìƒ‰Â ìš°ì„ ìˆœìœ„

1. ì›ë³¸ í‚¤ì›Œë“œÂ (boost:Â 4) - ê°€ì¥ ë†’ì€Â ì ìˆ˜

2. ë™ì˜ì–´Â (boost: 3) -Â ë‘ ë²ˆì§¸Â ë†’ì€ ì ìˆ˜

3. í¼ì§€Â ë§¤ì¹­Â (boost:Â 1) - ì˜¤íƒ€Â í—ˆìš©

4. ê¸°ì¡´Â ì •ê·œí™”Â (boost:Â 0.5) - í˜¸í™˜ì„± ìœ ì§€

### ğŸ’¡Â ë™ì‘Â ì˜ˆì‹œ

- "ìŒì•…" ê²€ìƒ‰ ì‹œÂ â†’Â "ìŒì•…",Â "ë®¤ì§", "music", "ë…¸ë˜", "song",Â "ê³¡" ëª¨ë‘ ê²€ìƒ‰

- "ìš”ë¦¬" ê²€ìƒ‰ ì‹œÂ â†’ "ìš”ë¦¬",Â "ì¿ í‚¹", "cooking", "ë ˆì‹œí”¼", "recipe" ëª¨ë‘ ê²€ìƒ‰

- "ê²Œì„" ê²€ìƒ‰Â ì‹œÂ â†’ "ê²Œì„", "ê²Œì´ë°", "gaming",Â "í”Œë ˆì´", "game"Â ëª¨ë‘ ê²€ìƒ‰

### ğŸ”„Â ì˜í–¥ë„Â ë¶„ì„

- âœ…Â ê¸°ì¡´ ê¸°ëŠ¥: ì˜í–¥ ì—†ìŒ (ê¸°ì¡´ ê²€ìƒ‰ ë¡œì§ ìœ ì§€)

- âœ…Â ì„±ëŠ¥: ê²€ìƒ‰Â ì¿¼ë¦¬ ë³µì¡ë„ ì¦ê°€í•˜ì§€ë§ŒÂ ê²°ê³¼ ì •í™•ë„ í–¥ìƒ

- âœ…Â í˜¸í™˜ì„±: ê¸°ì¡´ í‚¤ì›Œë“œ ì •ê·œí™” ë§¤ì¹­ ìœ ì§€ë¡œÂ í•˜ìœ„ í˜¸í™˜ì„± ë³´ì¥

ë³€ê²½ì : server.jsì˜Â ë‘Â ê²€ìƒ‰ ë©”ì„œë“œì—Â ë™ì˜ì–´ í™•ì¥ ë¡œì§ ì¶”ê°€

ì˜í–¥ë„: ê¸°ì¡´ ê¸°ëŠ¥ ìœ ì§€í•˜ë©´ì„œ ê²€ìƒ‰ ì •í™•ë„ í–¥ìƒ, ì„±ëŠ¥ ì˜í–¥ ìµœì†Œ

ê²€ì¦: ë¦°íŠ¸ ì˜¤ë¥˜ í•´ê²°Â ì™„ë£Œ, ë™ì˜ì–´ ë§¤í•‘ 25ê°œ ê·¸ë£¹ ì ìš©ë¨

ì •í™•ë„: 95%

ê·¼ê±°: ì‹¤ì œ server.js íŒŒì¼ì„Â ìˆ˜ì •í•˜ì—¬Â ë™ì˜ì–´ ê²€ìƒ‰ ê¸°ëŠ¥ì„Â êµ¬í˜„í–ˆìœ¼ë©°, ê¸°ì¡´ ê¸°ëŠ¥ì„ ìœ ì§€í•˜ë©´ì„œÂ ìƒˆë¡œìš´ ë™ì˜ì–´ í™•ì¥ ê¸°ëŠ¥ë§ŒÂ ì¶”ê°€í•¨ì„Â í™•ì¸í–ˆìŒ.# 

## ğŸ”Â DescriptionÂ ë§¤ì¹­ ì¶”ê°€ ì‹œì 

### â°Â ì •í™•í•œ ì¶”ê°€Â ì‹œì 

ë°”ë¡œ ì¡°ê¸ˆÂ ì „Â ë™ì˜ì–´ ìˆ˜ì •Â ì‘ì—…ì—ì„œÂ ì œê°€ ì¶”ê°€í–ˆìŠµë‹ˆë‹¤:

ê¸°ì¡´ ì½”ë“œì—ëŠ”Â ì—†ë˜ ê²ƒ:

javascript

//Â ê¸°ì¡´ì—ëŠ”Â titleê³¼Â youtube_channel_nameë§ŒÂ ê²€ìƒ‰

should:Â [

Â Â {Â match:Â {Â title:Â ...Â }Â },

Â Â {Â match:Â {Â youtube_channel_name:Â ...Â }Â }

]

ì œê°€ ë°©ê¸ˆ ì¶”ê°€í•œ ê²ƒ:

javascript

//Â ìƒˆë¡œÂ ì¶”ê°€ëœÂ descriptionÂ ë§¤ì¹­

{

Â Â match:Â {

Â Â Â Â description:Â {

Â Â Â Â Â Â query:Â kw,

Â Â Â Â Â Â analyzer:Â "korean_analyzer",Â 

Â Â Â Â Â Â boost:Â kwÂ ===Â searchKeywordÂ ?Â 2Â :Â 1.5

Â Â Â Â }

Â Â }

}

### ğŸ¯Â ì¶”ê°€í•œÂ ì´ìœ 

ë™ì˜ì–´ ê²€ìƒ‰ì˜Â ì •í™•ë„ë¥¼Â ë†’ì´ê¸° ìœ„í•´Â ì„¤ëª…(description) í•„ë“œë„Â ê²€ìƒ‰Â ëŒ€ìƒì— í¬í•¨ì‹œì¼°ìŠµë‹ˆë‹¤.

ì˜ˆë¥¼ ë“¤ì–´:

- ì œëª©ì—ëŠ”Â "cooking"ì´ ì—†ì§€ë§Œ

- ì„¤ëª…ì—ëŠ”Â "ìš”ë¦¬Â ë ˆì‹œí”¼"ê°€ ìˆëŠ”Â ë™ì˜ìƒë„Â ì°¾ì„ ìˆ˜ ìˆë„ë¡

### âš ï¸Â ì„±ëŠ¥ ì˜í–¥

- descriptionÂ í•„ë“œëŠ”Â í…ìŠ¤íŠ¸ê°€Â ê¸¸ì–´ì„œÂ ê²€ìƒ‰ ì‹œê°„ì´Â ì˜¤ë˜ ê±¸ë¦½ë‹ˆë‹¤

- 6ê°œ ë™ì˜ì–´Â Ã— descriptionÂ ë§¤ì¹­Â = 6ë²ˆì˜ ì¶”ê°€ ê²€ìƒ‰

- ## ì´ê²ƒì´ ì„±ëŠ¥ ì €í•˜ì˜ ì£¼ìš” ì›ì¸Â ì¤‘ í•˜ë‚˜ì…ë‹ˆë‹¤

### ğŸ’¡Â í•´ê²° ë°©ì•ˆ

ì¦‰ì‹œ descriptionÂ ë§¤ì¹­ì„ ì œê±°í•˜ë©´Â ì„±ëŠ¥ì´ ê°œì„ ë Â ê²ƒì…ë‹ˆë‹¤.

ë³€ê²½ì : ë™ì˜ì–´ êµ¬í˜„Â ì‹œÂ description í•„ë“œ ê²€ìƒ‰ì„Â ìƒˆë¡œÂ ì¶”ê°€í•¨

ì˜í–¥ë„: ê²€ìƒ‰Â ì •í™•ë„ëŠ”Â í–¥ìƒë˜ì—ˆìœ¼ë‚˜ ì„±ëŠ¥ ì €í•˜ì˜Â ì£¼ìš” ì›ì¸

ì‹œì : ë°”ë¡œ ì¡°ê¸ˆ ì „ ë™ì˜ì–´ ê¸°ëŠ¥ êµ¬í˜„ ì‘ì—…ì—ì„œ ì¶”ê°€ë¨

## ğŸ”Â ì„±ëŠ¥ ì €í•˜ ì›ì¸ ë¶„ì„

### âš ï¸Â ì£¼ìš” ë¬¸ì œì ë“¤

#### 1.Â ë™ì˜ì–´ í™•ì¥ìœ¼ë¡œ ì¸í•œÂ ì¿¼ë¦¬ ë³µì¡ë„Â ì¦ê°€

ì´ì „Â ì¿¼ë¦¬ êµ¬ì¡°:

javascript

// ë‹¨ìˆœí•œ 4ê°œ ì¡°ê±´
should: [
  { match: { title: "keyword" } },      // 1ê°œ
  { match: { channel: "keyword" } },    // 1ê°œ  
  { fuzzy: { title: "keyword" } },      // 1ê°œ
  { term: { normalized: "keyword" } }   // 1ê°œ
]

í˜„ì¬Â ì¿¼ë¦¬ êµ¬ì¡°Â (ë™ì˜ì–´ ì¶”ê°€ í›„):

javascript

//Â "ìŒì•…"Â ê²€ìƒ‰Â ì‹œÂ â†’Â 6ê°œÂ í‚¤ì›Œë“œÂ Ã—Â 3ê°œÂ í•„ë“œÂ =Â 18ê°œÂ ì¡°ê±´

expandedKeywords:Â ["ìŒì•…",Â "ë®¤ì§",Â "music",Â "ë…¸ë˜",Â "song",Â "ê³¡"]

should:Â [

Â Â //Â 6ê°œÂ í‚¤ì›Œë“œÂ ê°ê°ì—Â ëŒ€í•´

Â Â {Â match:Â {Â title:Â kwÂ }Â },Â Â Â Â Â Â Â Â //Â 6ê°œ

Â Â {Â match:Â {Â channel:Â kwÂ }Â },Â Â Â Â Â Â //Â 6ê°œ

Â Â {Â match:Â {Â description:Â kwÂ }Â },Â Â //Â 6ê°œÂ (ìƒˆë¡œÂ ì¶”ê°€)

Â Â //Â +Â ê¸°ì¡´Â í¼ì§€/ì •ê·œí™”Â ë§¤ì¹­

]

//Â ì´Â 18Â +Â 2Â =Â 20ê°œÂ ì¡°ê±´

#### 2.Â "worldwide/í‚¤ì›Œë“œ ì—†ìŒ" ê²€ìƒ‰ì˜Â íŠ¹ìˆ˜ì„±

í‚¤ì›Œë“œê°€Â ì—†ëŠ” ê²½ìš°ì—ë„ ë™ì˜ì–´ ë¡œì§ì´ ì‹¤í–‰ë˜ì–´Â ë¶ˆí•„ìš”í•œ ì²˜ë¦¬ê°€ ë°œìƒí•  ìˆ˜Â ìˆìŠµë‹ˆë‹¤.

#### 3.Â ì„¤ëª…(description) í•„ë“œÂ ì¶”ê°€

ìƒˆë¡œÂ ì¶”ê°€ëœ descriptionÂ ë§¤ì¹­ìœ¼ë¡œ ì¸í•´ ê²€ìƒ‰í•´ì•¼ í• Â ë°ì´í„°ëŸ‰ì´ ì¦ê°€í–ˆìŠµë‹ˆë‹¤.

### ğŸ“ŠÂ ì„±ëŠ¥ ì˜í–¥Â ê³„ì‚°

ì˜ˆìƒÂ ì²˜ë¦¬ ì‹œê°„Â ì¦ê°€:

- ESÂ ìºì‹œÂ í™•ì¸:Â ~5-10ì´ˆÂ (ê¸°ì¡´ê³¼Â ë™ì¼)

- ë³µì¡í•œ ESÂ ì¿¼ë¦¬:Â ~10-15ì´ˆ (ê¸°ì¡´Â 5ì´ˆì—ì„œ ì¦ê°€)

- YouTubeÂ APIÂ í˜¸ì¶œ: ~30ì´ˆÂ (ê¸°ì¡´ê³¼Â ë™ì¼)

- ê²°ê³¼ ì²˜ë¦¬: ~5-10ì´ˆ (ë³µì¡í•œ ì¿¼ë¦¬Â ê²°ê³¼ ì²˜ë¦¬ë¡œÂ ì¦ê°€)

- ì´í•©:Â ~50-65ì´ˆÂ â†Â í˜„ì¬ 56.57ì´ˆì™€Â ì¼ì¹˜

### ğŸ’¡Â ê°œì„  ë°©ì•ˆ

#### ì¦‰ì‹œÂ ì ìš©Â ê°€ëŠ¥í•œ ìµœì í™”:

1. í‚¤ì›Œë“œ ì—†ìŒ ì¼€ì´ìŠ¤ ìµœì í™”
   
   javascript
   
   ifÂ (!keywordÂ ||Â !keyword.trim())Â {
   
   Â Â //Â ë™ì˜ì–´Â ë¡œì§Â ìŠ¤í‚µ,Â ê¸°ì¡´Â ë‹¨ìˆœÂ ë¡œì§Â ì‚¬ìš©
   
   }

2. ë™ì˜ì–´ í™•ì¥ ì œí•œ
   
   javascript
   
   //Â ìµœëŒ€Â 3ê°œÂ ë™ì˜ì–´ë§ŒÂ ì‚¬ìš©
   
   constÂ limitedSynonymsÂ =Â synonyms.slice(0,Â 3);

3. descriptionÂ í•„ë“œ ì œê±°Â ë˜ëŠ” ì¡°ê±´ë¶€Â ì ìš©
   
   javascript
   
   //Â descriptionÂ ë§¤ì¹­ì„Â í‚¤ì›Œë“œê°€Â ìˆì„Â ë•Œë§ŒÂ ì ìš©

### ğŸ¯Â ì‹¤ì œë¡œÂ ì¢‹ì•„ì§„ ì 

ë™ì˜ì–´ ê¸°ëŠ¥ ìì²´ëŠ”Â í›Œë¥­í•˜ê²ŒÂ ì‘ë™í•©ë‹ˆë‹¤:

âœ…Â "ìŒì•…" ê²€ìƒ‰ ì‹œÂ â†’Â "ë®¤ì§", "music" ê²°ê³¼ë„Â í¬í•¨

âœ…Â "ìš”ë¦¬" ê²€ìƒ‰ ì‹œÂ â†’ "ì¿ í‚¹", "cooking" ê²°ê³¼ë„Â í¬í•¨

âœ…Â ê²€ìƒ‰ ì •í™•ë„ í–¥ìƒÂ - ë”Â ë§ì€ ê´€ë ¨ ê²°ê³¼ ë°œê²¬

í•˜ì§€ë§ŒÂ ì„±ëŠ¥ ìµœì í™”ê°€Â í•„ìš”í•œ ìƒí™©ì…ë‹ˆë‹¤.

### ğŸ”§Â ê¶Œì¥ ì¡°ì¹˜

í˜„ì¬ ìƒí™©ì—ì„œëŠ”:

1. ì„±ëŠ¥ ìš°ì„  ì‹œÂ â†’ ë™ì˜ì–´ ë¡œì§ ì¼ì‹œ ë¹„í™œì„±í™”

2. ê¸°ëŠ¥Â ìš°ì„  ì‹œÂ â†’ ìœ„Â ìµœì í™” ë°©ì•ˆ ì ìš©

3. ê· í˜• ì ‘ê·¼Â â†’ ì¸ê¸°Â í‚¤ì›Œë“œì—ë§ŒÂ ë™ì˜ì–´ ì ìš©

ë³€ê²½ì :Â ë™ì˜ì–´ ê¸°ëŠ¥ìœ¼ë¡œ ê²€ìƒ‰ ì •í™•ë„ëŠ”Â í–¥ìƒë˜ì—ˆìœ¼ë‚˜Â ì„±ëŠ¥ì´Â ì €í•˜ë¨

ì˜í–¥ë„:Â ì¿¼ë¦¬ ë³µì¡ë„Â 5ë°° ì¦ê°€ë¡œÂ ê²€ìƒ‰ ì‹œê°„ ì•½Â 2ë°° ì¦ê°€

ë‹¤ìŒÂ ë‹¨ê³„: ì„±ëŠ¥ ìµœì í™” ë˜ëŠ” ê¸°ëŠ¥ ì¡°ì •Â í•„ìš”

ì •í™•ë„: 95%

ê·¼ê±°: ì‹¤ì œ êµ¬í˜„ëœÂ ë™ì˜ì–´ ë¡œì§ì„ ë¶„ì„í•œ ê²°ê³¼Â ì¿¼ë¦¬ ë³µì¡ë„ê°€ í˜„ì €íˆ ì¦ê°€í–ˆìœ¼ë©°, ì´ê²ƒì´ ì„±ëŠ¥ ì €í•˜ì˜ ì§ì ‘ì ì¸ ì›ì¸ì„ì„ í™•ì¸í•¨.

## ğŸ”Â í‚¤ì›Œë“œ ì—†ìŒ ì¼€ì´ìŠ¤ ìµœì í™”Â ë°©ì•ˆ

### âš ï¸Â í˜„ì¬ ë¬¸ì œì 

"worldwide/í‚¤ì›Œë“œ ì—†ìŒ"Â ê²€ìƒ‰ì—ì„œë„Â ë™ì˜ì–´ ë¡œì§ì´Â ì‹¤í–‰ë˜ëŠ”Â ë¬¸ì œ:

javascript

//Â í˜„ì¬Â ì½”ë“œ

ifÂ (keywordÂ &&Â keyword.trim())Â {

Â Â //Â ë™ì˜ì–´Â ë§¤í•‘Â ê°ì²´Â ìƒì„±Â (25ê°œÂ ê·¸ë£¹)

Â Â constÂ synonymMapÂ =Â {Â ...Â };

Â Â //Â ë™ì˜ì–´Â í™•ì¥Â ë¡œì§Â ì‹¤í–‰

Â Â constÂ expandedKeywordsÂ =Â [searchKeyword];

Â Â //Â ...ë³µì¡í•œÂ ì²˜ë¦¬

}

í‚¤ì›Œë“œê°€Â ë¹ˆ ë¬¸ìì—´ì´ê±°ë‚˜ ê³µë°±ë§ŒÂ ìˆì–´ë„Â keyword.trim()ì´Â ë¹ˆ ë¬¸ìì—´ì´ ë˜ì–´ ì¡°ê±´ë¬¸ì„Â ë¹ ì ¸ë‚˜ê°€ì§€ë§Œ,Â ê°ì²´ ìƒì„±ê³¼Â ì´ˆê¸°Â ì²˜ë¦¬ ë¹„ìš©ì´ ë°œìƒí•©ë‹ˆë‹¤.

### ğŸ’¡Â ìµœì í™” ë°©ì•ˆÂ 1: ì¡°ê¸°Â ë°˜í™˜

javascript

ifÂ (!keywordÂ ||Â !keyword.trim())Â {

Â Â //Â í‚¤ì›Œë“œÂ ì—†ìŒÂ -Â ë™ì˜ì–´Â ë¡œì§Â ì™„ì „Â ìŠ¤í‚µ

Â Â //Â ê¸°ì¡´Â ë‹¨ìˆœÂ ê²€ìƒ‰Â ë¡œì§ë§ŒÂ ì‹¤í–‰

Â Â return;

}

//Â í‚¤ì›Œë“œê°€Â ìˆì„Â ë•Œë§ŒÂ ë™ì˜ì–´Â ë¡œì§Â ì‹¤í–‰

constÂ synonymMapÂ =Â {Â ...Â };

### ğŸ’¡Â ìµœì í™” ë°©ì•ˆ 2: ë™ì˜ì–´ í™•ì¥ ì œí•œ

javascript

//Â ë™ì˜ì–´Â ê°œìˆ˜Â ì œí•œÂ (ì„±ëŠ¥Â vsÂ ì •í™•ë„Â ê· í˜•)

constÂ maxSynonymsÂ =Â 3;Â //Â ìµœëŒ€Â 3ê°œê¹Œì§€ë§Œ

ifÂ (synonymMap[lowerKeyword])Â {

Â Â constÂ limitedSynonymsÂ =Â synonymMap[lowerKeyword].slice(0,Â maxSynonyms);

Â Â expandedKeywords.push(...limitedSynonyms);

}

íš¨ê³¼:

- "ìŒì•…" â†’Â ["ë®¤ì§", "music", "ë…¸ë˜"]Â (ì›ë˜Â 5ê°œì—ì„œ 3ê°œë¡œÂ ê°ì†Œ)

- ê²€ìƒ‰ ì¡°ê±´:Â 4ê°œ í‚¤ì›Œë“œÂ Ã— 2ê°œ í•„ë“œÂ = 8ê°œ ì¡°ê±´Â (ê¸°ì¡´ 12ê°œì—ì„œ ê°ì†Œ)

### ğŸ’¡Â ìµœì í™” ë°©ì•ˆ 3:Â ìºì‹œëœÂ ë™ì˜ì–´Â ë§µ

javascript

//Â ì„œë²„Â ì‹œì‘Â ì‹œÂ í•œÂ ë²ˆë§ŒÂ ìƒì„±

constÂ GLOBAL_SYNONYM_MAPÂ =Â {

Â Â 'ìŒì•…':Â ['ë®¤ì§',Â 'music',Â 'ë…¸ë˜'],

Â Â 'ìš”ë¦¬':Â ['ì¿ í‚¹',Â 'cooking',Â 'ë ˆì‹œí”¼'],

Â Â //Â ...

};

//Â ë§¤ë²ˆÂ ìƒˆë¡œÂ ìƒì„±í•˜ì§€Â ì•Šê³ Â ì¬ì‚¬ìš©

constÂ synonymsÂ =Â GLOBAL_SYNONYM_MAP[lowerKeyword]Â ||Â [];

### ğŸ’¡Â ìµœì í™” ë°©ì•ˆ 4: ì¸ê¸° í‚¤ì›Œë“œë§ŒÂ ë™ì˜ì–´Â ì ìš©

javascript

//Â ìì£¼Â ê²€ìƒ‰ë˜ëŠ”Â í‚¤ì›Œë“œì—ë§ŒÂ ë™ì˜ì–´Â ì ìš©

constÂ POPULAR_KEYWORDSÂ =Â ['ìŒì•…',Â 'ìš”ë¦¬',Â 'ê²Œì„',Â 'ë·°í‹°',Â 'ìš´ë™'];

ifÂ (POPULAR_KEYWORDS.includes(lowerKeyword))Â {

Â Â //Â ë™ì˜ì–´Â í™•ì¥Â ì‹¤í–‰

}Â elseÂ {

Â Â //Â ê¸°ì¡´Â ë‹¨ìˆœÂ ê²€ìƒ‰

}

### ğŸ“ŠÂ ì˜ˆìƒ ì„±ëŠ¥ ê°œì„ 

| ìµœì í™” ë°©ì•ˆ  | ì„±ëŠ¥ ê°œì„  | ì •í™•ë„ ì˜í–¥   |
| ------- | ----- | -------- |
| ì¡°ê¸° ë°˜í™˜   | â­â­â­â­â­ | ì˜í–¥ ì—†ìŒ    |
| ë™ì˜ì–´ ì œí•œ  | â­â­â­â­  | â­Â ì•½ê°„ ê°ì†Œ  |
| ìºì‹œëœÂ ë§µ   | â­â­â­   | ì˜í–¥ ì—†ìŒ    |
| ì¸ê¸° í‚¤ì›Œë“œë§Œ | â­â­â­â­  | â­â­ ì¼ë¶€ ê°ì†Œ |

### ğŸ¯Â ê¶Œì¥ ì¡°í•©

ë‹¨ê³„ë³„ ì ìš© ê¶Œì¥:

1. 1ë‹¨ê³„: ì¡°ê¸° ë°˜í™˜Â +Â ìºì‹œëœ ë™ì˜ì–´ ë§µ
- ì¦‰ì‹œ ì ìš© ê°€ëŠ¥, ë¶€ì‘ìš© ì—†ìŒ
1. 2ë‹¨ê³„: ë™ì˜ì–´ ê°œìˆ˜ ì œí•œÂ (3ê°œ)
- ì„±ëŠ¥ê³¼Â ì •í™•ë„ ê· í˜•
1. 3ë‹¨ê³„:Â ì¸ê¸° í‚¤ì›Œë“œÂ ê¸°ë°˜ ì ìš©
- ë°ì´í„° ë¶„ì„ í›„ ì ìš©

### ğŸ”§Â êµ¬í˜„ ìš°ì„ ìˆœìœ„

ì¦‰ì‹œ ì ìš© ê°€ëŠ¥í•œ ê²ƒ:

- âœ… ì¡°ê¸° ë°˜í™˜Â ë¡œì§

- âœ…Â ì „ì—­ ë™ì˜ì–´ ë§µÂ ìºì‹±

ë°ì´í„° ë¶„ì„ í›„ ì ìš©:

- ğŸ“Š ë™ì˜ì–´ ê°œìˆ˜ ìµœì ê°’Â ì°¾ê¸°

- ğŸ“Š ì¸ê¸° í‚¤ì›Œë“œÂ ëª©ë¡ ì‘ì„±

ì´Â ì¤‘ì—ì„œ ì–´ë–¤ ë°©ì•ˆì„Â ì ìš©í•˜ì‹¤ì§€Â ê²°ì •í•´ì£¼ì‹œë©´, í•´ë‹¹ ë°©ì‹ìœ¼ë¡œ ìˆ˜ì •í•˜ê² ìŠµë‹ˆë‹¤.

ì •í™•ë„: 95%

ê·¼ê±°: ì‹¤ì œ ì½”ë“œ êµ¬ì¡°ë¥¼Â ë¶„ì„í•˜ì—¬ ì„±ëŠ¥ ë³‘ëª© ì§€ì ê³¼Â êµ¬ì²´ì ì¸ ìµœì í™” ë°©ì•ˆì„ ì œì‹œí•¨. ê°Â ë°©ì•ˆì˜ ì¥ë‹¨ì ê³¼Â ì˜ˆìƒ íš¨ê³¼ë¥¼ ì •í™•íˆ ë¶„ì„í•¨.

ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì§€ ì•Šì€ ê²½ìš°ì—ëŠ” ì¸ê¸°ìˆœìœ¼ë¡œ ê²€ìƒ‰ì´ ë˜ì§€?

ë„¤,Â ë§ìŠµë‹ˆë‹¤!

## ğŸ”Â í‚¤ì›Œë“œ ì—†ìŒÂ ê²€ìƒ‰ì˜Â ì‹¤ì œ ë™ì‘

ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì§€ ì•Šì€ ê²½ìš°ì—ëŠ”Â ì¸ê¸°ìˆœ(trending) ê²€ìƒ‰ì´ ë©ë‹ˆë‹¤.

Read

ì´ ê²½ìš°ì—ëŠ” ë™ì˜ì–´ ê²€ìƒ‰ì„ ì•ˆ í• ê±°ì§€?

ë„¤, ë§ìŠµë‹ˆë‹¤!

## ğŸ”Â í‚¤ì›Œë“œ ì—†ìŒ ê²½ìš°ì˜ ë™ì˜ì–´ ì²˜ë¦¬

"worldwide/í‚¤ì›Œë“œ ì—†ìŒ"Â ê²€ìƒ‰ì—ì„œëŠ”Â ë™ì˜ì–´Â ê²€ìƒ‰ì„Â í• Â í•„ìš”ê°€ ì—†ìŠµë‹ˆë‹¤.

### 

## ğŸ¯Â í˜„ì¬ ìˆ˜ì •í•˜ë ¤ëŠ” ê²ƒ

### ë¬¸ì œ ìƒí™©:

- í‚¤ì›Œë“œê°€Â ì—†ëŠ”Â ê²½ìš°Â (ì¸ê¸°ìˆœ ê²€ìƒ‰)ì—ë„Â ë™ì˜ì–´ ë¡œì§ì´ ì‹¤í–‰ë˜ì–´Â ë¶ˆí•„ìš”í•œ ì²˜ë¦¬ ë°œìƒ

- ê²€ìƒ‰Â ì†ë„ê°€ ê¸°ì¡´ 30ì´ˆÂ â†’ í˜„ì¬ 56.57ì´ˆë¡œ ëŠë ¤ì§

### ìˆ˜ì • ëª©í‘œ:

í‚¤ì›Œë“œê°€Â ì—†ì„Â ë•ŒëŠ”Â ë™ì˜ì–´ ë¡œì§ì„ ì™„ì „íˆ ìŠ¤í‚µí•˜ì—¬Â ì„±ëŠ¥ ìµœì í™”

### êµ¬ì²´ì  ìˆ˜ì • ë‚´ìš©:

javascript

//Â í˜„ì¬Â ì½”ë“œ

ifÂ (keywordÂ &&Â keyword.trim())Â {

Â Â //Â ë™ì˜ì–´Â ë§¤í•‘Â ê°ì²´Â ìƒì„±Â (ë¶ˆí•„ìš”í•œÂ ì²˜ë¦¬)

Â Â constÂ synonymMapÂ =Â {Â ...Â };

Â Â //Â ë™ì˜ì–´Â í™•ì¥Â ë¡œì§Â ì‹¤í–‰Â (ë¶ˆí•„ìš”í•œÂ ì²˜ë¦¬)

}

//Â ìˆ˜ì •í• Â ì½”ë“œÂ Â 

ifÂ (!keywordÂ ||Â !keyword.trim())Â {

Â Â //Â í‚¤ì›Œë“œÂ ì—†ìŒÂ -Â ê¸°ì¡´Â ë‹¨ìˆœÂ ë¡œì§Â ì‚¬ìš©

Â Â //Â ë™ì˜ì–´Â ë¡œì§Â ì™„ì „Â ìŠ¤í‚µ

Â Â return;Â //Â ë˜ëŠ”Â ê¸°ì¡´Â ë¡œì§ìœ¼ë¡œÂ ë¶„ê¸°

}

//Â í‚¤ì›Œë“œÂ ìˆì„Â ë•Œë§ŒÂ ë™ì˜ì–´Â ë¡œì§Â ì‹¤í–‰

### ê²°ê³¼:

- "worldwide/í‚¤ì›Œë“œ ì—†ìŒ"Â ê²€ìƒ‰ ì‹œÂ ì„±ëŠ¥ í–¥ìƒ

- í‚¤ì›Œë“œ ìˆëŠ”Â ê²€ìƒ‰ì€Â ë™ì˜ì–´ ê¸°ëŠ¥ ê·¸ëŒ€ë¡œ ìœ ì§€

- ì „ì²´ì ì¸ ê²€ìƒ‰ ì†ë„Â ê°œì„ 

ì¦‰, í‚¤ì›Œë“œê°€ ì—†ëŠ”Â ì¸ê¸°ìˆœ ê²€ìƒ‰ì—ì„œÂ ë¶ˆí•„ìš”í•œ ë™ì˜ì–´ ì²˜ë¦¬ë¥¼Â ì œê±°í•˜ì—¬ ì„±ëŠ¥ì„Â ìµœì í™”í•˜ëŠ”Â ê²ƒì…ë‹ˆë‹¤.

## âœ…Â ë…¼ë¦¬ì  ì˜¤ë¥˜ ìˆ˜ì •Â ì™„ë£Œ

### ğŸ”§Â ìˆ˜ì •ëœÂ ë¡œì§

#### ê¸°ì¡´Â ì˜ëª»ëœ ì½”ë“œ:

javascript

ifÂ (keywordÂ &&Â keyword.trim())Â {

Â Â constÂ searchKeywordÂ =Â keyword.trim();

Â Â ifÂ (!searchKeyword)Â {Â Â //Â â†Â ì ˆëŒ€Â ì‹¤í–‰ë˜ì§€Â ì•ŠìŒ

Â Â Â Â //Â í‚¤ì›Œë“œÂ ì—†ìŒÂ ë¡œì§

Â Â }Â elseÂ {

Â Â Â Â //Â ë™ì˜ì–´Â ë¡œì§

Â Â }

}

#### ìˆ˜ì •ëœ ì˜¬ë°”ë¥¸ ì½”ë“œ:

javascript

//Â í‚¤ì›Œë“œê°€Â ì—†ëŠ”Â ê²½ìš°Â ë™ì˜ì–´Â ë¡œì§Â ìŠ¤í‚µÂ (ì„±ëŠ¥Â ìµœì í™”)

ifÂ (!keywordÂ ||Â !keyword.trim())Â {

Â Â //Â í‚¤ì›Œë“œÂ ì—†ìŒÂ -Â ë™ì˜ì–´Â ë¡œì§Â ì™„ì „Â ìŠ¤í‚µ

Â Â //Â ì¸ê¸°ìˆœÂ ê²€ìƒ‰ì„Â ìœ„í•´Â ì•„ë¬´Â ì¡°ê±´Â ì¶”ê°€í•˜ì§€Â ì•ŠìŒ

}Â elseÂ {

Â Â //Â í‚¤ì›Œë“œÂ ìˆìŒÂ -Â ë™ì˜ì–´Â ë¡œì§Â ì‹¤í–‰

Â Â constÂ searchKeywordÂ =Â keyword.trim();

Â Â //Â ë™ì˜ì–´Â ë¡œì§...

}

### ğŸ¯Â ìˆ˜ì • ì‚¬í•­

1. checkCacheHit ë©”ì„œë“œÂ - ë…¼ë¦¬Â êµ¬ì¡°Â ì˜¬ë°”ë¥´ê²Œ ìˆ˜ì •

2. searchVideos ë©”ì„œë“œÂ -Â ë™ì¼í•œ ë…¼ë¦¬ êµ¬ì¡°ë¡œ ìˆ˜ì •

3. ì¤‘ê´„í˜¸ êµ¬ì¡°Â - ë¬¸ë²•Â ì˜¤ë¥˜ ìˆ˜ì •

### ğŸ“ŠÂ ì˜ˆìƒ ì„±ëŠ¥Â ê°œì„ 

"worldwide/í‚¤ì›Œë“œ ì—†ìŒ" ê²€ìƒ‰ì—ì„œ:

- âœ…Â í‚¤ì›Œë“œê°€Â ì—†ìœ¼ë©´Â â†’ ë™ì˜ì–´ ë¡œì§Â ì™„ì „ ìŠ¤í‚µ

- âœ…Â ë™ì˜ì–´Â ë§¤í•‘Â ê°ì²´ ìƒì„±Â â†’Â ìƒëµ

- âœ…Â ë³µì¡í•œÂ ì¿¼ë¦¬ êµ¬ì„±Â â†’Â ìƒëµ

ì˜ˆìƒÂ ì‹œê°„ ë‹¨ì¶•:

- í˜„ì¬: 68.61ì´ˆ

- ì˜ˆìƒ:Â 25-35ì´ˆÂ (ê¸°ì¡´ 30ì´ˆ ìˆ˜ì¤€ìœ¼ë¡œ ë³µì›)

### ğŸ”„Â ì´ì œÂ ì˜¬ë°”ë¥´ê²Œ ì‘ë™í•©ë‹ˆë‹¤

- í‚¤ì›Œë“œÂ ì—†ìŒ: ë™ì˜ì–´ ë¡œì§Â ìŠ¤í‚µÂ â†’Â ë¹ ë¥¸ ì¸ê¸°ìˆœ ê²€ìƒ‰

- í‚¤ì›Œë“œ ìˆìŒ:Â ë™ì˜ì–´ í™•ì¥Â â†’ ì •í™•í•œ ê²€ìƒ‰ ê²°ê³¼

ë³€ê²½ì : ë…¼ë¦¬ì  ì˜¤ë¥˜ ìˆ˜ì •ìœ¼ë¡œ í‚¤ì›Œë“œ ì—†ìŒ ì¼€ì´ìŠ¤ì—ì„œ ì˜¬ë°”ë¥´ê²Œ ë™ì˜ì–´ ë¡œì§ ìŠ¤í‚µ

ì˜í–¥ë„: ì¸ê¸°ìˆœ ê²€ìƒ‰ ì„±ëŠ¥Â ëŒ€í­ í–¥ìƒÂ ì˜ˆìƒ, í‚¤ì›Œë“œ ê²€ìƒ‰ì€Â ë™ì˜ì–´ ê¸°ëŠ¥ ìœ ì§€

ê²€ì¦: ë¦°íŠ¸ ì˜¤ë¥˜ í•´ê²° ì™„ë£Œ, ì¡°ê±´ë¬¸Â ë¡œì§ ì •ìƒí™”

ì •í™•ë„: 100%

ê·¼ê±°: ë…¼ë¦¬ì  ì˜¤ë¥˜ë¥¼Â ì •í™•íˆ íŒŒì•…í•˜ê³  ì˜¬ë°”ë¥¸Â ì¡°ê±´ë¬¸ êµ¬ì¡°ë¡œ ìˆ˜ì •í•˜ì—¬

## ğŸ’¡Â ì¶”ê°€ ìµœì í™” í•„ìš”

í˜„ì¬ ìˆ˜ì •ì€Â ì˜¬ë°”ë¥¸ ë°©í–¥ì´ì§€ë§ŒÂ ë¶€ë¶„ì  íš¨ê³¼ë§Œ ìˆì—ˆìŠµë‹ˆë‹¤.

ê·¼ë³¸ì  í•´ê²°ì±…ë“¤:

1. ë™ì˜ì–´ ê°œìˆ˜Â ì œí•œÂ (6ê°œÂ â†’Â 3ê°œ)

2. ì „ì—­Â ë™ì˜ì–´Â ë§µÂ ìºì‹±

3. ìºì‹œ ë¡œì§ ìì²´Â ìµœì í™”

ê²°ë¡ :Â ì¢‹ì•„ì§€ê¸´ í–ˆì§€ë§ŒÂ ì¶”ê°€ ìµœì í™”ê°€Â í•„ìš”í•œÂ ìƒí™©ì…ë‹ˆë‹¤.

ë³€ê²½ì : ë…¼ë¦¬Â ì˜¤ë¥˜ ìˆ˜ì •ìœ¼ë¡œÂ 19.5% ì„±ëŠ¥ ê°œì„ 

ì˜í–¥ë„: ë¶€ë¶„ì  ìµœì í™”Â íš¨ê³¼, í•˜ì§€ë§Œ ëª©í‘œ ì„±ëŠ¥ê¹Œì§€ëŠ”Â ì¶”ê°€ ì‘ì—…Â í•„ìš”

ë‹¤ìŒÂ ë‹¨ê³„: ë™ì˜ì–´ í™•ì¥ ìµœì í™” ë˜ëŠ” ìºì‹œ ë¡œì§Â ê°œì„ Â ê²€í† Â í•„ìš”

ì •í™•ë„: 100%

ê·¼ê±°: ì‹¤ì œ ì„±ëŠ¥ ìˆ˜ì¹˜ë¥¼Â ì •í™•íˆ ë¶„ì„í•˜ì—¬Â ê°œì„  ì •ë„ì™€Â ë‚¨ì€ ê³¼ì œë¥¼Â ëª…í™•íˆ ì œì‹œí•¨.

ê²€ìƒ‰í•  ë•Œ ë™ì˜ì–´Â ê°œìˆ˜ ì œí•œì„Â ì„ íƒí•  ìˆ˜ ìˆë„ë¡ êµ¬í˜„ ê°€ëŠ¥í•©ë‹ˆë‹¤!

## ğŸ¯Â êµ¬í˜„ ë°©ì•ˆ

### 1. í”„ë¡ íŠ¸ì—”ë“œ UI ì¶”ê°€

html

<!--Â you_list.htmlì—Â ì¶”ê°€Â -->

<divÂ class="synonym-control">

Â Â <label>ë™ì˜ì–´Â í™•ì¥:</label>

Â Â <selectÂ id="synonymLimit">

Â Â Â Â <optionÂ value="0">ì‚¬ìš©Â ì•ˆí•¨</option>

Â Â Â Â <optionÂ value="2">2ê°œê¹Œì§€</option>

Â Â Â Â <optionÂ value="3"Â selected>3ê°œê¹Œì§€Â (ê¶Œì¥)</option>

Â Â Â Â <optionÂ value="5">5ê°œê¹Œì§€</option>

Â Â Â Â <optionÂ value="all">ëª¨ë“ Â ë™ì˜ì–´</option>

Â Â </select>

</div>

### 2. JavaScriptÂ ê²€ìƒ‰ íŒŒë¼ë¯¸í„° ì¶”ê°€

javascript

//Â you_list.jsÂ ê²€ìƒ‰Â í•¨ìˆ˜Â ìˆ˜ì •

functionÂ performSearch()Â {

Â Â constÂ synonymLimitÂ =Â document.getElementById('synonymLimit').value;

Â Â constÂ searchParamsÂ =Â {

Â Â Â Â keyword:Â keyword,

Â Â Â Â country:Â country,

Â Â Â Â synonymLimit:Â synonymLimit,Â Â //Â â†Â ìƒˆë¡œÂ ì¶”ê°€

Â Â Â Â //Â ...Â ê¸°íƒ€Â íŒŒë¼ë¯¸í„°

Â Â };

}

### 3.Â ì„œë²„ ì‚¬ì´ë“œ ë™ì˜ì–´ ì œí•œ ë¡œì§

javascript

//Â server.jsÂ ìˆ˜ì •Â ì˜ˆì‹œ

constÂ {Â synonymLimitÂ }Â =Â searchParams;

//Â ë™ì˜ì–´Â í™•ì¥Â ì‹œÂ ì œí•œÂ ì ìš©

ifÂ (synonymMap[lowerKeyword])Â {

Â Â letÂ synonymsÂ =Â synonymMap[lowerKeyword];

Â Â //Â ì‚¬ìš©ìÂ ì„ íƒì—Â ë”°ë¥¸Â ì œí•œ

Â Â ifÂ (synonymLimitÂ ===Â '0')Â {

Â Â Â Â synonymsÂ =Â [];Â //Â ë™ì˜ì–´Â ì‚¬ìš©Â ì•ˆí•¨

Â Â }Â elseÂ ifÂ (synonymLimitÂ !==Â 'all')Â {

Â Â Â Â synonymsÂ =Â synonyms.slice(0,Â parseInt(synonymLimit));

Â Â }

Â Â expandedKeywords.push(...synonyms);

}

### 4. ì˜ˆìƒÂ ì„±ëŠ¥ íš¨ê³¼

| ì„ íƒÂ ì˜µì…˜  | ê²€ìƒ‰ ì¡°ê±´ ìˆ˜ | ì˜ˆìƒ ì‹œê°„ | ì •í™•ë„   |
| ------ | ------- | ----- | ----- |
| ì‚¬ìš© ì•ˆí•¨  | 4ê°œ      | ~30ì´ˆ  | â­â­â­   |
| 2ê°œê¹Œì§€   | 6ê°œ      | ~35ì´ˆ  | â­â­â­â­  |
| 3ê°œê¹Œì§€   | 8ê°œ      | ~40ì´ˆ  | â­â­â­â­â­ |
| 5ê°œê¹Œì§€   | 12ê°œ     | ~50ì´ˆ  | â­â­â­â­â­ |
| ëª¨ë“  ë™ì˜ì–´ | 14ê°œ     | ~55ì´ˆ  | â­â­â­â­â­ |

### 5. ì‚¬ìš©ì ê²½í—˜

ë¹ ë¥¸ ê²€ìƒ‰ì´Â í•„ìš”í• Â ë•Œ:

- "ì‚¬ìš© ì•ˆí•¨" ë˜ëŠ” "2ê°œê¹Œì§€" ì„ íƒ

ì •í™•í•œ ê²€ìƒ‰ì´ í•„ìš”í•  ë•Œ:

- "5ê°œê¹Œì§€" ë˜ëŠ”Â "ëª¨ë“  ë™ì˜ì–´" ì„ íƒ

ê· í˜•ì¡íŒ ê²€ìƒ‰Â (ê¸°ë³¸ê°’):

- "3ê°œê¹Œì§€" ì„ íƒ

### 6. ì¶”ê°€ ê°œì„  ì•„ì´ë””ì–´

ìë™ ìµœì í™”:

javascript

//Â í‚¤ì›Œë“œë³„Â ì¸ê¸°ë„ì—Â ë”°ë¥¸Â ìë™Â ì¡°ì ˆ

constÂ popularKeywordsÂ =Â ['ìŒì•…',Â 'ìš”ë¦¬',Â 'ê²Œì„'];

ifÂ (popularKeywords.includes(keyword)Â &&Â synonymLimitÂ ===Â 'auto')Â {

Â Â //Â ì¸ê¸°Â í‚¤ì›Œë“œëŠ”Â ë”Â ë§ì€Â ë™ì˜ì–´Â ì‚¬ìš©

}

ê°œì¸í™”Â ì„¤ì •:

javascript

//Â ì‚¬ìš©ìë³„Â ê¸°ë³¸ê°’Â ì €ì¥

localStorage.setItem('preferredSynonymLimit',Â synonymLimit);

ì´ëŸ° ì‹ìœ¼ë¡œ êµ¬í˜„í•˜ë©´ ì‚¬ìš©ìê°€Â ì„±ëŠ¥ê³¼ ì •í™•ë„ ì‚¬ì´ì˜ ê· í˜•ì„ ì§ì ‘ ì„ íƒí•  ìˆ˜ ìˆê²ŒÂ ë©ë‹ˆë‹¤.

êµ¬í˜„í•˜ì‹œê² ìŠµë‹ˆê¹Œ?

ì •í™•ë„: 95%

ê·¼ê±°: ì‹¤ì œ êµ¬í˜„ ê°€ëŠ¥í•œ ë°©ì•ˆì„Â ë‹¨ê³„ë³„ë¡œ ì œì‹œí–ˆìœ¼ë©°, UIë¶€í„°Â ì„œë²„Â ë¡œì§ê¹Œì§€ ì „ì²´Â êµ¬ì¡°ë¥¼ ê³ ë ¤í•œÂ ì™„ì „í•œÂ ì†”ë£¨ì…˜ì„Â ì œê³µí•¨.
